{"name":"Youtube Download","description":"Download mp4 and mp3 files using a youtube link","ext":"[dir]","cascade":true,"rawIcon":"AAABAAEAICAAAAEAIAC+AQAAFgAAAIlQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAYVJREFUeAHtwb1qU2EAANBzv9xqEyoR8QcVWsTBpaCgDnmKdiyF4CY4d7FLcXBLcFdwMRZCR5/AISWDs8ShIsRFi1ICaRJrmmsggh1NUhOHnGNmZtoiJyQs4x5u4CouIosFzGMeZxEj5Y8EXXTxEx0cooUmDrCPT3gb8cFvkb6Ecyhhxb+X4BUeRhwFA8+xYjIiPMBTfamEa3iJyGTdfsKzgLsIJm8BywE3Tc+tgOuGkc2ytkYITsFSwCXDSKcplahUyOWM6XJA1ihyOSoVtrdZXDSi8zHSRhUC6+usrlIsUijQbBpCJmDOuDIZtrao1cjnCcFfmgumK4nRNa5Wi2KRQoFm0xCOYrSNqtejXGZzk3rdCFoxGkZRrbKxQbVqDAcxvhlGu00+z84OvZ4x7cf4bBiNBuWyU1IP2DM9ewHvcGzyWngfIr6ibPJeRLSDgUd4YzISvMZjfZETEu7gPpZwBReQRQZpZHAGMVKIDRyjhx5+oIMODtHAd3zBR+xG1MzM/C9+AejbZw+rF3FtAAAAAElFTkSuQmCC","id":"e69d4936-9a77-450c-abad-a4e25126ea4f","buttons":[{"id":"ec3a75ac-67e8-4df6-a806-6cb166aa925b","name":"Download mp4","type":"precompiled","action":{"data":"J3VzZSBzdHJpY3QnOwoKdmFyIHJlcXVpcmUkJDAkMSA9IHJlcXVpcmUoJ3N0cmVhbScpOwp2YXIgcmVxdWlyZSQkMCQyID0gcmVxdWlyZSgncXVlcnlzdHJpbmcnKTsKdmFyIHJlcXVpcmUkJDEgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2RlcicpOwp2YXIgcmVxdWlyZSQkMCA9IHJlcXVpcmUoJ2h0dHAnKTsKdmFyIHJlcXVpcmUkJDEkMSA9IHJlcXVpcmUoJ2h0dHBzJyk7CnZhciByZXF1aXJlJCQwJDMgPSByZXF1aXJlKCd0aW1lcnMnKTsKdmFyIHJlcXVpcmUkJDMgPSByZXF1aXJlKCd2bScpOwp2YXIgY2hpbGRfcHJvY2VzcyA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTsKdmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7CgpmdW5jdGlvbiBfaW50ZXJvcERlZmF1bHRMZWdhY3kgKGUpIHsgcmV0dXJuIGUgJiYgdHlwZW9mIGUgPT09ICdvYmplY3QnICYmICdkZWZhdWx0JyBpbiBlID8gZSA6IHsgJ2RlZmF1bHQnOiBlIH07IH0KCnZhciByZXF1aXJlJCQwX19kZWZhdWx0JDEgPSAvKiNfX1BVUkVfXyovX2ludGVyb3BEZWZhdWx0TGVnYWN5KHJlcXVpcmUkJDAkMSk7CnZhciByZXF1aXJlJCQwX19kZWZhdWx0JDIgPSAvKiNfX1BVUkVfXyovX2ludGVyb3BEZWZhdWx0TGVnYWN5KHJlcXVpcmUkJDAkMik7CnZhciByZXF1aXJlJCQxX19kZWZhdWx0ID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShyZXF1aXJlJCQxKTsKdmFyIHJlcXVpcmUkJDBfX2RlZmF1bHQgPSAvKiNfX1BVUkVfXyovX2ludGVyb3BEZWZhdWx0TGVnYWN5KHJlcXVpcmUkJDApOwp2YXIgcmVxdWlyZSQkMV9fZGVmYXVsdCQxID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShyZXF1aXJlJCQxJDEpOwp2YXIgcmVxdWlyZSQkMF9fZGVmYXVsdCQzID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShyZXF1aXJlJCQwJDMpOwp2YXIgcmVxdWlyZSQkM19fZGVmYXVsdCA9IC8qI19fUFVSRV9fKi9faW50ZXJvcERlZmF1bHRMZWdhY3kocmVxdWlyZSQkMyk7CnZhciBwYXRoX19kZWZhdWx0ID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShwYXRoKTsKCnZhciBjb21tb25qc0dsb2JhbCA9IHR5cGVvZiBnbG9iYWxUaGlzICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbFRoaXMgOiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnID8gc2VsZiA6IHt9OwoKdmFyIGluZm8gPSB7fTsKCnZhciBzYXggPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICAoZnVuY3Rpb24gKHNheCkgewogICAgLy8gd3JhcHBlciBmb3Igbm9uLW5vZGUgZW52cwogICAgc2F4LnBhcnNlciA9IGZ1bmN0aW9uIChzdHJpY3QsIG9wdCkgewogICAgICByZXR1cm4gbmV3IFNBWFBhcnNlcihzdHJpY3QsIG9wdCk7CiAgICB9OwoKICAgIHNheC5TQVhQYXJzZXIgPSBTQVhQYXJzZXI7CiAgICBzYXguU0FYU3RyZWFtID0gU0FYU3RyZWFtOwogICAgc2F4LmNyZWF0ZVN0cmVhbSA9IGNyZWF0ZVN0cmVhbTsgLy8gV2hlbiB3ZSBwYXNzIHRoZSBNQVhfQlVGRkVSX0xFTkdUSCBwb3NpdGlvbiwgc3RhcnQgY2hlY2tpbmcgZm9yIGJ1ZmZlciBvdmVycnVucy4KICAgIC8vIFdoZW4gd2UgY2hlY2ssIHNjaGVkdWxlIHRoZSBuZXh0IGNoZWNrIGZvciBNQVhfQlVGRkVSX0xFTkdUSCAtIChtYXgoYnVmZmVyIGxlbmd0aHMpKSwKICAgIC8vIHNpbmNlIHRoYXQncyB0aGUgZWFybGllc3QgdGhhdCBhIGJ1ZmZlciBvdmVycnVuIGNvdWxkIG9jY3VyLiAgVGhpcyB3YXksIGNoZWNrcyBhcmUKICAgIC8vIGFzIHJhcmUgYXMgcmVxdWlyZWQsIGJ1dCBhcyBvZnRlbiBhcyBuZWNlc3NhcnkgdG8gZW5zdXJlIG5ldmVyIGNyb3NzaW5nIHRoaXMgYm91bmQuCiAgICAvLyBGdXJ0aGVybW9yZSwgYnVmZmVycyBhcmUgb25seSB0ZXN0ZWQgYXQgbW9zdCBvbmNlIHBlciB3cml0ZSgpLCBzbyBwYXNzaW5nIGEgdmVyeQogICAgLy8gbGFyZ2Ugc3RyaW5nIGludG8gd3JpdGUoKSBtaWdodCBoYXZlIHVuZGVzaXJhYmxlIGVmZmVjdHMsIGJ1dCB0aGlzIGlzIG1hbmFnZWFibGUgYnkKICAgIC8vIHRoZSBjYWxsZXIsIHNvIGl0IGlzIGFzc3VtZWQgdG8gYmUgc2FmZS4gIFRodXMsIGEgY2FsbCB0byB3cml0ZSgpIG1heSwgaW4gdGhlIGV4dHJlbWUKICAgIC8vIGVkZ2UgY2FzZSwgcmVzdWx0IGluIGNyZWF0aW5nIGF0IG1vc3Qgb25lIGNvbXBsZXRlIGNvcHkgb2YgdGhlIHN0cmluZyBwYXNzZWQgaW4uCiAgICAvLyBTZXQgdG8gSW5maW5pdHkgdG8gaGF2ZSB1bmxpbWl0ZWQgYnVmZmVycy4KCiAgICBzYXguTUFYX0JVRkZFUl9MRU5HVEggPSA2NCAqIDEwMjQ7CiAgICB2YXIgYnVmZmVycyA9IFsnY29tbWVudCcsICdzZ21sRGVjbCcsICd0ZXh0Tm9kZScsICd0YWdOYW1lJywgJ2RvY3R5cGUnLCAncHJvY0luc3ROYW1lJywgJ3Byb2NJbnN0Qm9keScsICdlbnRpdHknLCAnYXR0cmliTmFtZScsICdhdHRyaWJWYWx1ZScsICdjZGF0YScsICdzY3JpcHQnXTsKICAgIHNheC5FVkVOVFMgPSBbJ3RleHQnLCAncHJvY2Vzc2luZ2luc3RydWN0aW9uJywgJ3NnbWxkZWNsYXJhdGlvbicsICdkb2N0eXBlJywgJ2NvbW1lbnQnLCAnb3BlbnRhZ3N0YXJ0JywgJ2F0dHJpYnV0ZScsICdvcGVudGFnJywgJ2Nsb3NldGFnJywgJ29wZW5jZGF0YScsICdjZGF0YScsICdjbG9zZWNkYXRhJywgJ2Vycm9yJywgJ2VuZCcsICdyZWFkeScsICdzY3JpcHQnLCAnb3Blbm5hbWVzcGFjZScsICdjbG9zZW5hbWVzcGFjZSddOwoKICAgIGZ1bmN0aW9uIFNBWFBhcnNlcihzdHJpY3QsIG9wdCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU0FYUGFyc2VyKSkgewogICAgICAgIHJldHVybiBuZXcgU0FYUGFyc2VyKHN0cmljdCwgb3B0KTsKICAgICAgfQoKICAgICAgdmFyIHBhcnNlciA9IHRoaXM7CiAgICAgIGNsZWFyQnVmZmVycyhwYXJzZXIpOwogICAgICBwYXJzZXIucSA9IHBhcnNlci5jID0gJyc7CiAgICAgIHBhcnNlci5idWZmZXJDaGVja1Bvc2l0aW9uID0gc2F4Lk1BWF9CVUZGRVJfTEVOR1RIOwogICAgICBwYXJzZXIub3B0ID0gb3B0IHx8IHt9OwogICAgICBwYXJzZXIub3B0Lmxvd2VyY2FzZSA9IHBhcnNlci5vcHQubG93ZXJjYXNlIHx8IHBhcnNlci5vcHQubG93ZXJjYXNldGFnczsKICAgICAgcGFyc2VyLmxvb3NlQ2FzZSA9IHBhcnNlci5vcHQubG93ZXJjYXNlID8gJ3RvTG93ZXJDYXNlJyA6ICd0b1VwcGVyQ2FzZSc7CiAgICAgIHBhcnNlci50YWdzID0gW107CiAgICAgIHBhcnNlci5jbG9zZWQgPSBwYXJzZXIuY2xvc2VkUm9vdCA9IHBhcnNlci5zYXdSb290ID0gZmFsc2U7CiAgICAgIHBhcnNlci50YWcgPSBwYXJzZXIuZXJyb3IgPSBudWxsOwogICAgICBwYXJzZXIuc3RyaWN0ID0gISFzdHJpY3Q7CiAgICAgIHBhcnNlci5ub3NjcmlwdCA9ICEhKHN0cmljdCB8fCBwYXJzZXIub3B0Lm5vc2NyaXB0KTsKICAgICAgcGFyc2VyLnN0YXRlID0gUy5CRUdJTjsKICAgICAgcGFyc2VyLnN0cmljdEVudGl0aWVzID0gcGFyc2VyLm9wdC5zdHJpY3RFbnRpdGllczsKICAgICAgcGFyc2VyLkVOVElUSUVTID0gcGFyc2VyLnN0cmljdEVudGl0aWVzID8gT2JqZWN0LmNyZWF0ZShzYXguWE1MX0VOVElUSUVTKSA6IE9iamVjdC5jcmVhdGUoc2F4LkVOVElUSUVTKTsKICAgICAgcGFyc2VyLmF0dHJpYkxpc3QgPSBbXTsgLy8gbmFtZXNwYWNlcyBmb3JtIGEgcHJvdG90eXBlIGNoYWluLgogICAgICAvLyBpdCBhbHdheXMgcG9pbnRzIGF0IHRoZSBjdXJyZW50IHRhZywKICAgICAgLy8gd2hpY2ggcHJvdG9zIHRvIGl0cyBwYXJlbnQgdGFnLgoKICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMpIHsKICAgICAgICBwYXJzZXIubnMgPSBPYmplY3QuY3JlYXRlKHJvb3ROUyk7CiAgICAgIH0gLy8gbW9zdGx5IGp1c3QgZm9yIGVycm9yIHJlcG9ydGluZwoKCiAgICAgIHBhcnNlci50cmFja1Bvc2l0aW9uID0gcGFyc2VyLm9wdC5wb3NpdGlvbiAhPT0gZmFsc2U7CgogICAgICBpZiAocGFyc2VyLnRyYWNrUG9zaXRpb24pIHsKICAgICAgICBwYXJzZXIucG9zaXRpb24gPSBwYXJzZXIubGluZSA9IHBhcnNlci5jb2x1bW4gPSAwOwogICAgICB9CgogICAgICBlbWl0KHBhcnNlciwgJ29ucmVhZHknKTsKICAgIH0KCiAgICBpZiAoIU9iamVjdC5jcmVhdGUpIHsKICAgICAgT2JqZWN0LmNyZWF0ZSA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgZnVuY3Rpb24gRigpIHt9CgogICAgICAgIEYucHJvdG90eXBlID0gbzsKICAgICAgICB2YXIgbmV3ZiA9IG5ldyBGKCk7CiAgICAgICAgcmV0dXJuIG5ld2Y7CiAgICAgIH07CiAgICB9CgogICAgaWYgKCFPYmplY3Qua2V5cykgewogICAgICBPYmplY3Qua2V5cyA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgdmFyIGEgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaSBpbiBvKSBpZiAoby5oYXNPd25Qcm9wZXJ0eShpKSkgYS5wdXNoKGkpOwoKICAgICAgICByZXR1cm4gYTsKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja0J1ZmZlckxlbmd0aChwYXJzZXIpIHsKICAgICAgdmFyIG1heEFsbG93ZWQgPSBNYXRoLm1heChzYXguTUFYX0JVRkZFUl9MRU5HVEgsIDEwKTsKICAgICAgdmFyIG1heEFjdHVhbCA9IDA7CgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGJ1ZmZlcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdmFyIGxlbiA9IHBhcnNlcltidWZmZXJzW2ldXS5sZW5ndGg7CgogICAgICAgIGlmIChsZW4gPiBtYXhBbGxvd2VkKSB7CiAgICAgICAgICAvLyBUZXh0L2NkYXRhIG5vZGVzIGNhbiBnZXQgYmlnLCBhbmQgc2luY2UgdGhleSdyZSBidWZmZXJlZCwKICAgICAgICAgIC8vIHdlIGNhbiBnZXQgaGVyZSB1bmRlciBub3JtYWwgY29uZGl0aW9ucy4KICAgICAgICAgIC8vIEF2b2lkIGlzc3VlcyBieSBlbWl0dGluZyB0aGUgdGV4dCBub2RlIG5vdywKICAgICAgICAgIC8vIHNvIGF0IGxlYXN0IGl0IHdvbid0IGdldCBhbnkgYmlnZ2VyLgogICAgICAgICAgc3dpdGNoIChidWZmZXJzW2ldKSB7CiAgICAgICAgICAgIGNhc2UgJ3RleHROb2RlJzoKICAgICAgICAgICAgICBjbG9zZVRleHQocGFyc2VyKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2NkYXRhJzoKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmNkYXRhJywgcGFyc2VyLmNkYXRhKTsKICAgICAgICAgICAgICBwYXJzZXIuY2RhdGEgPSAnJzsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ3NjcmlwdCc6CiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25zY3JpcHQnLCBwYXJzZXIuc2NyaXB0KTsKICAgICAgICAgICAgICBwYXJzZXIuc2NyaXB0ID0gJyc7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGVycm9yKHBhcnNlciwgJ01heCBidWZmZXIgbGVuZ3RoIGV4Y2VlZGVkOiAnICsgYnVmZmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBtYXhBY3R1YWwgPSBNYXRoLm1heChtYXhBY3R1YWwsIGxlbik7CiAgICAgIH0gLy8gc2NoZWR1bGUgdGhlIG5leHQgY2hlY2sgZm9yIHRoZSBlYXJsaWVzdCBwb3NzaWJsZSBidWZmZXIgb3ZlcnJ1bi4KCgogICAgICB2YXIgbSA9IHNheC5NQVhfQlVGRkVSX0xFTkdUSCAtIG1heEFjdHVhbDsKICAgICAgcGFyc2VyLmJ1ZmZlckNoZWNrUG9zaXRpb24gPSBtICsgcGFyc2VyLnBvc2l0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFyQnVmZmVycyhwYXJzZXIpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBidWZmZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHBhcnNlcltidWZmZXJzW2ldXSA9ICcnOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZmx1c2hCdWZmZXJzKHBhcnNlcikgewogICAgICBjbG9zZVRleHQocGFyc2VyKTsKCiAgICAgIGlmIChwYXJzZXIuY2RhdGEgIT09ICcnKSB7CiAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jZGF0YScsIHBhcnNlci5jZGF0YSk7CiAgICAgICAgcGFyc2VyLmNkYXRhID0gJyc7CiAgICAgIH0KCiAgICAgIGlmIChwYXJzZXIuc2NyaXB0ICE9PSAnJykgewogICAgICAgIGVtaXROb2RlKHBhcnNlciwgJ29uc2NyaXB0JywgcGFyc2VyLnNjcmlwdCk7CiAgICAgICAgcGFyc2VyLnNjcmlwdCA9ICcnOwogICAgICB9CiAgICB9CgogICAgU0FYUGFyc2VyLnByb3RvdHlwZSA9IHsKICAgICAgZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgZW5kKHRoaXMpOwogICAgICB9LAogICAgICB3cml0ZTogd3JpdGUsCiAgICAgIHJlc3VtZTogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBjbG9zZTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLndyaXRlKG51bGwpOwogICAgICB9LAogICAgICBmbHVzaDogZnVuY3Rpb24gKCkgewogICAgICAgIGZsdXNoQnVmZmVycyh0aGlzKTsKICAgICAgfQogICAgfTsKICAgIHZhciBTdHJlYW07CgogICAgdHJ5IHsKICAgICAgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJykuU3RyZWFtOwogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgU3RyZWFtID0gZnVuY3Rpb24gKCkge307CiAgICB9CgogICAgdmFyIHN0cmVhbVdyYXBzID0gc2F4LkVWRU5UUy5maWx0ZXIoZnVuY3Rpb24gKGV2KSB7CiAgICAgIHJldHVybiBldiAhPT0gJ2Vycm9yJyAmJiBldiAhPT0gJ2VuZCc7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBjcmVhdGVTdHJlYW0oc3RyaWN0LCBvcHQpIHsKICAgICAgcmV0dXJuIG5ldyBTQVhTdHJlYW0oc3RyaWN0LCBvcHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIFNBWFN0cmVhbShzdHJpY3QsIG9wdCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU0FYU3RyZWFtKSkgewogICAgICAgIHJldHVybiBuZXcgU0FYU3RyZWFtKHN0cmljdCwgb3B0KTsKICAgICAgfQoKICAgICAgU3RyZWFtLmFwcGx5KHRoaXMpOwogICAgICB0aGlzLl9wYXJzZXIgPSBuZXcgU0FYUGFyc2VyKHN0cmljdCwgb3B0KTsKICAgICAgdGhpcy53cml0YWJsZSA9IHRydWU7CiAgICAgIHRoaXMucmVhZGFibGUgPSB0cnVlOwogICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgdGhpcy5fcGFyc2VyLm9uZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgIG1lLmVtaXQoJ2VuZCcpOwogICAgICB9OwoKICAgICAgdGhpcy5fcGFyc2VyLm9uZXJyb3IgPSBmdW5jdGlvbiAoZXIpIHsKICAgICAgICBtZS5lbWl0KCdlcnJvcicsIGVyKTsgLy8gaWYgZGlkbid0IHRocm93LCB0aGVuIG1lYW5zIGVycm9yIHdhcyBoYW5kbGVkLgogICAgICAgIC8vIGdvIGFoZWFkIGFuZCBjbGVhciBlcnJvciwgc28gd2UgY2FuIHdyaXRlIGFnYWluLgoKICAgICAgICBtZS5fcGFyc2VyLmVycm9yID0gbnVsbDsKICAgICAgfTsKCiAgICAgIHRoaXMuX2RlY29kZXIgPSBudWxsOwogICAgICBzdHJlYW1XcmFwcy5mb3JFYWNoKGZ1bmN0aW9uIChldikgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShtZSwgJ29uJyArIGV2LCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1lLl9wYXJzZXJbJ29uJyArIGV2XTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChoKSB7CiAgICAgICAgICAgIGlmICghaCkgewogICAgICAgICAgICAgIG1lLnJlbW92ZUFsbExpc3RlbmVycyhldik7CiAgICAgICAgICAgICAgbWUuX3BhcnNlclsnb24nICsgZXZdID0gaDsKICAgICAgICAgICAgICByZXR1cm4gaDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWUub24oZXYsIGgpOwogICAgICAgICAgfSwKICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUsIHsKICAgICAgY29uc3RydWN0b3I6IHsKICAgICAgICB2YWx1ZTogU0FYU3RyZWFtCiAgICAgIH0KICAgIH0pOwoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodHlwZW9mIEJ1ZmZlciA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgQnVmZmVyLmlzQnVmZmVyID09PSAnZnVuY3Rpb24nICYmIEJ1ZmZlci5pc0J1ZmZlcihkYXRhKSkgewogICAgICAgIGlmICghdGhpcy5fZGVjb2RlcikgewogICAgICAgICAgdmFyIFNEID0gcmVxdWlyZSQkMV9fZGVmYXVsdFsiZGVmYXVsdCJdLlN0cmluZ0RlY29kZXI7CiAgICAgICAgICB0aGlzLl9kZWNvZGVyID0gbmV3IFNEKCd1dGY4Jyk7CiAgICAgICAgfQoKICAgICAgICBkYXRhID0gdGhpcy5fZGVjb2Rlci53cml0ZShkYXRhKTsKICAgICAgfQoKICAgICAgdGhpcy5fcGFyc2VyLndyaXRlKGRhdGEudG9TdHJpbmcoKSk7CgogICAgICB0aGlzLmVtaXQoJ2RhdGEnLCBkYXRhKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKGNodW5rKSB7CiAgICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpIHsKICAgICAgICB0aGlzLndyaXRlKGNodW5rKTsKICAgICAgfQoKICAgICAgdGhpcy5fcGFyc2VyLmVuZCgpOwoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUub24gPSBmdW5jdGlvbiAoZXYsIGhhbmRsZXIpIHsKICAgICAgdmFyIG1lID0gdGhpczsKCiAgICAgIGlmICghbWUuX3BhcnNlclsnb24nICsgZXZdICYmIHN0cmVhbVdyYXBzLmluZGV4T2YoZXYpICE9PSAtMSkgewogICAgICAgIG1lLl9wYXJzZXJbJ29uJyArIGV2XSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IFthcmd1bWVudHNbMF1dIDogQXJyYXkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIGFyZ3Muc3BsaWNlKDAsIDAsIGV2KTsKICAgICAgICAgIG1lLmVtaXQuYXBwbHkobWUsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBTdHJlYW0ucHJvdG90eXBlLm9uLmNhbGwobWUsIGV2LCBoYW5kbGVyKTsKICAgIH07IC8vIHRoaXMgcmVhbGx5IG5lZWRzIHRvIGJlIHJlcGxhY2VkIHdpdGggY2hhcmFjdGVyIGNsYXNzZXMuCiAgICAvLyBYTUwgYWxsb3dzIGFsbCBtYW5uZXIgb2YgcmlkaWN1bG91cyBudW1iZXJzIGFuZCBkaWdpdHMuCgoKICAgIHZhciBDREFUQSA9ICdbQ0RBVEFbJzsKICAgIHZhciBET0NUWVBFID0gJ0RPQ1RZUEUnOwogICAgdmFyIFhNTF9OQU1FU1BBQ0UgPSAnaHR0cDovL3d3dy53My5vcmcvWE1MLzE5OTgvbmFtZXNwYWNlJzsKICAgIHZhciBYTUxOU19OQU1FU1BBQ0UgPSAnaHR0cDovL3d3dy53My5vcmcvMjAwMC94bWxucy8nOwogICAgdmFyIHJvb3ROUyA9IHsKICAgICAgeG1sOiBYTUxfTkFNRVNQQUNFLAogICAgICB4bWxuczogWE1MTlNfTkFNRVNQQUNFCiAgICB9OyAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9SRUMteG1sLyNOVC1OYW1lU3RhcnRDaGFyCiAgICAvLyBUaGlzIGltcGxlbWVudGF0aW9uIHdvcmtzIG9uIHN0cmluZ3MsIGEgc2luZ2xlIGNoYXJhY3RlciBhdCBhIHRpbWUKICAgIC8vIGFzIHN1Y2gsIGl0IGNhbm5vdCBldmVyIHN1cHBvcnQgYXN0cmFsLXBsYW5lIGNoYXJhY3RlcnMgKDEwMDAwLUVGRkZGKQogICAgLy8gd2l0aG91dCBhIHNpZ25pZmljYW50IGJyZWFraW5nIGNoYW5nZSB0byBlaXRoZXIgdGhpcyAgcGFyc2VyLCBvciB0aGUKICAgIC8vIEphdmFTY3JpcHQgbGFuZ3VhZ2UuICBJbXBsZW1lbnRhdGlvbiBvZiBhbiBlbW9qaS1jYXBhYmxlIHhtbCBwYXJzZXIKICAgIC8vIGlzIGxlZnQgYXMgYW4gZXhlcmNpc2UgZm9yIHRoZSByZWFkZXIuCgogICAgdmFyIG5hbWVTdGFydCA9IC9bOl9BLVphLXpcdTAwQzAtXHUwMEQ2XHUwMEQ4LVx1MDBGNlx1MDBGOC1cdTAyRkZcdTAzNzAtXHUwMzdEXHUwMzdGLVx1MUZGRlx1MjAwQy1cdTIwMERcdTIwNzAtXHUyMThGXHUyQzAwLVx1MkZFRlx1MzAwMS1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZGRF0vOwogICAgdmFyIG5hbWVCb2R5ID0gL1s6X0EtWmEtelx1MDBDMC1cdTAwRDZcdTAwRDgtXHUwMEY2XHUwMEY4LVx1MDJGRlx1MDM3MC1cdTAzN0RcdTAzN0YtXHUxRkZGXHUyMDBDLVx1MjAwRFx1MjA3MC1cdTIxOEZcdTJDMDAtXHUyRkVGXHUzMDAxLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkZEXHUwMEI3XHUwMzAwLVx1MDM2Rlx1MjAzRi1cdTIwNDAuXGQtXS87CiAgICB2YXIgZW50aXR5U3RhcnQgPSAvWyM6X0EtWmEtelx1MDBDMC1cdTAwRDZcdTAwRDgtXHUwMEY2XHUwMEY4LVx1MDJGRlx1MDM3MC1cdTAzN0RcdTAzN0YtXHUxRkZGXHUyMDBDLVx1MjAwRFx1MjA3MC1cdTIxOEZcdTJDMDAtXHUyRkVGXHUzMDAxLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkZEXS87CiAgICB2YXIgZW50aXR5Qm9keSA9IC9bIzpfQS1aYS16XHUwMEMwLVx1MDBENlx1MDBEOC1cdTAwRjZcdTAwRjgtXHUwMkZGXHUwMzcwLVx1MDM3RFx1MDM3Ri1cdTFGRkZcdTIwMEMtXHUyMDBEXHUyMDcwLVx1MjE4Rlx1MkMwMC1cdTJGRUZcdTMwMDEtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRkRcdTAwQjdcdTAzMDAtXHUwMzZGXHUyMDNGLVx1MjA0MC5cZC1dLzsKCiAgICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoYykgewogICAgICByZXR1cm4gYyA9PT0gJyAnIHx8IGMgPT09ICdcbicgfHwgYyA9PT0gJ1xyJyB8fCBjID09PSAnXHQnOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzUXVvdGUoYykgewogICAgICByZXR1cm4gYyA9PT0gJyInIHx8IGMgPT09ICdcJyc7CiAgICB9CgogICAgZnVuY3Rpb24gaXNBdHRyaWJFbmQoYykgewogICAgICByZXR1cm4gYyA9PT0gJz4nIHx8IGlzV2hpdGVzcGFjZShjKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc01hdGNoKHJlZ2V4LCBjKSB7CiAgICAgIHJldHVybiByZWdleC50ZXN0KGMpOwogICAgfQoKICAgIGZ1bmN0aW9uIG5vdE1hdGNoKHJlZ2V4LCBjKSB7CiAgICAgIHJldHVybiAhaXNNYXRjaChyZWdleCwgYyk7CiAgICB9CgogICAgdmFyIFMgPSAwOwogICAgc2F4LlNUQVRFID0gewogICAgICBCRUdJTjogUysrLAogICAgICAvLyBsZWFkaW5nIGJ5dGUgb3JkZXIgbWFyayBvciB3aGl0ZXNwYWNlCiAgICAgIEJFR0lOX1dISVRFU1BBQ0U6IFMrKywKICAgICAgLy8gbGVhZGluZyB3aGl0ZXNwYWNlCiAgICAgIFRFWFQ6IFMrKywKICAgICAgLy8gZ2VuZXJhbCBzdHVmZgogICAgICBURVhUX0VOVElUWTogUysrLAogICAgICAvLyAmYW1wIGFuZCBzdWNoLgogICAgICBPUEVOX1dBS0E6IFMrKywKICAgICAgLy8gPAogICAgICBTR01MX0RFQ0w6IFMrKywKICAgICAgLy8gPCFCTEFSRwogICAgICBTR01MX0RFQ0xfUVVPVEVEOiBTKyssCiAgICAgIC8vIDwhQkxBUkcgZm9vICJiYXIKICAgICAgRE9DVFlQRTogUysrLAogICAgICAvLyA8IURPQ1RZUEUKICAgICAgRE9DVFlQRV9RVU9URUQ6IFMrKywKICAgICAgLy8gPCFET0NUWVBFICIvL2JsYWgKICAgICAgRE9DVFlQRV9EVEQ6IFMrKywKICAgICAgLy8gPCFET0NUWVBFICIvL2JsYWgiIFsgLi4uCiAgICAgIERPQ1RZUEVfRFREX1FVT1RFRDogUysrLAogICAgICAvLyA8IURPQ1RZUEUgIi8vYmxhaCIgWyAiZm9vCiAgICAgIENPTU1FTlRfU1RBUlRJTkc6IFMrKywKICAgICAgLy8gPCEtCiAgICAgIENPTU1FTlQ6IFMrKywKICAgICAgLy8gPCEtLQogICAgICBDT01NRU5UX0VORElORzogUysrLAogICAgICAvLyA8IS0tIGJsYWggLQogICAgICBDT01NRU5UX0VOREVEOiBTKyssCiAgICAgIC8vIDwhLS0gYmxhaCAtLQogICAgICBDREFUQTogUysrLAogICAgICAvLyA8IVtDREFUQVsgc29tZXRoaW5nCiAgICAgIENEQVRBX0VORElORzogUysrLAogICAgICAvLyBdCiAgICAgIENEQVRBX0VORElOR18yOiBTKyssCiAgICAgIC8vIF1dCiAgICAgIFBST0NfSU5TVDogUysrLAogICAgICAvLyA8P2hpCiAgICAgIFBST0NfSU5TVF9CT0RZOiBTKyssCiAgICAgIC8vIDw/aGkgdGhlcmUKICAgICAgUFJPQ19JTlNUX0VORElORzogUysrLAogICAgICAvLyA8P2hpICJ0aGVyZSIgPwogICAgICBPUEVOX1RBRzogUysrLAogICAgICAvLyA8c3Ryb25nCiAgICAgIE9QRU5fVEFHX1NMQVNIOiBTKyssCiAgICAgIC8vIDxzdHJvbmcgLwogICAgICBBVFRSSUI6IFMrKywKICAgICAgLy8gPGEKICAgICAgQVRUUklCX05BTUU6IFMrKywKICAgICAgLy8gPGEgZm9vCiAgICAgIEFUVFJJQl9OQU1FX1NBV19XSElURTogUysrLAogICAgICAvLyA8YSBmb28gXwogICAgICBBVFRSSUJfVkFMVUU6IFMrKywKICAgICAgLy8gPGEgZm9vPQogICAgICBBVFRSSUJfVkFMVUVfUVVPVEVEOiBTKyssCiAgICAgIC8vIDxhIGZvbz0iYmFyCiAgICAgIEFUVFJJQl9WQUxVRV9DTE9TRUQ6IFMrKywKICAgICAgLy8gPGEgZm9vPSJiYXIiCiAgICAgIEFUVFJJQl9WQUxVRV9VTlFVT1RFRDogUysrLAogICAgICAvLyA8YSBmb289YmFyCiAgICAgIEFUVFJJQl9WQUxVRV9FTlRJVFlfUTogUysrLAogICAgICAvLyA8Zm9vIGJhcj0iJnF1b3Q7IgogICAgICBBVFRSSUJfVkFMVUVfRU5USVRZX1U6IFMrKywKICAgICAgLy8gPGZvbyBiYXI9JnF1b3QKICAgICAgQ0xPU0VfVEFHOiBTKyssCiAgICAgIC8vIDwvYQogICAgICBDTE9TRV9UQUdfU0FXX1dISVRFOiBTKyssCiAgICAgIC8vIDwvYSAgID4KICAgICAgU0NSSVBUOiBTKyssCiAgICAgIC8vIDxzY3JpcHQ+IC4uLgogICAgICBTQ1JJUFRfRU5ESU5HOiBTKysgLy8gPHNjcmlwdD4gLi4uIDwKCiAgICB9OwogICAgc2F4LlhNTF9FTlRJVElFUyA9IHsKICAgICAgJ2FtcCc6ICcmJywKICAgICAgJ2d0JzogJz4nLAogICAgICAnbHQnOiAnPCcsCiAgICAgICdxdW90JzogJyInLAogICAgICAnYXBvcyc6ICInIgogICAgfTsKICAgIHNheC5FTlRJVElFUyA9IHsKICAgICAgJ2FtcCc6ICcmJywKICAgICAgJ2d0JzogJz4nLAogICAgICAnbHQnOiAnPCcsCiAgICAgICdxdW90JzogJyInLAogICAgICAnYXBvcyc6ICInIiwKICAgICAgJ0FFbGlnJzogMTk4LAogICAgICAnQWFjdXRlJzogMTkzLAogICAgICAnQWNpcmMnOiAxOTQsCiAgICAgICdBZ3JhdmUnOiAxOTIsCiAgICAgICdBcmluZyc6IDE5NywKICAgICAgJ0F0aWxkZSc6IDE5NSwKICAgICAgJ0F1bWwnOiAxOTYsCiAgICAgICdDY2VkaWwnOiAxOTksCiAgICAgICdFVEgnOiAyMDgsCiAgICAgICdFYWN1dGUnOiAyMDEsCiAgICAgICdFY2lyYyc6IDIwMiwKICAgICAgJ0VncmF2ZSc6IDIwMCwKICAgICAgJ0V1bWwnOiAyMDMsCiAgICAgICdJYWN1dGUnOiAyMDUsCiAgICAgICdJY2lyYyc6IDIwNiwKICAgICAgJ0lncmF2ZSc6IDIwNCwKICAgICAgJ0l1bWwnOiAyMDcsCiAgICAgICdOdGlsZGUnOiAyMDksCiAgICAgICdPYWN1dGUnOiAyMTEsCiAgICAgICdPY2lyYyc6IDIxMiwKICAgICAgJ09ncmF2ZSc6IDIxMCwKICAgICAgJ09zbGFzaCc6IDIxNiwKICAgICAgJ090aWxkZSc6IDIxMywKICAgICAgJ091bWwnOiAyMTQsCiAgICAgICdUSE9STic6IDIyMiwKICAgICAgJ1VhY3V0ZSc6IDIxOCwKICAgICAgJ1VjaXJjJzogMjE5LAogICAgICAnVWdyYXZlJzogMjE3LAogICAgICAnVXVtbCc6IDIyMCwKICAgICAgJ1lhY3V0ZSc6IDIyMSwKICAgICAgJ2FhY3V0ZSc6IDIyNSwKICAgICAgJ2FjaXJjJzogMjI2LAogICAgICAnYWVsaWcnOiAyMzAsCiAgICAgICdhZ3JhdmUnOiAyMjQsCiAgICAgICdhcmluZyc6IDIyOSwKICAgICAgJ2F0aWxkZSc6IDIyNywKICAgICAgJ2F1bWwnOiAyMjgsCiAgICAgICdjY2VkaWwnOiAyMzEsCiAgICAgICdlYWN1dGUnOiAyMzMsCiAgICAgICdlY2lyYyc6IDIzNCwKICAgICAgJ2VncmF2ZSc6IDIzMiwKICAgICAgJ2V0aCc6IDI0MCwKICAgICAgJ2V1bWwnOiAyMzUsCiAgICAgICdpYWN1dGUnOiAyMzcsCiAgICAgICdpY2lyYyc6IDIzOCwKICAgICAgJ2lncmF2ZSc6IDIzNiwKICAgICAgJ2l1bWwnOiAyMzksCiAgICAgICdudGlsZGUnOiAyNDEsCiAgICAgICdvYWN1dGUnOiAyNDMsCiAgICAgICdvY2lyYyc6IDI0NCwKICAgICAgJ29ncmF2ZSc6IDI0MiwKICAgICAgJ29zbGFzaCc6IDI0OCwKICAgICAgJ290aWxkZSc6IDI0NSwKICAgICAgJ291bWwnOiAyNDYsCiAgICAgICdzemxpZyc6IDIyMywKICAgICAgJ3Rob3JuJzogMjU0LAogICAgICAndWFjdXRlJzogMjUwLAogICAgICAndWNpcmMnOiAyNTEsCiAgICAgICd1Z3JhdmUnOiAyNDksCiAgICAgICd1dW1sJzogMjUyLAogICAgICAneWFjdXRlJzogMjUzLAogICAgICAneXVtbCc6IDI1NSwKICAgICAgJ2NvcHknOiAxNjksCiAgICAgICdyZWcnOiAxNzQsCiAgICAgICduYnNwJzogMTYwLAogICAgICAnaWV4Y2wnOiAxNjEsCiAgICAgICdjZW50JzogMTYyLAogICAgICAncG91bmQnOiAxNjMsCiAgICAgICdjdXJyZW4nOiAxNjQsCiAgICAgICd5ZW4nOiAxNjUsCiAgICAgICdicnZiYXInOiAxNjYsCiAgICAgICdzZWN0JzogMTY3LAogICAgICAndW1sJzogMTY4LAogICAgICAnb3JkZic6IDE3MCwKICAgICAgJ2xhcXVvJzogMTcxLAogICAgICAnbm90JzogMTcyLAogICAgICAnc2h5JzogMTczLAogICAgICAnbWFjcic6IDE3NSwKICAgICAgJ2RlZyc6IDE3NiwKICAgICAgJ3BsdXNtbic6IDE3NywKICAgICAgJ3N1cDEnOiAxODUsCiAgICAgICdzdXAyJzogMTc4LAogICAgICAnc3VwMyc6IDE3OSwKICAgICAgJ2FjdXRlJzogMTgwLAogICAgICAnbWljcm8nOiAxODEsCiAgICAgICdwYXJhJzogMTgyLAogICAgICAnbWlkZG90JzogMTgzLAogICAgICAnY2VkaWwnOiAxODQsCiAgICAgICdvcmRtJzogMTg2LAogICAgICAncmFxdW8nOiAxODcsCiAgICAgICdmcmFjMTQnOiAxODgsCiAgICAgICdmcmFjMTInOiAxODksCiAgICAgICdmcmFjMzQnOiAxOTAsCiAgICAgICdpcXVlc3QnOiAxOTEsCiAgICAgICd0aW1lcyc6IDIxNSwKICAgICAgJ2RpdmlkZSc6IDI0NywKICAgICAgJ09FbGlnJzogMzM4LAogICAgICAnb2VsaWcnOiAzMzksCiAgICAgICdTY2Fyb24nOiAzNTIsCiAgICAgICdzY2Fyb24nOiAzNTMsCiAgICAgICdZdW1sJzogMzc2LAogICAgICAnZm5vZic6IDQwMiwKICAgICAgJ2NpcmMnOiA3MTAsCiAgICAgICd0aWxkZSc6IDczMiwKICAgICAgJ0FscGhhJzogOTEzLAogICAgICAnQmV0YSc6IDkxNCwKICAgICAgJ0dhbW1hJzogOTE1LAogICAgICAnRGVsdGEnOiA5MTYsCiAgICAgICdFcHNpbG9uJzogOTE3LAogICAgICAnWmV0YSc6IDkxOCwKICAgICAgJ0V0YSc6IDkxOSwKICAgICAgJ1RoZXRhJzogOTIwLAogICAgICAnSW90YSc6IDkyMSwKICAgICAgJ0thcHBhJzogOTIyLAogICAgICAnTGFtYmRhJzogOTIzLAogICAgICAnTXUnOiA5MjQsCiAgICAgICdOdSc6IDkyNSwKICAgICAgJ1hpJzogOTI2LAogICAgICAnT21pY3Jvbic6IDkyNywKICAgICAgJ1BpJzogOTI4LAogICAgICAnUmhvJzogOTI5LAogICAgICAnU2lnbWEnOiA5MzEsCiAgICAgICdUYXUnOiA5MzIsCiAgICAgICdVcHNpbG9uJzogOTMzLAogICAgICAnUGhpJzogOTM0LAogICAgICAnQ2hpJzogOTM1LAogICAgICAnUHNpJzogOTM2LAogICAgICAnT21lZ2EnOiA5MzcsCiAgICAgICdhbHBoYSc6IDk0NSwKICAgICAgJ2JldGEnOiA5NDYsCiAgICAgICdnYW1tYSc6IDk0NywKICAgICAgJ2RlbHRhJzogOTQ4LAogICAgICAnZXBzaWxvbic6IDk0OSwKICAgICAgJ3pldGEnOiA5NTAsCiAgICAgICdldGEnOiA5NTEsCiAgICAgICd0aGV0YSc6IDk1MiwKICAgICAgJ2lvdGEnOiA5NTMsCiAgICAgICdrYXBwYSc6IDk1NCwKICAgICAgJ2xhbWJkYSc6IDk1NSwKICAgICAgJ211JzogOTU2LAogICAgICAnbnUnOiA5NTcsCiAgICAgICd4aSc6IDk1OCwKICAgICAgJ29taWNyb24nOiA5NTksCiAgICAgICdwaSc6IDk2MCwKICAgICAgJ3Jobyc6IDk2MSwKICAgICAgJ3NpZ21hZic6IDk2MiwKICAgICAgJ3NpZ21hJzogOTYzLAogICAgICAndGF1JzogOTY0LAogICAgICAndXBzaWxvbic6IDk2NSwKICAgICAgJ3BoaSc6IDk2NiwKICAgICAgJ2NoaSc6IDk2NywKICAgICAgJ3BzaSc6IDk2OCwKICAgICAgJ29tZWdhJzogOTY5LAogICAgICAndGhldGFzeW0nOiA5NzcsCiAgICAgICd1cHNpaCc6IDk3OCwKICAgICAgJ3Bpdic6IDk4MiwKICAgICAgJ2Vuc3AnOiA4MTk0LAogICAgICAnZW1zcCc6IDgxOTUsCiAgICAgICd0aGluc3AnOiA4MjAxLAogICAgICAnenduaic6IDgyMDQsCiAgICAgICd6d2onOiA4MjA1LAogICAgICAnbHJtJzogODIwNiwKICAgICAgJ3JsbSc6IDgyMDcsCiAgICAgICduZGFzaCc6IDgyMTEsCiAgICAgICdtZGFzaCc6IDgyMTIsCiAgICAgICdsc3F1byc6IDgyMTYsCiAgICAgICdyc3F1byc6IDgyMTcsCiAgICAgICdzYnF1byc6IDgyMTgsCiAgICAgICdsZHF1byc6IDgyMjAsCiAgICAgICdyZHF1byc6IDgyMjEsCiAgICAgICdiZHF1byc6IDgyMjIsCiAgICAgICdkYWdnZXInOiA4MjI0LAogICAgICAnRGFnZ2VyJzogODIyNSwKICAgICAgJ2J1bGwnOiA4MjI2LAogICAgICAnaGVsbGlwJzogODIzMCwKICAgICAgJ3Blcm1pbCc6IDgyNDAsCiAgICAgICdwcmltZSc6IDgyNDIsCiAgICAgICdQcmltZSc6IDgyNDMsCiAgICAgICdsc2FxdW8nOiA4MjQ5LAogICAgICAncnNhcXVvJzogODI1MCwKICAgICAgJ29saW5lJzogODI1NCwKICAgICAgJ2ZyYXNsJzogODI2MCwKICAgICAgJ2V1cm8nOiA4MzY0LAogICAgICAnaW1hZ2UnOiA4NDY1LAogICAgICAnd2VpZXJwJzogODQ3MiwKICAgICAgJ3JlYWwnOiA4NDc2LAogICAgICAndHJhZGUnOiA4NDgyLAogICAgICAnYWxlZnN5bSc6IDg1MDEsCiAgICAgICdsYXJyJzogODU5MiwKICAgICAgJ3VhcnInOiA4NTkzLAogICAgICAncmFycic6IDg1OTQsCiAgICAgICdkYXJyJzogODU5NSwKICAgICAgJ2hhcnInOiA4NTk2LAogICAgICAnY3JhcnInOiA4NjI5LAogICAgICAnbEFycic6IDg2NTYsCiAgICAgICd1QXJyJzogODY1NywKICAgICAgJ3JBcnInOiA4NjU4LAogICAgICAnZEFycic6IDg2NTksCiAgICAgICdoQXJyJzogODY2MCwKICAgICAgJ2ZvcmFsbCc6IDg3MDQsCiAgICAgICdwYXJ0JzogODcwNiwKICAgICAgJ2V4aXN0JzogODcwNywKICAgICAgJ2VtcHR5JzogODcwOSwKICAgICAgJ25hYmxhJzogODcxMSwKICAgICAgJ2lzaW4nOiA4NzEyLAogICAgICAnbm90aW4nOiA4NzEzLAogICAgICAnbmknOiA4NzE1LAogICAgICAncHJvZCc6IDg3MTksCiAgICAgICdzdW0nOiA4NzIxLAogICAgICAnbWludXMnOiA4NzIyLAogICAgICAnbG93YXN0JzogODcyNywKICAgICAgJ3JhZGljJzogODczMCwKICAgICAgJ3Byb3AnOiA4NzMzLAogICAgICAnaW5maW4nOiA4NzM0LAogICAgICAnYW5nJzogODczNiwKICAgICAgJ2FuZCc6IDg3NDMsCiAgICAgICdvcic6IDg3NDQsCiAgICAgICdjYXAnOiA4NzQ1LAogICAgICAnY3VwJzogODc0NiwKICAgICAgJ2ludCc6IDg3NDcsCiAgICAgICd0aGVyZTQnOiA4NzU2LAogICAgICAnc2ltJzogODc2NCwKICAgICAgJ2NvbmcnOiA4NzczLAogICAgICAnYXN5bXAnOiA4Nzc2LAogICAgICAnbmUnOiA4ODAwLAogICAgICAnZXF1aXYnOiA4ODAxLAogICAgICAnbGUnOiA4ODA0LAogICAgICAnZ2UnOiA4ODA1LAogICAgICAnc3ViJzogODgzNCwKICAgICAgJ3N1cCc6IDg4MzUsCiAgICAgICduc3ViJzogODgzNiwKICAgICAgJ3N1YmUnOiA4ODM4LAogICAgICAnc3VwZSc6IDg4MzksCiAgICAgICdvcGx1cyc6IDg4NTMsCiAgICAgICdvdGltZXMnOiA4ODU1LAogICAgICAncGVycCc6IDg4NjksCiAgICAgICdzZG90JzogODkwMSwKICAgICAgJ2xjZWlsJzogODk2OCwKICAgICAgJ3JjZWlsJzogODk2OSwKICAgICAgJ2xmbG9vcic6IDg5NzAsCiAgICAgICdyZmxvb3InOiA4OTcxLAogICAgICAnbGFuZyc6IDkwMDEsCiAgICAgICdyYW5nJzogOTAwMiwKICAgICAgJ2xveic6IDk2NzQsCiAgICAgICdzcGFkZXMnOiA5ODI0LAogICAgICAnY2x1YnMnOiA5ODI3LAogICAgICAnaGVhcnRzJzogOTgyOSwKICAgICAgJ2RpYW1zJzogOTgzMAogICAgfTsKICAgIE9iamVjdC5rZXlzKHNheC5FTlRJVElFUykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBlID0gc2F4LkVOVElUSUVTW2tleV07CiAgICAgIHZhciBzID0gdHlwZW9mIGUgPT09ICdudW1iZXInID8gU3RyaW5nLmZyb21DaGFyQ29kZShlKSA6IGU7CiAgICAgIHNheC5FTlRJVElFU1trZXldID0gczsKICAgIH0pOwoKICAgIGZvciAodmFyIHMgaW4gc2F4LlNUQVRFKSB7CiAgICAgIHNheC5TVEFURVtzYXguU1RBVEVbc11dID0gczsKICAgIH0gLy8gc2hvcnRoYW5kCgoKICAgIFMgPSBzYXguU1RBVEU7CgogICAgZnVuY3Rpb24gZW1pdChwYXJzZXIsIGV2ZW50LCBkYXRhKSB7CiAgICAgIHBhcnNlcltldmVudF0gJiYgcGFyc2VyW2V2ZW50XShkYXRhKTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbWl0Tm9kZShwYXJzZXIsIG5vZGVUeXBlLCBkYXRhKSB7CiAgICAgIGlmIChwYXJzZXIudGV4dE5vZGUpIGNsb3NlVGV4dChwYXJzZXIpOwogICAgICBlbWl0KHBhcnNlciwgbm9kZVR5cGUsIGRhdGEpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsb3NlVGV4dChwYXJzZXIpIHsKICAgICAgcGFyc2VyLnRleHROb2RlID0gdGV4dG9wdHMocGFyc2VyLm9wdCwgcGFyc2VyLnRleHROb2RlKTsKICAgICAgaWYgKHBhcnNlci50ZXh0Tm9kZSkgZW1pdChwYXJzZXIsICdvbnRleHQnLCBwYXJzZXIudGV4dE5vZGUpOwogICAgICBwYXJzZXIudGV4dE5vZGUgPSAnJzsKICAgIH0KCiAgICBmdW5jdGlvbiB0ZXh0b3B0cyhvcHQsIHRleHQpIHsKICAgICAgaWYgKG9wdC50cmltKSB0ZXh0ID0gdGV4dC50cmltKCk7CiAgICAgIGlmIChvcHQubm9ybWFsaXplKSB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9ccysvZywgJyAnKTsKICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CgogICAgZnVuY3Rpb24gZXJyb3IocGFyc2VyLCBlcikgewogICAgICBjbG9zZVRleHQocGFyc2VyKTsKCiAgICAgIGlmIChwYXJzZXIudHJhY2tQb3NpdGlvbikgewogICAgICAgIGVyICs9ICdcbkxpbmU6ICcgKyBwYXJzZXIubGluZSArICdcbkNvbHVtbjogJyArIHBhcnNlci5jb2x1bW4gKyAnXG5DaGFyOiAnICsgcGFyc2VyLmM7CiAgICAgIH0KCiAgICAgIGVyID0gbmV3IEVycm9yKGVyKTsKICAgICAgcGFyc2VyLmVycm9yID0gZXI7CiAgICAgIGVtaXQocGFyc2VyLCAnb25lcnJvcicsIGVyKTsKICAgICAgcmV0dXJuIHBhcnNlcjsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmQocGFyc2VyKSB7CiAgICAgIGlmIChwYXJzZXIuc2F3Um9vdCAmJiAhcGFyc2VyLmNsb3NlZFJvb3QpIHN0cmljdEZhaWwocGFyc2VyLCAnVW5jbG9zZWQgcm9vdCB0YWcnKTsKCiAgICAgIGlmIChwYXJzZXIuc3RhdGUgIT09IFMuQkVHSU4gJiYgcGFyc2VyLnN0YXRlICE9PSBTLkJFR0lOX1dISVRFU1BBQ0UgJiYgcGFyc2VyLnN0YXRlICE9PSBTLlRFWFQpIHsKICAgICAgICBlcnJvcihwYXJzZXIsICdVbmV4cGVjdGVkIGVuZCcpOwogICAgICB9CgogICAgICBjbG9zZVRleHQocGFyc2VyKTsKICAgICAgcGFyc2VyLmMgPSAnJzsKICAgICAgcGFyc2VyLmNsb3NlZCA9IHRydWU7CiAgICAgIGVtaXQocGFyc2VyLCAnb25lbmQnKTsKICAgICAgU0FYUGFyc2VyLmNhbGwocGFyc2VyLCBwYXJzZXIuc3RyaWN0LCBwYXJzZXIub3B0KTsKICAgICAgcmV0dXJuIHBhcnNlcjsKICAgIH0KCiAgICBmdW5jdGlvbiBzdHJpY3RGYWlsKHBhcnNlciwgbWVzc2FnZSkgewogICAgICBpZiAodHlwZW9mIHBhcnNlciAhPT0gJ29iamVjdCcgfHwgIShwYXJzZXIgaW5zdGFuY2VvZiBTQVhQYXJzZXIpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdiYWQgY2FsbCB0byBzdHJpY3RGYWlsJyk7CiAgICAgIH0KCiAgICAgIGlmIChwYXJzZXIuc3RyaWN0KSB7CiAgICAgICAgZXJyb3IocGFyc2VyLCBtZXNzYWdlKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG5ld1RhZyhwYXJzZXIpIHsKICAgICAgaWYgKCFwYXJzZXIuc3RyaWN0KSBwYXJzZXIudGFnTmFtZSA9IHBhcnNlci50YWdOYW1lW3BhcnNlci5sb29zZUNhc2VdKCk7CiAgICAgIHZhciBwYXJlbnQgPSBwYXJzZXIudGFnc1twYXJzZXIudGFncy5sZW5ndGggLSAxXSB8fCBwYXJzZXI7CiAgICAgIHZhciB0YWcgPSBwYXJzZXIudGFnID0gewogICAgICAgIG5hbWU6IHBhcnNlci50YWdOYW1lLAogICAgICAgIGF0dHJpYnV0ZXM6IHt9CiAgICAgIH07IC8vIHdpbGwgYmUgb3ZlcnJpZGRlbiBpZiB0YWcgY29udGFpbHMgYW4geG1sbnM9ImZvbyIgb3IgeG1sbnM6Zm9vPSJiYXIiCgogICAgICBpZiAocGFyc2VyLm9wdC54bWxucykgewogICAgICAgIHRhZy5ucyA9IHBhcmVudC5uczsKICAgICAgfQoKICAgICAgcGFyc2VyLmF0dHJpYkxpc3QubGVuZ3RoID0gMDsKICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25vcGVudGFnc3RhcnQnLCB0YWcpOwogICAgfQoKICAgIGZ1bmN0aW9uIHFuYW1lKG5hbWUsIGF0dHJpYnV0ZSkgewogICAgICB2YXIgaSA9IG5hbWUuaW5kZXhPZignOicpOwogICAgICB2YXIgcXVhbE5hbWUgPSBpIDwgMCA/IFsnJywgbmFtZV0gOiBuYW1lLnNwbGl0KCc6Jyk7CiAgICAgIHZhciBwcmVmaXggPSBxdWFsTmFtZVswXTsKICAgICAgdmFyIGxvY2FsID0gcXVhbE5hbWVbMV07IC8vIDx4ICJ4bWxucyI9Imh0dHA6Ly9mb28iPgoKICAgICAgaWYgKGF0dHJpYnV0ZSAmJiBuYW1lID09PSAneG1sbnMnKSB7CiAgICAgICAgcHJlZml4ID0gJ3htbG5zJzsKICAgICAgICBsb2NhbCA9ICcnOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHByZWZpeDogcHJlZml4LAogICAgICAgIGxvY2FsOiBsb2NhbAogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGF0dHJpYihwYXJzZXIpIHsKICAgICAgaWYgKCFwYXJzZXIuc3RyaWN0KSB7CiAgICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBwYXJzZXIuYXR0cmliTmFtZVtwYXJzZXIubG9vc2VDYXNlXSgpOwogICAgICB9CgogICAgICBpZiAocGFyc2VyLmF0dHJpYkxpc3QuaW5kZXhPZihwYXJzZXIuYXR0cmliTmFtZSkgIT09IC0xIHx8IHBhcnNlci50YWcuYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwYXJzZXIuYXR0cmliTmFtZSkpIHsKICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSA9IHBhcnNlci5hdHRyaWJWYWx1ZSA9ICcnOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMpIHsKICAgICAgICB2YXIgcW4gPSBxbmFtZShwYXJzZXIuYXR0cmliTmFtZSwgdHJ1ZSk7CiAgICAgICAgdmFyIHByZWZpeCA9IHFuLnByZWZpeDsKICAgICAgICB2YXIgbG9jYWwgPSBxbi5sb2NhbDsKCiAgICAgICAgaWYgKHByZWZpeCA9PT0gJ3htbG5zJykgewogICAgICAgICAgLy8gbmFtZXNwYWNlIGJpbmRpbmcgYXR0cmlidXRlLiBwdXNoIHRoZSBiaW5kaW5nIGludG8gc2NvcGUKICAgICAgICAgIGlmIChsb2NhbCA9PT0gJ3htbCcgJiYgcGFyc2VyLmF0dHJpYlZhbHVlICE9PSBYTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAneG1sOiBwcmVmaXggbXVzdCBiZSBib3VuZCB0byAnICsgWE1MX05BTUVTUEFDRSArICdcbicgKyAnQWN0dWFsOiAnICsgcGFyc2VyLmF0dHJpYlZhbHVlKTsKICAgICAgICAgIH0gZWxzZSBpZiAobG9jYWwgPT09ICd4bWxucycgJiYgcGFyc2VyLmF0dHJpYlZhbHVlICE9PSBYTUxOU19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICd4bWxuczogcHJlZml4IG11c3QgYmUgYm91bmQgdG8gJyArIFhNTE5TX05BTUVTUEFDRSArICdcbicgKyAnQWN0dWFsOiAnICsgcGFyc2VyLmF0dHJpYlZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB0YWcgPSBwYXJzZXIudGFnOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyc2VyLnRhZ3NbcGFyc2VyLnRhZ3MubGVuZ3RoIC0gMV0gfHwgcGFyc2VyOwoKICAgICAgICAgICAgaWYgKHRhZy5ucyA9PT0gcGFyZW50Lm5zKSB7CiAgICAgICAgICAgICAgdGFnLm5zID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQubnMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0YWcubnNbbG9jYWxdID0gcGFyc2VyLmF0dHJpYlZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0gLy8gZGVmZXIgb25hdHRyaWJ1dGUgZXZlbnRzIHVudGlsIGFsbCBhdHRyaWJ1dGVzIGhhdmUgYmVlbiBzZWVuCiAgICAgICAgLy8gc28gYW55IG5ldyBiaW5kaW5ncyBjYW4gdGFrZSBlZmZlY3QuIHByZXNlcnZlIGF0dHJpYnV0ZSBvcmRlcgogICAgICAgIC8vIHNvIGRlZmVycmVkIGV2ZW50cyBjYW4gYmUgZW1pdHRlZCBpbiBkb2N1bWVudCBvcmRlcgoKCiAgICAgICAgcGFyc2VyLmF0dHJpYkxpc3QucHVzaChbcGFyc2VyLmF0dHJpYk5hbWUsIHBhcnNlci5hdHRyaWJWYWx1ZV0pOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGluIG5vbi14bWxucyBtb2RlLCB3ZSBjYW4gZW1pdCB0aGUgZXZlbnQgcmlnaHQgYXdheQogICAgICAgIHBhcnNlci50YWcuYXR0cmlidXRlc1twYXJzZXIuYXR0cmliTmFtZV0gPSBwYXJzZXIuYXR0cmliVmFsdWU7CiAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25hdHRyaWJ1dGUnLCB7CiAgICAgICAgICBuYW1lOiBwYXJzZXIuYXR0cmliTmFtZSwKICAgICAgICAgIHZhbHVlOiBwYXJzZXIuYXR0cmliVmFsdWUKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBwYXJzZXIuYXR0cmliVmFsdWUgPSAnJzsKICAgIH0KCiAgICBmdW5jdGlvbiBvcGVuVGFnKHBhcnNlciwgc2VsZkNsb3NpbmcpIHsKICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMpIHsKICAgICAgICAvLyBlbWl0IG5hbWVzcGFjZSBiaW5kaW5nIGV2ZW50cwogICAgICAgIHZhciB0YWcgPSBwYXJzZXIudGFnOyAvLyBhZGQgbmFtZXNwYWNlIGluZm8gdG8gdGFnCgogICAgICAgIHZhciBxbiA9IHFuYW1lKHBhcnNlci50YWdOYW1lKTsKICAgICAgICB0YWcucHJlZml4ID0gcW4ucHJlZml4OwogICAgICAgIHRhZy5sb2NhbCA9IHFuLmxvY2FsOwogICAgICAgIHRhZy51cmkgPSB0YWcubnNbcW4ucHJlZml4XSB8fCAnJzsKCiAgICAgICAgaWYgKHRhZy5wcmVmaXggJiYgIXRhZy51cmkpIHsKICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5ib3VuZCBuYW1lc3BhY2UgcHJlZml4OiAnICsgSlNPTi5zdHJpbmdpZnkocGFyc2VyLnRhZ05hbWUpKTsKICAgICAgICAgIHRhZy51cmkgPSBxbi5wcmVmaXg7CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyZW50ID0gcGFyc2VyLnRhZ3NbcGFyc2VyLnRhZ3MubGVuZ3RoIC0gMV0gfHwgcGFyc2VyOwoKICAgICAgICBpZiAodGFnLm5zICYmIHBhcmVudC5ucyAhPT0gdGFnLm5zKSB7CiAgICAgICAgICBPYmplY3Qua2V5cyh0YWcubnMpLmZvckVhY2goZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25vcGVubmFtZXNwYWNlJywgewogICAgICAgICAgICAgIHByZWZpeDogcCwKICAgICAgICAgICAgICB1cmk6IHRhZy5uc1twXQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0gLy8gaGFuZGxlIGRlZmVycmVkIG9uYXR0cmlidXRlIGV2ZW50cwogICAgICAgIC8vIE5vdGU6IGRvIG5vdCBhcHBseSBkZWZhdWx0IG5zIHRvIGF0dHJpYnV0ZXM6CiAgICAgICAgLy8gICBodHRwOi8vd3d3LnczLm9yZy9UUi9SRUMteG1sLW5hbWVzLyNkZWZhdWx0aW5nCgoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHBhcnNlci5hdHRyaWJMaXN0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdmFyIG52ID0gcGFyc2VyLmF0dHJpYkxpc3RbaV07CiAgICAgICAgICB2YXIgbmFtZSA9IG52WzBdOwogICAgICAgICAgdmFyIHZhbHVlID0gbnZbMV07CiAgICAgICAgICB2YXIgcXVhbE5hbWUgPSBxbmFtZShuYW1lLCB0cnVlKTsKICAgICAgICAgIHZhciBwcmVmaXggPSBxdWFsTmFtZS5wcmVmaXg7CiAgICAgICAgICB2YXIgbG9jYWwgPSBxdWFsTmFtZS5sb2NhbDsKICAgICAgICAgIHZhciB1cmkgPSBwcmVmaXggPT09ICcnID8gJycgOiB0YWcubnNbcHJlZml4XSB8fCAnJzsKICAgICAgICAgIHZhciBhID0gewogICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgIHByZWZpeDogcHJlZml4LAogICAgICAgICAgICBsb2NhbDogbG9jYWwsCiAgICAgICAgICAgIHVyaTogdXJpCiAgICAgICAgICB9OyAvLyBpZiB0aGVyZSdzIGFueSBhdHRyaWJ1dGVzIHdpdGggYW4gdW5kZWZpbmVkIG5hbWVzcGFjZSwKICAgICAgICAgIC8vIHRoZW4gZmFpbCBvbiB0aGVtIG5vdy4KCiAgICAgICAgICBpZiAocHJlZml4ICYmIHByZWZpeCAhPT0gJ3htbG5zJyAmJiAhdXJpKSB7CiAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5ib3VuZCBuYW1lc3BhY2UgcHJlZml4OiAnICsgSlNPTi5zdHJpbmdpZnkocHJlZml4KSk7CiAgICAgICAgICAgIGEudXJpID0gcHJlZml4OwogICAgICAgICAgfQoKICAgICAgICAgIHBhcnNlci50YWcuYXR0cmlidXRlc1tuYW1lXSA9IGE7CiAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmF0dHJpYnV0ZScsIGEpOwogICAgICAgIH0KCiAgICAgICAgcGFyc2VyLmF0dHJpYkxpc3QubGVuZ3RoID0gMDsKICAgICAgfQoKICAgICAgcGFyc2VyLnRhZy5pc1NlbGZDbG9zaW5nID0gISFzZWxmQ2xvc2luZzsgLy8gcHJvY2VzcyB0aGUgdGFnCgogICAgICBwYXJzZXIuc2F3Um9vdCA9IHRydWU7CiAgICAgIHBhcnNlci50YWdzLnB1c2gocGFyc2VyLnRhZyk7CiAgICAgIGVtaXROb2RlKHBhcnNlciwgJ29ub3BlbnRhZycsIHBhcnNlci50YWcpOwoKICAgICAgaWYgKCFzZWxmQ2xvc2luZykgewogICAgICAgIC8vIHNwZWNpYWwgY2FzZSBmb3IgPHNjcmlwdD4gaW4gbm9uLXN0cmljdCBtb2RlLgogICAgICAgIGlmICghcGFyc2VyLm5vc2NyaXB0ICYmIHBhcnNlci50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzY3JpcHQnKSB7CiAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNDUklQVDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgIH0KCiAgICAgICAgcGFyc2VyLnRhZyA9IG51bGw7CiAgICAgICAgcGFyc2VyLnRhZ05hbWUgPSAnJzsKICAgICAgfQoKICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBwYXJzZXIuYXR0cmliVmFsdWUgPSAnJzsKICAgICAgcGFyc2VyLmF0dHJpYkxpc3QubGVuZ3RoID0gMDsKICAgIH0KCiAgICBmdW5jdGlvbiBjbG9zZVRhZyhwYXJzZXIpIHsKICAgICAgaWYgKCFwYXJzZXIudGFnTmFtZSkgewogICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnV2VpcmQgZW1wdHkgY2xvc2UgdGFnLicpOwogICAgICAgIHBhcnNlci50ZXh0Tm9kZSArPSAnPC8+JzsKICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFQ7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAocGFyc2VyLnNjcmlwdCkgewogICAgICAgIGlmIChwYXJzZXIudGFnTmFtZSAhPT0gJ3NjcmlwdCcpIHsKICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gJzwvJyArIHBhcnNlci50YWdOYW1lICsgJz4nOwogICAgICAgICAgcGFyc2VyLnRhZ05hbWUgPSAnJzsKICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuU0NSSVBUOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25zY3JpcHQnLCBwYXJzZXIuc2NyaXB0KTsKICAgICAgICBwYXJzZXIuc2NyaXB0ID0gJyc7CiAgICAgIH0gLy8gZmlyc3QgbWFrZSBzdXJlIHRoYXQgdGhlIGNsb3NpbmcgdGFnIGFjdHVhbGx5IGV4aXN0cy4KICAgICAgLy8gPGE+PGI+PC9jPjwvYj48L2E+IHdpbGwgY2xvc2UgZXZlcnl0aGluZywgb3RoZXJ3aXNlLgoKCiAgICAgIHZhciB0ID0gcGFyc2VyLnRhZ3MubGVuZ3RoOwogICAgICB2YXIgdGFnTmFtZSA9IHBhcnNlci50YWdOYW1lOwoKICAgICAgaWYgKCFwYXJzZXIuc3RyaWN0KSB7CiAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWVbcGFyc2VyLmxvb3NlQ2FzZV0oKTsKICAgICAgfQoKICAgICAgdmFyIGNsb3NlVG8gPSB0YWdOYW1lOwoKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHZhciBjbG9zZSA9IHBhcnNlci50YWdzW3RdOwoKICAgICAgICBpZiAoY2xvc2UubmFtZSAhPT0gY2xvc2VUbykgewogICAgICAgICAgLy8gZmFpbCB0aGUgZmlyc3QgdGltZSBpbiBzdHJpY3QgbW9kZQogICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdVbmV4cGVjdGVkIGNsb3NlIHRhZycpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gLy8gZGlkbid0IGZpbmQgaXQuICB3ZSBhbHJlYWR5IGZhaWxlZCBmb3Igc3RyaWN0LCBzbyBqdXN0IGFib3J0LgoKCiAgICAgIGlmICh0IDwgMCkgewogICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5tYXRjaGVkIGNsb3NpbmcgdGFnOiAnICsgcGFyc2VyLnRhZ05hbWUpOwogICAgICAgIHBhcnNlci50ZXh0Tm9kZSArPSAnPC8nICsgcGFyc2VyLnRhZ05hbWUgKyAnPic7CiAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcGFyc2VyLnRhZ05hbWUgPSB0YWdOYW1lOwogICAgICB2YXIgcyA9IHBhcnNlci50YWdzLmxlbmd0aDsKCiAgICAgIHdoaWxlIChzLS0gPiB0KSB7CiAgICAgICAgdmFyIHRhZyA9IHBhcnNlci50YWcgPSBwYXJzZXIudGFncy5wb3AoKTsKICAgICAgICBwYXJzZXIudGFnTmFtZSA9IHBhcnNlci50YWcubmFtZTsKICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmNsb3NldGFnJywgcGFyc2VyLnRhZ05hbWUpOwogICAgICAgIHZhciB4ID0ge307CgogICAgICAgIGZvciAodmFyIGkgaW4gdGFnLm5zKSB7CiAgICAgICAgICB4W2ldID0gdGFnLm5zW2ldOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBhcmVudCA9IHBhcnNlci50YWdzW3BhcnNlci50YWdzLmxlbmd0aCAtIDFdIHx8IHBhcnNlcjsKCiAgICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMgJiYgdGFnLm5zICE9PSBwYXJlbnQubnMpIHsKICAgICAgICAgIC8vIHJlbW92ZSBuYW1lc3BhY2UgYmluZGluZ3MgaW50cm9kdWNlZCBieSB0YWcKICAgICAgICAgIE9iamVjdC5rZXlzKHRhZy5ucykuZm9yRWFjaChmdW5jdGlvbiAocCkgewogICAgICAgICAgICB2YXIgbiA9IHRhZy5uc1twXTsKICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jbG9zZW5hbWVzcGFjZScsIHsKICAgICAgICAgICAgICBwcmVmaXg6IHAsCiAgICAgICAgICAgICAgdXJpOiBuCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodCA9PT0gMCkgcGFyc2VyLmNsb3NlZFJvb3QgPSB0cnVlOwogICAgICBwYXJzZXIudGFnTmFtZSA9IHBhcnNlci5hdHRyaWJWYWx1ZSA9IHBhcnNlci5hdHRyaWJOYW1lID0gJyc7CiAgICAgIHBhcnNlci5hdHRyaWJMaXN0Lmxlbmd0aCA9IDA7CiAgICAgIHBhcnNlci5zdGF0ZSA9IFMuVEVYVDsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZUVudGl0eShwYXJzZXIpIHsKICAgICAgdmFyIGVudGl0eSA9IHBhcnNlci5lbnRpdHk7CiAgICAgIHZhciBlbnRpdHlMQyA9IGVudGl0eS50b0xvd2VyQ2FzZSgpOwogICAgICB2YXIgbnVtOwogICAgICB2YXIgbnVtU3RyID0gJyc7CgogICAgICBpZiAocGFyc2VyLkVOVElUSUVTW2VudGl0eV0pIHsKICAgICAgICByZXR1cm4gcGFyc2VyLkVOVElUSUVTW2VudGl0eV07CiAgICAgIH0KCiAgICAgIGlmIChwYXJzZXIuRU5USVRJRVNbZW50aXR5TENdKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlci5FTlRJVElFU1tlbnRpdHlMQ107CiAgICAgIH0KCiAgICAgIGVudGl0eSA9IGVudGl0eUxDOwoKICAgICAgaWYgKGVudGl0eS5jaGFyQXQoMCkgPT09ICcjJykgewogICAgICAgIGlmIChlbnRpdHkuY2hhckF0KDEpID09PSAneCcpIHsKICAgICAgICAgIGVudGl0eSA9IGVudGl0eS5zbGljZSgyKTsKICAgICAgICAgIG51bSA9IHBhcnNlSW50KGVudGl0eSwgMTYpOwogICAgICAgICAgbnVtU3RyID0gbnVtLnRvU3RyaW5nKDE2KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZW50aXR5ID0gZW50aXR5LnNsaWNlKDEpOwogICAgICAgICAgbnVtID0gcGFyc2VJbnQoZW50aXR5LCAxMCk7CiAgICAgICAgICBudW1TdHIgPSBudW0udG9TdHJpbmcoMTApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZW50aXR5ID0gZW50aXR5LnJlcGxhY2UoL14wKy8sICcnKTsKCiAgICAgIGlmIChpc05hTihudW0pIHx8IG51bVN0ci50b0xvd2VyQ2FzZSgpICE9PSBlbnRpdHkpIHsKICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ0ludmFsaWQgY2hhcmFjdGVyIGVudGl0eScpOwogICAgICAgIHJldHVybiAnJicgKyBwYXJzZXIuZW50aXR5ICsgJzsnOwogICAgICB9CgogICAgICByZXR1cm4gU3RyaW5nLmZyb21Db2RlUG9pbnQobnVtKTsKICAgIH0KCiAgICBmdW5jdGlvbiBiZWdpbldoaXRlU3BhY2UocGFyc2VyLCBjKSB7CiAgICAgIGlmIChjID09PSAnPCcpIHsKICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLk9QRU5fV0FLQTsKICAgICAgICBwYXJzZXIuc3RhcnRUYWdQb3NpdGlvbiA9IHBhcnNlci5wb3NpdGlvbjsKICAgICAgfSBlbHNlIGlmICghaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgLy8gaGF2ZSB0byBwcm9jZXNzIHRoaXMgYXMgYSB0ZXh0IG5vZGUuCiAgICAgICAgLy8gd2VpcmQsIGJ1dCBoYXBwZW5zLgogICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnTm9uLXdoaXRlc3BhY2UgYmVmb3JlIGZpcnN0IHRhZy4nKTsKICAgICAgICBwYXJzZXIudGV4dE5vZGUgPSBjOwogICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuVEVYVDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNoYXJBdChjaHVuaywgaSkgewogICAgICB2YXIgcmVzdWx0ID0gJyc7CgogICAgICBpZiAoaSA8IGNodW5rLmxlbmd0aCkgewogICAgICAgIHJlc3VsdCA9IGNodW5rLmNoYXJBdChpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiB3cml0ZShjaHVuaykgewogICAgICB2YXIgcGFyc2VyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLmVycm9yKSB7CiAgICAgICAgdGhyb3cgdGhpcy5lcnJvcjsKICAgICAgfQoKICAgICAgaWYgKHBhcnNlci5jbG9zZWQpIHsKICAgICAgICByZXR1cm4gZXJyb3IocGFyc2VyLCAnQ2Fubm90IHdyaXRlIGFmdGVyIGNsb3NlLiBBc3NpZ24gYW4gb25yZWFkeSBoYW5kbGVyLicpOwogICAgICB9CgogICAgICBpZiAoY2h1bmsgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5kKHBhcnNlcik7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdvYmplY3QnKSB7CiAgICAgICAgY2h1bmsgPSBjaHVuay50b1N0cmluZygpOwogICAgICB9CgogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBjID0gJyc7CgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGMgPSBjaGFyQXQoY2h1bmssIGkrKyk7CiAgICAgICAgcGFyc2VyLmMgPSBjOwoKICAgICAgICBpZiAoIWMpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgaWYgKHBhcnNlci50cmFja1Bvc2l0aW9uKSB7CiAgICAgICAgICBwYXJzZXIucG9zaXRpb24rKzsKCiAgICAgICAgICBpZiAoYyA9PT0gJ1xuJykgewogICAgICAgICAgICBwYXJzZXIubGluZSsrOwogICAgICAgICAgICBwYXJzZXIuY29sdW1uID0gMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcnNlci5jb2x1bW4rKzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN3aXRjaCAocGFyc2VyLnN0YXRlKSB7CiAgICAgICAgICBjYXNlIFMuQkVHSU46CiAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQkVHSU5fV0hJVEVTUEFDRTsKCiAgICAgICAgICAgIGlmIChjID09PSAnXHVGRUZGJykgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBiZWdpbldoaXRlU3BhY2UocGFyc2VyLCBjKTsKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkJFR0lOX1dISVRFU1BBQ0U6CiAgICAgICAgICAgIGJlZ2luV2hpdGVTcGFjZShwYXJzZXIsIGMpOwogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuVEVYVDoKICAgICAgICAgICAgaWYgKHBhcnNlci5zYXdSb290ICYmICFwYXJzZXIuY2xvc2VkUm9vdCkgewogICAgICAgICAgICAgIHZhciBzdGFydGkgPSBpIC0gMTsKCiAgICAgICAgICAgICAgd2hpbGUgKGMgJiYgYyAhPT0gJzwnICYmIGMgIT09ICcmJykgewogICAgICAgICAgICAgICAgYyA9IGNoYXJBdChjaHVuaywgaSsrKTsKCiAgICAgICAgICAgICAgICBpZiAoYyAmJiBwYXJzZXIudHJhY2tQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICBwYXJzZXIucG9zaXRpb24rKzsKCiAgICAgICAgICAgICAgICAgIGlmIChjID09PSAnXG4nKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VyLmxpbmUrKzsKICAgICAgICAgICAgICAgICAgICBwYXJzZXIuY29sdW1uID0gMDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwYXJzZXIuY29sdW1uKys7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHBhcnNlci50ZXh0Tm9kZSArPSBjaHVuay5zdWJzdHJpbmcoc3RhcnRpLCBpIC0gMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjID09PSAnPCcgJiYgIShwYXJzZXIuc2F3Um9vdCAmJiBwYXJzZXIuY2xvc2VkUm9vdCAmJiAhcGFyc2VyLnN0cmljdCkpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLk9QRU5fV0FLQTsKICAgICAgICAgICAgICBwYXJzZXIuc3RhcnRUYWdQb3NpdGlvbiA9IHBhcnNlci5wb3NpdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWlzV2hpdGVzcGFjZShjKSAmJiAoIXBhcnNlci5zYXdSb290IHx8IHBhcnNlci5jbG9zZWRSb290KSkgewogICAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdUZXh0IGRhdGEgb3V0c2lkZSBvZiByb290IG5vZGUuJyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoYyA9PT0gJyYnKSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFRfRU5USVRZOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJzZXIudGV4dE5vZGUgKz0gYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5TQ1JJUFQ6CiAgICAgICAgICAgIC8vIG9ubHkgbm9uLXN0cmljdAogICAgICAgICAgICBpZiAoYyA9PT0gJzwnKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5TQ1JJUFRfRU5ESU5HOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gYzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLlNDUklQVF9FTkRJTkc6CiAgICAgICAgICAgIGlmIChjID09PSAnLycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNMT1NFX1RBRzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuc2NyaXB0ICs9ICc8JyArIGM7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5TQ1JJUFQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5PUEVOX1dBS0E6CiAgICAgICAgICAgIC8vIGVpdGhlciBhIC8sID8sICEsIG9yIHRleHQgaXMgY29taW5nIG5leHQuCiAgICAgICAgICAgIGlmIChjID09PSAnIScpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNHTUxfREVDTDsKICAgICAgICAgICAgICBwYXJzZXIuc2dtbERlY2wgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1doaXRlc3BhY2UoYykpIDsgZWxzZSBpZiAoaXNNYXRjaChuYW1lU3RhcnQsIGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5PUEVOX1RBRzsKICAgICAgICAgICAgICBwYXJzZXIudGFnTmFtZSA9IGM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gJy8nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DTE9TRV9UQUc7CiAgICAgICAgICAgICAgcGFyc2VyLnRhZ05hbWUgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSAnPycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlBST0NfSU5TVDsKICAgICAgICAgICAgICBwYXJzZXIucHJvY0luc3ROYW1lID0gcGFyc2VyLnByb2NJbnN0Qm9keSA9ICcnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5lbmNvZGVkIDwnKTsgLy8gaWYgdGhlcmUgd2FzIHNvbWUgd2hpdGVzcGFjZSwgdGhlbiBhZGQgdGhhdCBpbi4KCiAgICAgICAgICAgICAgaWYgKHBhcnNlci5zdGFydFRhZ1Bvc2l0aW9uICsgMSA8IHBhcnNlci5wb3NpdGlvbikgewogICAgICAgICAgICAgICAgdmFyIHBhZCA9IHBhcnNlci5wb3NpdGlvbiAtIHBhcnNlci5zdGFydFRhZ1Bvc2l0aW9uOwogICAgICAgICAgICAgICAgYyA9IG5ldyBBcnJheShwYWQpLmpvaW4oJyAnKSArIGM7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwYXJzZXIudGV4dE5vZGUgKz0gJzwnICsgYzsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5TR01MX0RFQ0w6CiAgICAgICAgICAgIGlmICgocGFyc2VyLnNnbWxEZWNsICsgYykudG9VcHBlckNhc2UoKSA9PT0gQ0RBVEEpIHsKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbm9wZW5jZGF0YScpOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ0RBVEE7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhID0gJyc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocGFyc2VyLnNnbWxEZWNsICsgYyA9PT0gJy0tJykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ09NTUVOVDsKICAgICAgICAgICAgICBwYXJzZXIuY29tbWVudCA9ICcnOwogICAgICAgICAgICAgIHBhcnNlci5zZ21sRGVjbCA9ICcnOwogICAgICAgICAgICB9IGVsc2UgaWYgKChwYXJzZXIuc2dtbERlY2wgKyBjKS50b1VwcGVyQ2FzZSgpID09PSBET0NUWVBFKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFOwoKICAgICAgICAgICAgICBpZiAocGFyc2VyLmRvY3R5cGUgfHwgcGFyc2VyLnNhd1Jvb3QpIHsKICAgICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW5hcHByb3ByaWF0ZWx5IGxvY2F0ZWQgZG9jdHlwZSBkZWNsYXJhdGlvbicpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcGFyc2VyLmRvY3R5cGUgPSAnJzsKICAgICAgICAgICAgICBwYXJzZXIuc2dtbERlY2wgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbnNnbWxkZWNsYXJhdGlvbicsIHBhcnNlci5zZ21sRGVjbCk7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUXVvdGUoYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNHTUxfREVDTF9RVU9URUQ7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5TR01MX0RFQ0xfUVVPVEVEOgogICAgICAgICAgICBpZiAoYyA9PT0gcGFyc2VyLnEpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNHTUxfREVDTDsKICAgICAgICAgICAgICBwYXJzZXIucSA9ICcnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwYXJzZXIuc2dtbERlY2wgKz0gYzsKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkRPQ1RZUEU6CiAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFQ7CiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25kb2N0eXBlJywgcGFyc2VyLmRvY3R5cGUpOwogICAgICAgICAgICAgIHBhcnNlci5kb2N0eXBlID0gdHJ1ZTsgLy8ganVzdCByZW1lbWJlciB0aGF0IHdlIHNhdyBpdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuZG9jdHlwZSArPSBjOwoKICAgICAgICAgICAgICBpZiAoYyA9PT0gJ1snKSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkRPQ1RZUEVfRFREOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNRdW90ZShjKSkgewogICAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFX1FVT1RFRDsKICAgICAgICAgICAgICAgIHBhcnNlci5xID0gYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5ET0NUWVBFX1FVT1RFRDoKICAgICAgICAgICAgcGFyc2VyLmRvY3R5cGUgKz0gYzsKCiAgICAgICAgICAgIGlmIChjID09PSBwYXJzZXIucSkgewogICAgICAgICAgICAgIHBhcnNlci5xID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuRE9DVFlQRV9EVEQ6CiAgICAgICAgICAgIHBhcnNlci5kb2N0eXBlICs9IGM7CgogICAgICAgICAgICBpZiAoYyA9PT0gJ10nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUXVvdGUoYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkRPQ1RZUEVfRFREX1FVT1RFRDsKICAgICAgICAgICAgICBwYXJzZXIucSA9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5ET0NUWVBFX0RURF9RVU9URUQ6CiAgICAgICAgICAgIHBhcnNlci5kb2N0eXBlICs9IGM7CgogICAgICAgICAgICBpZiAoYyA9PT0gcGFyc2VyLnEpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkRPQ1RZUEVfRFREOwogICAgICAgICAgICAgIHBhcnNlci5xID0gJyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DT01NRU5UOgogICAgICAgICAgICBpZiAoYyA9PT0gJy0nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DT01NRU5UX0VORElORzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuY29tbWVudCArPSBjOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuQ09NTUVOVF9FTkRJTkc6CiAgICAgICAgICAgIGlmIChjID09PSAnLScpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNPTU1FTlRfRU5ERUQ7CiAgICAgICAgICAgICAgcGFyc2VyLmNvbW1lbnQgPSB0ZXh0b3B0cyhwYXJzZXIub3B0LCBwYXJzZXIuY29tbWVudCk7CgogICAgICAgICAgICAgIGlmIChwYXJzZXIuY29tbWVudCkgewogICAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jb21tZW50JywgcGFyc2VyLmNvbW1lbnQpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcGFyc2VyLmNvbW1lbnQgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuY29tbWVudCArPSAnLScgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ09NTUVOVDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkNPTU1FTlRfRU5ERUQ6CiAgICAgICAgICAgIGlmIChjICE9PSAnPicpIHsKICAgICAgICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ01hbGZvcm1lZCBjb21tZW50Jyk7IC8vIGFsbG93IDwhLS0gYmxhaCAtLSBibG9vIC0tPiBpbiBub24tc3RyaWN0IG1vZGUsCiAgICAgICAgICAgICAgLy8gd2hpY2ggaXMgYSBjb21tZW50IG9mICIgYmxhaCAtLSBibG9vICIKCiAgICAgICAgICAgICAgcGFyc2VyLmNvbW1lbnQgKz0gJy0tJyArIGM7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DT01NRU5UOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuVEVYVDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkNEQVRBOgogICAgICAgICAgICBpZiAoYyA9PT0gJ10nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DREFUQV9FTkRJTkc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DREFUQV9FTkRJTkc6CiAgICAgICAgICAgIGlmIChjID09PSAnXScpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNEQVRBX0VORElOR18yOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5jZGF0YSArPSAnXScgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ0RBVEE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DREFUQV9FTkRJTkdfMjoKICAgICAgICAgICAgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgIGlmIChwYXJzZXIuY2RhdGEpIHsKICAgICAgICAgICAgICAgIGVtaXROb2RlKHBhcnNlciwgJ29uY2RhdGEnLCBwYXJzZXIuY2RhdGEpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jbG9zZWNkYXRhJyk7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICddJykgewogICAgICAgICAgICAgIHBhcnNlci5jZGF0YSArPSAnXSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhICs9ICddXScgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ0RBVEE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5QUk9DX0lOU1Q6CiAgICAgICAgICAgIGlmIChjID09PSAnPycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlBST0NfSU5TVF9FTkRJTkc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5QUk9DX0lOU1RfQk9EWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIucHJvY0luc3ROYW1lICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5QUk9DX0lOU1RfQk9EWToKICAgICAgICAgICAgaWYgKCFwYXJzZXIucHJvY0luc3RCb2R5ICYmIGlzV2hpdGVzcGFjZShjKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICc/JykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuUFJPQ19JTlNUX0VORElORzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIucHJvY0luc3RCb2R5ICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5QUk9DX0lOU1RfRU5ESU5HOgogICAgICAgICAgICBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24nLCB7CiAgICAgICAgICAgICAgICBuYW1lOiBwYXJzZXIucHJvY0luc3ROYW1lLAogICAgICAgICAgICAgICAgYm9keTogcGFyc2VyLnByb2NJbnN0Qm9keQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBhcnNlci5wcm9jSW5zdE5hbWUgPSBwYXJzZXIucHJvY0luc3RCb2R5ID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5wcm9jSW5zdEJvZHkgKz0gJz8nICsgYzsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlBST0NfSU5TVF9CT0RZOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuT1BFTl9UQUc6CiAgICAgICAgICAgIGlmIChpc01hdGNoKG5hbWVCb2R5LCBjKSkgewogICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3VGFnKHBhcnNlcik7CgogICAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICAgIG9wZW5UYWcocGFyc2VyKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICcvJykgewogICAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5PUEVOX1RBR19TTEFTSDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpc1doaXRlc3BhY2UoYykpIHsKICAgICAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIGNoYXJhY3RlciBpbiB0YWcgbmFtZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLk9QRU5fVEFHX1NMQVNIOgogICAgICAgICAgICBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgb3BlblRhZyhwYXJzZXIsIHRydWUpOwogICAgICAgICAgICAgIGNsb3NlVGFnKHBhcnNlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdGb3J3YXJkLXNsYXNoIGluIG9wZW5pbmcgdGFnIG5vdCBmb2xsb3dlZCBieSA+Jyk7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5BVFRSSUI6CiAgICAgICAgICAgIC8vIGhhdmVuJ3QgcmVhZCB0aGUgYXR0cmlidXRlIG5hbWUgeWV0LgogICAgICAgICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgb3BlblRhZyhwYXJzZXIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICcvJykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuT1BFTl9UQUdfU0xBU0g7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChuYW1lU3RhcnQsIGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBjOwogICAgICAgICAgICAgIHBhcnNlci5hdHRyaWJWYWx1ZSA9ICcnOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX05BTUU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5BVFRSSUJfTkFNRToKICAgICAgICAgICAgaWYgKGMgPT09ICc9JykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX1ZBTFVFOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnQXR0cmlidXRlIHdpdGhvdXQgdmFsdWUnKTsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgPSBwYXJzZXIuYXR0cmliTmFtZTsKICAgICAgICAgICAgICBhdHRyaWIocGFyc2VyKTsKICAgICAgICAgICAgICBvcGVuVGFnKHBhcnNlcik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfTkFNRV9TQVdfV0hJVEU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChuYW1lQm9keSwgYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSArPSBjOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW52YWxpZCBhdHRyaWJ1dGUgbmFtZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuQVRUUklCX05BTUVfU0FXX1dISVRFOgogICAgICAgICAgICBpZiAoYyA9PT0gJz0nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdBdHRyaWJ1dGUgd2l0aG91dCB2YWx1ZScpOwogICAgICAgICAgICAgIHBhcnNlci50YWcuYXR0cmlidXRlc1twYXJzZXIuYXR0cmliTmFtZV0gPSAnJzsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgPSAnJzsKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmF0dHJpYnV0ZScsIHsKICAgICAgICAgICAgICAgIG5hbWU6IHBhcnNlci5hdHRyaWJOYW1lLAogICAgICAgICAgICAgICAgdmFsdWU6ICcnCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSAnJzsKCiAgICAgICAgICAgICAgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgICAgb3BlblRhZyhwYXJzZXIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChuYW1lU3RhcnQsIGMpKSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSA9IGM7CiAgICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkFUVFJJQl9OQU1FOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ0ludmFsaWQgYXR0cmlidXRlIG5hbWUnKTsKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkFUVFJJQl9WQUxVRToKICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUXVvdGUoYykpIHsKICAgICAgICAgICAgICBwYXJzZXIucSA9IGM7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUVfUVVPVEVEOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlJyk7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUVfVU5RVU9URUQ7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYlZhbHVlID0gYzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkFUVFJJQl9WQUxVRV9RVU9URUQ6CiAgICAgICAgICAgIGlmIChjICE9PSBwYXJzZXIucSkgewogICAgICAgICAgICAgIGlmIChjID09PSAnJicpIHsKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX1ZBTFVFX0VOVElUWV9ROwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgKz0gYzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhdHRyaWIocGFyc2VyKTsKICAgICAgICAgICAgcGFyc2VyLnEgPSAnJzsKICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUVfQ0xPU0VEOwogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuQVRUUklCX1ZBTFVFX0NMT1NFRDoKICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjKSkgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgIG9wZW5UYWcocGFyc2VyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSAnLycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLk9QRU5fVEFHX1NMQVNIOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzTWF0Y2gobmFtZVN0YXJ0LCBjKSkgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnTm8gd2hpdGVzcGFjZSBiZXR3ZWVuIGF0dHJpYnV0ZXMnKTsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSA9IGM7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYlZhbHVlID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfTkFNRTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ0ludmFsaWQgYXR0cmlidXRlIG5hbWUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkFUVFJJQl9WQUxVRV9VTlFVT1RFRDoKICAgICAgICAgICAgaWYgKCFpc0F0dHJpYkVuZChjKSkgewogICAgICAgICAgICAgIGlmIChjID09PSAnJicpIHsKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX1ZBTFVFX0VOVElUWV9VOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgKz0gYzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhdHRyaWIocGFyc2VyKTsKCiAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBvcGVuVGFnKHBhcnNlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DTE9TRV9UQUc6CiAgICAgICAgICAgIGlmICghcGFyc2VyLnRhZ05hbWUpIHsKICAgICAgICAgICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vdE1hdGNoKG5hbWVTdGFydCwgYykpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJzZXIuc2NyaXB0KSB7CiAgICAgICAgICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gJzwvJyArIGM7CiAgICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuU0NSSVBUOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIHRhZ25hbWUgaW4gY2xvc2luZyB0YWcuJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lID0gYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgY2xvc2VUYWcocGFyc2VyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc01hdGNoKG5hbWVCb2R5LCBjKSkgewogICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocGFyc2VyLnNjcmlwdCkgewogICAgICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gJzwvJyArIHBhcnNlci50YWdOYW1lOwogICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5TQ1JJUFQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpc1doaXRlc3BhY2UoYykpIHsKICAgICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW52YWxpZCB0YWduYW1lIGluIGNsb3NpbmcgdGFnJyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNMT1NFX1RBR19TQVdfV0hJVEU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DTE9TRV9UQUdfU0FXX1dISVRFOgogICAgICAgICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBjbG9zZVRhZyhwYXJzZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW52YWxpZCBjaGFyYWN0ZXJzIGluIGNsb3NpbmcgdGFnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5URVhUX0VOVElUWToKICAgICAgICAgIGNhc2UgUy5BVFRSSUJfVkFMVUVfRU5USVRZX1E6CiAgICAgICAgICBjYXNlIFMuQVRUUklCX1ZBTFVFX0VOVElUWV9VOgogICAgICAgICAgICB2YXIgcmV0dXJuU3RhdGU7CiAgICAgICAgICAgIHZhciBidWZmZXI7CgogICAgICAgICAgICBzd2l0Y2ggKHBhcnNlci5zdGF0ZSkgewogICAgICAgICAgICAgIGNhc2UgUy5URVhUX0VOVElUWToKICAgICAgICAgICAgICAgIHJldHVyblN0YXRlID0gUy5URVhUOwogICAgICAgICAgICAgICAgYnVmZmVyID0gJ3RleHROb2RlJzsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIFMuQVRUUklCX1ZBTFVFX0VOVElUWV9ROgogICAgICAgICAgICAgICAgcmV0dXJuU3RhdGUgPSBTLkFUVFJJQl9WQUxVRV9RVU9URUQ7CiAgICAgICAgICAgICAgICBidWZmZXIgPSAnYXR0cmliVmFsdWUnOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgUy5BVFRSSUJfVkFMVUVfRU5USVRZX1U6CiAgICAgICAgICAgICAgICByZXR1cm5TdGF0ZSA9IFMuQVRUUklCX1ZBTFVFX1VOUVVPVEVEOwogICAgICAgICAgICAgICAgYnVmZmVyID0gJ2F0dHJpYlZhbHVlJzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYyA9PT0gJzsnKSB7CiAgICAgICAgICAgICAgcGFyc2VyW2J1ZmZlcl0gKz0gcGFyc2VFbnRpdHkocGFyc2VyKTsKICAgICAgICAgICAgICBwYXJzZXIuZW50aXR5ID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gcmV0dXJuU3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChwYXJzZXIuZW50aXR5Lmxlbmd0aCA/IGVudGl0eUJvZHkgOiBlbnRpdHlTdGFydCwgYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuZW50aXR5ICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIGNoYXJhY3RlciBpbiBlbnRpdHkgbmFtZScpOwogICAgICAgICAgICAgIHBhcnNlcltidWZmZXJdICs9ICcmJyArIHBhcnNlci5lbnRpdHkgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5lbnRpdHkgPSAnJzsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSByZXR1cm5TdGF0ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHBhcnNlciwgJ1Vua25vd24gc3RhdGU6ICcgKyBwYXJzZXIuc3RhdGUpOwogICAgICAgIH0KICAgICAgfSAvLyB3aGlsZQoKCiAgICAgIGlmIChwYXJzZXIucG9zaXRpb24gPj0gcGFyc2VyLmJ1ZmZlckNoZWNrUG9zaXRpb24pIHsKICAgICAgICBjaGVja0J1ZmZlckxlbmd0aChwYXJzZXIpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyc2VyOwogICAgfQogICAgLyohIGh0dHA6Ly9tdGhzLmJlL2Zyb21jb2RlcG9pbnQgdjAuMS4wIGJ5IEBtYXRoaWFzICovCgogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgogICAgaWYgKCFTdHJpbmcuZnJvbUNvZGVQb2ludCkgewogICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzdHJpbmdGcm9tQ2hhckNvZGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlOwogICAgICAgIHZhciBmbG9vciA9IE1hdGguZmxvb3I7CgogICAgICAgIHZhciBmcm9tQ29kZVBvaW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIE1BWF9TSVpFID0gMHg0MDAwOwogICAgICAgICAgdmFyIGNvZGVVbml0cyA9IFtdOwogICAgICAgICAgdmFyIGhpZ2hTdXJyb2dhdGU7CiAgICAgICAgICB2YXIgbG93U3Vycm9nYXRlOwogICAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsKCiAgICAgICAgICBpZiAoIWxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJlc3VsdCA9ICcnOwoKICAgICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBjb2RlUG9pbnQgPSBOdW1iZXIoYXJndW1lbnRzW2luZGV4XSk7CgogICAgICAgICAgICBpZiAoIWlzRmluaXRlKGNvZGVQb2ludCkgfHwgLy8gYE5hTmAsIGArSW5maW5pdHlgLCBvciBgLUluZmluaXR5YAogICAgICAgICAgICBjb2RlUG9pbnQgPCAwIHx8IC8vIG5vdCBhIHZhbGlkIFVuaWNvZGUgY29kZSBwb2ludAogICAgICAgICAgICBjb2RlUG9pbnQgPiAweDEwRkZGRiB8fCAvLyBub3QgYSB2YWxpZCBVbmljb2RlIGNvZGUgcG9pbnQKICAgICAgICAgICAgZmxvb3IoY29kZVBvaW50KSAhPT0gY29kZVBvaW50IC8vIG5vdCBhbiBpbnRlZ2VyCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRocm93IFJhbmdlRXJyb3IoJ0ludmFsaWQgY29kZSBwb2ludDogJyArIGNvZGVQb2ludCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjb2RlUG9pbnQgPD0gMHhGRkZGKSB7CiAgICAgICAgICAgICAgLy8gQk1QIGNvZGUgcG9pbnQKICAgICAgICAgICAgICBjb2RlVW5pdHMucHVzaChjb2RlUG9pbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIEFzdHJhbCBjb2RlIHBvaW50OyBzcGxpdCBpbiBzdXJyb2dhdGUgaGFsdmVzCiAgICAgICAgICAgICAgLy8gaHR0cDovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZyNzdXJyb2dhdGUtZm9ybXVsYWUKICAgICAgICAgICAgICBjb2RlUG9pbnQgLT0gMHgxMDAwMDsKICAgICAgICAgICAgICBoaWdoU3Vycm9nYXRlID0gKGNvZGVQb2ludCA+PiAxMCkgKyAweEQ4MDA7CiAgICAgICAgICAgICAgbG93U3Vycm9nYXRlID0gY29kZVBvaW50ICUgMHg0MDAgKyAweERDMDA7CiAgICAgICAgICAgICAgY29kZVVuaXRzLnB1c2goaGlnaFN1cnJvZ2F0ZSwgbG93U3Vycm9nYXRlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGluZGV4ICsgMSA9PT0gbGVuZ3RoIHx8IGNvZGVVbml0cy5sZW5ndGggPiBNQVhfU0laRSkgewogICAgICAgICAgICAgIHJlc3VsdCArPSBzdHJpbmdGcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgY29kZVVuaXRzKTsKICAgICAgICAgICAgICBjb2RlVW5pdHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgICAgICAgaWYgKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0cmluZywgJ2Zyb21Db2RlUG9pbnQnLCB7CiAgICAgICAgICAgIHZhbHVlOiBmcm9tQ29kZVBvaW50LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgU3RyaW5nLmZyb21Db2RlUG9pbnQgPSBmcm9tQ29kZVBvaW50OwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9KShleHBvcnRzKTsKfSkoc2F4KTsKCnZhciBfX2ltcG9ydERlZmF1bHQkMiA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9faW1wb3J0RGVmYXVsdCB8fCBmdW5jdGlvbiAobW9kKSB7CiAgcmV0dXJuIG1vZCAmJiBtb2QuX19lc01vZHVsZSA/IG1vZCA6IHsKICAgICJkZWZhdWx0IjogbW9kCiAgfTsKfTsKCmNvbnN0IGh0dHBfMSA9IF9faW1wb3J0RGVmYXVsdCQyKHJlcXVpcmUkJDBfX2RlZmF1bHRbImRlZmF1bHQiXSk7Cgpjb25zdCBodHRwc18xID0gX19pbXBvcnREZWZhdWx0JDIocmVxdWlyZSQkMV9fZGVmYXVsdCQxWyJkZWZhdWx0Il0pOwoKY29uc3Qgc3RyZWFtXzEkMyA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMVsiZGVmYXVsdCJdOwpjb25zdCBodHRwTGlicyA9IHsKICAnaHR0cDonOiBodHRwXzEuZGVmYXVsdCwKICAnaHR0cHM6JzogaHR0cHNfMS5kZWZhdWx0Cn07CmNvbnN0IHJlZGlyZWN0U3RhdHVzQ29kZXMgPSBuZXcgU2V0KFszMDEsIDMwMiwgMzAzLCAzMDcsIDMwOF0pOwpjb25zdCByZXRyeVN0YXR1c0NvZGVzID0gbmV3IFNldChbNDI5LCA1MDNdKTsgLy8gYHJlcXVlc3RgLCBgcmVzcG9uc2VgLCBgYWJvcnRgLCBsZWZ0IG91dCwgbWluaWdldCB3aWxsIGVtaXQgdGhlc2UuCgpjb25zdCByZXF1ZXN0RXZlbnRzID0gWydjb25uZWN0JywgJ2NvbnRpbnVlJywgJ2luZm9ybWF0aW9uJywgJ3NvY2tldCcsICd0aW1lb3V0JywgJ3VwZ3JhZGUnXTsKY29uc3QgcmVzcG9uc2VFdmVudHMgPSBbJ2Fib3J0ZWQnXTsKTWluaWdldC5NaW5pZ2V0RXJyb3IgPSBjbGFzcyBNaW5pZ2V0RXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgc3RhdHVzQ29kZSkgewogICAgc3VwZXIobWVzc2FnZSk7CiAgICB0aGlzLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogIH0KCn07Ck1pbmlnZXQuZGVmYXVsdE9wdGlvbnMgPSB7CiAgbWF4UmVkaXJlY3RzOiAxMCwKICBtYXhSZXRyaWVzOiAyLAogIG1heFJlY29ubmVjdHM6IDAsCiAgYmFja29mZjogewogICAgaW5jOiAxMDAsCiAgICBtYXg6IDEwMDAwCiAgfQp9OwoKZnVuY3Rpb24gTWluaWdldCh1cmwsIG9wdGlvbnMgPSB7fSkgewogIHZhciBfYTsKCiAgY29uc3Qgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIE1pbmlnZXQuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpOwogIGNvbnN0IHN0cmVhbSA9IG5ldyBzdHJlYW1fMSQzLlBhc3NUaHJvdWdoKHsKICAgIGhpZ2hXYXRlck1hcms6IG9wdHMuaGlnaFdhdGVyTWFyawogIH0pOwogIHN0cmVhbS5kZXN0cm95ZWQgPSBzdHJlYW0uYWJvcnRlZCA9IGZhbHNlOwogIGxldCBhY3RpdmVSZXF1ZXN0OwogIGxldCBhY3RpdmVSZXNwb25zZTsKICBsZXQgYWN0aXZlRGVjb2RlZFN0cmVhbTsKICBsZXQgcmVkaXJlY3RzID0gMDsKICBsZXQgcmV0cmllcyA9IDA7CiAgbGV0IHJldHJ5VGltZW91dDsKICBsZXQgcmVjb25uZWN0cyA9IDA7CiAgbGV0IGNvbnRlbnRMZW5ndGg7CiAgbGV0IGFjY2VwdFJhbmdlcyA9IGZhbHNlOwogIGxldCByYW5nZVN0YXJ0ID0gMCwKICAgICAgcmFuZ2VFbmQ7CiAgbGV0IGRvd25sb2FkZWQgPSAwOyAvLyBDaGVjayBpZiB0aGlzIGlzIGEgcmFuZ2VkIHJlcXVlc3QuCgogIGlmICgoX2EgPSBvcHRzLmhlYWRlcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5SYW5nZSkgewogICAgbGV0IHIgPSAvYnl0ZXM9KFxkKyktKFxkKyk/Ly5leGVjKGAke29wdHMuaGVhZGVycy5SYW5nZX1gKTsKCiAgICBpZiAocikgewogICAgICByYW5nZVN0YXJ0ID0gcGFyc2VJbnQoclsxXSwgMTApOwogICAgICByYW5nZUVuZCA9IHBhcnNlSW50KHJbMl0sIDEwKTsKICAgIH0KICB9IC8vIEFkZCBgQWNjZXB0LUVuY29kaW5nYCBoZWFkZXIuCgoKICBpZiAob3B0cy5hY2NlcHRFbmNvZGluZykgewogICAgb3B0cy5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICdBY2NlcHQtRW5jb2RpbmcnOiBPYmplY3Qua2V5cyhvcHRzLmFjY2VwdEVuY29kaW5nKS5qb2luKCcsICcpCiAgICB9LCBvcHRzLmhlYWRlcnMpOwogIH0KCiAgY29uc3QgZG93bmxvYWRIYXNTdGFydGVkID0gKCkgPT4gYWN0aXZlRGVjb2RlZFN0cmVhbSAmJiBkb3dubG9hZGVkID4gMDsKCiAgY29uc3QgZG93bmxvYWRDb21wbGV0ZSA9ICgpID0+ICFhY2NlcHRSYW5nZXMgfHwgZG93bmxvYWRlZCA9PT0gY29udGVudExlbmd0aDsKCiAgY29uc3QgcmVjb25uZWN0ID0gZXJyID0+IHsKICAgIGFjdGl2ZURlY29kZWRTdHJlYW0gPSBudWxsOwogICAgcmV0cmllcyA9IDA7CiAgICBsZXQgaW5jID0gb3B0cy5iYWNrb2ZmLmluYzsKICAgIGxldCBtcyA9IE1hdGgubWluKGluYywgb3B0cy5iYWNrb2ZmLm1heCk7CiAgICByZXRyeVRpbWVvdXQgPSBzZXRUaW1lb3V0KGRvRG93bmxvYWQsIG1zKTsKICAgIHN0cmVhbS5lbWl0KCdyZWNvbm5lY3QnLCByZWNvbm5lY3RzLCBlcnIpOwogIH07CgogIGNvbnN0IHJlY29ubmVjdElmRW5kZWRFYXJseSA9IGVyciA9PiB7CiAgICBpZiAob3B0aW9ucy5tZXRob2QgIT09ICdIRUFEJyAmJiAhZG93bmxvYWRDb21wbGV0ZSgpICYmIHJlY29ubmVjdHMrKyA8IG9wdHMubWF4UmVjb25uZWN0cykgewogICAgICByZWNvbm5lY3QoZXJyKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CgogIGNvbnN0IHJldHJ5UmVxdWVzdCA9IHJldHJ5T3B0aW9ucyA9PiB7CiAgICBpZiAoc3RyZWFtLmRlc3Ryb3llZCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKGRvd25sb2FkSGFzU3RhcnRlZCgpKSB7CiAgICAgIHJldHVybiByZWNvbm5lY3RJZkVuZGVkRWFybHkocmV0cnlPcHRpb25zLmVycik7CiAgICB9IGVsc2UgaWYgKCghcmV0cnlPcHRpb25zLmVyciB8fCByZXRyeU9wdGlvbnMuZXJyLm1lc3NhZ2UgPT09ICdFTk9URk9VTkQnKSAmJiByZXRyaWVzKysgPCBvcHRzLm1heFJldHJpZXMpIHsKICAgICAgbGV0IG1zID0gcmV0cnlPcHRpb25zLnJldHJ5QWZ0ZXIgfHwgTWF0aC5taW4ocmV0cmllcyAqIG9wdHMuYmFja29mZi5pbmMsIG9wdHMuYmFja29mZi5tYXgpOwogICAgICByZXRyeVRpbWVvdXQgPSBzZXRUaW1lb3V0KGRvRG93bmxvYWQsIG1zKTsKICAgICAgc3RyZWFtLmVtaXQoJ3JldHJ5JywgcmV0cmllcywgcmV0cnlPcHRpb25zLmVycik7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9OwoKICBjb25zdCBmb3J3YXJkRXZlbnRzID0gKGVlLCBldmVudHMpID0+IHsKICAgIGZvciAobGV0IGV2ZW50IG9mIGV2ZW50cykgewogICAgICBlZS5vbihldmVudCwgc3RyZWFtLmVtaXQuYmluZChzdHJlYW0sIGV2ZW50KSk7CiAgICB9CiAgfTsKCiAgY29uc3QgZG9Eb3dubG9hZCA9ICgpID0+IHsKICAgIGxldCBwYXJzZWQgPSB7fSwKICAgICAgICBodHRwTGliOwoKICAgIHRyeSB7CiAgICAgIGxldCB1cmxPYmogPSB0eXBlb2YgdXJsID09PSAnc3RyaW5nJyA/IG5ldyBVUkwodXJsKSA6IHVybDsKICAgICAgcGFyc2VkID0gT2JqZWN0LmFzc2lnbih7fSwgewogICAgICAgIGhvc3Q6IHVybE9iai5ob3N0LAogICAgICAgIGhvc3RuYW1lOiB1cmxPYmouaG9zdG5hbWUsCiAgICAgICAgcGF0aDogdXJsT2JqLnBhdGhuYW1lICsgdXJsT2JqLnNlYXJjaCArIHVybE9iai5oYXNoLAogICAgICAgIHBvcnQ6IHVybE9iai5wb3J0LAogICAgICAgIHByb3RvY29sOiB1cmxPYmoucHJvdG9jb2wKICAgICAgfSk7CgogICAgICBpZiAodXJsT2JqLnVzZXJuYW1lKSB7CiAgICAgICAgcGFyc2VkLmF1dGggPSBgJHt1cmxPYmoudXNlcm5hbWV9OiR7dXJsT2JqLnBhc3N3b3JkfWA7CiAgICAgIH0KCiAgICAgIGh0dHBMaWIgPSBodHRwTGlic1tTdHJpbmcocGFyc2VkLnByb3RvY29sKV07CiAgICB9IGNhdGNoIChlcnIpIHsvLyBMZXQgdGhlIGVycm9yIGJlIGNhdWdodCBieSB0aGUgaWYgc3RhdGVtZW50IGJlbG93LgogICAgfQoKICAgIGlmICghaHR0cExpYikgewogICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBuZXcgTWluaWdldC5NaW5pZ2V0RXJyb3IoYEludmFsaWQgVVJMOiAke3VybH1gKSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBPYmplY3QuYXNzaWduKHBhcnNlZCwgb3B0cyk7CgogICAgaWYgKGFjY2VwdFJhbmdlcyAmJiBkb3dubG9hZGVkID4gMCkgewogICAgICBsZXQgc3RhcnQgPSBkb3dubG9hZGVkICsgcmFuZ2VTdGFydDsKICAgICAgbGV0IGVuZCA9IHJhbmdlRW5kIHx8ICcnOwogICAgICBwYXJzZWQuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHBhcnNlZC5oZWFkZXJzLCB7CiAgICAgICAgUmFuZ2U6IGBieXRlcz0ke3N0YXJ0fS0ke2VuZH1gCiAgICAgIH0pOwogICAgfQoKICAgIGlmIChvcHRzLnRyYW5zZm9ybSkgewogICAgICB0cnkgewogICAgICAgIHBhcnNlZCA9IG9wdHMudHJhbnNmb3JtKHBhcnNlZCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXBhcnNlZCB8fCBwYXJzZWQucHJvdG9jb2wpIHsKICAgICAgICBodHRwTGliID0gaHR0cExpYnNbU3RyaW5nKHBhcnNlZCA9PT0gbnVsbCB8fCBwYXJzZWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhcnNlZC5wcm90b2NvbCldOwoKICAgICAgICBpZiAoIWh0dHBMaWIpIHsKICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIG5ldyBNaW5pZ2V0Lk1pbmlnZXRFcnJvcignSW52YWxpZCBVUkwgb2JqZWN0IGZyb20gYHRyYW5zZm9ybWAgZnVuY3Rpb24nKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY29uc3Qgb25FcnJvciA9IGVyciA9PiB7CiAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkIHx8IHN0cmVhbS5yZWFkYWJsZUVuZGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjbGVhbnVwKCk7CgogICAgICBpZiAoIXJldHJ5UmVxdWVzdCh7CiAgICAgICAgZXJyCiAgICAgIH0pKSB7CiAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhY3RpdmVSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uUmVxdWVzdENsb3NlKTsKICAgICAgfQogICAgfTsKCiAgICBjb25zdCBvblJlcXVlc3RDbG9zZSA9ICgpID0+IHsKICAgICAgY2xlYW51cCgpOwogICAgICByZXRyeVJlcXVlc3Qoe30pOwogICAgfTsKCiAgICBjb25zdCBjbGVhbnVwID0gKCkgPT4gewogICAgICBhY3RpdmVSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uUmVxdWVzdENsb3NlKTsKICAgICAgYWN0aXZlUmVzcG9uc2UgPT09IG51bGwgfHwgYWN0aXZlUmVzcG9uc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVJlc3BvbnNlLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgb25EYXRhKTsKICAgICAgYWN0aXZlRGVjb2RlZFN0cmVhbSA9PT0gbnVsbCB8fCBhY3RpdmVEZWNvZGVkU3RyZWFtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVEZWNvZGVkU3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdlbmQnLCBvbkVuZCk7CiAgICB9OwoKICAgIGNvbnN0IG9uRGF0YSA9IGNodW5rID0+IHsKICAgICAgZG93bmxvYWRlZCArPSBjaHVuay5sZW5ndGg7CiAgICB9OwoKICAgIGNvbnN0IG9uRW5kID0gKCkgPT4gewogICAgICBjbGVhbnVwKCk7CgogICAgICBpZiAoIXJlY29ubmVjdElmRW5kZWRFYXJseSgpKSB7CiAgICAgICAgc3RyZWFtLmVuZCgpOwogICAgICB9CiAgICB9OwoKICAgIGFjdGl2ZVJlcXVlc3QgPSBodHRwTGliLnJlcXVlc3QocGFyc2VkLCByZXMgPT4gewogICAgICAvLyBOZWVkZWQgZm9yIG5vZGUgdjEwLCB2MTIuCiAgICAgIC8vIGlzdGFuYnVsIGlnbm9yZSBuZXh0CiAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAocmVkaXJlY3RTdGF0dXNDb2Rlcy5oYXMocmVzLnN0YXR1c0NvZGUpKSB7CiAgICAgICAgaWYgKHJlZGlyZWN0cysrID49IG9wdHMubWF4UmVkaXJlY3RzKSB7CiAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBuZXcgTWluaWdldC5NaW5pZ2V0RXJyb3IoJ1RvbyBtYW55IHJlZGlyZWN0cycpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHJlcy5oZWFkZXJzLmxvY2F0aW9uKSB7CiAgICAgICAgICAgIHVybCA9IHJlcy5oZWFkZXJzLmxvY2F0aW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IGVyciA9IG5ldyBNaW5pZ2V0Lk1pbmlnZXRFcnJvcignUmVkaXJlY3Qgc3RhdHVzIGNvZGUgZ2l2ZW4gd2l0aCBubyBsb2NhdGlvbicsIHJlcy5zdGF0dXNDb2RlKTsKICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgc2V0VGltZW91dChkb0Rvd25sb2FkLCBwYXJzZUludChyZXMuaGVhZGVyc1sncmV0cnktYWZ0ZXInXSB8fCAnMCcsIDEwKSAqIDEwMDApOwogICAgICAgICAgc3RyZWFtLmVtaXQoJ3JlZGlyZWN0JywgdXJsKTsKICAgICAgICB9CgogICAgICAgIGNsZWFudXAoKTsKICAgICAgICByZXR1cm47IC8vIENoZWNrIGZvciByYXRlIGxpbWl0aW5nLgogICAgICB9IGVsc2UgaWYgKHJldHJ5U3RhdHVzQ29kZXMuaGFzKHJlcy5zdGF0dXNDb2RlKSkgewogICAgICAgIGlmICghcmV0cnlSZXF1ZXN0KHsKICAgICAgICAgIHJldHJ5QWZ0ZXI6IHBhcnNlSW50KHJlcy5oZWFkZXJzWydyZXRyeS1hZnRlciddIHx8ICcwJywgMTApCiAgICAgICAgfSkpIHsKICAgICAgICAgIGxldCBlcnIgPSBuZXcgTWluaWdldC5NaW5pZ2V0RXJyb3IoYFN0YXR1cyBjb2RlOiAke3Jlcy5zdGF0dXNDb2RlfWAsIHJlcy5zdGF0dXNDb2RlKTsKICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgfQoKICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKHJlcy5zdGF0dXNDb2RlICYmIChyZXMuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXMuc3RhdHVzQ29kZSA+PSA0MDApKSB7CiAgICAgICAgbGV0IGVyciA9IG5ldyBNaW5pZ2V0Lk1pbmlnZXRFcnJvcihgU3RhdHVzIGNvZGU6ICR7cmVzLnN0YXR1c0NvZGV9YCwgcmVzLnN0YXR1c0NvZGUpOwoKICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPj0gNTAwKSB7CiAgICAgICAgICBvbkVycm9yKGVycik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgfQoKICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID0gcmVzOwoKICAgICAgaWYgKG9wdHMuYWNjZXB0RW5jb2RpbmcgJiYgcmVzLmhlYWRlcnNbJ2NvbnRlbnQtZW5jb2RpbmcnXSkgewogICAgICAgIGZvciAobGV0IGVuYyBvZiByZXMuaGVhZGVyc1snY29udGVudC1lbmNvZGluZyddLnNwbGl0KCcsICcpLnJldmVyc2UoKSkgewogICAgICAgICAgbGV0IGZuID0gb3B0cy5hY2NlcHRFbmNvZGluZ1tlbmNdOwoKICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID0gYWN0aXZlRGVjb2RlZFN0cmVhbS5waXBlKGZuKCkpOwogICAgICAgICAgICBhY3RpdmVEZWNvZGVkU3RyZWFtLm9uKCdlcnJvcicsIG9uRXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFjb250ZW50TGVuZ3RoKSB7CiAgICAgICAgY29udGVudExlbmd0aCA9IHBhcnNlSW50KGAke3Jlcy5oZWFkZXJzWydjb250ZW50LWxlbmd0aCddfWAsIDEwKTsKICAgICAgICBhY2NlcHRSYW5nZXMgPSByZXMuaGVhZGVyc1snYWNjZXB0LXJhbmdlcyddID09PSAnYnl0ZXMnICYmIGNvbnRlbnRMZW5ndGggPiAwICYmIG9wdHMubWF4UmVjb25uZWN0cyA+IDA7CiAgICAgIH0KCiAgICAgIHJlcy5vbignZGF0YScsIG9uRGF0YSk7CiAgICAgIGFjdGl2ZURlY29kZWRTdHJlYW0ub24oJ2VuZCcsIG9uRW5kKTsKICAgICAgYWN0aXZlRGVjb2RlZFN0cmVhbS5waXBlKHN0cmVhbSwgewogICAgICAgIGVuZDogIWFjY2VwdFJhbmdlcwogICAgICB9KTsKICAgICAgYWN0aXZlUmVzcG9uc2UgPSByZXM7CiAgICAgIHN0cmVhbS5lbWl0KCdyZXNwb25zZScsIHJlcyk7CiAgICAgIHJlcy5vbignZXJyb3InLCBvbkVycm9yKTsKICAgICAgZm9yd2FyZEV2ZW50cyhyZXMsIHJlc3BvbnNlRXZlbnRzKTsKICAgIH0pOwogICAgYWN0aXZlUmVxdWVzdC5vbignZXJyb3InLCBvbkVycm9yKTsKICAgIGFjdGl2ZVJlcXVlc3Qub24oJ2Nsb3NlJywgb25SZXF1ZXN0Q2xvc2UpOwogICAgZm9yd2FyZEV2ZW50cyhhY3RpdmVSZXF1ZXN0LCByZXF1ZXN0RXZlbnRzKTsKCiAgICBpZiAoc3RyZWFtLmRlc3Ryb3llZCkgewogICAgICBzdHJlYW1EZXN0cm95KC4uLmRlc3Ryb3lBcmdzKTsKICAgIH0KCiAgICBzdHJlYW0uZW1pdCgncmVxdWVzdCcsIGFjdGl2ZVJlcXVlc3QpOwogICAgYWN0aXZlUmVxdWVzdC5lbmQoKTsKICB9OwoKICBzdHJlYW0uYWJvcnQgPSBlcnIgPT4gewogICAgY29uc29sZS53YXJuKCdgTWluaWdldFN0cmVhbSNhYm9ydCgpYCBoYXMgYmVlbiBkZXByZWNhdGVkIGluIGZhdm9yIG9mIGBNaW5pZ2V0U3RyZWFtI2Rlc3Ryb3koKWAnKTsKICAgIHN0cmVhbS5hYm9ydGVkID0gdHJ1ZTsKICAgIHN0cmVhbS5lbWl0KCdhYm9ydCcpOwogICAgc3RyZWFtLmRlc3Ryb3koZXJyKTsKICB9OwoKICBsZXQgZGVzdHJveUFyZ3M7CgogIGNvbnN0IHN0cmVhbURlc3Ryb3kgPSBlcnIgPT4gewogICAgYWN0aXZlUmVxdWVzdC5kZXN0cm95KGVycik7CiAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID09PSBudWxsIHx8IGFjdGl2ZURlY29kZWRTdHJlYW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZURlY29kZWRTdHJlYW0udW5waXBlKHN0cmVhbSk7CiAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID09PSBudWxsIHx8IGFjdGl2ZURlY29kZWRTdHJlYW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZURlY29kZWRTdHJlYW0uZGVzdHJveSgpOwogICAgY2xlYXJUaW1lb3V0KHJldHJ5VGltZW91dCk7CiAgfTsKCiAgc3RyZWFtLl9kZXN0cm95ID0gKC4uLmFyZ3MpID0+IHsKICAgIHN0cmVhbS5kZXN0cm95ZWQgPSB0cnVlOwoKICAgIGlmIChhY3RpdmVSZXF1ZXN0KSB7CiAgICAgIHN0cmVhbURlc3Ryb3koLi4uYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZXN0cm95QXJncyA9IGFyZ3M7CiAgICB9CiAgfTsKCiAgc3RyZWFtLnRleHQgPSAoKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBsZXQgYm9keSA9ICcnOwogICAgc3RyZWFtLnNldEVuY29kaW5nKCd1dGY4Jyk7CiAgICBzdHJlYW0ub24oJ2RhdGEnLCBjaHVuayA9PiBib2R5ICs9IGNodW5rKTsKICAgIHN0cmVhbS5vbignZW5kJywgKCkgPT4gcmVzb2x2ZShib2R5KSk7CiAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTsKICB9KTsKCiAgcHJvY2Vzcy5uZXh0VGljayhkb0Rvd25sb2FkKTsKICByZXR1cm4gc3RyZWFtOwp9Cgp2YXIgZGlzdCQxID0gTWluaWdldDsKCnZhciB1dGlscyQyID0ge307Cgp2YXIgbmFtZSA9ICJ5dGRsLWNvcmUiOwp2YXIgZGVzY3JpcHRpb24gPSAiWW91VHViZSB2aWRlbyBkb3dubG9hZGVyIGluIHB1cmUgamF2YXNjcmlwdC4iOwp2YXIga2V5d29yZHMgPSBbCgkieW91dHViZSIsCgkidmlkZW8iLAoJImRvd25sb2FkIgpdOwp2YXIgdmVyc2lvbiA9ICI0LjExLjAiOwp2YXIgcmVwb3NpdG9yeSA9IHsKCXR5cGU6ICJnaXQiLAoJdXJsOiAiZ2l0Oi8vZ2l0aHViLmNvbS9mZW50L25vZGUteXRkbC1jb3JlLmdpdCIKfTsKdmFyIGF1dGhvciA9ICJmZW50IDxmZW50Ym94QGdtYWlsLmNvbT4gKGh0dHBzOi8vZ2l0aHViLmNvbS9mZW50KSI7CnZhciBjb250cmlidXRvcnMgPSBbCgkiVG9iaWFzIEt1dHNjaGEgKGh0dHBzOi8vZ2l0aHViLmNvbS9UaW1lRm9yQU5pbmphKSIsCgkiQW5kcmV3IEtlbGxleSAoaHR0cHM6Ly9naXRodWIuY29tL2FuZHJld3JrKSIsCgkiTWF1cmljaW8gQWxsZW5kZSAoaHR0cHM6Ly9naXRodWIuY29tL21hbGxlbmRlbykiLAoJIlJvZHJpZ28gQWx0YW1pcmFubyAoaHR0cHM6Ly9naXRodWIuY29tL3JhbHRhbWlyYW5vKSIsCgkiSmltIEJ1Y2sgKGh0dHBzOi8vZ2l0aHViLmNvbS9KaW1teUJvaCkiLAoJIlBhd2XFgiBSdWNpxYRza2kgKGh0dHBzOi8vZ2l0aHViLmNvbS9Sb2tpMTAwKSIsCgkiQWxleGFuZGVyIFBhb2xpbmkgKGh0dHBzOi8vZ2l0aHViLmNvbS9NaWxsaW9uOTAwbykiCl07CnZhciBtYWluID0gIi4vbGliL2luZGV4LmpzIjsKdmFyIHR5cGVzID0gIi4vdHlwaW5ncy9pbmRleC5kLnRzIjsKdmFyIGZpbGVzID0gWwoJImxpYiIsCgkidHlwaW5ncyIKXTsKdmFyIHNjcmlwdHMgPSB7Cgl0ZXN0OiAibnljIC0tcmVwb3J0ZXI9bGNvdiAtLXJlcG9ydGVyPXRleHQtc3VtbWFyeSBucG0gcnVuIHRlc3Q6dW5pdCIsCgkidGVzdDp1bml0IjogIm1vY2hhIC0taWdub3JlIHRlc3QvaXJsLXRlc3QuanMgdGVzdC8qLXRlc3QuanMgLS10aW1lb3V0IDQwMDAiLAoJInRlc3Q6aXJsIjogIm1vY2hhIC0tdGltZW91dCAxNjAwMCB0ZXN0L2lybC10ZXN0LmpzIiwKCWxpbnQ6ICJlc2xpbnQgLi8iLAoJImxpbnQ6Zml4IjogImVzbGludCAtLWZpeCAuLyIsCgkibGludDp0eXBpbmdzIjogInRzbGludCB0eXBpbmdzL2luZGV4LmQudHMiLAoJImxpbnQ6dHlwaW5nczpmaXgiOiAidHNsaW50IC0tZml4IHR5cGluZ3MvaW5kZXguZC50cyIKfTsKdmFyIGRlcGVuZGVuY2llcyA9IHsKCW0zdThzdHJlYW06ICJeMC44LjYiLAoJbWluaWdldDogIl40LjIuMiIsCglzYXg6ICJeMS4xLjMiCn07CnZhciBkZXZEZXBlbmRlbmNpZXMgPSB7CgkiQHR5cGVzL25vZGUiOiAiXjEzLjEuMCIsCgkiYXNzZXJ0LWRpZmYiOiAiXjMuMC4xIiwKCWR0c2xpbnQ6ICJeMy42LjE0IiwKCWVzbGludDogIl42LjguMCIsCgltb2NoYTogIl43LjAuMCIsCgkibXVrLXJlcXVpcmUiOiAiXjEuMi4wIiwKCW5vY2s6ICJeMTMuMC40IiwKCW55YzogIl4xNS4wLjAiLAoJc2lub246ICJeOS4wLjAiLAoJInN0cmVhbS1lcXVhbCI6ICJ+MS4xLjAiLAoJdHlwZXNjcmlwdDogIl4zLjkuNyIKfTsKdmFyIGVuZ2luZXMgPSB7Cglub2RlOiAiPj0xMiIKfTsKdmFyIGxpY2Vuc2UgPSAiTUlUIjsKdmFyIHJlcXVpcmUkJDggPSB7CgluYW1lOiBuYW1lLAoJZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLAoJa2V5d29yZHM6IGtleXdvcmRzLAoJdmVyc2lvbjogdmVyc2lvbiwKCXJlcG9zaXRvcnk6IHJlcG9zaXRvcnksCglhdXRob3I6IGF1dGhvciwKCWNvbnRyaWJ1dG9yczogY29udHJpYnV0b3JzLAoJbWFpbjogbWFpbiwKCXR5cGVzOiB0eXBlcywKCWZpbGVzOiBmaWxlcywKCXNjcmlwdHM6IHNjcmlwdHMsCglkZXBlbmRlbmNpZXM6IGRlcGVuZGVuY2llcywKCWRldkRlcGVuZGVuY2llczogZGV2RGVwZW5kZW5jaWVzLAoJZW5naW5lczogZW5naW5lcywKCWxpY2Vuc2U6IGxpY2Vuc2UKfTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewogIGNvbnN0IG1pbmlnZXQgPSBkaXN0JDE7CiAgLyoqCiAgICogRXh0cmFjdCBzdHJpbmcgaW5iZXR3ZWVuIGFub3RoZXIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaGF5c3RhY2sKICAgKiBAcGFyYW0ge3N0cmluZ30gbGVmdAogICAqIEBwYXJhbSB7c3RyaW5nfSByaWdodAogICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgICovCgogIGV4cG9ydHMuYmV0d2VlbiA9IChoYXlzdGFjaywgbGVmdCwgcmlnaHQpID0+IHsKICAgIGxldCBwb3M7CgogICAgaWYgKGxlZnQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgY29uc3QgbWF0Y2ggPSBoYXlzdGFjay5tYXRjaChsZWZ0KTsKCiAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KCiAgICAgIHBvcyA9IG1hdGNoLmluZGV4ICsgbWF0Y2hbMF0ubGVuZ3RoOwogICAgfSBlbHNlIHsKICAgICAgcG9zID0gaGF5c3RhY2suaW5kZXhPZihsZWZ0KTsKCiAgICAgIGlmIChwb3MgPT09IC0xKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CgogICAgICBwb3MgKz0gbGVmdC5sZW5ndGg7CiAgICB9CgogICAgaGF5c3RhY2sgPSBoYXlzdGFjay5zbGljZShwb3MpOwogICAgcG9zID0gaGF5c3RhY2suaW5kZXhPZihyaWdodCk7CgogICAgaWYgKHBvcyA9PT0gLTEpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQoKICAgIGhheXN0YWNrID0gaGF5c3RhY2suc2xpY2UoMCwgcG9zKTsKICAgIHJldHVybiBoYXlzdGFjazsKICB9OwogIC8qKgogICAqIEdldCBhIG51bWJlciBmcm9tIGFuIGFiYnJldmlhdGVkIG51bWJlciBzdHJpbmcuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nCiAgICogQHJldHVybnMge251bWJlcn0KICAgKi8KCgogIGV4cG9ydHMucGFyc2VBYmJyZXZpYXRlZE51bWJlciA9IHN0cmluZyA9PiB7CiAgICBjb25zdCBtYXRjaCA9IHN0cmluZy5yZXBsYWNlKCcsJywgJy4nKS5yZXBsYWNlKCcgJywgJycpLm1hdGNoKC8oW1xkLC5dKykoW01LXT8pLyk7CgogICAgaWYgKG1hdGNoKSB7CiAgICAgIGxldCBbLCBudW0sIG11bHRpXSA9IG1hdGNoOwogICAgICBudW0gPSBwYXJzZUZsb2F0KG51bSk7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKG11bHRpID09PSAnTScgPyBudW0gKiAxMDAwMDAwIDogbXVsdGkgPT09ICdLJyA/IG51bSAqIDEwMDAgOiBudW0pOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CiAgLyoqCiAgICogTWF0Y2ggYmVnaW4gYW5kIGVuZCBicmFjZXMgb2YgaW5wdXQgSlNPTiwgcmV0dXJuIG9ubHkganNvbgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG1peGVkSnNvbgogICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgKi8KCgogIGV4cG9ydHMuY3V0QWZ0ZXJKU09OID0gbWl4ZWRKc29uID0+IHsKICAgIGxldCBvcGVuLCBjbG9zZTsKCiAgICBpZiAobWl4ZWRKc29uWzBdID09PSAnWycpIHsKICAgICAgb3BlbiA9ICdbJzsKICAgICAgY2xvc2UgPSAnXSc7CiAgICB9IGVsc2UgaWYgKG1peGVkSnNvblswXSA9PT0gJ3snKSB7CiAgICAgIG9wZW4gPSAneyc7CiAgICAgIGNsb3NlID0gJ30nOwogICAgfQoKICAgIGlmICghb3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGN1dCB1bnN1cHBvcnRlZCBKU09OIChuZWVkIHRvIGJlZ2luIHdpdGggWyBvciB7ICkgYnV0IGdvdDogJHttaXhlZEpzb25bMF19YCk7CiAgICB9IC8vIFN0YXRlcyBpZiB0aGUgbG9vcCBpcyBjdXJyZW50bHkgaW4gYSBzdHJpbmcKCgogICAgbGV0IGlzU3RyaW5nID0gZmFsc2U7IC8vIFN0YXRlcyBpZiB0aGUgY3VycmVudCBjaGFyYWN0ZXIgaXMgdHJlYXRlZCBhcyBlc2NhcGVkIG9yIG5vdAoKICAgIGxldCBpc0VzY2FwZWQgPSBmYWxzZTsgLy8gQ3VycmVudCBvcGVuIGJyYWNrZXRzIHRvIGJlIGNsb3NlZAoKICAgIGxldCBjb3VudGVyID0gMDsKICAgIGxldCBpOwoKICAgIGZvciAoaSA9IDA7IGkgPCBtaXhlZEpzb24ubGVuZ3RoOyBpKyspIHsKICAgICAgLy8gVG9nZ2xlIHRoZSBpc1N0cmluZyBib29sZWFuIHdoZW4gbGVhdmluZy9lbnRlcmluZyBzdHJpbmcKICAgICAgaWYgKG1peGVkSnNvbltpXSA9PT0gJyInICYmICFpc0VzY2FwZWQpIHsKICAgICAgICBpc1N0cmluZyA9ICFpc1N0cmluZzsKICAgICAgICBjb250aW51ZTsKICAgICAgfSAvLyBUb2dnbGUgdGhlIGlzRXNjYXBlZCBib29sZWFuIGZvciBldmVyeSBiYWNrc2xhc2gKICAgICAgLy8gUmVzZXQgZm9yIGV2ZXJ5IHJlZ3VsYXIgY2hhcmFjdGVyCgoKICAgICAgaXNFc2NhcGVkID0gbWl4ZWRKc29uW2ldID09PSAnXFwnICYmICFpc0VzY2FwZWQ7CiAgICAgIGlmIChpc1N0cmluZykgY29udGludWU7CgogICAgICBpZiAobWl4ZWRKc29uW2ldID09PSBvcGVuKSB7CiAgICAgICAgY291bnRlcisrOwogICAgICB9IGVsc2UgaWYgKG1peGVkSnNvbltpXSA9PT0gY2xvc2UpIHsKICAgICAgICBjb3VudGVyLS07CiAgICAgIH0gLy8gQWxsIGJyYWNrZXRzIGhhdmUgYmVlbiBjbG9zZWQsIHRodXMgZW5kIG9mIEpTT04gaXMgcmVhY2hlZAoKCiAgICAgIGlmIChjb3VudGVyID09PSAwKSB7CiAgICAgICAgLy8gUmV0dXJuIHRoZSBjdXQgSlNPTgogICAgICAgIHJldHVybiBtaXhlZEpzb24uc3Vic3RyKDAsIGkgKyAxKTsKICAgICAgfQogICAgfSAvLyBXZSByYW4gdGhyb3VnaCB0aGUgd2hvbGUgc3RyaW5nIGFuZCBlbmRlZCB1cCB3aXRoIGFuIHVuY2xvc2VkIGJyYWNrZXQKCgogICAgdGhyb3cgRXJyb3IoIkNhbid0IGN1dCB1bnN1cHBvcnRlZCBKU09OIChubyBtYXRjaGluZyBjbG9zaW5nIGJyYWNrZXQgZm91bmQpIik7CiAgfTsKICAvKioKICAgKiBDaGVja3MgaWYgdGhlcmUgaXMgYSBwbGF5YWJpbGl0eSBlcnJvci4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBwbGF5ZXJfcmVzcG9uc2UKICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+fSBzdGF0dXNlcwogICAqIEBwYXJhbSB7RXJyb3J9IEVycm9yVHlwZQogICAqIEByZXR1cm5zIHshRXJyb3J9CiAgICovCgoKICBleHBvcnRzLnBsYXlFcnJvciA9IChwbGF5ZXJfcmVzcG9uc2UsIHN0YXR1c2VzLCBFcnJvclR5cGUgPSBFcnJvcikgPT4gewogICAgbGV0IHBsYXlhYmlsaXR5ID0gcGxheWVyX3Jlc3BvbnNlICYmIHBsYXllcl9yZXNwb25zZS5wbGF5YWJpbGl0eVN0YXR1czsKCiAgICBpZiAocGxheWFiaWxpdHkgJiYgc3RhdHVzZXMuaW5jbHVkZXMocGxheWFiaWxpdHkuc3RhdHVzKSkgewogICAgICByZXR1cm4gbmV3IEVycm9yVHlwZShwbGF5YWJpbGl0eS5yZWFzb24gfHwgcGxheWFiaWxpdHkubWVzc2FnZXMgJiYgcGxheWFiaWxpdHkubWVzc2FnZXNbMF0pOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CiAgLyoqCiAgICogRG9lcyBhIG1pbmlnZXQgcmVxdWVzdCBhbmQgY2FsbHMgb3B0aW9ucy5yZXF1ZXN0Q2FsbGJhY2sgaWYgcHJlc2VudAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCB0aGUgcmVxdWVzdCB1cmwKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBhbiBvYmplY3Qgd2l0aCBvcHRpb25hbCByZXF1ZXN0T3B0aW9ucyBhbmQgcmVxdWVzdENhbGxiYWNrIHBhcmFtZXRlcnMKICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdE9wdGlvbnNPdmVyd3JpdGUgb3ZlcndyaXRlIG9mIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMKICAgKiBAcmV0dXJucyB7bWluaWdldC5TdHJlYW19CiAgICovCgoKICBleHBvcnRzLmV4cG9zZWRNaW5pZ2V0ID0gKHVybCwgb3B0aW9ucyA9IHt9LCByZXF1ZXN0T3B0aW9uc092ZXJ3cml0ZSkgPT4gewogICAgY29uc3QgcmVxID0gbWluaWdldCh1cmwsIHJlcXVlc3RPcHRpb25zT3ZlcndyaXRlIHx8IG9wdGlvbnMucmVxdWVzdE9wdGlvbnMpOwogICAgaWYgKHR5cGVvZiBvcHRpb25zLnJlcXVlc3RDYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgb3B0aW9ucy5yZXF1ZXN0Q2FsbGJhY2socmVxKTsKICAgIHJldHVybiByZXE7CiAgfTsKICAvKioKICAgKiBUZW1wb3JhcnkgaGVscGVyIHRvIGhlbHAgZGVwcmVjYXRpbmcgYSBmZXcgcHJvcGVydGllcy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmoKICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcAogICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRQYXRoCiAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1BhdGgKICAgKi8KCgogIGV4cG9ydHMuZGVwcmVjYXRlID0gKG9iaiwgcHJvcCwgdmFsdWUsIG9sZFBhdGgsIG5ld1BhdGgpID0+IHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIHByb3AsIHsKICAgICAgZ2V0OiAoKSA9PiB7CiAgICAgICAgY29uc29sZS53YXJuKGBcYCR7b2xkUGF0aH1cYCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBuZWFyIGZ1dHVyZSByZWxlYXNlLCBgICsgYHVzZSBcYCR7bmV3UGF0aH1cYCBpbnN0ZWFkLmApOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgfTsgLy8gQ2hlY2sgZm9yIHVwZGF0ZXMuCgoKICBjb25zdCBwa2cgPSByZXF1aXJlJCQ4OwogIGNvbnN0IFVQREFURV9JTlRFUlZBTCA9IDEwMDAgKiA2MCAqIDYwICogMTI7CiAgZXhwb3J0cy5sYXN0VXBkYXRlQ2hlY2sgPSAwOwoKICBleHBvcnRzLmNoZWNrRm9yVXBkYXRlcyA9ICgpID0+IHsKICAgIGlmICghcHJvY2Vzcy5lbnYuWVRETF9OT19VUERBVEUgJiYgIXBrZy52ZXJzaW9uLnN0YXJ0c1dpdGgoJzAuMC4wLScpICYmIERhdGUubm93KCkgLSBleHBvcnRzLmxhc3RVcGRhdGVDaGVjayA+PSBVUERBVEVfSU5URVJWQUwpIHsKICAgICAgZXhwb3J0cy5sYXN0VXBkYXRlQ2hlY2sgPSBEYXRlLm5vdygpOwogICAgICByZXR1cm4gbWluaWdldCgnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9mZW50L25vZGUteXRkbC1jb3JlL3JlbGVhc2VzL2xhdGVzdCcsIHsKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAnVXNlci1BZ2VudCc6ICd5dGRsLWNvcmUnCiAgICAgICAgfQogICAgICB9KS50ZXh0KCkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgaWYgKEpTT04ucGFyc2UocmVzcG9uc2UpLnRhZ19uYW1lICE9PSBgdiR7cGtnLnZlcnNpb259YCkgewogICAgICAgICAgY29uc29sZS53YXJuKCdceDFiWzMzbVdBUk5JTkc6XHgxQlswbSB5dGRsLWNvcmUgaXMgb3V0IG9mIGRhdGUhIFVwZGF0ZSB3aXRoICJucG0gaW5zdGFsbCB5dGRsLWNvcmVAbGF0ZXN0Ii4nKTsKICAgICAgICB9CiAgICAgIH0sIGVyciA9PiB7CiAgICAgICAgY29uc29sZS53YXJuKCdFcnJvciBjaGVja2luZyBmb3IgdXBkYXRlczonLCBlcnIubWVzc2FnZSk7CiAgICAgICAgY29uc29sZS53YXJuKCdZb3UgY2FuIGRpc2FibGUgdGhpcyBjaGVjayBieSBzZXR0aW5nIHRoZSBgWVRETF9OT19VUERBVEVgIGVudiB2YXJpYWJsZS4nKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfTsKICAvKioKICAgKiBHZXRzIHJhbmRvbSBJUHY2IEFkZHJlc3MgZnJvbSBhIGJsb2NrCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaXAgdGhlIElQdjYgYmxvY2sgaW4gQ0lEUi1Ob3RhdGlvbgogICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgICovCgoKICBleHBvcnRzLmdldFJhbmRvbUlQdjYgPSBpcCA9PiB7CiAgICAvLyBTdGFydCB3aXRoIGEgZmFzdCBSZWdleC1DaGVjawogICAgaWYgKCFpc0lQdjYoaXApKSB0aHJvdyBFcnJvcignSW52YWxpZCBJUHY2IGZvcm1hdCcpOyAvLyBTdGFydCBieSBzcGxpdHRpbmcgYW5kIG5vcm1hbGl6aW5nIGFkZHIgYW5kIG1hc2sKCiAgICBjb25zdCBbcmF3QWRkciwgcmF3TWFza10gPSBpcC5zcGxpdCgnLycpOwogICAgbGV0IGJhc2UxME1hc2sgPSBwYXJzZUludChyYXdNYXNrKTsKICAgIGlmICghYmFzZTEwTWFzayB8fCBiYXNlMTBNYXNrID4gMTI4IHx8IGJhc2UxME1hc2sgPCAyNCkgdGhyb3cgRXJyb3IoJ0ludmFsaWQgSVB2NiBzdWJuZXQnKTsKICAgIGNvbnN0IGJhc2UxMGFkZHIgPSBub3JtYWxpemVJUChyYXdBZGRyKTsgLy8gR2V0IHJhbmRvbSBhZGRyIHRvIHBhZCB3aXRoCiAgICAvLyB1c2luZyBNYXRoLnJhbmRvbSBzaW5jZSB3ZSdyZSBub3QgcmVxdWlyaW5nIGhpZ2ggbGV2ZWwgb2YgcmFuZG9tbmVzcwoKICAgIGNvbnN0IHJhbmRvbUFkZHIgPSBuZXcgQXJyYXkoOCkuZmlsbCgxKS5tYXAoKCkgPT4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMHhmZmZmKSk7IC8vIE1lcmdlIGJhc2UxMGFkZHIgd2l0aCByYW5kb21BZGRyCgogICAgY29uc3QgbWVyZ2VkQWRkciA9IHJhbmRvbUFkZHIubWFwKChyYW5kb21JdGVtLCBpZHgpID0+IHsKICAgICAgLy8gQ2FsY3VsYXRlIHRoZSBhbW91bnQgb2Ygc3RhdGljIGJpdHMKICAgICAgY29uc3Qgc3RhdGljQml0cyA9IE1hdGgubWluKGJhc2UxME1hc2ssIDE2KTsgLy8gQWRqdXN0IHRoZSBiaXRtYXNrIHdpdGggdGhlIHN0YXRpY0JpdHMKCiAgICAgIGJhc2UxME1hc2sgLT0gc3RhdGljQml0czsgLy8gQ2FsY3VsYXRlIHRoZSBiaXRtYXNrCiAgICAgIC8vIGxzYiBtYWtlcyB0aGUgY2FsY3VsYXRpb24gd2F5IG1vcmUgY29tcGxpY2F0ZWQKCiAgICAgIGNvbnN0IG1hc2sgPSAweGZmZmYgLSAoMiAqKiAoMTYgLSBzdGF0aWNCaXRzKSAtIDEpOyAvLyBDb21iaW5lIGJhc2UxMGFkZHIgYW5kIHJhbmRvbQoKICAgICAgcmV0dXJuIChiYXNlMTBhZGRyW2lkeF0gJiBtYXNrKSArIChyYW5kb21JdGVtICYgKG1hc2sgXiAweGZmZmYpKTsKICAgIH0pOyAvLyBSZXR1cm4gbmV3IGFkZHIKCiAgICByZXR1cm4gbWVyZ2VkQWRkci5tYXAoeCA9PiB4LnRvU3RyaW5nKCcxNicpKS5qb2luKCc6Jyk7CiAgfTsgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW4KCgogIGNvbnN0IElQVjZfUkVHRVggPSAvXigoWzAtOWEtZl17MSw0fTopKDpbMC05YS1mXXsxLDR9KXsxLDZ9fChbMC05YS1mXXsxLDR9Oil7MSwyfSg6WzAtOWEtZl17MSw0fSl7MSw1fXwoWzAtOWEtZl17MSw0fTopezEsM30oOlswLTlhLWZdezEsNH0pezEsNH18KFswLTlhLWZdezEsNH06KXsxLDR9KDpbMC05YS1mXXsxLDR9KXsxLDN9fChbMC05YS1mXXsxLDR9Oil7MSw1fSg6WzAtOWEtZl17MSw0fSl7MSwyfXwoWzAtOWEtZl17MSw0fTopezEsNn0oOlswLTlhLWZdezEsNH0pfChbMC05YS1mXXsxLDR9Oil7MSw3fSgoWzAtOWEtZl17MSw0fSl8OikpXC8oMVswLTFdXGR8MTJbMC04XXxcZHsxLDJ9KSQvOwogIC8qKgogICAqIFF1aWNrIGNoZWNrIGZvciBhIHZhbGlkIElQdjYKICAgKiBUaGUgUmVnZXggb25seSBhY2NlcHRzIGEgc3Vic2V0IG9mIGFsbCBJUHY2IEFkZHJlc3NlcwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlwIHRoZSBJUHY2IGJsb2NrIGluIENJRFItTm90YXRpb24gdG8gdGVzdAogICAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIHZhbGlkCiAgICovCgogIGNvbnN0IGlzSVB2NiA9IGV4cG9ydHMuaXNJUHY2ID0gaXAgPT4gSVBWNl9SRUdFWC50ZXN0KGlwKTsKICAvKioKICAgKiBOb3JtYWxpc2UgYW4gSVAgQWRkcmVzcwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlwIHRoZSBJUHY2IEFkZHIKICAgKiBAcmV0dXJucyB7bnVtYmVyW119IHRoZSA4IHBhcnRzIG9mIHRoZSBJUHY2IGFzIEludGVnZXJzCiAgICovCgoKICBjb25zdCBub3JtYWxpemVJUCA9IGV4cG9ydHMubm9ybWFsaXplSVAgPSBpcCA9PiB7CiAgICAvLyBTcGxpdCBieSBmaWxsIHBvc2l0aW9uCiAgICBjb25zdCBwYXJ0cyA9IGlwLnNwbGl0KCc6OicpLm1hcCh4ID0+IHguc3BsaXQoJzonKSk7IC8vIE5vcm1hbGl6ZSBzdGFydCBhbmQgZW5kCgogICAgY29uc3QgcGFydFN0YXJ0ID0gcGFydHNbMF0gfHwgW107CiAgICBjb25zdCBwYXJ0RW5kID0gcGFydHNbMV0gfHwgW107CiAgICBwYXJ0RW5kLnJldmVyc2UoKTsgLy8gUGxhY2Vob2xkZXIgZm9yIGZ1bGwgaXAKCiAgICBjb25zdCBmdWxsSVAgPSBuZXcgQXJyYXkoOCkuZmlsbCgwKTsgLy8gRmlsbCBpbiBzdGFydCBhbmQgZW5kIHBhcnRzCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNYXRoLm1pbihwYXJ0U3RhcnQubGVuZ3RoLCA4KTsgaSsrKSB7CiAgICAgIGZ1bGxJUFtpXSA9IHBhcnNlSW50KHBhcnRTdGFydFtpXSwgMTYpIHx8IDA7CiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNYXRoLm1pbihwYXJ0RW5kLmxlbmd0aCwgOCk7IGkrKykgewogICAgICBmdWxsSVBbNyAtIGldID0gcGFyc2VJbnQocGFydEVuZFtpXSwgMTYpIHx8IDA7CiAgICB9CgogICAgcmV0dXJuIGZ1bGxJUDsKICB9Owp9KSh1dGlscyQyKTsKCnZhciBmb3JtYXRVdGlscyQxID0ge307CgovKioKICogaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Zb3VUdWJlI1F1YWxpdHlfYW5kX2Zvcm1hdHMKICovCnZhciBmb3JtYXRzID0gewogIDU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vZmx2OyBjb2RlY3M9IlNvcmVuc29uIEguMjgzLCBtcDMiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAnLAogICAgYml0cmF0ZTogMjUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA2NAogIH0sCiAgNjogewogICAgbWltZVR5cGU6ICd2aWRlby9mbHY7IGNvZGVjcz0iU29yZW5zb24gSC4yNjMsIG1wMyInLAogICAgcXVhbGl0eUxhYmVsOiAnMjcwcCcsCiAgICBiaXRyYXRlOiA4MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDY0CiAgfSwKICAxMzogewogICAgbWltZVR5cGU6ICd2aWRlby8zZ3A7IGNvZGVjcz0iTVBFRy00IFZpc3VhbCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiA1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDE3OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvLzNncDsgY29kZWNzPSJNUEVHLTQgVmlzdWFsLCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzE0NHAnLAogICAgYml0cmF0ZTogNTAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDI0CiAgfSwKICAxODogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiA1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDk2CiAgfSwKICAyMjogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNzIwcCcsCiAgICBiaXRyYXRlOiAyMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAxOTIKICB9LAogIDM0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL2ZsdjsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICczNjBwJywKICAgIGJpdHJhdGU6IDUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICAzNTogewogICAgbWltZVR5cGU6ICd2aWRlby9mbHY7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNDgwcCcsCiAgICBiaXRyYXRlOiA4MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgMzY6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vM2dwOyBjb2RlY3M9Ik1QRUctNCBWaXN1YWwsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMjQwcCcsCiAgICBiaXRyYXRlOiAxNzUwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDMyCiAgfSwKICAzNzogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMTA4MHAnLAogICAgYml0cmF0ZTogMzAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICAzODogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzA3MnAnLAogICAgYml0cmF0ZTogMzUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICA0MzogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOCwgdm9yYmlzIicsCiAgICBxdWFsaXR5TGFiZWw6ICczNjBwJywKICAgIGJpdHJhdGU6IDUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICA0NDogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOCwgdm9yYmlzIicsCiAgICBxdWFsaXR5TGFiZWw6ICc0ODBwJywKICAgIGJpdHJhdGU6IDEwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgNDU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDgsIHZvcmJpcyInLAogICAgcXVhbGl0eUxhYmVsOiAnNzIwcCcsCiAgICBiaXRyYXRlOiAyMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAxOTIKICB9LAogIDQ2OiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3dlYm07IGNvZGVjcz0idnA4LCB2b3JiaXMiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE5MgogIH0sCiAgODI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzM2MHAnLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA5NgogIH0sCiAgODM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAnLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA5NgogIH0sCiAgODQ6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzcyMHAnLAogICAgYml0cmF0ZTogMjAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICA4NTogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMTA4MHAnLAogICAgYml0cmF0ZTogMzAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICA5MTogewogICAgbWltZVR5cGU6ICd2aWRlby90czsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICcxNDRwJywKICAgIGJpdHJhdGU6IDEwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogNDgKICB9LAogIDkyOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3RzOyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAnLAogICAgYml0cmF0ZTogMTUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA0OAogIH0sCiAgOTM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiA1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgOTQ6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNDgwcCcsCiAgICBiaXRyYXRlOiA4MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgOTU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNzIwcCcsCiAgICBiaXRyYXRlOiAxNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAyNTYKICB9LAogIDk2OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3RzOyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IDI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDI1NgogIH0sCiAgMTAwOiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3dlYm07IGNvZGVjcz0iVlA4LCB2b3JiaXMiJywKICAgIHF1YWxpdHlMYWJlbDogJzM2MHAnLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICAxMDE6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vd2VibTsgY29kZWNzPSJWUDgsIHZvcmJpcyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiAxOTIKICB9LAogIDEwMjogewogICAgbWltZVR5cGU6ICdhdWRpby93ZWJtOyBjb2RlY3M9IlZQOCwgdm9yYmlzIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE5MgogIH0sCiAgMTIwOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL2ZsdjsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDIwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgMTI3OiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3RzOyBjb2RlY3M9ImFhYyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogOTYKICB9LAogIDEyODogewogICAgbWltZVR5cGU6ICdhdWRpby90czsgY29kZWNzPSJhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogbnVsbCwKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDk2CiAgfSwKICAxMzI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMjQwcCcsCiAgICBiaXRyYXRlOiAxNTAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDQ4CiAgfSwKICAxMzM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0IicsCiAgICBxdWFsaXR5TGFiZWw6ICcyNDBwJywKICAgIGJpdHJhdGU6IDIwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMTM0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiAzMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDEzNTogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzQ4MHAnLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAxMzY6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0IicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDEwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDEzNzogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IDI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDEzODogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzQzMjBwJywKICAgIGJpdHJhdGU6IDEzNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAxMzk6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vbXA0OyBjb2RlY3M9ImFhYyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogNDgKICB9LAogIDE0MDogewogICAgbWltZVR5cGU6ICdhdWRpby9tNGE7IGNvZGVjcz0iYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiAxMjgKICB9LAogIDE0MTogewogICAgbWltZVR5cGU6ICdhdWRpby9tcDQ7IGNvZGVjcz0iYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiAyNTYKICB9LAogIDE1MTogewogICAgbWltZVR5cGU6ICd2aWRlby90czsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAyNAogIH0sCiAgMTYwOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0cCcsCiAgICBiaXRyYXRlOiAxMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDE3MTogewogICAgbWltZVR5cGU6ICdhdWRpby93ZWJtOyBjb2RlY3M9InZvcmJpcyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICAxNzI6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vd2VibTsgY29kZWNzPSJ2b3JiaXMiJywKICAgIHF1YWxpdHlMYWJlbDogbnVsbCwKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE5MgogIH0sCiAgMjQyOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcyNDBwJywKICAgIGJpdHJhdGU6IDEwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQzOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICczNjBwJywKICAgIGJpdHJhdGU6IDI1MDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQ0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICc0ODBwJywKICAgIGJpdHJhdGU6IDUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQ3OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDcwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQ4OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxMDgwcCcsCiAgICBiaXRyYXRlOiAxNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAyNDk6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vd2VibTsgY29kZWNzPSJvcHVzIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiA0OAogIH0sCiAgMjUwOiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3dlYm07IGNvZGVjcz0ib3B1cyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogNjQKICB9LAogIDI1MTogewogICAgbWltZVR5cGU6ICdhdWRpby93ZWJtOyBjb2RlY3M9Im9wdXMiJywKICAgIHF1YWxpdHlMYWJlbDogbnVsbCwKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE2MAogIH0sCiAgMjY0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0MHAnLAogICAgYml0cmF0ZTogNDAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjY2OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMjE2MHAnLAogICAgYml0cmF0ZTogMTI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDI3MTogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0MHAnLAogICAgYml0cmF0ZTogOTAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjcyOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICc0MzIwcCcsCiAgICBiaXRyYXRlOiAyMDAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjc4OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxNDRwIDMwZnBzJywKICAgIGJpdHJhdGU6IDgwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAyOTg6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0IicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDMwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDI5OTogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IDU1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMwMDogewogICAgbWltZVR5cGU6ICd2aWRlby90czsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDEzMTgwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDQ4CiAgfSwKICAzMDI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzcyMHAgSEZSJywKICAgIGJpdHJhdGU6IDI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMwMzogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMTA4MHAgSEZSJywKICAgIGJpdHJhdGU6IDUwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMwODogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0MHAgSEZSJywKICAgIGJpdHJhdGU6IDEwMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMTM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzIxNjBwJywKICAgIGJpdHJhdGU6IDEzMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMTU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzIxNjBwIEhGUicsCiAgICBiaXRyYXRlOiAyMDAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMzMwOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxNDRwIEhEUiwgSEZSJywKICAgIGJpdHJhdGU6IDgwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzE6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzM2MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMjUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzQ6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzcyMHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMTAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMzM1OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxMDgwcCBIRFIsIEhGUicsCiAgICBiaXRyYXRlOiAxNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzY6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzE0NDBwIEhEUiwgSEZSJywKICAgIGJpdHJhdGU6IDUwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMzNzogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMjE2MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMTIwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9Cn07CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKICBjb25zdCB1dGlscyA9IHV0aWxzJDI7CiAgY29uc3QgRk9STUFUUyA9IGZvcm1hdHM7IC8vIFVzZSB0aGVzZSB0byBoZWxwIHNvcnQgZm9ybWF0cywgaGlnaGVyIGluZGV4IGlzIGJldHRlci4KCiAgY29uc3QgYXVkaW9FbmNvZGluZ1JhbmtzID0gWydtcDRhJywgJ21wMycsICd2b3JiaXMnLCAnYWFjJywgJ29wdXMnLCAnZmxhYyddOwogIGNvbnN0IHZpZGVvRW5jb2RpbmdSYW5rcyA9IFsnbXA0dicsICdhdmMxJywgJ1NvcmVuc29uIEguMjgzJywgJ01QRUctNCBWaXN1YWwnLCAnVlA4JywgJ1ZQOScsICdILjI2NCddOwoKICBjb25zdCBnZXRWaWRlb0JpdHJhdGUgPSBmb3JtYXQgPT4gZm9ybWF0LmJpdHJhdGUgfHwgMDsKCiAgY29uc3QgZ2V0VmlkZW9FbmNvZGluZ1JhbmsgPSBmb3JtYXQgPT4gdmlkZW9FbmNvZGluZ1JhbmtzLmZpbmRJbmRleChlbmMgPT4gZm9ybWF0LmNvZGVjcyAmJiBmb3JtYXQuY29kZWNzLmluY2x1ZGVzKGVuYykpOwoKICBjb25zdCBnZXRBdWRpb0JpdHJhdGUgPSBmb3JtYXQgPT4gZm9ybWF0LmF1ZGlvQml0cmF0ZSB8fCAwOwoKICBjb25zdCBnZXRBdWRpb0VuY29kaW5nUmFuayA9IGZvcm1hdCA9PiBhdWRpb0VuY29kaW5nUmFua3MuZmluZEluZGV4KGVuYyA9PiBmb3JtYXQuY29kZWNzICYmIGZvcm1hdC5jb2RlY3MuaW5jbHVkZXMoZW5jKSk7CiAgLyoqCiAgICogU29ydCBmb3JtYXRzIGJ5IGEgbGlzdCBvZiBmdW5jdGlvbnMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gYQogICAqIEBwYXJhbSB7T2JqZWN0fSBiCiAgICogQHBhcmFtIHtBcnJheS48RnVuY3Rpb24+fSBzb3J0QnkKICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqLwoKCiAgY29uc3Qgc29ydEZvcm1hdHNCeSA9IChhLCBiLCBzb3J0QnkpID0+IHsKICAgIGxldCByZXMgPSAwOwoKICAgIGZvciAobGV0IGZuIG9mIHNvcnRCeSkgewogICAgICByZXMgPSBmbihiKSAtIGZuKGEpOwoKICAgICAgaWYgKHJlcyAhPT0gMCkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9OwoKICBjb25zdCBzb3J0Rm9ybWF0c0J5VmlkZW8gPSAoYSwgYikgPT4gc29ydEZvcm1hdHNCeShhLCBiLCBbZm9ybWF0ID0+IHBhcnNlSW50KGZvcm1hdC5xdWFsaXR5TGFiZWwpLCBnZXRWaWRlb0JpdHJhdGUsIGdldFZpZGVvRW5jb2RpbmdSYW5rXSk7CgogIGNvbnN0IHNvcnRGb3JtYXRzQnlBdWRpbyA9IChhLCBiKSA9PiBzb3J0Rm9ybWF0c0J5KGEsIGIsIFtnZXRBdWRpb0JpdHJhdGUsIGdldEF1ZGlvRW5jb2RpbmdSYW5rXSk7CiAgLyoqCiAgICogU29ydCBmb3JtYXRzIGZyb20gaGlnaGVzdCBxdWFsaXR5IHRvIGxvd2VzdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBhCiAgICogQHBhcmFtIHtPYmplY3R9IGIKICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqLwoKCiAgZXhwb3J0cy5zb3J0Rm9ybWF0cyA9IChhLCBiKSA9PiBzb3J0Rm9ybWF0c0J5KGEsIGIsIFsvLyBGb3JtYXRzIHdpdGggYm90aCB2aWRlbyBhbmQgYXVkaW8gYXJlIHJhbmtlZCBoaWdoZXN0LgogIGZvcm1hdCA9PiArISFmb3JtYXQuaXNITFMsIGZvcm1hdCA9PiArISFmb3JtYXQuaXNEYXNoTVBELCBmb3JtYXQgPT4gKyhmb3JtYXQuY29udGVudExlbmd0aCA+IDApLCBmb3JtYXQgPT4gKyhmb3JtYXQuaGFzVmlkZW8gJiYgZm9ybWF0Lmhhc0F1ZGlvKSwgZm9ybWF0ID0+ICtmb3JtYXQuaGFzVmlkZW8sIGZvcm1hdCA9PiBwYXJzZUludChmb3JtYXQucXVhbGl0eUxhYmVsKSB8fCAwLCBnZXRWaWRlb0JpdHJhdGUsIGdldEF1ZGlvQml0cmF0ZSwgZ2V0VmlkZW9FbmNvZGluZ1JhbmssIGdldEF1ZGlvRW5jb2RpbmdSYW5rXSk7CiAgLyoqCiAgICogQ2hvb3NlIGEgZm9ybWF0IGRlcGVuZGluZyBvbiB0aGUgZ2l2ZW4gb3B0aW9ucy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXkuPE9iamVjdD59IGZvcm1hdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICogQHRocm93cyB7RXJyb3J9IHdoZW4gbm8gZm9ybWF0IG1hdGNoZXMgdGhlIGZpbHRlci9mb3JtYXQgcnVsZXMKICAgKi8KCgogIGV4cG9ydHMuY2hvb3NlRm9ybWF0ID0gKGZvcm1hdHMsIG9wdGlvbnMpID0+IHsKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5mb3JtYXQgPT09ICdvYmplY3QnKSB7CiAgICAgIGlmICghb3B0aW9ucy5mb3JtYXQudXJsKSB7CiAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgZm9ybWF0IGdpdmVuLCBkaWQgeW91IHVzZSBgeXRkbC5nZXRJbmZvKClgPycpOwogICAgICB9CgogICAgICByZXR1cm4gb3B0aW9ucy5mb3JtYXQ7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuZmlsdGVyKSB7CiAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgb3B0aW9ucy5maWx0ZXIpOwogICAgfSAvLyBXZSBjdXJyZW50bHkgb25seSBzdXBwb3J0IEhMUy1Gb3JtYXRzIGZvciBsaXZlc3RyZWFtcwogICAgLy8gU28gd2UgKG5vdykgcmVtb3ZlIGFsbCBub24tSExTIHN0cmVhbXMKCgogICAgaWYgKGZvcm1hdHMuc29tZShmbXQgPT4gZm10LmlzSExTKSkgewogICAgICBmb3JtYXRzID0gZm9ybWF0cy5maWx0ZXIoZm10ID0+IGZtdC5pc0hMUyB8fCAhZm10LmlzTGl2ZSk7CiAgICB9CgogICAgbGV0IGZvcm1hdDsKICAgIGNvbnN0IHF1YWxpdHkgPSBvcHRpb25zLnF1YWxpdHkgfHwgJ2hpZ2hlc3QnOwoKICAgIHN3aXRjaCAocXVhbGl0eSkgewogICAgICBjYXNlICdoaWdoZXN0JzoKICAgICAgICBmb3JtYXQgPSBmb3JtYXRzWzBdOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnbG93ZXN0JzoKICAgICAgICBmb3JtYXQgPSBmb3JtYXRzW2Zvcm1hdHMubGVuZ3RoIC0gMV07CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdoaWdoZXN0YXVkaW8nOgogICAgICAgIHsKICAgICAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgJ2F1ZGlvJyk7CiAgICAgICAgICBmb3JtYXRzLnNvcnQoc29ydEZvcm1hdHNCeUF1ZGlvKTsgLy8gRmlsdGVyIGZvciBvbmx5IHRoZSBiZXN0IGF1ZGlvIGZvcm1hdAoKICAgICAgICAgIGNvbnN0IGJlc3RBdWRpb0Zvcm1hdCA9IGZvcm1hdHNbMF07CiAgICAgICAgICBmb3JtYXRzID0gZm9ybWF0cy5maWx0ZXIoZiA9PiBzb3J0Rm9ybWF0c0J5QXVkaW8oYmVzdEF1ZGlvRm9ybWF0LCBmKSA9PT0gMCk7IC8vIENoZWNrIGZvciB0aGUgd29yc3QgdmlkZW8gcXVhbGl0eSBmb3IgdGhlIGJlc3QgYXVkaW8gcXVhbGl0eSBhbmQgcGljayBhY2NvcmRpbmcKICAgICAgICAgIC8vIFRoaXMgZG9lcyBub3QgbG9vc2UgZGVmYXVsdCBzb3J0aW5nIG9mIHZpZGVvIGVuY29kaW5nIGFuZCBiaXRyYXRlCgogICAgICAgICAgY29uc3Qgd29yc3RWaWRlb1F1YWxpdHkgPSBmb3JtYXRzLm1hcChmID0+IHBhcnNlSW50KGYucXVhbGl0eUxhYmVsKSB8fCAwKS5zb3J0KChhLCBiKSA9PiBhIC0gYilbMF07CiAgICAgICAgICBmb3JtYXQgPSBmb3JtYXRzLmZpbmQoZiA9PiAocGFyc2VJbnQoZi5xdWFsaXR5TGFiZWwpIHx8IDApID09PSB3b3JzdFZpZGVvUXVhbGl0eSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdsb3dlc3RhdWRpbyc6CiAgICAgICAgZm9ybWF0cyA9IGV4cG9ydHMuZmlsdGVyRm9ybWF0cyhmb3JtYXRzLCAnYXVkaW8nKTsKICAgICAgICBmb3JtYXRzLnNvcnQoc29ydEZvcm1hdHNCeUF1ZGlvKTsKICAgICAgICBmb3JtYXQgPSBmb3JtYXRzW2Zvcm1hdHMubGVuZ3RoIC0gMV07CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdoaWdoZXN0dmlkZW8nOgogICAgICAgIHsKICAgICAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgJ3ZpZGVvJyk7CiAgICAgICAgICBmb3JtYXRzLnNvcnQoc29ydEZvcm1hdHNCeVZpZGVvKTsgLy8gRmlsdGVyIGZvciBvbmx5IHRoZSBiZXN0IHZpZGVvIGZvcm1hdAoKICAgICAgICAgIGNvbnN0IGJlc3RWaWRlb0Zvcm1hdCA9IGZvcm1hdHNbMF07CiAgICAgICAgICBmb3JtYXRzID0gZm9ybWF0cy5maWx0ZXIoZiA9PiBzb3J0Rm9ybWF0c0J5VmlkZW8oYmVzdFZpZGVvRm9ybWF0LCBmKSA9PT0gMCk7IC8vIENoZWNrIGZvciB0aGUgd29yc3QgYXVkaW8gcXVhbGl0eSBmb3IgdGhlIGJlc3QgdmlkZW8gcXVhbGl0eSBhbmQgcGljayBhY2NvcmRpbmcKICAgICAgICAgIC8vIFRoaXMgZG9lcyBub3QgbG9vc2UgZGVmYXVsdCBzb3J0aW5nIG9mIGF1ZGlvIGVuY29kaW5nIGFuZCBiaXRyYXRlCgogICAgICAgICAgY29uc3Qgd29yc3RBdWRpb1F1YWxpdHkgPSBmb3JtYXRzLm1hcChmID0+IGYuYXVkaW9CaXRyYXRlIHx8IDApLnNvcnQoKGEsIGIpID0+IGEgLSBiKVswXTsKICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdHMuZmluZChmID0+IChmLmF1ZGlvQml0cmF0ZSB8fCAwKSA9PT0gd29yc3RBdWRpb1F1YWxpdHkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnbG93ZXN0dmlkZW8nOgogICAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgJ3ZpZGVvJyk7CiAgICAgICAgZm9ybWF0cy5zb3J0KHNvcnRGb3JtYXRzQnlWaWRlbyk7CiAgICAgICAgZm9ybWF0ID0gZm9ybWF0c1tmb3JtYXRzLmxlbmd0aCAtIDFdOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICBmb3JtYXQgPSBnZXRGb3JtYXRCeVF1YWxpdHkocXVhbGl0eSwgZm9ybWF0cyk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgaWYgKCFmb3JtYXQpIHsKICAgICAgdGhyb3cgRXJyb3IoYE5vIHN1Y2ggZm9ybWF0IGZvdW5kOiAke3F1YWxpdHl9YCk7CiAgICB9CgogICAgcmV0dXJuIGZvcm1hdDsKICB9OwogIC8qKgogICAqIEdldHMgYSBmb3JtYXQgYmFzZWQgb24gcXVhbGl0eSBvciBhcnJheSBvZiBxdWFsaXR5J3MKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfFtzdHJpbmddfSBxdWFsaXR5CiAgICogQHBhcmFtIHtbT2JqZWN0XX0gZm9ybWF0cwogICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICovCgoKICBjb25zdCBnZXRGb3JtYXRCeVF1YWxpdHkgPSAocXVhbGl0eSwgZm9ybWF0cykgPT4gewogICAgbGV0IGdldEZvcm1hdCA9IGl0YWcgPT4gZm9ybWF0cy5maW5kKGZvcm1hdCA9PiBgJHtmb3JtYXQuaXRhZ31gID09PSBgJHtpdGFnfWApOwoKICAgIGlmIChBcnJheS5pc0FycmF5KHF1YWxpdHkpKSB7CiAgICAgIHJldHVybiBnZXRGb3JtYXQocXVhbGl0eS5maW5kKHEgPT4gZ2V0Rm9ybWF0KHEpKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZ2V0Rm9ybWF0KHF1YWxpdHkpOwogICAgfQogIH07CiAgLyoqCiAgICogQHBhcmFtIHtBcnJheS48T2JqZWN0Pn0gZm9ybWF0cwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlcgogICAqIEByZXR1cm5zIHtBcnJheS48T2JqZWN0Pn0KICAgKi8KCgogIGV4cG9ydHMuZmlsdGVyRm9ybWF0cyA9IChmb3JtYXRzLCBmaWx0ZXIpID0+IHsKICAgIGxldCBmbjsKCiAgICBzd2l0Y2ggKGZpbHRlcikgewogICAgICBjYXNlICd2aWRlb2FuZGF1ZGlvJzoKICAgICAgY2FzZSAnYXVkaW9hbmR2aWRlbyc6CiAgICAgICAgZm4gPSBmb3JtYXQgPT4gZm9ybWF0Lmhhc1ZpZGVvICYmIGZvcm1hdC5oYXNBdWRpbzsKCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICd2aWRlbyc6CiAgICAgICAgZm4gPSBmb3JtYXQgPT4gZm9ybWF0Lmhhc1ZpZGVvOwoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3ZpZGVvb25seSc6CiAgICAgICAgZm4gPSBmb3JtYXQgPT4gZm9ybWF0Lmhhc1ZpZGVvICYmICFmb3JtYXQuaGFzQXVkaW87CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnYXVkaW8nOgogICAgICAgIGZuID0gZm9ybWF0ID0+IGZvcm1hdC5oYXNBdWRpbzsKCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdhdWRpb29ubHknOgogICAgICAgIGZuID0gZm9ybWF0ID0+ICFmb3JtYXQuaGFzVmlkZW8gJiYgZm9ybWF0Lmhhc0F1ZGlvOwoKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKHR5cGVvZiBmaWx0ZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGZuID0gZmlsdGVyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoYEdpdmVuIGZpbHRlciAoJHtmaWx0ZXJ9KSBpcyBub3Qgc3VwcG9ydGVkYCk7CiAgICAgICAgfQoKICAgIH0KCiAgICByZXR1cm4gZm9ybWF0cy5maWx0ZXIoZm9ybWF0ID0+ICEhZm9ybWF0LnVybCAmJiBmbihmb3JtYXQpKTsKICB9OwogIC8qKgogICAqIEBwYXJhbSB7T2JqZWN0fSBmb3JtYXQKICAgKiBAcmV0dXJucyB7T2JqZWN0fQogICAqLwoKCiAgZXhwb3J0cy5hZGRGb3JtYXRNZXRhID0gZm9ybWF0ID0+IHsKICAgIGZvcm1hdCA9IE9iamVjdC5hc3NpZ24oe30sIEZPUk1BVFNbZm9ybWF0Lml0YWddLCBmb3JtYXQpOwogICAgZm9ybWF0Lmhhc1ZpZGVvID0gISFmb3JtYXQucXVhbGl0eUxhYmVsOwogICAgZm9ybWF0Lmhhc0F1ZGlvID0gISFmb3JtYXQuYXVkaW9CaXRyYXRlOwogICAgZm9ybWF0LmNvbnRhaW5lciA9IGZvcm1hdC5taW1lVHlwZSA/IGZvcm1hdC5taW1lVHlwZS5zcGxpdCgnOycpWzBdLnNwbGl0KCcvJylbMV0gOiBudWxsOwogICAgZm9ybWF0LmNvZGVjcyA9IGZvcm1hdC5taW1lVHlwZSA/IHV0aWxzLmJldHdlZW4oZm9ybWF0Lm1pbWVUeXBlLCAnY29kZWNzPSInLCAnIicpIDogbnVsbDsKICAgIGZvcm1hdC52aWRlb0NvZGVjID0gZm9ybWF0Lmhhc1ZpZGVvICYmIGZvcm1hdC5jb2RlY3MgPyBmb3JtYXQuY29kZWNzLnNwbGl0KCcsICcpWzBdIDogbnVsbDsKICAgIGZvcm1hdC5hdWRpb0NvZGVjID0gZm9ybWF0Lmhhc0F1ZGlvICYmIGZvcm1hdC5jb2RlY3MgPyBmb3JtYXQuY29kZWNzLnNwbGl0KCcsICcpLnNsaWNlKC0xKVswXSA6IG51bGw7CiAgICBmb3JtYXQuaXNMaXZlID0gL1xic291cmNlWy89XXl0X2xpdmVfYnJvYWRjYXN0XGIvLnRlc3QoZm9ybWF0LnVybCk7CiAgICBmb3JtYXQuaXNITFMgPSAvXC9tYW5pZmVzdFwvaGxzXyh2YXJpYW50fHBsYXlsaXN0KVwvLy50ZXN0KGZvcm1hdC51cmwpOwogICAgZm9ybWF0LmlzRGFzaE1QRCA9IC9cL21hbmlmZXN0XC9kYXNoXC8vLnRlc3QoZm9ybWF0LnVybCk7CiAgICByZXR1cm4gZm9ybWF0OwogIH07Cn0pKGZvcm1hdFV0aWxzJDEpOwoKdmFyIHVybFV0aWxzJDEgPSB7fTsKCi8qKgogKiBHZXQgdmlkZW8gSUQuCiAqCiAqIFRoZXJlIGFyZSBhIGZldyB0eXBlIG9mIHZpZGVvIFVSTCBmb3JtYXRzLgogKiAgLSBodHRwczovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PVZJREVPX0lECiAqICAtIGh0dHBzOi8vbS55b3V0dWJlLmNvbS93YXRjaD92PVZJREVPX0lECiAqICAtIGh0dHBzOi8veW91dHUuYmUvVklERU9fSUQKICogIC0gaHR0cHM6Ly93d3cueW91dHViZS5jb20vdi9WSURFT19JRAogKiAgLSBodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC9WSURFT19JRAogKiAgLSBodHRwczovL211c2ljLnlvdXR1YmUuY29tL3dhdGNoP3Y9VklERU9fSUQKICogIC0gaHR0cHM6Ly9nYW1pbmcueW91dHViZS5jb20vd2F0Y2g/dj1WSURFT19JRAogKgogKiBAcGFyYW0ge3N0cmluZ30gbGluawogKiBAcmV0dXJuIHtzdHJpbmd9CiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB1bmFibGUgdG8gZmluZCBhIGlkCiAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gSWYgdmlkZW9pZCBkb2Vzbid0IG1hdGNoIHNwZWNzCiAqLwoKKGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgY29uc3QgdmFsaWRRdWVyeURvbWFpbnMgPSBuZXcgU2V0KFsneW91dHViZS5jb20nLCAnd3d3LnlvdXR1YmUuY29tJywgJ20ueW91dHViZS5jb20nLCAnbXVzaWMueW91dHViZS5jb20nLCAnZ2FtaW5nLnlvdXR1YmUuY29tJ10pOwogIGNvbnN0IHZhbGlkUGF0aERvbWFpbnMgPSAvXmh0dHBzPzpcL1wvKHlvdXR1XC5iZVwvfCh3d3dcLik/eW91dHViZVwuY29tXC8oZW1iZWR8dnxzaG9ydHMpXC8pLzsKCiAgZXhwb3J0cy5nZXRVUkxWaWRlb0lEID0gbGluayA9PiB7CiAgICBjb25zdCBwYXJzZWQgPSBuZXcgVVJMKGxpbmsudHJpbSgpKTsKICAgIGxldCBpZCA9IHBhcnNlZC5zZWFyY2hQYXJhbXMuZ2V0KCd2Jyk7CgogICAgaWYgKHZhbGlkUGF0aERvbWFpbnMudGVzdChsaW5rLnRyaW0oKSkgJiYgIWlkKSB7CiAgICAgIGNvbnN0IHBhdGhzID0gcGFyc2VkLnBhdGhuYW1lLnNwbGl0KCcvJyk7CiAgICAgIGlkID0gcGFyc2VkLmhvc3QgPT09ICd5b3V0dS5iZScgPyBwYXRoc1sxXSA6IHBhdGhzWzJdOwogICAgfSBlbHNlIGlmIChwYXJzZWQuaG9zdG5hbWUgJiYgIXZhbGlkUXVlcnlEb21haW5zLmhhcyhwYXJzZWQuaG9zdG5hbWUpKSB7CiAgICAgIHRocm93IEVycm9yKCdOb3QgYSBZb3VUdWJlIGRvbWFpbicpOwogICAgfQoKICAgIGlmICghaWQpIHsKICAgICAgdGhyb3cgRXJyb3IoYE5vIHZpZGVvIGlkIGZvdW5kOiAiJHtsaW5rfSJgKTsKICAgIH0KCiAgICBpZCA9IGlkLnN1YnN0cmluZygwLCAxMSk7CgogICAgaWYgKCFleHBvcnRzLnZhbGlkYXRlSUQoaWQpKSB7CiAgICAgIHRocm93IFR5cGVFcnJvcihgVmlkZW8gaWQgKCR7aWR9KSBkb2VzIG5vdCBtYXRjaCBleHBlY3RlZCBgICsgYGZvcm1hdCAoJHtpZFJlZ2V4LnRvU3RyaW5nKCl9KWApOwogICAgfQoKICAgIHJldHVybiBpZDsKICB9OwogIC8qKgogICAqIEdldHMgdmlkZW8gSUQgZWl0aGVyIGZyb20gYSB1cmwgb3IgYnkgY2hlY2tpbmcgaWYgdGhlIGdpdmVuIHN0cmluZwogICAqIG1hdGNoZXMgdGhlIHZpZGVvIElEIGZvcm1hdC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBzdHIKICAgKiBAcmV0dXJucyB7c3RyaW5nfQogICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB1bmFibGUgdG8gZmluZCBhIGlkCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBJZiB2aWRlb2lkIGRvZXNuJ3QgbWF0Y2ggc3BlY3MKICAgKi8KCgogIGNvbnN0IHVybFJlZ2V4ID0gL15odHRwcz86XC9cLy87CgogIGV4cG9ydHMuZ2V0VmlkZW9JRCA9IHN0ciA9PiB7CiAgICBpZiAoZXhwb3J0cy52YWxpZGF0ZUlEKHN0cikpIHsKICAgICAgcmV0dXJuIHN0cjsKICAgIH0gZWxzZSBpZiAodXJsUmVnZXgudGVzdChzdHIudHJpbSgpKSkgewogICAgICByZXR1cm4gZXhwb3J0cy5nZXRVUkxWaWRlb0lEKHN0cik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBFcnJvcihgTm8gdmlkZW8gaWQgZm91bmQ6ICR7c3RyfWApOwogICAgfQogIH07CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIGdpdmVuIGlkIHNhdGlmaWVzIFlvdVR1YmUncyBpZCBmb3JtYXQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaWQKICAgKiBAcmV0dXJuIHtib29sZWFufQogICAqLwoKCiAgY29uc3QgaWRSZWdleCA9IC9eW2EtekEtWjAtOS1fXXsxMX0kLzsKCiAgZXhwb3J0cy52YWxpZGF0ZUlEID0gaWQgPT4gaWRSZWdleC50ZXN0KGlkLnRyaW0oKSk7CiAgLyoqCiAgICogQ2hlY2tzIHdldGhlciB0aGUgaW5wdXQgc3RyaW5nIGluY2x1ZGVzIGEgdmFsaWQgaWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nCiAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICovCgoKICBleHBvcnRzLnZhbGlkYXRlVVJMID0gc3RyaW5nID0+IHsKICAgIHRyeSB7CiAgICAgIGV4cG9ydHMuZ2V0VVJMVmlkZW9JRChzdHJpbmcpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07Cn0pKHVybFV0aWxzJDEpOwoKdmFyIGluZm9FeHRyYXMgPSB7fTsKCnZhciBtM3U4UGFyc2VyJDEgPSB7fTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShtM3U4UGFyc2VyJDEsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCBzdHJlYW1fMSQyID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQxWyJkZWZhdWx0Il07Ci8qKgogKiBBIHZlcnkgc2ltcGxlIG0zdTggcGxheWxpc3QgZmlsZSBwYXJzZXIgdGhhdCBkZXRlY3RzIHRhZ3MgYW5kIHNlZ21lbnRzLgogKi8KCmNsYXNzIG0zdThQYXJzZXIgZXh0ZW5kcyBzdHJlYW1fMSQyLldyaXRhYmxlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLl9sYXN0TGluZSA9ICcnOwogICAgdGhpcy5fc2VxID0gMDsKICAgIHRoaXMuX25leHRJdGVtRHVyYXRpb24gPSBudWxsOwogICAgdGhpcy5fbmV4dEl0ZW1SYW5nZSA9IG51bGw7CiAgICB0aGlzLl9sYXN0SXRlbVJhbmdlRW5kID0gMDsKICAgIHRoaXMub24oJ2ZpbmlzaCcsICgpID0+IHsKICAgICAgdGhpcy5fcGFyc2VMaW5lKHRoaXMuX2xhc3RMaW5lKTsKCiAgICAgIHRoaXMuZW1pdCgnZW5kJyk7CiAgICB9KTsKICB9CgogIF9wYXJzZUF0dHJMaXN0KHZhbHVlKSB7CiAgICBsZXQgYXR0cnMgPSB7fTsKICAgIGxldCByZWdleCA9IC8oW0EtWjAtOS1dKyk9KD86IihbXiJdKj8pInwoW14sXSo/KSkvZzsKICAgIGxldCBtYXRjaDsKCiAgICB3aGlsZSAoKG1hdGNoID0gcmVnZXguZXhlYyh2YWx1ZSkpICE9PSBudWxsKSB7CiAgICAgIGF0dHJzW21hdGNoWzFdXSA9IG1hdGNoWzJdIHx8IG1hdGNoWzNdOwogICAgfQoKICAgIHJldHVybiBhdHRyczsKICB9CgogIF9wYXJzZVJhbmdlKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlKSByZXR1cm4gbnVsbDsKICAgIGxldCBzdmFsdWUgPSB2YWx1ZS5zcGxpdCgnQCcpOwogICAgbGV0IHN0YXJ0ID0gc3ZhbHVlWzFdID8gcGFyc2VJbnQoc3ZhbHVlWzFdKSA6IHRoaXMuX2xhc3RJdGVtUmFuZ2VFbmQgKyAxOwogICAgbGV0IGVuZCA9IHN0YXJ0ICsgcGFyc2VJbnQoc3ZhbHVlWzBdKSAtIDE7CiAgICBsZXQgcmFuZ2UgPSB7CiAgICAgIHN0YXJ0LAogICAgICBlbmQKICAgIH07CiAgICB0aGlzLl9sYXN0SXRlbVJhbmdlRW5kID0gcmFuZ2UuZW5kOwogICAgcmV0dXJuIHJhbmdlOwogIH0KCiAgX3BhcnNlTGluZShsaW5lKSB7CiAgICBsZXQgbWF0Y2ggPSBsaW5lLm1hdGNoKC9eIyhFWFRbQS1aMC05LV0rKSg/OjooLiopKT8vKTsKCiAgICBpZiAobWF0Y2gpIHsKICAgICAgLy8gVGhpcyBpcyBhIHRhZy4KICAgICAgY29uc3QgdGFnID0gbWF0Y2hbMV07CiAgICAgIGNvbnN0IHZhbHVlID0gbWF0Y2hbMl0gfHwgJyc7CgogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgJ0VYVC1YLVBST0dSQU0tREFURS1USU1FJzoKICAgICAgICAgIHRoaXMuZW1pdCgnc3RhcnR0aW1lJywgbmV3IERhdGUodmFsdWUpLmdldFRpbWUoKSk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRVhULVgtTUVESUEtU0VRVUVOQ0UnOgogICAgICAgICAgdGhpcy5fc2VxID0gcGFyc2VJbnQodmFsdWUpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0VYVC1YLU1BUCc6CiAgICAgICAgICB7CiAgICAgICAgICAgIGxldCBhdHRycyA9IHRoaXMuX3BhcnNlQXR0ckxpc3QodmFsdWUpOwoKICAgICAgICAgICAgaWYgKCFhdHRycy5VUkkpIHsKICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdgRVhULVgtTUFQYCBmb3VuZCB3aXRob3V0IHJlcXVpcmVkIGF0dHJpYnV0ZSBgVVJJYCcpKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICB1cmw6IGF0dHJzLlVSSSwKICAgICAgICAgICAgICBzZXE6IHRoaXMuX3NlcSwKICAgICAgICAgICAgICBpbml0OiB0cnVlLAogICAgICAgICAgICAgIGR1cmF0aW9uOiAwLAogICAgICAgICAgICAgIHJhbmdlOiB0aGlzLl9wYXJzZVJhbmdlKGF0dHJzLkJZVEVSQU5HRSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICBjYXNlICdFWFQtWC1CWVRFUkFOR0UnOgogICAgICAgICAgewogICAgICAgICAgICB0aGlzLl9uZXh0SXRlbVJhbmdlID0gdGhpcy5fcGFyc2VSYW5nZSh2YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICBjYXNlICdFWFRJTkYnOgogICAgICAgICAgdGhpcy5fbmV4dEl0ZW1EdXJhdGlvbiA9IE1hdGgucm91bmQocGFyc2VGbG9hdCh2YWx1ZS5zcGxpdCgnLCcpWzBdKSAqIDEwMDApOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0VYVC1YLUVORExJU1QnOgogICAgICAgICAgdGhpcy5lbWl0KCdlbmRsaXN0Jyk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfSBlbHNlIGlmICghL14jLy50ZXN0KGxpbmUpICYmIGxpbmUudHJpbSgpKSB7CiAgICAgIC8vIFRoaXMgaXMgYSBzZWdtZW50CiAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICB1cmw6IGxpbmUudHJpbSgpLAogICAgICAgIHNlcTogdGhpcy5fc2VxKyssCiAgICAgICAgZHVyYXRpb246IHRoaXMuX25leHRJdGVtRHVyYXRpb24sCiAgICAgICAgcmFuZ2U6IHRoaXMuX25leHRJdGVtUmFuZ2UKICAgICAgfSk7CiAgICAgIHRoaXMuX25leHRJdGVtUmFuZ2UgPSBudWxsOwogICAgfQogIH0KCiAgX3dyaXRlKGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spIHsKICAgIGxldCBsaW5lcyA9IGNodW5rLnRvU3RyaW5nKCd1dGY4Jykuc3BsaXQoJ1xuJyk7CgogICAgaWYgKHRoaXMuX2xhc3RMaW5lKSB7CiAgICAgIGxpbmVzWzBdID0gdGhpcy5fbGFzdExpbmUgKyBsaW5lc1swXTsKICAgIH0KCiAgICBsaW5lcy5mb3JFYWNoKChsaW5lLCBpKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuOwoKICAgICAgaWYgKGkgPCBsaW5lcy5sZW5ndGggLSAxKSB7CiAgICAgICAgdGhpcy5fcGFyc2VMaW5lKGxpbmUpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNhdmUgdGhlIGxhc3QgbGluZSBpbiBjYXNlIGl0IGhhcyBiZWVuIGJyb2tlbiB1cC4KICAgICAgICB0aGlzLl9sYXN0TGluZSA9IGxpbmU7CiAgICAgIH0KICAgIH0pOwogICAgY2FsbGJhY2soKTsKICB9Cgp9CgptM3U4UGFyc2VyJDEuZGVmYXVsdCA9IG0zdThQYXJzZXI7Cgp2YXIgZGFzaE1wZFBhcnNlciA9IHt9OwoKdmFyIHBhcnNlVGltZSA9IHt9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHBhcnNlVGltZSwgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CnBhcnNlVGltZS5kdXJhdGlvblN0ciA9IHBhcnNlVGltZS5odW1hblN0ciA9IHZvaWQgMDsKY29uc3QgbnVtYmVyRm9ybWF0ID0gL15cZCskLzsKY29uc3QgdGltZUZvcm1hdCA9IC9eKD86KD86KFxkKyk6KT8oXGR7MSwyfSk6KT8oXGR7MSwyfSkoPzpcLihcZHszfSkpPyQvOwpjb25zdCB0aW1lVW5pdHMgPSB7CiAgbXM6IDEsCiAgczogMTAwMCwKICBtOiA2MDAwMCwKICBoOiAzNjAwMDAwCn07Ci8qKgogKiBDb252ZXJ0cyBodW1hbiBmcmllbmRseSB0aW1lIHRvIG1pbGxpc2Vjb25kcy4gU3VwcG9ydHMgdGhlIGZvcm1hdAogKiAwMDowMDowMC4wMDAgZm9yIGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzLCBhbmQgbWlsbGlzZWNvbmRzIHJlc3BlY3RpdmVseS4KICogQW5kIDBtcywgMHMsIDBtLCAwaCwgYW5kIHRvZ2V0aGVyIDFtMXMuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gdGltZQogKiBAcmV0dXJucyB7bnVtYmVyfQogKi8KCnBhcnNlVGltZS5odW1hblN0ciA9IHRpbWUgPT4gewogIGlmICh0eXBlb2YgdGltZSA9PT0gJ251bWJlcicpIHsKICAgIHJldHVybiB0aW1lOwogIH0KCiAgaWYgKG51bWJlckZvcm1hdC50ZXN0KHRpbWUpKSB7CiAgICByZXR1cm4gK3RpbWU7CiAgfQoKICBjb25zdCBmaXJzdEZvcm1hdCA9IHRpbWVGb3JtYXQuZXhlYyh0aW1lKTsKCiAgaWYgKGZpcnN0Rm9ybWF0KSB7CiAgICByZXR1cm4gKyhmaXJzdEZvcm1hdFsxXSB8fCAwKSAqIHRpbWVVbml0cy5oICsgKyhmaXJzdEZvcm1hdFsyXSB8fCAwKSAqIHRpbWVVbml0cy5tICsgK2ZpcnN0Rm9ybWF0WzNdICogdGltZVVuaXRzLnMgKyArKGZpcnN0Rm9ybWF0WzRdIHx8IDApOwogIH0gZWxzZSB7CiAgICBsZXQgdG90YWwgPSAwOwogICAgY29uc3QgciA9IC8oLT9cZCspKG1zfHN8bXxoKS9nOwogICAgbGV0IHJzOwoKICAgIHdoaWxlICgocnMgPSByLmV4ZWModGltZSkpICE9PSBudWxsKSB7CiAgICAgIHRvdGFsICs9ICtyc1sxXSAqIHRpbWVVbml0c1tyc1syXV07CiAgICB9CgogICAgcmV0dXJuIHRvdGFsOwogIH0KfTsKLyoqCiAqIFBhcnNlcyBhIGR1cmF0aW9uIHN0cmluZyBpbiB0aGUgZm9ybSBvZiAiMTIzLjQ1NlMiLCByZXR1cm5zIG1pbGxpc2Vjb25kcy4KICoKICogQHBhcmFtIHtzdHJpbmd9IHRpbWUKICogQHJldHVybnMge251bWJlcn0KICovCgoKcGFyc2VUaW1lLmR1cmF0aW9uU3RyID0gdGltZSA9PiB7CiAgbGV0IHRvdGFsID0gMDsKICBjb25zdCByID0gLyhcZCsoPzpcLlxkKyk/KShTfE18SCkvZzsKICBsZXQgcnM7CgogIHdoaWxlICgocnMgPSByLmV4ZWModGltZSkpICE9PSBudWxsKSB7CiAgICB0b3RhbCArPSArcnNbMV0gKiB0aW1lVW5pdHNbcnNbMl0udG9Mb3dlckNhc2UoKV07CiAgfQoKICByZXR1cm4gdG90YWw7Cn07Cgp2YXIgX19pbXBvcnREZWZhdWx0JDEgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2ltcG9ydERlZmF1bHQgfHwgZnVuY3Rpb24gKG1vZCkgewogIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAiZGVmYXVsdCI6IG1vZAogIH07Cn07CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZGFzaE1wZFBhcnNlciwgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmNvbnN0IHN0cmVhbV8xJDEgPSByZXF1aXJlJCQwX19kZWZhdWx0JDFbImRlZmF1bHQiXTsKCmNvbnN0IHNheF8xID0gX19pbXBvcnREZWZhdWx0JDEoc2F4KTsKCmNvbnN0IHBhcnNlX3RpbWVfMSQxID0gcGFyc2VUaW1lOwovKioKICogQSB3cmFwcGVyIGFyb3VuZCBzYXggdGhhdCBlbWl0cyBzZWdtZW50cy4KICovCgpjbGFzcyBEYXNoTVBEUGFyc2VyIGV4dGVuZHMgc3RyZWFtXzEkMS5Xcml0YWJsZSB7CiAgY29uc3RydWN0b3IodGFyZ2V0SUQpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLl9wYXJzZXIgPSBzYXhfMS5kZWZhdWx0LmNyZWF0ZVN0cmVhbShmYWxzZSwgewogICAgICBsb3dlcmNhc2U6IHRydWUKICAgIH0pOwoKICAgIHRoaXMuX3BhcnNlci5vbignZXJyb3InLCB0aGlzLmRlc3Ryb3kuYmluZCh0aGlzKSk7CgogICAgbGV0IGxhc3RUYWc7CiAgICBsZXQgY3VycnRpbWUgPSAwOwogICAgbGV0IHNlcSA9IDA7CiAgICBsZXQgc2VnbWVudFRlbXBsYXRlOwogICAgbGV0IHRpbWVzY2FsZSwgb2Zmc2V0LCBkdXJhdGlvbiwgYmFzZVVSTDsKICAgIGxldCB0aW1lbGluZSA9IFtdOwogICAgbGV0IGdldFNlZ21lbnRzID0gZmFsc2U7CiAgICBsZXQgZ290U2VnbWVudHMgPSBmYWxzZTsKICAgIGxldCBpc1N0YXRpYzsKICAgIGxldCB0cmVlTGV2ZWw7CiAgICBsZXQgcGVyaW9kU3RhcnQ7CgogICAgY29uc3QgdG1wbCA9IHN0ciA9PiB7CiAgICAgIGNvbnN0IGNvbnRleHQgPSB7CiAgICAgICAgUmVwcmVzZW50YXRpb25JRDogdGFyZ2V0SUQsCiAgICAgICAgTnVtYmVyOiBzZXEsCiAgICAgICAgVGltZTogY3VycnRpbWUKICAgICAgfTsKICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9cJChcdyspXCQvZywgKG0sIHAxKSA9PiBgJHtjb250ZXh0W3AxXX1gKTsKICAgIH07CgogICAgdGhpcy5fcGFyc2VyLm9uKCdvcGVudGFnJywgbm9kZSA9PiB7CiAgICAgIHN3aXRjaCAobm9kZS5uYW1lKSB7CiAgICAgICAgY2FzZSAnbXBkJzoKICAgICAgICAgIGN1cnJ0aW1lID0gbm9kZS5hdHRyaWJ1dGVzLmF2YWlsYWJpbGl0eXN0YXJ0dGltZSA/IG5ldyBEYXRlKG5vZGUuYXR0cmlidXRlcy5hdmFpbGFiaWxpdHlzdGFydHRpbWUpLmdldFRpbWUoKSA6IDA7CiAgICAgICAgICBpc1N0YXRpYyA9IG5vZGUuYXR0cmlidXRlcy50eXBlICE9PSAnZHluYW1pYyc7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncGVyaW9kJzoKICAgICAgICAgIC8vIFJlc2V0IGV2ZXJ5dGhpbmcgb24gPFBlcmlvZD4gdGFnLgogICAgICAgICAgc2VxID0gMDsKICAgICAgICAgIHRpbWVzY2FsZSA9IDEwMDA7CiAgICAgICAgICBkdXJhdGlvbiA9IDA7CiAgICAgICAgICBvZmZzZXQgPSAwOwogICAgICAgICAgYmFzZVVSTCA9IFtdOwogICAgICAgICAgdHJlZUxldmVsID0gMDsKICAgICAgICAgIHBlcmlvZFN0YXJ0ID0gcGFyc2VfdGltZV8xJDEuZHVyYXRpb25TdHIobm9kZS5hdHRyaWJ1dGVzLnN0YXJ0KSB8fCAwOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3NlZ21lbnRsaXN0JzoKICAgICAgICAgIHNlcSA9IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5zdGFydG51bWJlcikgfHwgc2VxOwogICAgICAgICAgdGltZXNjYWxlID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLnRpbWVzY2FsZSkgfHwgdGltZXNjYWxlOwogICAgICAgICAgZHVyYXRpb24gPSBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMuZHVyYXRpb24pIHx8IGR1cmF0aW9uOwogICAgICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLnByZXNlbnRhdGlvbnRpbWVvZmZzZXQpIHx8IG9mZnNldDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdzZWdtZW50dGVtcGxhdGUnOgogICAgICAgICAgc2VnbWVudFRlbXBsYXRlID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgc2VxID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLnN0YXJ0bnVtYmVyKSB8fCBzZXE7CiAgICAgICAgICB0aW1lc2NhbGUgPSBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMudGltZXNjYWxlKSB8fCB0aW1lc2NhbGU7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc2VnbWVudHRpbWVsaW5lJzoKICAgICAgICBjYXNlICdiYXNldXJsJzoKICAgICAgICAgIGxhc3RUYWcgPSBub2RlLm5hbWU7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncyc6CiAgICAgICAgICB0aW1lbGluZS5wdXNoKHsKICAgICAgICAgICAgZHVyYXRpb246IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5kKSwKICAgICAgICAgICAgcmVwZWF0OiBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMuciksCiAgICAgICAgICAgIHRpbWU6IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy50KQogICAgICAgICAgfSk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnYWRhcHRhdGlvbnNldCc6CiAgICAgICAgY2FzZSAncmVwcmVzZW50YXRpb24nOgogICAgICAgICAgdHJlZUxldmVsKys7CgogICAgICAgICAgaWYgKCF0YXJnZXRJRCkgewogICAgICAgICAgICB0YXJnZXRJRCA9IG5vZGUuYXR0cmlidXRlcy5pZDsKICAgICAgICAgIH0KCiAgICAgICAgICBnZXRTZWdtZW50cyA9IG5vZGUuYXR0cmlidXRlcy5pZCA9PT0gYCR7dGFyZ2V0SUR9YDsKCiAgICAgICAgICBpZiAoZ2V0U2VnbWVudHMpIHsKICAgICAgICAgICAgaWYgKHBlcmlvZFN0YXJ0KSB7CiAgICAgICAgICAgICAgY3VycnRpbWUgKz0gcGVyaW9kU3RhcnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKICAgICAgICAgICAgICBjdXJydGltZSAtPSBvZmZzZXQgLyB0aW1lc2NhbGUgKiAxMDAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmVtaXQoJ3N0YXJ0dGltZScsIGN1cnJ0aW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnaW5pdGlhbGl6YXRpb24nOgogICAgICAgICAgaWYgKGdldFNlZ21lbnRzKSB7CiAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICB1cmw6IGJhc2VVUkwuZmlsdGVyKHMgPT4gISFzKS5qb2luKCcnKSArIG5vZGUuYXR0cmlidXRlcy5zb3VyY2V1cmwsCiAgICAgICAgICAgICAgc2VxOiBzZXEsCiAgICAgICAgICAgICAgaW5pdDogdHJ1ZSwKICAgICAgICAgICAgICBkdXJhdGlvbjogMAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc2VnbWVudHVybCc6CiAgICAgICAgICBpZiAoZ2V0U2VnbWVudHMpIHsKICAgICAgICAgICAgZ290U2VnbWVudHMgPSB0cnVlOwogICAgICAgICAgICBsZXQgdGwgPSB0aW1lbGluZS5zaGlmdCgpOwogICAgICAgICAgICBsZXQgc2VnbWVudER1cmF0aW9uID0gKCh0bCA9PT0gbnVsbCB8fCB0bCA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGwuZHVyYXRpb24pIHx8IGR1cmF0aW9uKSAvIHRpbWVzY2FsZSAqIDEwMDA7CiAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICB1cmw6IGJhc2VVUkwuZmlsdGVyKHMgPT4gISFzKS5qb2luKCcnKSArIG5vZGUuYXR0cmlidXRlcy5tZWRpYSwKICAgICAgICAgICAgICBzZXE6IHNlcSsrLAogICAgICAgICAgICAgIGR1cmF0aW9uOiBzZWdtZW50RHVyYXRpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGN1cnJ0aW1lICs9IHNlZ21lbnREdXJhdGlvbjsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfSk7CgogICAgY29uc3Qgb25FbmQgPSAoKSA9PiB7CiAgICAgIGlmIChpc1N0YXRpYykgewogICAgICAgIHRoaXMuZW1pdCgnZW5kbGlzdCcpOwogICAgICB9CgogICAgICBpZiAoIWdldFNlZ21lbnRzKSB7CiAgICAgICAgdGhpcy5kZXN0cm95KEVycm9yKGBSZXByZXNlbnRhdGlvbiAnJHt0YXJnZXRJRH0nIG5vdCBmb3VuZGApKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmVtaXQoJ2VuZCcpOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuX3BhcnNlci5vbignY2xvc2V0YWcnLCB0YWdOYW1lID0+IHsKICAgICAgc3dpdGNoICh0YWdOYW1lKSB7CiAgICAgICAgY2FzZSAnYWRhcHRhdGlvbnNldCc6CiAgICAgICAgY2FzZSAncmVwcmVzZW50YXRpb24nOgogICAgICAgICAgdHJlZUxldmVsLS07CgogICAgICAgICAgaWYgKHNlZ21lbnRUZW1wbGF0ZSAmJiB0aW1lbGluZS5sZW5ndGgpIHsKICAgICAgICAgICAgZ290U2VnbWVudHMgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHNlZ21lbnRUZW1wbGF0ZS5pbml0aWFsaXphdGlvbikgewogICAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICAgIHVybDogYmFzZVVSTC5maWx0ZXIocyA9PiAhIXMpLmpvaW4oJycpICsgdG1wbChzZWdtZW50VGVtcGxhdGUuaW5pdGlhbGl6YXRpb24pLAogICAgICAgICAgICAgICAgc2VxOiBzZXEsCiAgICAgICAgICAgICAgICBpbml0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IDAKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChsZXQgewogICAgICAgICAgICAgIGR1cmF0aW9uOiBpdGVtRHVyYXRpb24sCiAgICAgICAgICAgICAgcmVwZWF0LAogICAgICAgICAgICAgIHRpbWUKICAgICAgICAgICAgfSBvZiB0aW1lbGluZSkgewogICAgICAgICAgICAgIGl0ZW1EdXJhdGlvbiA9IGl0ZW1EdXJhdGlvbiAvIHRpbWVzY2FsZSAqIDEwMDA7CiAgICAgICAgICAgICAgcmVwZWF0ID0gcmVwZWF0IHx8IDE7CiAgICAgICAgICAgICAgY3VycnRpbWUgPSB0aW1lIHx8IGN1cnJ0aW1lOwoKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlcGVhdDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2l0ZW0nLCB7CiAgICAgICAgICAgICAgICAgIHVybDogYmFzZVVSTC5maWx0ZXIocyA9PiAhIXMpLmpvaW4oJycpICsgdG1wbChzZWdtZW50VGVtcGxhdGUubWVkaWEpLAogICAgICAgICAgICAgICAgICBzZXE6IHNlcSsrLAogICAgICAgICAgICAgICAgICBkdXJhdGlvbjogaXRlbUR1cmF0aW9uCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGN1cnJ0aW1lICs9IGl0ZW1EdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZ290U2VnbWVudHMpIHsKICAgICAgICAgICAgdGhpcy5lbWl0KCdlbmRlYXJseScpOwogICAgICAgICAgICBvbkVuZCgpOwoKICAgICAgICAgICAgdGhpcy5fcGFyc2VyLnJlbW92ZUFsbExpc3RlbmVycygpOwoKICAgICAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2ZpbmlzaCcpOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLl9wYXJzZXIub24oJ3RleHQnLCB0ZXh0ID0+IHsKICAgICAgaWYgKGxhc3RUYWcgPT09ICdiYXNldXJsJykgewogICAgICAgIGJhc2VVUkxbdHJlZUxldmVsXSA9IHRleHQ7CiAgICAgICAgbGFzdFRhZyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMub24oJ2ZpbmlzaCcsIG9uRW5kKTsKICB9CgogIF93cml0ZShjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7CiAgICB0aGlzLl9wYXJzZXIud3JpdGUoY2h1bmspOwoKICAgIGNhbGxiYWNrKCk7CiAgfQoKfQoKZGFzaE1wZFBhcnNlci5kZWZhdWx0ID0gRGFzaE1QRFBhcnNlcjsKCnZhciBxdWV1ZSA9IHt9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHF1ZXVlLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKcXVldWUuUXVldWUgPSB2b2lkIDA7CgpjbGFzcyBRdWV1ZSB7CiAgLyoqCiAgICogQSByZWFsbHkgc2ltcGxlIHF1ZXVlIHdpdGggY29uY3VycmVuY3kuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSB3b3JrZXIKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEBwYXJhbSB7IW51bWJlcn0gb3B0aW9ucy5jb25jdXJyZW5jeQogICAqLwogIGNvbnN0cnVjdG9yKHdvcmtlciwgb3B0aW9ucyA9IHt9KSB7CiAgICB0aGlzLl93b3JrZXIgPSB3b3JrZXI7CiAgICB0aGlzLl9jb25jdXJyZW5jeSA9IG9wdGlvbnMuY29uY3VycmVuY3kgfHwgMTsKICAgIHRoaXMudGFza3MgPSBbXTsKICAgIHRoaXMudG90YWwgPSAwOwogICAgdGhpcy5hY3RpdmUgPSAwOwogIH0KICAvKioKICAgKiBQdXNoIGEgdGFzayB0byB0aGUgcXVldWUuCiAgICoKICAgKiAgQHBhcmFtIHtUfSBpdGVtCiAgICogIEBwYXJhbSB7IUZ1bmN0aW9ufSBjYWxsYmFjawogICAqLwoKCiAgcHVzaChpdGVtLCBjYWxsYmFjaykgewogICAgdGhpcy50YXNrcy5wdXNoKHsKICAgICAgaXRlbSwKICAgICAgY2FsbGJhY2sKICAgIH0pOwogICAgdGhpcy50b3RhbCsrOwoKICAgIHRoaXMuX25leHQoKTsKICB9CiAgLyoqCiAgICogUHJvY2VzcyBuZXh0IGpvYiBpbiBxdWV1ZS4KICAgKi8KCgogIF9uZXh0KCkgewogICAgaWYgKHRoaXMuYWN0aXZlID49IHRoaXMuX2NvbmN1cnJlbmN5IHx8ICF0aGlzLnRhc2tzLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgewogICAgICBpdGVtLAogICAgICBjYWxsYmFjawogICAgfSA9IHRoaXMudGFza3Muc2hpZnQoKTsKICAgIGxldCBjYWxsYmFja0NhbGxlZCA9IGZhbHNlOwogICAgdGhpcy5hY3RpdmUrKzsKCiAgICB0aGlzLl93b3JrZXIoaXRlbSwgKGVyciwgcmVzdWx0KSA9PiB7CiAgICAgIGlmIChjYWxsYmFja0NhbGxlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5hY3RpdmUtLTsKICAgICAgY2FsbGJhY2tDYWxsZWQgPSB0cnVlOwogICAgICBjYWxsYmFjayA9PT0gbnVsbCB8fCBjYWxsYmFjayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2FsbGJhY2soZXJyLCByZXN1bHQpOwoKICAgICAgdGhpcy5fbmV4dCgpOwogICAgfSk7CiAgfQogIC8qKgogICAqIFN0b3BzIHByb2Nlc3NpbmcgcXVldWVkIGpvYnMuCiAgICovCgoKICBkaWUoKSB7CiAgICB0aGlzLnRhc2tzID0gW107CiAgfQoKfQoKcXVldWUuUXVldWUgPSBRdWV1ZTsKCnZhciBfX2ltcG9ydERlZmF1bHQgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2ltcG9ydERlZmF1bHQgfHwgZnVuY3Rpb24gKG1vZCkgewogIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAiZGVmYXVsdCI6IG1vZAogIH07Cn07Cgpjb25zdCBzdHJlYW1fMSA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMVsiZGVmYXVsdCJdOwoKY29uc3QgbWluaWdldF8xID0gX19pbXBvcnREZWZhdWx0KGRpc3QkMSk7Cgpjb25zdCBtM3U4X3BhcnNlcl8xID0gX19pbXBvcnREZWZhdWx0KG0zdThQYXJzZXIkMSk7Cgpjb25zdCBkYXNoX21wZF9wYXJzZXJfMSA9IF9faW1wb3J0RGVmYXVsdChkYXNoTXBkUGFyc2VyKTsKCmNvbnN0IHF1ZXVlXzEgPSBxdWV1ZTsKY29uc3QgcGFyc2VfdGltZV8xID0gcGFyc2VUaW1lOwpjb25zdCBzdXBwb3J0ZWRQYXJzZXJzID0gewogIG0zdTg6IG0zdThfcGFyc2VyXzEuZGVmYXVsdCwKICAnZGFzaC1tcGQnOiBkYXNoX21wZF9wYXJzZXJfMS5kZWZhdWx0Cn07CgpsZXQgbTN1OHN0cmVhbSQxID0gKHBsYXlsaXN0VVJMLCBvcHRpb25zID0ge30pID0+IHsKICBjb25zdCBzdHJlYW0gPSBuZXcgc3RyZWFtXzEuUGFzc1Rocm91Z2goewogICAgaGlnaFdhdGVyTWFyazogb3B0aW9ucy5oaWdoV2F0ZXJNYXJrCiAgfSk7CiAgY29uc3QgY2h1bmtSZWFkYWhlYWQgPSBvcHRpb25zLmNodW5rUmVhZGFoZWFkIHx8IDM7IC8vIDIwIHNlY29uZHMuCgogIGNvbnN0IGxpdmVCdWZmZXIgPSBvcHRpb25zLmxpdmVCdWZmZXIgfHwgMjAwMDA7CiAgY29uc3QgcmVxdWVzdE9wdGlvbnMgPSBvcHRpb25zLnJlcXVlc3RPcHRpb25zOwogIGNvbnN0IFBhcnNlciA9IHN1cHBvcnRlZFBhcnNlcnNbb3B0aW9ucy5wYXJzZXIgfHwgKC9cLm1wZCQvLnRlc3QocGxheWxpc3RVUkwpID8gJ2Rhc2gtbXBkJyA6ICdtM3U4JyldOwoKICBpZiAoIVBhcnNlcikgewogICAgdGhyb3cgVHlwZUVycm9yKGBwYXJzZXIgJyR7b3B0aW9ucy5wYXJzZXJ9JyBub3Qgc3VwcG9ydGVkYCk7CiAgfQoKICBsZXQgYmVnaW4gPSAwOwoKICBpZiAodHlwZW9mIG9wdGlvbnMuYmVnaW4gIT09ICd1bmRlZmluZWQnKSB7CiAgICBiZWdpbiA9IHR5cGVvZiBvcHRpb25zLmJlZ2luID09PSAnc3RyaW5nJyA/IHBhcnNlX3RpbWVfMS5odW1hblN0cihvcHRpb25zLmJlZ2luKSA6IE1hdGgubWF4KG9wdGlvbnMuYmVnaW4gLSBsaXZlQnVmZmVyLCAwKTsKICB9CgogIGNvbnN0IGZvcndhcmRFdmVudHMgPSByZXEgPT4gewogICAgZm9yIChsZXQgZXZlbnQgb2YgWydhYm9ydCcsICdyZXF1ZXN0JywgJ3Jlc3BvbnNlJywgJ3JlZGlyZWN0JywgJ3JldHJ5JywgJ3JlY29ubmVjdCddKSB7CiAgICAgIHJlcS5vbihldmVudCwgc3RyZWFtLmVtaXQuYmluZChzdHJlYW0sIGV2ZW50KSk7CiAgICB9CiAgfTsKCiAgbGV0IGN1cnJTZWdtZW50OwogIGNvbnN0IHN0cmVhbVF1ZXVlID0gbmV3IHF1ZXVlXzEuUXVldWUoKHJlcSwgY2FsbGJhY2spID0+IHsKICAgIGN1cnJTZWdtZW50ID0gcmVxOyAvLyBDb3VudCB0aGUgc2l6ZSBtYW51YWxseSwgc2luY2UgdGhlIGBjb250ZW50LWxlbmd0aGAgaGVhZGVyIGlzIG5vdAogICAgLy8gYWx3YXlzIHRoZXJlLgoKICAgIGxldCBzaXplID0gMDsKICAgIHJlcS5vbignZGF0YScsIGNodW5rID0+IHNpemUgKz0gY2h1bmsubGVuZ3RoKTsKICAgIHJlcS5waXBlKHN0cmVhbSwgewogICAgICBlbmQ6IGZhbHNlCiAgICB9KTsKICAgIHJlcS5vbignZW5kJywgKCkgPT4gY2FsbGJhY2sobnVsbCwgc2l6ZSkpOwogIH0sIHsKICAgIGNvbmN1cnJlbmN5OiAxCiAgfSk7CiAgbGV0IHNlZ21lbnROdW1iZXIgPSAwOwogIGxldCBkb3dubG9hZGVkID0gMDsKICBjb25zdCByZXF1ZXN0UXVldWUgPSBuZXcgcXVldWVfMS5RdWV1ZSgoc2VnbWVudCwgY2FsbGJhY2spID0+IHsKICAgIGxldCByZXFPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxdWVzdE9wdGlvbnMpOwoKICAgIGlmIChzZWdtZW50LnJhbmdlKSB7CiAgICAgIHJlcU9wdGlvbnMuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHJlcU9wdGlvbnMuaGVhZGVycywgewogICAgICAgIFJhbmdlOiBgYnl0ZXM9JHtzZWdtZW50LnJhbmdlLnN0YXJ0fS0ke3NlZ21lbnQucmFuZ2UuZW5kfWAKICAgICAgfSk7CiAgICB9CgogICAgbGV0IHJlcSA9IG1pbmlnZXRfMS5kZWZhdWx0KG5ldyBVUkwoc2VnbWVudC51cmwsIHBsYXlsaXN0VVJMKS50b1N0cmluZygpLCByZXFPcHRpb25zKTsKICAgIHJlcS5vbignZXJyb3InLCBjYWxsYmFjayk7CiAgICBmb3J3YXJkRXZlbnRzKHJlcSk7CiAgICBzdHJlYW1RdWV1ZS5wdXNoKHJlcSwgKF8sIHNpemUpID0+IHsKICAgICAgZG93bmxvYWRlZCArPSArc2l6ZTsKICAgICAgc3RyZWFtLmVtaXQoJ3Byb2dyZXNzJywgewogICAgICAgIG51bTogKytzZWdtZW50TnVtYmVyLAogICAgICAgIHNpemU6IHNpemUsCiAgICAgICAgZHVyYXRpb246IHNlZ21lbnQuZHVyYXRpb24sCiAgICAgICAgdXJsOiBzZWdtZW50LnVybAogICAgICB9LCByZXF1ZXN0UXVldWUudG90YWwsIGRvd25sb2FkZWQpOwogICAgICBjYWxsYmFjayhudWxsKTsKICAgIH0pOwogIH0sIHsKICAgIGNvbmN1cnJlbmN5OiBjaHVua1JlYWRhaGVhZAogIH0pOwoKICBjb25zdCBvbkVycm9yID0gZXJyID0+IHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7IC8vIFN0b3Agb24gYW55IGVycm9yLgoKICAgIHN0cmVhbS5lbmQoKTsKICB9OyAvLyBXaGVuIHRvIGxvb2sgZm9yIGl0ZW1zIGFnYWluLgoKCiAgbGV0IHJlZnJlc2hUaHJlc2hvbGQ7CiAgbGV0IG1pblJlZnJlc2hUaW1lOwogIGxldCByZWZyZXNoVGltZW91dDsKICBsZXQgZmV0Y2hpbmdQbGF5bGlzdCA9IHRydWU7CiAgbGV0IGVuZGVkID0gZmFsc2U7CiAgbGV0IGlzU3RhdGljID0gZmFsc2U7CiAgbGV0IGxhc3RSZWZyZXNoOwoKICBjb25zdCBvblF1ZXVlZEVuZCA9IGVyciA9PiB7CiAgICBjdXJyU2VnbWVudCA9IG51bGw7CgogICAgaWYgKGVycikgewogICAgICBvbkVycm9yKGVycik7CiAgICB9IGVsc2UgaWYgKCFmZXRjaGluZ1BsYXlsaXN0ICYmICFlbmRlZCAmJiAhaXNTdGF0aWMgJiYgcmVxdWVzdFF1ZXVlLnRhc2tzLmxlbmd0aCArIHJlcXVlc3RRdWV1ZS5hY3RpdmUgPD0gcmVmcmVzaFRocmVzaG9sZCkgewogICAgICBsZXQgbXMgPSBNYXRoLm1heCgwLCBtaW5SZWZyZXNoVGltZSAtIChEYXRlLm5vdygpIC0gbGFzdFJlZnJlc2gpKTsKICAgICAgZmV0Y2hpbmdQbGF5bGlzdCA9IHRydWU7CiAgICAgIHJlZnJlc2hUaW1lb3V0ID0gc2V0VGltZW91dChyZWZyZXNoUGxheWxpc3QsIG1zKTsKICAgIH0gZWxzZSBpZiAoKGVuZGVkIHx8IGlzU3RhdGljKSAmJiAhcmVxdWVzdFF1ZXVlLnRhc2tzLmxlbmd0aCAmJiAhcmVxdWVzdFF1ZXVlLmFjdGl2ZSkgewogICAgICBzdHJlYW0uZW5kKCk7CiAgICB9CiAgfTsKCiAgbGV0IGN1cnJQbGF5bGlzdDsKICBsZXQgbGFzdFNlcTsKICBsZXQgc3RhcnR0aW1lID0gMDsKCiAgY29uc3QgcmVmcmVzaFBsYXlsaXN0ID0gKCkgPT4gewogICAgbGFzdFJlZnJlc2ggPSBEYXRlLm5vdygpOwogICAgY3VyclBsYXlsaXN0ID0gbWluaWdldF8xLmRlZmF1bHQocGxheWxpc3RVUkwsIHJlcXVlc3RPcHRpb25zKTsKICAgIGN1cnJQbGF5bGlzdC5vbignZXJyb3InLCBvbkVycm9yKTsKICAgIGZvcndhcmRFdmVudHMoY3VyclBsYXlsaXN0KTsKICAgIGNvbnN0IHBhcnNlciA9IGN1cnJQbGF5bGlzdC5waXBlKG5ldyBQYXJzZXIob3B0aW9ucy5pZCkpOwogICAgcGFyc2VyLm9uKCdzdGFydHRpbWUnLCBhID0+IHsKICAgICAgaWYgKHN0YXJ0dGltZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgc3RhcnR0aW1lID0gYTsKCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5iZWdpbiA9PT0gJ3N0cmluZycgJiYgYmVnaW4gPj0gMCkgewogICAgICAgIGJlZ2luICs9IHN0YXJ0dGltZTsKICAgICAgfQogICAgfSk7CiAgICBwYXJzZXIub24oJ2VuZGxpc3QnLCAoKSA9PiB7CiAgICAgIGlzU3RhdGljID0gdHJ1ZTsKICAgIH0pOwogICAgcGFyc2VyLm9uKCdlbmRlYXJseScsIGN1cnJQbGF5bGlzdC51bnBpcGUuYmluZChjdXJyUGxheWxpc3QsIHBhcnNlcikpOwogICAgbGV0IGFkZGVkSXRlbXMgPSBbXTsKCiAgICBjb25zdCBhZGRJdGVtID0gaXRlbSA9PiB7CiAgICAgIGlmICghaXRlbS5pbml0KSB7CiAgICAgICAgaWYgKGl0ZW0uc2VxIDw9IGxhc3RTZXEpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxhc3RTZXEgPSBpdGVtLnNlcTsKICAgICAgfQoKICAgICAgYmVnaW4gPSBpdGVtLnRpbWU7CiAgICAgIHJlcXVlc3RRdWV1ZS5wdXNoKGl0ZW0sIG9uUXVldWVkRW5kKTsKICAgICAgYWRkZWRJdGVtcy5wdXNoKGl0ZW0pOwogICAgfTsKCiAgICBsZXQgdGFpbGVkSXRlbXMgPSBbXSwKICAgICAgICB0YWlsZWRJdGVtc0R1cmF0aW9uID0gMDsKICAgIHBhcnNlci5vbignaXRlbScsIGl0ZW0gPT4gewogICAgICBsZXQgdGltZWRJdGVtID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICAgdGltZTogc3RhcnR0aW1lCiAgICAgIH0sIGl0ZW0pOwoKICAgICAgaWYgKGJlZ2luIDw9IHRpbWVkSXRlbS50aW1lKSB7CiAgICAgICAgYWRkSXRlbSh0aW1lZEl0ZW0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRhaWxlZEl0ZW1zLnB1c2godGltZWRJdGVtKTsKICAgICAgICB0YWlsZWRJdGVtc0R1cmF0aW9uICs9IHRpbWVkSXRlbS5kdXJhdGlvbjsgLy8gT25seSBrZWVwIHRoZSBsYXN0IGBsaXZlQnVmZmVyYCBvZiBpdGVtcy4KCiAgICAgICAgd2hpbGUgKHRhaWxlZEl0ZW1zLmxlbmd0aCA+IDEgJiYgdGFpbGVkSXRlbXNEdXJhdGlvbiAtIHRhaWxlZEl0ZW1zWzBdLmR1cmF0aW9uID4gbGl2ZUJ1ZmZlcikgewogICAgICAgICAgY29uc3QgbGFzdEl0ZW0gPSB0YWlsZWRJdGVtcy5zaGlmdCgpOwogICAgICAgICAgdGFpbGVkSXRlbXNEdXJhdGlvbiAtPSBsYXN0SXRlbS5kdXJhdGlvbjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHN0YXJ0dGltZSArPSB0aW1lZEl0ZW0uZHVyYXRpb247CiAgICB9KTsKICAgIHBhcnNlci5vbignZW5kJywgKCkgPT4gewogICAgICBjdXJyUGxheWxpc3QgPSBudWxsOyAvLyBJZiB3ZSBhcmUgdG9vIGFoZWFkIG9mIHRoZSBzdHJlYW0sIG1ha2Ugc3VyZSB0byBnZXQgdGhlCiAgICAgIC8vIGxhdGVzdCBhdmFpbGFibGUgaXRlbXMgd2l0aCBhIHNtYWxsIGJ1ZmZlci4KCiAgICAgIGlmICghYWRkZWRJdGVtcy5sZW5ndGggJiYgdGFpbGVkSXRlbXMubGVuZ3RoKSB7CiAgICAgICAgdGFpbGVkSXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgIGFkZEl0ZW0oaXRlbSk7CiAgICAgICAgfSk7CiAgICAgIH0gLy8gUmVmcmVzaCB0aGUgcGxheWxpc3Qgd2hlbiByZW1haW5pbmcgc2VnbWVudHMgZ2V0IGxvdy4KCgogICAgICByZWZyZXNoVGhyZXNob2xkID0gTWF0aC5tYXgoMSwgTWF0aC5jZWlsKGFkZGVkSXRlbXMubGVuZ3RoICogMC4wMSkpOyAvLyBUaHJvdHRsZSByZWZyZXNoaW5nIHRoZSBwbGF5bGlzdCBieSBsb29raW5nIGF0IHRoZSBkdXJhdGlvbgogICAgICAvLyBvZiBsaXZlIGl0ZW1zIGFkZGVkIG9uIHRoaXMgcmVmcmVzaC4KCiAgICAgIG1pblJlZnJlc2hUaW1lID0gYWRkZWRJdGVtcy5yZWR1Y2UoKHRvdGFsLCBpdGVtKSA9PiBpdGVtLmR1cmF0aW9uICsgdG90YWwsIDApOwogICAgICBmZXRjaGluZ1BsYXlsaXN0ID0gZmFsc2U7CiAgICAgIG9uUXVldWVkRW5kKG51bGwpOwogICAgfSk7CiAgfTsKCiAgcmVmcmVzaFBsYXlsaXN0KCk7CgogIHN0cmVhbS5lbmQgPSAoKSA9PiB7CiAgICBlbmRlZCA9IHRydWU7CiAgICBzdHJlYW1RdWV1ZS5kaWUoKTsKICAgIHJlcXVlc3RRdWV1ZS5kaWUoKTsKICAgIGNsZWFyVGltZW91dChyZWZyZXNoVGltZW91dCk7CiAgICBjdXJyUGxheWxpc3QgPT09IG51bGwgfHwgY3VyclBsYXlsaXN0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyUGxheWxpc3QuZGVzdHJveSgpOwogICAgY3VyclNlZ21lbnQgPT09IG51bGwgfHwgY3VyclNlZ21lbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGN1cnJTZWdtZW50LmRlc3Ryb3koKTsKICAgIHN0cmVhbV8xLlBhc3NUaHJvdWdoLnByb3RvdHlwZS5lbmQuY2FsbChzdHJlYW0sIG51bGwpOwogICAgcmV0dXJuIHN0cmVhbTsKICB9OwoKICByZXR1cm4gc3RyZWFtOwp9OwoKbTN1OHN0cmVhbSQxLnBhcnNlVGltZXN0YW1wID0gcGFyc2VfdGltZV8xLmh1bWFuU3RyOwp2YXIgZGlzdCA9IG0zdThzdHJlYW0kMTsKCmNvbnN0IHV0aWxzJDEgPSB1dGlscyQyOwpjb25zdCBxcyA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMlsiZGVmYXVsdCJdOwpjb25zdCB7CiAgcGFyc2VUaW1lc3RhbXA6IHBhcnNlVGltZXN0YW1wJDEKfSA9IGRpc3Q7CmNvbnN0IEJBU0VfVVJMID0gJ2h0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9JzsKY29uc3QgVElUTEVfVE9fQ0FURUdPUlkgPSB7CiAgc29uZzogewogICAgbmFtZTogJ011c2ljJywKICAgIHVybDogJ2h0dHBzOi8vbXVzaWMueW91dHViZS5jb20vJwogIH0KfTsKCmNvbnN0IGdldFRleHQgPSBvYmogPT4gb2JqID8gb2JqLnJ1bnMgPyBvYmoucnVuc1swXS50ZXh0IDogb2JqLnNpbXBsZVRleHQgOiBudWxsOwovKioKICogR2V0IHZpZGVvIG1lZGlhLgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7T2JqZWN0fQogKi8KCgppbmZvRXh0cmFzLmdldE1lZGlhID0gaW5mbyA9PiB7CiAgbGV0IG1lZGlhID0ge307CiAgbGV0IHJlc3VsdHMgPSBbXTsKCiAgdHJ5IHsKICAgIHJlc3VsdHMgPSBpbmZvLnJlc3BvbnNlLmNvbnRlbnRzLnR3b0NvbHVtbldhdGNoTmV4dFJlc3VsdHMucmVzdWx0cy5yZXN1bHRzLmNvbnRlbnRzOwogIH0gY2F0Y2ggKGVycikgey8vIERvIG5vdGhpbmcKICB9CgogIGxldCByZXN1bHQgPSByZXN1bHRzLmZpbmQodiA9PiB2LnZpZGVvU2Vjb25kYXJ5SW5mb1JlbmRlcmVyKTsKCiAgaWYgKCFyZXN1bHQpIHsKICAgIHJldHVybiB7fTsKICB9CgogIHRyeSB7CiAgICBsZXQgbWV0YWRhdGFSb3dzID0gKHJlc3VsdC5tZXRhZGF0YVJvd0NvbnRhaW5lciB8fCByZXN1bHQudmlkZW9TZWNvbmRhcnlJbmZvUmVuZGVyZXIubWV0YWRhdGFSb3dDb250YWluZXIpLm1ldGFkYXRhUm93Q29udGFpbmVyUmVuZGVyZXIucm93czsKCiAgICBmb3IgKGxldCByb3cgb2YgbWV0YWRhdGFSb3dzKSB7CiAgICAgIGlmIChyb3cubWV0YWRhdGFSb3dSZW5kZXJlcikgewogICAgICAgIGxldCB0aXRsZSA9IGdldFRleHQocm93Lm1ldGFkYXRhUm93UmVuZGVyZXIudGl0bGUpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgbGV0IGNvbnRlbnRzID0gcm93Lm1ldGFkYXRhUm93UmVuZGVyZXIuY29udGVudHNbMF07CiAgICAgICAgbWVkaWFbdGl0bGVdID0gZ2V0VGV4dChjb250ZW50cyk7CiAgICAgICAgbGV0IHJ1bnMgPSBjb250ZW50cy5ydW5zOwoKICAgICAgICBpZiAocnVucyAmJiBydW5zWzBdLm5hdmlnYXRpb25FbmRwb2ludCkgewogICAgICAgICAgbWVkaWFbYCR7dGl0bGV9X3VybGBdID0gbmV3IFVSTChydW5zWzBdLm5hdmlnYXRpb25FbmRwb2ludC5jb21tYW5kTWV0YWRhdGEud2ViQ29tbWFuZE1ldGFkYXRhLnVybCwgQkFTRV9VUkwpLnRvU3RyaW5nKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGl0bGUgaW4gVElUTEVfVE9fQ0FURUdPUlkpIHsKICAgICAgICAgIG1lZGlhLmNhdGVnb3J5ID0gVElUTEVfVE9fQ0FURUdPUllbdGl0bGVdLm5hbWU7CiAgICAgICAgICBtZWRpYS5jYXRlZ29yeV91cmwgPSBUSVRMRV9UT19DQVRFR09SWVt0aXRsZV0udXJsOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChyb3cucmljaE1ldGFkYXRhUm93UmVuZGVyZXIpIHsKICAgICAgICBsZXQgY29udGVudHMgPSByb3cucmljaE1ldGFkYXRhUm93UmVuZGVyZXIuY29udGVudHM7CiAgICAgICAgbGV0IGJveEFydCA9IGNvbnRlbnRzLmZpbHRlcihtZXRhID0+IG1ldGEucmljaE1ldGFkYXRhUmVuZGVyZXIuc3R5bGUgPT09ICdSSUNIX01FVEFEQVRBX1JFTkRFUkVSX1NUWUxFX0JPWF9BUlQnKTsKCiAgICAgICAgZm9yIChsZXQgewogICAgICAgICAgcmljaE1ldGFkYXRhUmVuZGVyZXIKICAgICAgICB9IG9mIGJveEFydCkgewogICAgICAgICAgbGV0IG1ldGEgPSByaWNoTWV0YWRhdGFSZW5kZXJlcjsKICAgICAgICAgIG1lZGlhLnllYXIgPSBnZXRUZXh0KG1ldGEuc3VidGl0bGUpOwogICAgICAgICAgbGV0IHR5cGUgPSBnZXRUZXh0KG1ldGEuY2FsbFRvQWN0aW9uKS5zcGxpdCgnICcpWzFdOwogICAgICAgICAgbWVkaWFbdHlwZV0gPSBnZXRUZXh0KG1ldGEudGl0bGUpOwogICAgICAgICAgbWVkaWFbYCR7dHlwZX1fdXJsYF0gPSBuZXcgVVJMKG1ldGEuZW5kcG9pbnQuY29tbWFuZE1ldGFkYXRhLndlYkNvbW1hbmRNZXRhZGF0YS51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICAgICAgbWVkaWEudGh1bWJuYWlscyA9IG1ldGEudGh1bWJuYWlsLnRodW1ibmFpbHM7CiAgICAgICAgfQoKICAgICAgICBsZXQgdG9waWMgPSBjb250ZW50cy5maWx0ZXIobWV0YSA9PiBtZXRhLnJpY2hNZXRhZGF0YVJlbmRlcmVyLnN0eWxlID09PSAnUklDSF9NRVRBREFUQV9SRU5ERVJFUl9TVFlMRV9UT1BJQycpOwoKICAgICAgICBmb3IgKGxldCB7CiAgICAgICAgICByaWNoTWV0YWRhdGFSZW5kZXJlcgogICAgICAgIH0gb2YgdG9waWMpIHsKICAgICAgICAgIGxldCBtZXRhID0gcmljaE1ldGFkYXRhUmVuZGVyZXI7CiAgICAgICAgICBtZWRpYS5jYXRlZ29yeSA9IGdldFRleHQobWV0YS50aXRsZSk7CiAgICAgICAgICBtZWRpYS5jYXRlZ29yeV91cmwgPSBuZXcgVVJMKG1ldGEuZW5kcG9pbnQuY29tbWFuZE1ldGFkYXRhLndlYkNvbW1hbmRNZXRhZGF0YS51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gY2F0Y2ggKGVycikgey8vIERvIG5vdGhpbmcuCiAgfQoKICByZXR1cm4gbWVkaWE7Cn07Cgpjb25zdCBpc1ZlcmlmaWVkID0gYmFkZ2VzID0+ICEhKGJhZGdlcyAmJiBiYWRnZXMuZmluZChiID0+IGIubWV0YWRhdGFCYWRnZVJlbmRlcmVyLnRvb2x0aXAgPT09ICdWZXJpZmllZCcpKTsKLyoqCiAqIEdldCB2aWRlbyBhdXRob3IuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvCiAqIEByZXR1cm5zIHtPYmplY3R9CiAqLwoKCmluZm9FeHRyYXMuZ2V0QXV0aG9yID0gaW5mbyA9PiB7CiAgbGV0IGNoYW5uZWxJZCwKICAgICAgdGh1bWJuYWlscyA9IFtdLAogICAgICBzdWJzY3JpYmVyQ291bnQsCiAgICAgIHZlcmlmaWVkID0gZmFsc2U7CgogIHRyeSB7CiAgICBsZXQgcmVzdWx0cyA9IGluZm8ucmVzcG9uc2UuY29udGVudHMudHdvQ29sdW1uV2F0Y2hOZXh0UmVzdWx0cy5yZXN1bHRzLnJlc3VsdHMuY29udGVudHM7CiAgICBsZXQgdiA9IHJlc3VsdHMuZmluZCh2MiA9PiB2Mi52aWRlb1NlY29uZGFyeUluZm9SZW5kZXJlciAmJiB2Mi52aWRlb1NlY29uZGFyeUluZm9SZW5kZXJlci5vd25lciAmJiB2Mi52aWRlb1NlY29uZGFyeUluZm9SZW5kZXJlci5vd25lci52aWRlb093bmVyUmVuZGVyZXIpOwogICAgbGV0IHZpZGVvT3duZXJSZW5kZXJlciA9IHYudmlkZW9TZWNvbmRhcnlJbmZvUmVuZGVyZXIub3duZXIudmlkZW9Pd25lclJlbmRlcmVyOwogICAgY2hhbm5lbElkID0gdmlkZW9Pd25lclJlbmRlcmVyLm5hdmlnYXRpb25FbmRwb2ludC5icm93c2VFbmRwb2ludC5icm93c2VJZDsKICAgIHRodW1ibmFpbHMgPSB2aWRlb093bmVyUmVuZGVyZXIudGh1bWJuYWlsLnRodW1ibmFpbHMubWFwKHRodW1ibmFpbCA9PiB7CiAgICAgIHRodW1ibmFpbC51cmwgPSBuZXcgVVJMKHRodW1ibmFpbC51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICByZXR1cm4gdGh1bWJuYWlsOwogICAgfSk7CiAgICBzdWJzY3JpYmVyQ291bnQgPSB1dGlscyQxLnBhcnNlQWJicmV2aWF0ZWROdW1iZXIoZ2V0VGV4dCh2aWRlb093bmVyUmVuZGVyZXIuc3Vic2NyaWJlckNvdW50VGV4dCkpOwogICAgdmVyaWZpZWQgPSBpc1ZlcmlmaWVkKHZpZGVvT3duZXJSZW5kZXJlci5iYWRnZXMpOwogIH0gY2F0Y2ggKGVycikgey8vIERvIG5vdGhpbmcuCiAgfQoKICB0cnkgewogICAgbGV0IHZpZGVvRGV0YWlscyA9IGluZm8ucGxheWVyX3Jlc3BvbnNlLm1pY3JvZm9ybWF0ICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLm1pY3JvZm9ybWF0LnBsYXllck1pY3JvZm9ybWF0UmVuZGVyZXI7CiAgICBsZXQgaWQgPSB2aWRlb0RldGFpbHMgJiYgdmlkZW9EZXRhaWxzLmNoYW5uZWxJZCB8fCBjaGFubmVsSWQgfHwgaW5mby5wbGF5ZXJfcmVzcG9uc2UudmlkZW9EZXRhaWxzLmNoYW5uZWxJZDsKICAgIGxldCBhdXRob3IgPSB7CiAgICAgIGlkOiBpZCwKICAgICAgbmFtZTogdmlkZW9EZXRhaWxzID8gdmlkZW9EZXRhaWxzLm93bmVyQ2hhbm5lbE5hbWUgOiBpbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMuYXV0aG9yLAogICAgICB1c2VyOiB2aWRlb0RldGFpbHMgPyB2aWRlb0RldGFpbHMub3duZXJQcm9maWxlVXJsLnNwbGl0KCcvJykuc2xpY2UoLTEpWzBdIDogbnVsbCwKICAgICAgY2hhbm5lbF91cmw6IGBodHRwczovL3d3dy55b3V0dWJlLmNvbS9jaGFubmVsLyR7aWR9YCwKICAgICAgZXh0ZXJuYWxfY2hhbm5lbF91cmw6IHZpZGVvRGV0YWlscyA/IGBodHRwczovL3d3dy55b3V0dWJlLmNvbS9jaGFubmVsLyR7dmlkZW9EZXRhaWxzLmV4dGVybmFsQ2hhbm5lbElkfWAgOiAnJywKICAgICAgdXNlcl91cmw6IHZpZGVvRGV0YWlscyA/IG5ldyBVUkwodmlkZW9EZXRhaWxzLm93bmVyUHJvZmlsZVVybCwgQkFTRV9VUkwpLnRvU3RyaW5nKCkgOiAnJywKICAgICAgdGh1bWJuYWlscywKICAgICAgdmVyaWZpZWQsCiAgICAgIHN1YnNjcmliZXJfY291bnQ6IHN1YnNjcmliZXJDb3VudAogICAgfTsKCiAgICBpZiAodGh1bWJuYWlscy5sZW5ndGgpIHsKICAgICAgdXRpbHMkMS5kZXByZWNhdGUoYXV0aG9yLCAnYXZhdGFyJywgYXV0aG9yLnRodW1ibmFpbHNbMF0udXJsLCAnYXV0aG9yLmF2YXRhcicsICdhdXRob3IudGh1bWJuYWlsc1swXS51cmwnKTsKICAgIH0KCiAgICByZXR1cm4gYXV0aG9yOwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIHt9OwogIH0KfTsKCmNvbnN0IHBhcnNlUmVsYXRlZFZpZGVvID0gKGRldGFpbHMsIHJ2c1BhcmFtcykgPT4gewogIGlmICghZGV0YWlscykgcmV0dXJuOwoKICB0cnkgewogICAgbGV0IHZpZXdDb3VudCA9IGdldFRleHQoZGV0YWlscy52aWV3Q291bnRUZXh0KTsKICAgIGxldCBzaG9ydFZpZXdDb3VudCA9IGdldFRleHQoZGV0YWlscy5zaG9ydFZpZXdDb3VudFRleHQpOwogICAgbGV0IHJ2c0RldGFpbHMgPSBydnNQYXJhbXMuZmluZChlbGVtID0+IGVsZW0uaWQgPT09IGRldGFpbHMudmlkZW9JZCk7CgogICAgaWYgKCEvXlxkLy50ZXN0KHNob3J0Vmlld0NvdW50KSkgewogICAgICBzaG9ydFZpZXdDb3VudCA9IHJ2c0RldGFpbHMgJiYgcnZzRGV0YWlscy5zaG9ydF92aWV3X2NvdW50X3RleHQgfHwgJyc7CiAgICB9CgogICAgdmlld0NvdW50ID0gKC9eXGQvLnRlc3Qodmlld0NvdW50KSA/IHZpZXdDb3VudCA6IHNob3J0Vmlld0NvdW50KS5zcGxpdCgnICcpWzBdOwogICAgbGV0IGJyb3dzZUVuZHBvaW50ID0gZGV0YWlscy5zaG9ydEJ5bGluZVRleHQucnVuc1swXS5uYXZpZ2F0aW9uRW5kcG9pbnQuYnJvd3NlRW5kcG9pbnQ7CiAgICBsZXQgY2hhbm5lbElkID0gYnJvd3NlRW5kcG9pbnQuYnJvd3NlSWQ7CiAgICBsZXQgbmFtZSA9IGdldFRleHQoZGV0YWlscy5zaG9ydEJ5bGluZVRleHQpOwogICAgbGV0IHVzZXIgPSAoYnJvd3NlRW5kcG9pbnQuY2Fub25pY2FsQmFzZVVybCB8fCAnJykuc3BsaXQoJy8nKS5zbGljZSgtMSlbMF07CiAgICBsZXQgdmlkZW8gPSB7CiAgICAgIGlkOiBkZXRhaWxzLnZpZGVvSWQsCiAgICAgIHRpdGxlOiBnZXRUZXh0KGRldGFpbHMudGl0bGUpLAogICAgICBwdWJsaXNoZWQ6IGdldFRleHQoZGV0YWlscy5wdWJsaXNoZWRUaW1lVGV4dCksCiAgICAgIGF1dGhvcjogewogICAgICAgIGlkOiBjaGFubmVsSWQsCiAgICAgICAgbmFtZSwKICAgICAgICB1c2VyLAogICAgICAgIGNoYW5uZWxfdXJsOiBgaHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC8ke2NoYW5uZWxJZH1gLAogICAgICAgIHVzZXJfdXJsOiBgaHR0cHM6Ly93d3cueW91dHViZS5jb20vdXNlci8ke3VzZXJ9YCwKICAgICAgICB0aHVtYm5haWxzOiBkZXRhaWxzLmNoYW5uZWxUaHVtYm5haWwudGh1bWJuYWlscy5tYXAodGh1bWJuYWlsID0+IHsKICAgICAgICAgIHRodW1ibmFpbC51cmwgPSBuZXcgVVJMKHRodW1ibmFpbC51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICAgICAgcmV0dXJuIHRodW1ibmFpbDsKICAgICAgICB9KSwKICAgICAgICB2ZXJpZmllZDogaXNWZXJpZmllZChkZXRhaWxzLm93bmVyQmFkZ2VzKSwKCiAgICAgICAgW1N5bWJvbC50b1ByaW1pdGl2ZV0oKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oYFxgcmVsYXRlZFZpZGVvLmF1dGhvclxgIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIG5lYXIgZnV0dXJlIHJlbGVhc2UsIGAgKyBgdXNlIFxgcmVsYXRlZFZpZGVvLmF1dGhvci5uYW1lXGAgaW5zdGVhZC5gKTsKICAgICAgICAgIHJldHVybiB2aWRlby5hdXRob3IubmFtZTsKICAgICAgICB9CgogICAgICB9LAogICAgICBzaG9ydF92aWV3X2NvdW50X3RleHQ6IHNob3J0Vmlld0NvdW50LnNwbGl0KCcgJylbMF0sCiAgICAgIHZpZXdfY291bnQ6IHZpZXdDb3VudC5yZXBsYWNlKC8sL2csICcnKSwKICAgICAgbGVuZ3RoX3NlY29uZHM6IGRldGFpbHMubGVuZ3RoVGV4dCA/IE1hdGguZmxvb3IocGFyc2VUaW1lc3RhbXAkMShnZXRUZXh0KGRldGFpbHMubGVuZ3RoVGV4dCkpIC8gMTAwMCkgOiBydnNQYXJhbXMgJiYgYCR7cnZzUGFyYW1zLmxlbmd0aF9zZWNvbmRzfWAsCiAgICAgIHRodW1ibmFpbHM6IGRldGFpbHMudGh1bWJuYWlsLnRodW1ibmFpbHMsCiAgICAgIHJpY2hUaHVtYm5haWxzOiBkZXRhaWxzLnJpY2hUaHVtYm5haWwgPyBkZXRhaWxzLnJpY2hUaHVtYm5haWwubW92aW5nVGh1bWJuYWlsUmVuZGVyZXIubW92aW5nVGh1bWJuYWlsRGV0YWlscy50aHVtYm5haWxzIDogW10sCiAgICAgIGlzTGl2ZTogISEoZGV0YWlscy5iYWRnZXMgJiYgZGV0YWlscy5iYWRnZXMuZmluZChiID0+IGIubWV0YWRhdGFCYWRnZVJlbmRlcmVyLmxhYmVsID09PSAnTElWRSBOT1cnKSkKICAgIH07CiAgICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlbywgJ2F1dGhvcl90aHVtYm5haWwnLCB2aWRlby5hdXRob3IudGh1bWJuYWlsc1swXS51cmwsICdyZWxhdGVkVmlkZW8uYXV0aG9yX3RodW1ibmFpbCcsICdyZWxhdGVkVmlkZW8uYXV0aG9yLnRodW1ibmFpbHNbMF0udXJsJyk7CiAgICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlbywgJ3VjaWQnLCB2aWRlby5hdXRob3IuaWQsICdyZWxhdGVkVmlkZW8udWNpZCcsICdyZWxhdGVkVmlkZW8uYXV0aG9yLmlkJyk7CiAgICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlbywgJ3ZpZGVvX3RodW1ibmFpbCcsIHZpZGVvLnRodW1ibmFpbHNbMF0udXJsLCAncmVsYXRlZFZpZGVvLnZpZGVvX3RodW1ibmFpbCcsICdyZWxhdGVkVmlkZW8udGh1bWJuYWlsc1swXS51cmwnKTsKICAgIHJldHVybiB2aWRlbzsKICB9IGNhdGNoIChlcnIpIHsvLyBTa2lwLgogIH0KfTsKLyoqCiAqIEdldCByZWxhdGVkIHZpZGVvcy4KICoKICogQHBhcmFtIHtPYmplY3R9IGluZm8KICogQHJldHVybnMge0FycmF5LjxPYmplY3Q+fQogKi8KCgppbmZvRXh0cmFzLmdldFJlbGF0ZWRWaWRlb3MgPSBpbmZvID0+IHsKICBsZXQgcnZzUGFyYW1zID0gW10sCiAgICAgIHNlY29uZGFyeVJlc3VsdHMgPSBbXTsKCiAgdHJ5IHsKICAgIHJ2c1BhcmFtcyA9IGluZm8ucmVzcG9uc2Uud2ViV2F0Y2hOZXh0UmVzcG9uc2VFeHRlbnNpb25EYXRhLnJlbGF0ZWRWaWRlb0FyZ3Muc3BsaXQoJywnKS5tYXAoZSA9PiBxcy5wYXJzZShlKSk7CiAgfSBjYXRjaCAoZXJyKSB7Ly8gRG8gbm90aGluZy4KICB9CgogIHRyeSB7CiAgICBzZWNvbmRhcnlSZXN1bHRzID0gaW5mby5yZXNwb25zZS5jb250ZW50cy50d29Db2x1bW5XYXRjaE5leHRSZXN1bHRzLnNlY29uZGFyeVJlc3VsdHMuc2Vjb25kYXJ5UmVzdWx0cy5yZXN1bHRzOwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFtdOwogIH0KCiAgbGV0IHZpZGVvcyA9IFtdOwoKICBmb3IgKGxldCByZXN1bHQgb2Ygc2Vjb25kYXJ5UmVzdWx0cyB8fCBbXSkgewogICAgbGV0IGRldGFpbHMgPSByZXN1bHQuY29tcGFjdFZpZGVvUmVuZGVyZXI7CgogICAgaWYgKGRldGFpbHMpIHsKICAgICAgbGV0IHZpZGVvID0gcGFyc2VSZWxhdGVkVmlkZW8oZGV0YWlscywgcnZzUGFyYW1zKTsKICAgICAgaWYgKHZpZGVvKSB2aWRlb3MucHVzaCh2aWRlbyk7CiAgICB9IGVsc2UgewogICAgICBsZXQgYXV0b3BsYXkgPSByZXN1bHQuY29tcGFjdEF1dG9wbGF5UmVuZGVyZXIgfHwgcmVzdWx0Lml0ZW1TZWN0aW9uUmVuZGVyZXI7CiAgICAgIGlmICghYXV0b3BsYXkgfHwgIUFycmF5LmlzQXJyYXkoYXV0b3BsYXkuY29udGVudHMpKSBjb250aW51ZTsKCiAgICAgIGZvciAobGV0IGNvbnRlbnQgb2YgYXV0b3BsYXkuY29udGVudHMpIHsKICAgICAgICBsZXQgdmlkZW8gPSBwYXJzZVJlbGF0ZWRWaWRlbyhjb250ZW50LmNvbXBhY3RWaWRlb1JlbmRlcmVyLCBydnNQYXJhbXMpOwogICAgICAgIGlmICh2aWRlbykgdmlkZW9zLnB1c2godmlkZW8pOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gdmlkZW9zOwp9OwovKioKICogR2V0IGxpa2UgY291bnQuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvCiAqIEByZXR1cm5zIHtudW1iZXJ9CiAqLwoKCmluZm9FeHRyYXMuZ2V0TGlrZXMgPSBpbmZvID0+IHsKICB0cnkgewogICAgbGV0IGNvbnRlbnRzID0gaW5mby5yZXNwb25zZS5jb250ZW50cy50d29Db2x1bW5XYXRjaE5leHRSZXN1bHRzLnJlc3VsdHMucmVzdWx0cy5jb250ZW50czsKICAgIGxldCB2aWRlbyA9IGNvbnRlbnRzLmZpbmQociA9PiByLnZpZGVvUHJpbWFyeUluZm9SZW5kZXJlcik7CiAgICBsZXQgYnV0dG9ucyA9IHZpZGVvLnZpZGVvUHJpbWFyeUluZm9SZW5kZXJlci52aWRlb0FjdGlvbnMubWVudVJlbmRlcmVyLnRvcExldmVsQnV0dG9uczsKICAgIGxldCBsaWtlID0gYnV0dG9ucy5maW5kKGIgPT4gYi50b2dnbGVCdXR0b25SZW5kZXJlciAmJiBiLnRvZ2dsZUJ1dHRvblJlbmRlcmVyLmRlZmF1bHRJY29uLmljb25UeXBlID09PSAnTElLRScpOwogICAgcmV0dXJuIHBhcnNlSW50KGxpa2UudG9nZ2xlQnV0dG9uUmVuZGVyZXIuZGVmYXVsdFRleHQuYWNjZXNzaWJpbGl0eS5hY2Nlc3NpYmlsaXR5RGF0YS5sYWJlbC5yZXBsYWNlKC9cRCsvZywgJycpKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKLyoqCiAqIEdldCBkaXNsaWtlIGNvdW50LgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7bnVtYmVyfQogKi8KCgppbmZvRXh0cmFzLmdldERpc2xpa2VzID0gaW5mbyA9PiB7CiAgdHJ5IHsKICAgIGxldCBjb250ZW50cyA9IGluZm8ucmVzcG9uc2UuY29udGVudHMudHdvQ29sdW1uV2F0Y2hOZXh0UmVzdWx0cy5yZXN1bHRzLnJlc3VsdHMuY29udGVudHM7CiAgICBsZXQgdmlkZW8gPSBjb250ZW50cy5maW5kKHIgPT4gci52aWRlb1ByaW1hcnlJbmZvUmVuZGVyZXIpOwogICAgbGV0IGJ1dHRvbnMgPSB2aWRlby52aWRlb1ByaW1hcnlJbmZvUmVuZGVyZXIudmlkZW9BY3Rpb25zLm1lbnVSZW5kZXJlci50b3BMZXZlbEJ1dHRvbnM7CiAgICBsZXQgZGlzbGlrZSA9IGJ1dHRvbnMuZmluZChiID0+IGIudG9nZ2xlQnV0dG9uUmVuZGVyZXIgJiYgYi50b2dnbGVCdXR0b25SZW5kZXJlci5kZWZhdWx0SWNvbi5pY29uVHlwZSA9PT0gJ0RJU0xJS0UnKTsKICAgIHJldHVybiBwYXJzZUludChkaXNsaWtlLnRvZ2dsZUJ1dHRvblJlbmRlcmVyLmRlZmF1bHRUZXh0LmFjY2Vzc2liaWxpdHkuYWNjZXNzaWJpbGl0eURhdGEubGFiZWwucmVwbGFjZSgvXEQrL2csICcnKSk7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn07Ci8qKgogKiBDbGVhbnMgdXAgYSBmZXcgZmllbGRzIG9uIGB2aWRlb0RldGFpbHNgLgogKgogKiBAcGFyYW0ge09iamVjdH0gdmlkZW9EZXRhaWxzCiAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvCiAqIEByZXR1cm5zIHtPYmplY3R9CiAqLwoKCmluZm9FeHRyYXMuY2xlYW5WaWRlb0RldGFpbHMgPSAodmlkZW9EZXRhaWxzLCBpbmZvKSA9PiB7CiAgdmlkZW9EZXRhaWxzLnRodW1ibmFpbHMgPSB2aWRlb0RldGFpbHMudGh1bWJuYWlsLnRodW1ibmFpbHM7CiAgZGVsZXRlIHZpZGVvRGV0YWlscy50aHVtYm5haWw7CiAgdXRpbHMkMS5kZXByZWNhdGUodmlkZW9EZXRhaWxzLCAndGh1bWJuYWlsJywgewogICAgdGh1bWJuYWlsczogdmlkZW9EZXRhaWxzLnRodW1ibmFpbHMKICB9LCAndmlkZW9EZXRhaWxzLnRodW1ibmFpbC50aHVtYm5haWxzJywgJ3ZpZGVvRGV0YWlscy50aHVtYm5haWxzJyk7CiAgdmlkZW9EZXRhaWxzLmRlc2NyaXB0aW9uID0gdmlkZW9EZXRhaWxzLnNob3J0RGVzY3JpcHRpb24gfHwgZ2V0VGV4dCh2aWRlb0RldGFpbHMuZGVzY3JpcHRpb24pOwogIGRlbGV0ZSB2aWRlb0RldGFpbHMuc2hvcnREZXNjcmlwdGlvbjsKICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlb0RldGFpbHMsICdzaG9ydERlc2NyaXB0aW9uJywgdmlkZW9EZXRhaWxzLmRlc2NyaXB0aW9uLCAndmlkZW9EZXRhaWxzLnNob3J0RGVzY3JpcHRpb24nLCAndmlkZW9EZXRhaWxzLmRlc2NyaXB0aW9uJyk7IC8vIFVzZSBtb3JlIHJlbGlhYmxlIGBsZW5ndGhTZWNvbmRzYCBmcm9tIGBwbGF5ZXJNaWNyb2Zvcm1hdFJlbmRlcmVyYC4KCiAgdmlkZW9EZXRhaWxzLmxlbmd0aFNlY29uZHMgPSBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdC5wbGF5ZXJNaWNyb2Zvcm1hdFJlbmRlcmVyLmxlbmd0aFNlY29uZHMgfHwgaW5mby5wbGF5ZXJfcmVzcG9uc2UudmlkZW9EZXRhaWxzLmxlbmd0aFNlY29uZHM7CiAgcmV0dXJuIHZpZGVvRGV0YWlsczsKfTsKLyoqCiAqIEdldCBzdG9yeWJvYXJkcyBpbmZvLgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7QXJyYXkuPE9iamVjdD59CiAqLwoKCmluZm9FeHRyYXMuZ2V0U3Rvcnlib2FyZHMgPSBpbmZvID0+IHsKICBjb25zdCBwYXJ0cyA9IGluZm8ucGxheWVyX3Jlc3BvbnNlLnN0b3J5Ym9hcmRzICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLnN0b3J5Ym9hcmRzLnBsYXllclN0b3J5Ym9hcmRTcGVjUmVuZGVyZXIgJiYgaW5mby5wbGF5ZXJfcmVzcG9uc2Uuc3Rvcnlib2FyZHMucGxheWVyU3Rvcnlib2FyZFNwZWNSZW5kZXJlci5zcGVjICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLnN0b3J5Ym9hcmRzLnBsYXllclN0b3J5Ym9hcmRTcGVjUmVuZGVyZXIuc3BlYy5zcGxpdCgnfCcpOwogIGlmICghcGFydHMpIHJldHVybiBbXTsKICBjb25zdCB1cmwgPSBuZXcgVVJMKHBhcnRzLnNoaWZ0KCkpOwogIHJldHVybiBwYXJ0cy5tYXAoKHBhcnQsIGkpID0+IHsKICAgIGxldCBbdGh1bWJuYWlsV2lkdGgsIHRodW1ibmFpbEhlaWdodCwgdGh1bWJuYWlsQ291bnQsIGNvbHVtbnMsIHJvd3MsIGludGVydmFsLCBuYW1lUmVwbGFjZW1lbnQsIHNpZ2hdID0gcGFydC5zcGxpdCgnIycpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3NpZ2gnLCBzaWdoKTsKICAgIHRodW1ibmFpbENvdW50ID0gcGFyc2VJbnQodGh1bWJuYWlsQ291bnQsIDEwKTsKICAgIGNvbHVtbnMgPSBwYXJzZUludChjb2x1bW5zLCAxMCk7CiAgICByb3dzID0gcGFyc2VJbnQocm93cywgMTApOwogICAgY29uc3Qgc3Rvcnlib2FyZENvdW50ID0gTWF0aC5jZWlsKHRodW1ibmFpbENvdW50IC8gKGNvbHVtbnMgKiByb3dzKSk7CiAgICByZXR1cm4gewogICAgICB0ZW1wbGF0ZVVybDogdXJsLnRvU3RyaW5nKCkucmVwbGFjZSgnJEwnLCBpKS5yZXBsYWNlKCckTicsIG5hbWVSZXBsYWNlbWVudCksCiAgICAgIHRodW1ibmFpbFdpZHRoOiBwYXJzZUludCh0aHVtYm5haWxXaWR0aCwgMTApLAogICAgICB0aHVtYm5haWxIZWlnaHQ6IHBhcnNlSW50KHRodW1ibmFpbEhlaWdodCwgMTApLAogICAgICB0aHVtYm5haWxDb3VudCwKICAgICAgaW50ZXJ2YWw6IHBhcnNlSW50KGludGVydmFsLCAxMCksCiAgICAgIGNvbHVtbnMsCiAgICAgIHJvd3MsCiAgICAgIHN0b3J5Ym9hcmRDb3VudAogICAgfTsKICB9KTsKfTsKLyoqCiAqIEdldCBjaGFwdGVycyBpbmZvLgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7QXJyYXkuPE9iamVjdD59CiAqLwoKCmluZm9FeHRyYXMuZ2V0Q2hhcHRlcnMgPSBpbmZvID0+IHsKICBjb25zdCBwbGF5ZXJPdmVybGF5UmVuZGVyZXIgPSBpbmZvLnJlc3BvbnNlICYmIGluZm8ucmVzcG9uc2UucGxheWVyT3ZlcmxheXMgJiYgaW5mby5yZXNwb25zZS5wbGF5ZXJPdmVybGF5cy5wbGF5ZXJPdmVybGF5UmVuZGVyZXI7CiAgY29uc3QgcGxheWVyQmFyID0gcGxheWVyT3ZlcmxheVJlbmRlcmVyICYmIHBsYXllck92ZXJsYXlSZW5kZXJlci5kZWNvcmF0ZWRQbGF5ZXJCYXJSZW5kZXJlciAmJiBwbGF5ZXJPdmVybGF5UmVuZGVyZXIuZGVjb3JhdGVkUGxheWVyQmFyUmVuZGVyZXIuZGVjb3JhdGVkUGxheWVyQmFyUmVuZGVyZXIgJiYgcGxheWVyT3ZlcmxheVJlbmRlcmVyLmRlY29yYXRlZFBsYXllckJhclJlbmRlcmVyLmRlY29yYXRlZFBsYXllckJhclJlbmRlcmVyLnBsYXllckJhcjsKICBjb25zdCBtYXJrZXJzTWFwID0gcGxheWVyQmFyICYmIHBsYXllckJhci5tdWx0aU1hcmtlcnNQbGF5ZXJCYXJSZW5kZXJlciAmJiBwbGF5ZXJCYXIubXVsdGlNYXJrZXJzUGxheWVyQmFyUmVuZGVyZXIubWFya2Vyc01hcDsKICBjb25zdCBtYXJrZXIgPSBBcnJheS5pc0FycmF5KG1hcmtlcnNNYXApICYmIG1hcmtlcnNNYXAuZmluZChtID0+IG0udmFsdWUgJiYgQXJyYXkuaXNBcnJheShtLnZhbHVlLmNoYXB0ZXJzKSk7CiAgaWYgKCFtYXJrZXIpIHJldHVybiBbXTsKICBjb25zdCBjaGFwdGVycyA9IG1hcmtlci52YWx1ZS5jaGFwdGVyczsKICByZXR1cm4gY2hhcHRlcnMubWFwKGNoYXB0ZXIgPT4gKHsKICAgIHRpdGxlOiBnZXRUZXh0KGNoYXB0ZXIuY2hhcHRlclJlbmRlcmVyLnRpdGxlKSwKICAgIHN0YXJ0X3RpbWU6IGNoYXB0ZXIuY2hhcHRlclJlbmRlcmVyLnRpbWVSYW5nZVN0YXJ0TWlsbGlzIC8gMTAwMAogIH0pKTsKfTsKCnZhciBzaWckMSA9IHt9OwoKY29uc3QgewogIHNldFRpbWVvdXQ6IHNldFRpbWVvdXQkMQp9ID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQzWyJkZWZhdWx0Il07IC8vIEEgY2FjaGUgdGhhdCBleHBpcmVzLgoKdmFyIGNhY2hlID0gY2xhc3MgQ2FjaGUgZXh0ZW5kcyBNYXAgewogIGNvbnN0cnVjdG9yKHRpbWVvdXQgPSAxMDAwKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy50aW1lb3V0ID0gdGltZW91dDsKICB9CgogIHNldChrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5oYXMoa2V5KSkgewogICAgICBjbGVhclRpbWVvdXQoc3VwZXIuZ2V0KGtleSkudGlkKTsKICAgIH0KCiAgICBzdXBlci5zZXQoa2V5LCB7CiAgICAgIHRpZDogc2V0VGltZW91dCQxKHRoaXMuZGVsZXRlLmJpbmQodGhpcywga2V5KSwgdGhpcy50aW1lb3V0KS51bnJlZigpLAogICAgICB2YWx1ZQogICAgfSk7CiAgfQoKICBnZXQoa2V5KSB7CiAgICBsZXQgZW50cnkgPSBzdXBlci5nZXQoa2V5KTsKCiAgICBpZiAoZW50cnkpIHsKICAgICAgcmV0dXJuIGVudHJ5LnZhbHVlOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0KCiAgZ2V0T3JTZXQoa2V5LCBmbikgewogICAgaWYgKHRoaXMuaGFzKGtleSkpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0KGtleSk7CiAgICB9IGVsc2UgewogICAgICBsZXQgdmFsdWUgPSBmbigpOwogICAgICB0aGlzLnNldChrZXksIHZhbHVlKTsKCiAgICAgIChhc3luYyAoKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHZhbHVlOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgdGhpcy5kZWxldGUoa2V5KTsKICAgICAgICB9CiAgICAgIH0pKCk7CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfQoKICBkZWxldGUoa2V5KSB7CiAgICBsZXQgZW50cnkgPSBzdXBlci5nZXQoa2V5KTsKCiAgICBpZiAoZW50cnkpIHsKICAgICAgY2xlYXJUaW1lb3V0KGVudHJ5LnRpZCk7CiAgICAgIHN1cGVyLmRlbGV0ZShrZXkpOwogICAgfQogIH0KCiAgY2xlYXIoKSB7CiAgICBmb3IgKGxldCBlbnRyeSBvZiB0aGlzLnZhbHVlcygpKSB7CiAgICAgIGNsZWFyVGltZW91dChlbnRyeS50aWQpOwogICAgfQoKICAgIHN1cGVyLmNsZWFyKCk7CiAgfQoKfTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewogIGNvbnN0IHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQyWyJkZWZhdWx0Il07CiAgY29uc3QgQ2FjaGUgPSBjYWNoZTsKICBjb25zdCB1dGlscyA9IHV0aWxzJDI7CiAgY29uc3Qgdm0gPSByZXF1aXJlJCQzX19kZWZhdWx0WyJkZWZhdWx0Il07IC8vIEEgc2hhcmVkIGNhY2hlIHRvIGtlZXAgdHJhY2sgb2YgaHRtbDVwbGF5ZXIganMgZnVuY3Rpb25zLgoKICBleHBvcnRzLmNhY2hlID0gbmV3IENhY2hlKCk7CiAgLyoqCiAgICogRXh0cmFjdCBzaWduYXR1cmUgZGVjaXBoZXJpbmcgYW5kIG4gcGFyYW1ldGVyIHRyYW5zZm9ybSBmdW5jdGlvbnMgZnJvbSBodG1sNXBsYXllciBmaWxlLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGh0bWw1cGxheWVyZmlsZQogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXkuPHN0cmluZz4+fQogICAqLwoKICBleHBvcnRzLmdldEZ1bmN0aW9ucyA9IChodG1sNXBsYXllcmZpbGUsIG9wdGlvbnMpID0+IGV4cG9ydHMuY2FjaGUuZ2V0T3JTZXQoaHRtbDVwbGF5ZXJmaWxlLCBhc3luYyAoKSA9PiB7CiAgICBjb25zdCBib2R5ID0gYXdhaXQgdXRpbHMuZXhwb3NlZE1pbmlnZXQoaHRtbDVwbGF5ZXJmaWxlLCBvcHRpb25zKS50ZXh0KCk7CiAgICBjb25zdCBmdW5jdGlvbnMgPSBleHBvcnRzLmV4dHJhY3RGdW5jdGlvbnMoYm9keSk7CgogICAgaWYgKCFmdW5jdGlvbnMgfHwgIWZ1bmN0aW9ucy5sZW5ndGgpIHsKICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBleHRyYWN0IGZ1bmN0aW9ucycpOwogICAgfQoKICAgIGV4cG9ydHMuY2FjaGUuc2V0KGh0bWw1cGxheWVyZmlsZSwgZnVuY3Rpb25zKTsKICAgIHJldHVybiBmdW5jdGlvbnM7CiAgfSk7CiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIGFjdGlvbnMgdGhhdCBzaG91bGQgYmUgdGFrZW4gdG8gZGVjaXBoZXIgYSBzaWduYXR1cmUKICAgKiBhbmQgdHJhbmZvcm0gdGhlIG4gcGFyYW1ldGVyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gYm9keQogICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0KICAgKi8KCgogIGV4cG9ydHMuZXh0cmFjdEZ1bmN0aW9ucyA9IGJvZHkgPT4gewogICAgY29uc3QgZnVuY3Rpb25zID0gW107CgogICAgY29uc3QgZXh0cmFjdE1hbmlwdWxhdGlvbnMgPSBjYWxsZXIgPT4gewogICAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSB1dGlscy5iZXR3ZWVuKGNhbGxlciwgYGE9YS5zcGxpdCgiIik7YCwgYC5gKTsKICAgICAgaWYgKCFmdW5jdGlvbk5hbWUpIHJldHVybiAnJzsKICAgICAgY29uc3QgZnVuY3Rpb25TdGFydCA9IGB2YXIgJHtmdW5jdGlvbk5hbWV9PXtgOwogICAgICBjb25zdCBuZHggPSBib2R5LmluZGV4T2YoZnVuY3Rpb25TdGFydCk7CiAgICAgIGlmIChuZHggPCAwKSByZXR1cm4gJyc7CiAgICAgIGNvbnN0IHN1YkJvZHkgPSBib2R5LnNsaWNlKG5keCArIGZ1bmN0aW9uU3RhcnQubGVuZ3RoIC0gMSk7CiAgICAgIHJldHVybiBgdmFyICR7ZnVuY3Rpb25OYW1lfT0ke3V0aWxzLmN1dEFmdGVySlNPTihzdWJCb2R5KX1gOwogICAgfTsKCiAgICBjb25zdCBleHRyYWN0RGVjaXBoZXIgPSAoKSA9PiB7CiAgICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IHV0aWxzLmJldHdlZW4oYm9keSwgYGEuc2V0KCJhbHIiLCJ5ZXMiKTtjJiYoYz1gLCBgKGRlY29kZVVSSUNgKTsKCiAgICAgIGlmIChmdW5jdGlvbk5hbWUgJiYgZnVuY3Rpb25OYW1lLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGZ1bmN0aW9uU3RhcnQgPSBgJHtmdW5jdGlvbk5hbWV9PWZ1bmN0aW9uKGEpYDsKICAgICAgICBjb25zdCBuZHggPSBib2R5LmluZGV4T2YoZnVuY3Rpb25TdGFydCk7CgogICAgICAgIGlmIChuZHggPj0gMCkgewogICAgICAgICAgY29uc3Qgc3ViQm9keSA9IGJvZHkuc2xpY2UobmR4ICsgZnVuY3Rpb25TdGFydC5sZW5ndGgpOwogICAgICAgICAgbGV0IGZ1bmN0aW9uQm9keSA9IGB2YXIgJHtmdW5jdGlvblN0YXJ0fSR7dXRpbHMuY3V0QWZ0ZXJKU09OKHN1YkJvZHkpfWA7CiAgICAgICAgICBmdW5jdGlvbkJvZHkgPSBgJHtleHRyYWN0TWFuaXB1bGF0aW9ucyhmdW5jdGlvbkJvZHkpfTske2Z1bmN0aW9uQm9keX07JHtmdW5jdGlvbk5hbWV9KHNpZyk7YDsKICAgICAgICAgIGZ1bmN0aW9ucy5wdXNoKGZ1bmN0aW9uQm9keSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGNvbnN0IGV4dHJhY3ROQ29kZSA9ICgpID0+IHsKICAgICAgbGV0IGZ1bmN0aW9uTmFtZSA9IHV0aWxzLmJldHdlZW4oYm9keSwgYCYmKGI9YS5nZXQoIm4iKSkmJihiPWAsIGAoYilgKTsKICAgICAgaWYgKGZ1bmN0aW9uTmFtZS5pbmNsdWRlcygnWycpKSBmdW5jdGlvbk5hbWUgPSB1dGlscy5iZXR3ZWVuKGJvZHksIGAke2Z1bmN0aW9uTmFtZS5zcGxpdCgnWycpWzBdfT1bYCwgYF1gKTsKCiAgICAgIGlmIChmdW5jdGlvbk5hbWUgJiYgZnVuY3Rpb25OYW1lLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGZ1bmN0aW9uU3RhcnQgPSBgJHtmdW5jdGlvbk5hbWV9PWZ1bmN0aW9uKGEpYDsKICAgICAgICBjb25zdCBuZHggPSBib2R5LmluZGV4T2YoZnVuY3Rpb25TdGFydCk7CgogICAgICAgIGlmIChuZHggPj0gMCkgewogICAgICAgICAgY29uc3Qgc3ViQm9keSA9IGJvZHkuc2xpY2UobmR4ICsgZnVuY3Rpb25TdGFydC5sZW5ndGgpOwogICAgICAgICAgY29uc3QgZnVuY3Rpb25Cb2R5ID0gYHZhciAke2Z1bmN0aW9uU3RhcnR9JHt1dGlscy5jdXRBZnRlckpTT04oc3ViQm9keSl9OyR7ZnVuY3Rpb25OYW1lfShuY29kZSk7YDsKICAgICAgICAgIGZ1bmN0aW9ucy5wdXNoKGZ1bmN0aW9uQm9keSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGV4dHJhY3REZWNpcGhlcigpOwogICAgZXh0cmFjdE5Db2RlKCk7CiAgICByZXR1cm4gZnVuY3Rpb25zOwogIH07CiAgLyoqCiAgICogQXBwbHkgZGVjaXBoZXIgYW5kIG4tdHJhbnNmb3JtIHRvIGluZGl2aWR1YWwgZm9ybWF0CiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZm9ybWF0CiAgICogQHBhcmFtIHt2bS5TY3JpcHR9IGRlY2lwaGVyU2NyaXB0CiAgICogQHBhcmFtIHt2bS5TY3JpcHR9IG5UcmFuc2Zvcm1TY3JpcHQKICAgKi8KCgogIGV4cG9ydHMuc2V0RG93bmxvYWRVUkwgPSAoZm9ybWF0LCBkZWNpcGhlclNjcmlwdCwgblRyYW5zZm9ybVNjcmlwdCkgPT4gewogICAgY29uc3QgZGVjaXBoZXIgPSB1cmwgPT4gewogICAgICBjb25zdCBhcmdzID0gcXVlcnlzdHJpbmcucGFyc2UodXJsKTsKICAgICAgaWYgKCFhcmdzLnMgfHwgIWRlY2lwaGVyU2NyaXB0KSByZXR1cm4gYXJncy51cmw7CiAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSBuZXcgVVJMKGRlY29kZVVSSUNvbXBvbmVudChhcmdzLnVybCkpOwogICAgICBjb21wb25lbnRzLnNlYXJjaFBhcmFtcy5zZXQoYXJncy5zcCA/IGFyZ3Muc3AgOiAnc2lnbmF0dXJlJywgZGVjaXBoZXJTY3JpcHQucnVuSW5OZXdDb250ZXh0KHsKICAgICAgICBzaWc6IGRlY29kZVVSSUNvbXBvbmVudChhcmdzLnMpCiAgICAgIH0pKTsKICAgICAgcmV0dXJuIGNvbXBvbmVudHMudG9TdHJpbmcoKTsKICAgIH07CgogICAgY29uc3QgbmNvZGUgPSB1cmwgPT4gewogICAgICBjb25zdCBjb21wb25lbnRzID0gbmV3IFVSTChkZWNvZGVVUklDb21wb25lbnQodXJsKSk7CiAgICAgIGNvbnN0IG4gPSBjb21wb25lbnRzLnNlYXJjaFBhcmFtcy5nZXQoJ24nKTsKICAgICAgaWYgKCFuIHx8ICFuVHJhbnNmb3JtU2NyaXB0KSByZXR1cm4gdXJsOwogICAgICBjb21wb25lbnRzLnNlYXJjaFBhcmFtcy5zZXQoJ24nLCBuVHJhbnNmb3JtU2NyaXB0LnJ1bkluTmV3Q29udGV4dCh7CiAgICAgICAgbmNvZGU6IG4KICAgICAgfSkpOwogICAgICByZXR1cm4gY29tcG9uZW50cy50b1N0cmluZygpOwogICAgfTsKCiAgICBjb25zdCBjaXBoZXIgPSAhZm9ybWF0LnVybDsKICAgIGNvbnN0IHVybCA9IGZvcm1hdC51cmwgfHwgZm9ybWF0LnNpZ25hdHVyZUNpcGhlciB8fCBmb3JtYXQuY2lwaGVyOwogICAgZm9ybWF0LnVybCA9IGNpcGhlciA/IG5jb2RlKGRlY2lwaGVyKHVybCkpIDogbmNvZGUodXJsKTsKICAgIGRlbGV0ZSBmb3JtYXQuc2lnbmF0dXJlQ2lwaGVyOwogICAgZGVsZXRlIGZvcm1hdC5jaXBoZXI7CiAgfTsKICAvKioKICAgKiBBcHBsaWVzIGRlY2lwaGVyIGFuZCBuIHBhcmFtZXRlciB0cmFuc2Zvcm1zIHRvIGFsbCBmb3JtYXQgVVJMJ3MuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5LjxPYmplY3Q+fSBmb3JtYXRzCiAgICogQHBhcmFtIHtzdHJpbmd9IGh0bWw1cGxheWVyCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKi8KCgogIGV4cG9ydHMuZGVjaXBoZXJGb3JtYXRzID0gYXN5bmMgKGZvcm1hdHMsIGh0bWw1cGxheWVyLCBvcHRpb25zKSA9PiB7CiAgICBsZXQgZGVjaXBoZXJlZEZvcm1hdHMgPSB7fTsKICAgIGxldCBmdW5jdGlvbnMgPSBhd2FpdCBleHBvcnRzLmdldEZ1bmN0aW9ucyhodG1sNXBsYXllciwgb3B0aW9ucyk7CiAgICBjb25zdCBkZWNpcGhlclNjcmlwdCA9IGZ1bmN0aW9ucy5sZW5ndGggPyBuZXcgdm0uU2NyaXB0KGZ1bmN0aW9uc1swXSkgOiBudWxsOwogICAgY29uc3QgblRyYW5zZm9ybVNjcmlwdCA9IGZ1bmN0aW9ucy5sZW5ndGggPiAxID8gbmV3IHZtLlNjcmlwdChmdW5jdGlvbnNbMV0pIDogbnVsbDsKICAgIGZvcm1hdHMuZm9yRWFjaChmb3JtYXQgPT4gewogICAgICBleHBvcnRzLnNldERvd25sb2FkVVJMKGZvcm1hdCwgZGVjaXBoZXJTY3JpcHQsIG5UcmFuc2Zvcm1TY3JpcHQpOwogICAgICBkZWNpcGhlcmVkRm9ybWF0c1tmb3JtYXQudXJsXSA9IGZvcm1hdDsKICAgIH0pOwogICAgcmV0dXJuIGRlY2lwaGVyZWRGb3JtYXRzOwogIH07Cn0pKHNpZyQxKTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewogIGNvbnN0IHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQyWyJkZWZhdWx0Il07CiAgY29uc3Qgc2F4JDEgPSBzYXg7CiAgY29uc3QgbWluaWdldCA9IGRpc3QkMTsKICBjb25zdCB1dGlscyA9IHV0aWxzJDI7IC8vIEZvcmNlcyBOb2RlIEpTIHZlcnNpb24gb2Ygc2V0VGltZW91dCBmb3IgRWxlY3Ryb24gYmFzZWQgYXBwbGljYXRpb25zCgogIGNvbnN0IHsKICAgIHNldFRpbWVvdXQKICB9ID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQzWyJkZWZhdWx0Il07CiAgY29uc3QgZm9ybWF0VXRpbHMgPSBmb3JtYXRVdGlscyQxOwogIGNvbnN0IHVybFV0aWxzID0gdXJsVXRpbHMkMTsKICBjb25zdCBleHRyYXMgPSBpbmZvRXh0cmFzOwogIGNvbnN0IHNpZyA9IHNpZyQxOwogIGNvbnN0IENhY2hlID0gY2FjaGU7CiAgY29uc3QgQkFTRV9VUkwgPSAnaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0nOyAvLyBDYWNoZWQgZm9yIHN0b3JpbmcgYmFzaWMvZnVsbCBpbmZvLgoKICBleHBvcnRzLmNhY2hlID0gbmV3IENhY2hlKCk7CiAgZXhwb3J0cy5jb29raWVDYWNoZSA9IG5ldyBDYWNoZSgxMDAwICogNjAgKiA2MCAqIDI0KTsKICBleHBvcnRzLndhdGNoUGFnZUNhY2hlID0gbmV3IENhY2hlKCk7IC8vIENhY2hlIGZvciBjdmVyIHVzZWQgaW4gZ2V0VmlkZW9JbmZvUGFnZQoKICBsZXQgY3ZlciA9ICcyLjIwMjEwNjIyLjEwLjAwJzsgLy8gU3BlY2lhbCBlcnJvciBjbGFzcyB1c2VkIHRvIGRldGVybWluZSBpZiBhbiBlcnJvciBpcyB1bnJlY292ZXJhYmxlLAogIC8vIGFzIGluLCB5dGRsLWNvcmUgc2hvdWxkIG5vdCB0cnkgYWdhaW4gdG8gZmV0Y2ggdGhlIHZpZGVvIG1ldGFkYXRhLgogIC8vIEluIHRoaXMgY2FzZSwgdGhlIHZpZGVvIGlzIHVzdWFsbHkgdW5hdmFpbGFibGUgaW4gc29tZSB3YXkuCgogIGNsYXNzIFVucmVjb3ZlcmFibGVFcnJvciBleHRlbmRzIEVycm9yIHt9IC8vIExpc3Qgb2YgVVJMcyB0aGF0IHNob3cgdXAgaW4gYG5vdGljZV91cmxgIGZvciBhZ2UgcmVzdHJpY3RlZCB2aWRlb3MuCgoKICBjb25zdCBBR0VfUkVTVFJJQ1RFRF9VUkxTID0gWydzdXBwb3J0Lmdvb2dsZS5jb20veW91dHViZS8/cD1hZ2VfcmVzdHJpY3Rpb25zJywgJ3lvdXR1YmUuY29tL3QvY29tbXVuaXR5X2d1aWRlbGluZXMnXTsKICAvKioKICAgKiBHZXRzIGluZm8gZnJvbSBhIHZpZGVvIHdpdGhvdXQgZ2V0dGluZyBhZGRpdGlvbmFsIGZvcm1hdHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaWQKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59CiAgKi8KCiAgZXhwb3J0cy5nZXRCYXNpY0luZm8gPSBhc3luYyAoaWQsIG9wdGlvbnMpID0+IHsKICAgIGlmIChvcHRpb25zLklQdjZCbG9jaykgewogICAgICBvcHRpb25zLnJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucywgewogICAgICAgIGZhbWlseTogNiwKICAgICAgICBsb2NhbEFkZHJlc3M6IHV0aWxzLmdldFJhbmRvbUlQdjYob3B0aW9ucy5JUHY2QmxvY2spCiAgICAgIH0pOwogICAgfQoKICAgIGNvbnN0IHJldHJ5T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG1pbmlnZXQuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMpOwogICAgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMsIHt9KTsKICAgIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW4KICAgICAgJ1VzZXItQWdlbnQnOiAnTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzg3LjAuNDI4MC4xMDEgU2FmYXJpLzUzNy4zNicKICAgIH0sIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMuaGVhZGVycyk7CgogICAgY29uc3QgdmFsaWRhdGUgPSBpbmZvID0+IHsKICAgICAgbGV0IHBsYXlFcnIgPSB1dGlscy5wbGF5RXJyb3IoaW5mby5wbGF5ZXJfcmVzcG9uc2UsIFsnRVJST1InXSwgVW5yZWNvdmVyYWJsZUVycm9yKTsKICAgICAgbGV0IHByaXZhdGVFcnIgPSBwcml2YXRlVmlkZW9FcnJvcihpbmZvLnBsYXllcl9yZXNwb25zZSk7CgogICAgICBpZiAocGxheUVyciB8fCBwcml2YXRlRXJyKSB7CiAgICAgICAgdGhyb3cgcGxheUVyciB8fCBwcml2YXRlRXJyOwogICAgICB9CgogICAgICByZXR1cm4gaW5mbyAmJiBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiAoaW5mby5wbGF5ZXJfcmVzcG9uc2Uuc3RyZWFtaW5nRGF0YSB8fCBpc1JlbnRhbChpbmZvLnBsYXllcl9yZXNwb25zZSkgfHwgaXNOb3RZZXRCcm9hZGNhc3RlZChpbmZvLnBsYXllcl9yZXNwb25zZSkpOwogICAgfTsKCiAgICBsZXQgaW5mbyA9IGF3YWl0IHBpcGVsaW5lKFtpZCwgb3B0aW9uc10sIHZhbGlkYXRlLCByZXRyeU9wdGlvbnMsIFtnZXRXYXRjaEhUTUxQYWdlLCBnZXRXYXRjaEpTT05QYWdlLCBnZXRWaWRlb0luZm9QYWdlXSk7CiAgICBPYmplY3QuYXNzaWduKGluZm8sIHsKICAgICAgZm9ybWF0czogcGFyc2VGb3JtYXRzKGluZm8ucGxheWVyX3Jlc3BvbnNlKSwKICAgICAgcmVsYXRlZF92aWRlb3M6IGV4dHJhcy5nZXRSZWxhdGVkVmlkZW9zKGluZm8pCiAgICB9KTsgLy8gQWRkIGFkZGl0aW9uYWwgcHJvcGVydGllcyB0byBpbmZvLgoKICAgIGNvbnN0IG1lZGlhID0gZXh0cmFzLmdldE1lZGlhKGluZm8pOwogICAgY29uc3QgYWRkaXRpb25hbCA9IHsKICAgICAgYXV0aG9yOiBleHRyYXMuZ2V0QXV0aG9yKGluZm8pLAogICAgICBtZWRpYSwKICAgICAgbGlrZXM6IGV4dHJhcy5nZXRMaWtlcyhpbmZvKSwKICAgICAgZGlzbGlrZXM6IGV4dHJhcy5nZXREaXNsaWtlcyhpbmZvKSwKICAgICAgYWdlX3Jlc3RyaWN0ZWQ6ICEhKG1lZGlhICYmIEFHRV9SRVNUUklDVEVEX1VSTFMuc29tZSh1cmwgPT4gT2JqZWN0LnZhbHVlcyhtZWRpYSkuc29tZSh2ID0+IHR5cGVvZiB2ID09PSAnc3RyaW5nJyAmJiB2LmluY2x1ZGVzKHVybCkpKSksCiAgICAgIC8vIEdpdmUgdGhlIHN0YW5kYXJkIGxpbmsgdG8gdGhlIHZpZGVvLgogICAgICB2aWRlb191cmw6IEJBU0VfVVJMICsgaWQsCiAgICAgIHN0b3J5Ym9hcmRzOiBleHRyYXMuZ2V0U3Rvcnlib2FyZHMoaW5mbyksCiAgICAgIGNoYXB0ZXJzOiBleHRyYXMuZ2V0Q2hhcHRlcnMoaW5mbykKICAgIH07CiAgICBpbmZvLnZpZGVvRGV0YWlscyA9IGV4dHJhcy5jbGVhblZpZGVvRGV0YWlscyhPYmplY3QuYXNzaWduKHt9LCBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdC5wbGF5ZXJNaWNyb2Zvcm1hdFJlbmRlcmVyLCBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMsIGFkZGl0aW9uYWwpLCBpbmZvKTsKICAgIHJldHVybiBpbmZvOwogIH07CgogIGNvbnN0IHByaXZhdGVWaWRlb0Vycm9yID0gcGxheWVyX3Jlc3BvbnNlID0+IHsKICAgIGxldCBwbGF5YWJpbGl0eSA9IHBsYXllcl9yZXNwb25zZSAmJiBwbGF5ZXJfcmVzcG9uc2UucGxheWFiaWxpdHlTdGF0dXM7CgogICAgaWYgKHBsYXlhYmlsaXR5ICYmIHBsYXlhYmlsaXR5LnN0YXR1cyA9PT0gJ0xPR0lOX1JFUVVJUkVEJyAmJiBwbGF5YWJpbGl0eS5tZXNzYWdlcyAmJiBwbGF5YWJpbGl0eS5tZXNzYWdlcy5maWx0ZXIobSA9PiAvVGhpcyBpcyBhIHByaXZhdGUgdmlkZW8vLnRlc3QobSkpLmxlbmd0aCkgewogICAgICByZXR1cm4gbmV3IFVucmVjb3ZlcmFibGVFcnJvcihwbGF5YWJpbGl0eS5yZWFzb24gfHwgcGxheWFiaWxpdHkubWVzc2FnZXMgJiYgcGxheWFiaWxpdHkubWVzc2FnZXNbMF0pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfTsKCiAgY29uc3QgaXNSZW50YWwgPSBwbGF5ZXJfcmVzcG9uc2UgPT4gewogICAgbGV0IHBsYXlhYmlsaXR5ID0gcGxheWVyX3Jlc3BvbnNlLnBsYXlhYmlsaXR5U3RhdHVzOwogICAgcmV0dXJuIHBsYXlhYmlsaXR5ICYmIHBsYXlhYmlsaXR5LnN0YXR1cyA9PT0gJ1VOUExBWUFCTEUnICYmIHBsYXlhYmlsaXR5LmVycm9yU2NyZWVuICYmIHBsYXlhYmlsaXR5LmVycm9yU2NyZWVuLnBsYXllckxlZ2FjeURlc2t0b3BZcGNPZmZlclJlbmRlcmVyOwogIH07CgogIGNvbnN0IGlzTm90WWV0QnJvYWRjYXN0ZWQgPSBwbGF5ZXJfcmVzcG9uc2UgPT4gewogICAgbGV0IHBsYXlhYmlsaXR5ID0gcGxheWVyX3Jlc3BvbnNlLnBsYXlhYmlsaXR5U3RhdHVzOwogICAgcmV0dXJuIHBsYXlhYmlsaXR5ICYmIHBsYXlhYmlsaXR5LnN0YXR1cyA9PT0gJ0xJVkVfU1RSRUFNX09GRkxJTkUnOwogIH07CgogIGNvbnN0IGdldFdhdGNoSFRNTFVSTCA9IChpZCwgb3B0aW9ucykgPT4gYCR7QkFTRV9VUkwgKyBpZH0maGw9JHtvcHRpb25zLmxhbmcgfHwgJ2VuJ31gOwoKICBjb25zdCBnZXRXYXRjaEhUTUxQYWdlQm9keSA9IChpZCwgb3B0aW9ucykgPT4gewogICAgY29uc3QgdXJsID0gZ2V0V2F0Y2hIVE1MVVJMKGlkLCBvcHRpb25zKTsKICAgIHJldHVybiBleHBvcnRzLndhdGNoUGFnZUNhY2hlLmdldE9yU2V0KHVybCwgKCkgPT4gdXRpbHMuZXhwb3NlZE1pbmlnZXQodXJsLCBvcHRpb25zKS50ZXh0KCkpOwogIH07CgogIGNvbnN0IEVNQkVEX1VSTCA9ICdodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC8nOwoKICBjb25zdCBnZXRFbWJlZFBhZ2VCb2R5ID0gKGlkLCBvcHRpb25zKSA9PiB7CiAgICBjb25zdCBlbWJlZFVybCA9IGAke0VNQkVEX1VSTCArIGlkfT9obD0ke29wdGlvbnMubGFuZyB8fCAnZW4nfWA7CiAgICByZXR1cm4gdXRpbHMuZXhwb3NlZE1pbmlnZXQoZW1iZWRVcmwsIG9wdGlvbnMpLnRleHQoKTsKICB9OwoKICBjb25zdCBnZXRIVE1MNXBsYXllciA9IGJvZHkgPT4gewogICAgbGV0IGh0bWw1cGxheWVyUmVzID0gLzxzY3JpcHRccytzcmM9IihbXiJdKykiKD86XHMrdHlwZT0idGV4dFwvamF2YXNjcmlwdCIpP1xzK25hbWU9InBsYXllcl9pYXNcL2Jhc2UiXHMqPnwianNVcmwiOiIoW14iXSspIi8uZXhlYyhib2R5KTsKICAgIHJldHVybiBodG1sNXBsYXllclJlcyA/IGh0bWw1cGxheWVyUmVzWzFdIHx8IGh0bWw1cGxheWVyUmVzWzJdIDogbnVsbDsKICB9OwoKICBjb25zdCBnZXRJZGVudGl0eVRva2VuID0gKGlkLCBvcHRpb25zLCBrZXksIHRocm93SWZOb3RGb3VuZCkgPT4gZXhwb3J0cy5jb29raWVDYWNoZS5nZXRPclNldChrZXksIGFzeW5jICgpID0+IHsKICAgIGxldCBwYWdlID0gYXdhaXQgZ2V0V2F0Y2hIVE1MUGFnZUJvZHkoaWQsIG9wdGlvbnMpOwogICAgbGV0IG1hdGNoID0gcGFnZS5tYXRjaCgvKFsiJ10pSURfVE9LRU5cMVs6LF1ccz8iKFteIl0rKSIvKTsKCiAgICBpZiAoIW1hdGNoICYmIHRocm93SWZOb3RGb3VuZCkgewogICAgICB0aHJvdyBuZXcgVW5yZWNvdmVyYWJsZUVycm9yKCdDb29raWUgaGVhZGVyIHVzZWQgaW4gcmVxdWVzdCwgYnV0IHVuYWJsZSB0byBmaW5kIFlvdVR1YmUgaWRlbnRpdHkgdG9rZW4nKTsKICAgIH0KCiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMl07CiAgfSk7CiAgLyoqCiAgICogR29lcyB0aHJvdWdoIGVhY2ggZW5kcG9pbnQgaW4gdGhlIHBpcGVsaW5lLCByZXRyeWluZyBvbiBmYWlsdXJlIGlmIHRoZSBlcnJvciBpcyByZWNvdmVyYWJsZS4KICAgKiBJZiB1bmFibGUgdG8gc3VjY2VlZCB3aXRoIG9uZSBlbmRwb2ludCwgbW92ZXMgb250byB0aGUgbmV4dCBvbmUuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5LjxPYmplY3Q+fSBhcmdzCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gdmFsaWRhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gcmV0cnlPcHRpb25zCiAgICogQHBhcmFtIHtBcnJheS48RnVuY3Rpb24+fSBlbmRwb2ludHMKICAgKiBAcmV0dXJucyB7W09iamVjdCwgT2JqZWN0LCBPYmplY3RdfQogICAqLwoKCiAgY29uc3QgcGlwZWxpbmUgPSBhc3luYyAoYXJncywgdmFsaWRhdGUsIHJldHJ5T3B0aW9ucywgZW5kcG9pbnRzKSA9PiB7CiAgICBsZXQgaW5mbzsKCiAgICBmb3IgKGxldCBmdW5jIG9mIGVuZHBvaW50cykgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IG5ld0luZm8gPSBhd2FpdCByZXRyeUZ1bmMoZnVuYywgYXJncy5jb25jYXQoW2luZm9dKSwgcmV0cnlPcHRpb25zKTsKCiAgICAgICAgaWYgKG5ld0luZm8ucGxheWVyX3Jlc3BvbnNlKSB7CiAgICAgICAgICBuZXdJbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMgPSBhc3NpZ24oaW5mbyAmJiBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMsIG5ld0luZm8ucGxheWVyX3Jlc3BvbnNlLnZpZGVvRGV0YWlscyk7CiAgICAgICAgICBuZXdJbmZvLnBsYXllcl9yZXNwb25zZSA9IGFzc2lnbihpbmZvICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLCBuZXdJbmZvLnBsYXllcl9yZXNwb25zZSk7CiAgICAgICAgfQoKICAgICAgICBpbmZvID0gYXNzaWduKGluZm8sIG5ld0luZm8pOwoKICAgICAgICBpZiAodmFsaWRhdGUoaW5mbywgZmFsc2UpKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBVbnJlY292ZXJhYmxlRXJyb3IgfHwgZnVuYyA9PT0gZW5kcG9pbnRzW2VuZHBvaW50cy5sZW5ndGggLSAxXSkgewogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0gLy8gVW5hYmxlIHRvIGZpbmQgdmlkZW8gbWV0YWRhdGEuLi4gc28gdHJ5IG5leHQgZW5kcG9pbnQuCgogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluZm87CiAgfTsKICAvKioKICAgKiBMaWtlIE9iamVjdC5hc3NpZ24oKSwgYnV0IGlnbm9yZXMgYG51bGxgIGFuZCBgdW5kZWZpbmVkYCBmcm9tIGBzb3VyY2VgLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldAogICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UKICAgKiBAcmV0dXJucyB7T2JqZWN0fQogICAqLwoKCiAgY29uc3QgYXNzaWduID0gKHRhcmdldCwgc291cmNlKSA9PiB7CiAgICBpZiAoIXRhcmdldCB8fCAhc291cmNlKSB7CiAgICAgIHJldHVybiB0YXJnZXQgfHwgc291cmNlOwogICAgfQoKICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzb3VyY2UpKSB7CiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGFyZ2V0W2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0YXJnZXQ7CiAgfTsKICAvKioKICAgKiBHaXZlbiBhIGZ1bmN0aW9uLCBjYWxscyBpdCB3aXRoIGBhcmdzYCB1bnRpbCBpdCdzIHN1Y2Nlc3NmdWwsCiAgICogb3IgdW50aWwgaXQgZW5jb3VudGVycyBhbiB1bnJlY292ZXJhYmxlIGVycm9yLgogICAqIEN1cnJlbnRseSwgYW55IGVycm9yIGZyb20gbWluaWdldCBpcyBjb25zaWRlcmVkIHVucmVjb3ZlcmFibGUuIEVycm9ycyBzdWNoIGFzCiAgICogdG9vIG1hbnkgcmVkaXJlY3RzLCBpbnZhbGlkIFVSTCwgc3RhdHVzIGNvZGUgNDA0LCBzdGF0dXMgY29kZSA1MDIuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jCiAgICogQHBhcmFtIHtBcnJheS48T2JqZWN0Pn0gYXJncwogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubWF4UmV0cmllcwogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLmJhY2tvZmYKICAgKiBAcGFyYW0ge251bWJlcn0gb3B0aW9ucy5iYWNrb2ZmLmluYwogICAqLwoKCiAgY29uc3QgcmV0cnlGdW5jID0gYXN5bmMgKGZ1bmMsIGFyZ3MsIG9wdGlvbnMpID0+IHsKICAgIGxldCBjdXJyZW50VHJ5ID0gMCwKICAgICAgICByZXN1bHQ7CgogICAgd2hpbGUgKGN1cnJlbnRUcnkgPD0gb3B0aW9ucy5tYXhSZXRyaWVzKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmVzdWx0ID0gYXdhaXQgZnVuYyguLi5hcmdzKTsKICAgICAgICBicmVhazsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFVucmVjb3ZlcmFibGVFcnJvciB8fCBlcnIgaW5zdGFuY2VvZiBtaW5pZ2V0Lk1pbmlnZXRFcnJvciAmJiBlcnIuc3RhdHVzQ29kZSA8IDUwMCB8fCBjdXJyZW50VHJ5ID49IG9wdGlvbnMubWF4UmV0cmllcykgewogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdhaXQgPSBNYXRoLm1pbigrK2N1cnJlbnRUcnkgKiBvcHRpb25zLmJhY2tvZmYuaW5jLCBvcHRpb25zLmJhY2tvZmYubWF4KTsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgd2FpdCkpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICBjb25zdCBqc29uQ2xvc2luZ0NoYXJzID0gL15bKVxdfSdcc10rLzsKCiAgY29uc3QgcGFyc2VKU09OID0gKHNvdXJjZSwgdmFyTmFtZSwganNvbikgPT4gewogICAgaWYgKCFqc29uIHx8IHR5cGVvZiBqc29uID09PSAnb2JqZWN0JykgewogICAgICByZXR1cm4ganNvbjsKICAgIH0gZWxzZSB7CiAgICAgIHRyeSB7CiAgICAgICAganNvbiA9IGpzb24ucmVwbGFjZShqc29uQ2xvc2luZ0NoYXJzLCAnJyk7CiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoanNvbik7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHRocm93IEVycm9yKGBFcnJvciBwYXJzaW5nICR7dmFyTmFtZX0gaW4gJHtzb3VyY2V9OiAke2Vyci5tZXNzYWdlfWApOwogICAgICB9CiAgICB9CiAgfTsKCiAgY29uc3QgZmluZEpTT04gPSAoc291cmNlLCB2YXJOYW1lLCBib2R5LCBsZWZ0LCByaWdodCwgcHJlcGVuZEpTT04pID0+IHsKICAgIGxldCBqc29uU3RyID0gdXRpbHMuYmV0d2Vlbihib2R5LCBsZWZ0LCByaWdodCk7CgogICAgaWYgKCFqc29uU3RyKSB7CiAgICAgIHRocm93IEVycm9yKGBDb3VsZCBub3QgZmluZCAke3Zhck5hbWV9IGluICR7c291cmNlfWApOwogICAgfQoKICAgIHJldHVybiBwYXJzZUpTT04oc291cmNlLCB2YXJOYW1lLCB1dGlscy5jdXRBZnRlckpTT04oYCR7cHJlcGVuZEpTT059JHtqc29uU3RyfWApKTsKICB9OwoKICBjb25zdCBmaW5kUGxheWVyUmVzcG9uc2UgPSAoc291cmNlLCBpbmZvKSA9PiB7CiAgICBjb25zdCBwbGF5ZXJfcmVzcG9uc2UgPSBpbmZvICYmIChpbmZvLmFyZ3MgJiYgaW5mby5hcmdzLnBsYXllcl9yZXNwb25zZSB8fCBpbmZvLnBsYXllcl9yZXNwb25zZSB8fCBpbmZvLnBsYXllclJlc3BvbnNlIHx8IGluZm8uZW1iZWRkZWRfcGxheWVyX3Jlc3BvbnNlKTsKICAgIHJldHVybiBwYXJzZUpTT04oc291cmNlLCAncGxheWVyX3Jlc3BvbnNlJywgcGxheWVyX3Jlc3BvbnNlKTsKICB9OwoKICBjb25zdCBnZXRXYXRjaEpTT05VUkwgPSAoaWQsIG9wdGlvbnMpID0+IGAke2dldFdhdGNoSFRNTFVSTChpZCwgb3B0aW9ucyl9JnBiaj0xYDsKCiAgY29uc3QgZ2V0V2F0Y2hKU09OUGFnZSA9IGFzeW5jIChpZCwgb3B0aW9ucykgPT4gewogICAgY29uc3QgcmVxT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oewogICAgICBoZWFkZXJzOiB7fQogICAgfSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucyk7CiAgICBsZXQgY29va2llID0gcmVxT3B0aW9ucy5oZWFkZXJzLkNvb2tpZSB8fCByZXFPcHRpb25zLmhlYWRlcnMuY29va2llOwogICAgcmVxT3B0aW9ucy5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICd4LXlvdXR1YmUtY2xpZW50LW5hbWUnOiAnMScsCiAgICAgICd4LXlvdXR1YmUtY2xpZW50LXZlcnNpb24nOiBjdmVyLAogICAgICAneC15b3V0dWJlLWlkZW50aXR5LXRva2VuJzogZXhwb3J0cy5jb29raWVDYWNoZS5nZXQoY29va2llIHx8ICdicm93c2VyJykgfHwgJycKICAgIH0sIHJlcU9wdGlvbnMuaGVhZGVycyk7CgogICAgY29uc3Qgc2V0SWRlbnRpdHlUb2tlbiA9IGFzeW5jIChrZXksIHRocm93SWZOb3RGb3VuZCkgPT4gewogICAgICBpZiAocmVxT3B0aW9ucy5oZWFkZXJzWyd4LXlvdXR1YmUtaWRlbnRpdHktdG9rZW4nXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcmVxT3B0aW9ucy5oZWFkZXJzWyd4LXlvdXR1YmUtaWRlbnRpdHktdG9rZW4nXSA9IGF3YWl0IGdldElkZW50aXR5VG9rZW4oaWQsIG9wdGlvbnMsIGtleSwgdGhyb3dJZk5vdEZvdW5kKTsKICAgIH07CgogICAgaWYgKGNvb2tpZSkgewogICAgICBhd2FpdCBzZXRJZGVudGl0eVRva2VuKGNvb2tpZSwgdHJ1ZSk7CiAgICB9CgogICAgY29uc3QganNvblVybCA9IGdldFdhdGNoSlNPTlVSTChpZCwgb3B0aW9ucyk7CiAgICBjb25zdCBib2R5ID0gYXdhaXQgdXRpbHMuZXhwb3NlZE1pbmlnZXQoanNvblVybCwgb3B0aW9ucywgcmVxT3B0aW9ucykudGV4dCgpOwogICAgbGV0IHBhcnNlZEJvZHkgPSBwYXJzZUpTT04oJ3dhdGNoLmpzb24nLCAnYm9keScsIGJvZHkpOwoKICAgIGlmIChwYXJzZWRCb2R5LnJlbG9hZCA9PT0gJ25vdycpIHsKICAgICAgYXdhaXQgc2V0SWRlbnRpdHlUb2tlbignYnJvd3NlcicsIGZhbHNlKTsKICAgIH0KCiAgICBpZiAocGFyc2VkQm9keS5yZWxvYWQgPT09ICdub3cnIHx8ICFBcnJheS5pc0FycmF5KHBhcnNlZEJvZHkpKSB7CiAgICAgIHRocm93IEVycm9yKCdVbmFibGUgdG8gcmV0cmlldmUgdmlkZW8gbWV0YWRhdGEgaW4gd2F0Y2guanNvbicpOwogICAgfQoKICAgIGxldCBpbmZvID0gcGFyc2VkQm9keS5yZWR1Y2UoKHBhcnQsIGN1cnIpID0+IE9iamVjdC5hc3NpZ24oY3VyciwgcGFydCksIHt9KTsKICAgIGluZm8ucGxheWVyX3Jlc3BvbnNlID0gZmluZFBsYXllclJlc3BvbnNlKCd3YXRjaC5qc29uJywgaW5mbyk7CiAgICBpbmZvLmh0bWw1cGxheWVyID0gaW5mby5wbGF5ZXIgJiYgaW5mby5wbGF5ZXIuYXNzZXRzICYmIGluZm8ucGxheWVyLmFzc2V0cy5qczsKICAgIHJldHVybiBpbmZvOwogIH07CgogIGNvbnN0IGdldFdhdGNoSFRNTFBhZ2UgPSBhc3luYyAoaWQsIG9wdGlvbnMpID0+IHsKICAgIGxldCBib2R5ID0gYXdhaXQgZ2V0V2F0Y2hIVE1MUGFnZUJvZHkoaWQsIG9wdGlvbnMpOwogICAgbGV0IGluZm8gPSB7CiAgICAgIHBhZ2U6ICd3YXRjaCcKICAgIH07CgogICAgdHJ5IHsKICAgICAgY3ZlciA9IHV0aWxzLmJldHdlZW4oYm9keSwgJ3sia2V5IjoiY3ZlciIsInZhbHVlIjoiJywgJyJ9Jyk7CiAgICAgIGluZm8ucGxheWVyX3Jlc3BvbnNlID0gZmluZEpTT04oJ3dhdGNoLmh0bWwnLCAncGxheWVyX3Jlc3BvbnNlJywgYm9keSwgL1xieXRJbml0aWFsUGxheWVyUmVzcG9uc2Vccyo9XHMqXHsvaSwgJzwvc2NyaXB0PicsICd7Jyk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgbGV0IGFyZ3MgPSBmaW5kSlNPTignd2F0Y2guaHRtbCcsICdwbGF5ZXJfcmVzcG9uc2UnLCBib2R5LCAvXGJ5dHBsYXllclwuY29uZmlnXHMqPVxzKnsvLCAnPC9zY3JpcHQ+JywgJ3snKTsKICAgICAgaW5mby5wbGF5ZXJfcmVzcG9uc2UgPSBmaW5kUGxheWVyUmVzcG9uc2UoJ3dhdGNoLmh0bWwnLCBhcmdzKTsKICAgIH0KCiAgICBpbmZvLnJlc3BvbnNlID0gZmluZEpTT04oJ3dhdGNoLmh0bWwnLCAncmVzcG9uc2UnLCBib2R5LCAvXGJ5dEluaXRpYWxEYXRhKCJcXSk/XHMqPVxzKlx7L2ksICc8L3NjcmlwdD4nLCAneycpOwogICAgaW5mby5odG1sNXBsYXllciA9IGdldEhUTUw1cGxheWVyKGJvZHkpOwogICAgcmV0dXJuIGluZm87CiAgfTsKCiAgY29uc3QgSU5GT19IT1NUID0gJ3d3dy55b3V0dWJlLmNvbSc7CiAgY29uc3QgSU5GT19QQVRIID0gJy9nZXRfdmlkZW9faW5mbyc7CiAgY29uc3QgVklERU9fRVVSTCA9ICdodHRwczovL3lvdXR1YmUuZ29vZ2xlYXBpcy5jb20vdi8nOwoKICBjb25zdCBnZXRWaWRlb0luZm9QYWdlID0gYXN5bmMgKGlkLCBvcHRpb25zKSA9PiB7CiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGBodHRwczovLyR7SU5GT19IT1NUfSR7SU5GT19QQVRIfWApOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3ZpZGVvX2lkJywgaWQpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2MnLCAnVFZIVE1MNScpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2N2ZXInLCBgNyR7Y3Zlci5zdWJzdHIoMSl9YCk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnZXVybCcsIFZJREVPX0VVUkwgKyBpZCk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgncHMnLCAnZGVmYXVsdCcpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2dsJywgJ1VTJyk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnaGwnLCBvcHRpb25zLmxhbmcgfHwgJ2VuJyk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnaHRtbDUnLCAnMScpOwogICAgY29uc3QgYm9keSA9IGF3YWl0IHV0aWxzLmV4cG9zZWRNaW5pZ2V0KHVybC50b1N0cmluZygpLCBvcHRpb25zKS50ZXh0KCk7CiAgICBsZXQgaW5mbyA9IHF1ZXJ5c3RyaW5nLnBhcnNlKGJvZHkpOwogICAgaW5mby5wbGF5ZXJfcmVzcG9uc2UgPSBmaW5kUGxheWVyUmVzcG9uc2UoJ2dldF92aWRlb19pbmZvJywgaW5mbyk7CiAgICByZXR1cm4gaW5mbzsKICB9OwogIC8qKgogICAqIEBwYXJhbSB7T2JqZWN0fSBwbGF5ZXJfcmVzcG9uc2UKICAgKiBAcmV0dXJucyB7QXJyYXkuPE9iamVjdD59CiAgICovCgoKICBjb25zdCBwYXJzZUZvcm1hdHMgPSBwbGF5ZXJfcmVzcG9uc2UgPT4gewogICAgbGV0IGZvcm1hdHMgPSBbXTsKCiAgICBpZiAocGxheWVyX3Jlc3BvbnNlICYmIHBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhKSB7CiAgICAgIGZvcm1hdHMgPSBmb3JtYXRzLmNvbmNhdChwbGF5ZXJfcmVzcG9uc2Uuc3RyZWFtaW5nRGF0YS5mb3JtYXRzIHx8IFtdKS5jb25jYXQocGxheWVyX3Jlc3BvbnNlLnN0cmVhbWluZ0RhdGEuYWRhcHRpdmVGb3JtYXRzIHx8IFtdKTsKICAgIH0KCiAgICByZXR1cm4gZm9ybWF0czsKICB9OwogIC8qKgogICAqIEdldHMgaW5mbyBmcm9tIGEgdmlkZW8gYWRkaXRpb25hbCBmb3JtYXRzIGFuZCBkZWNpcGhlcmVkIFVSTHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaWQKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59CiAgICovCgoKICBleHBvcnRzLmdldEluZm8gPSBhc3luYyAoaWQsIG9wdGlvbnMpID0+IHsKICAgIGxldCBpbmZvID0gYXdhaXQgZXhwb3J0cy5nZXRCYXNpY0luZm8oaWQsIG9wdGlvbnMpOwogICAgY29uc3QgaGFzTWFuaWZlc3QgPSBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhICYmIChpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmRhc2hNYW5pZmVzdFVybCB8fCBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmhsc01hbmlmZXN0VXJsKTsKICAgIGxldCBmdW5jcyA9IFtdOwoKICAgIGlmIChpbmZvLmZvcm1hdHMubGVuZ3RoKSB7CiAgICAgIGluZm8uaHRtbDVwbGF5ZXIgPSBpbmZvLmh0bWw1cGxheWVyIHx8IGdldEhUTUw1cGxheWVyKGF3YWl0IGdldFdhdGNoSFRNTFBhZ2VCb2R5KGlkLCBvcHRpb25zKSkgfHwgZ2V0SFRNTDVwbGF5ZXIoYXdhaXQgZ2V0RW1iZWRQYWdlQm9keShpZCwgb3B0aW9ucykpOwoKICAgICAgaWYgKCFpbmZvLmh0bWw1cGxheWVyKSB7CiAgICAgICAgdGhyb3cgRXJyb3IoJ1VuYWJsZSB0byBmaW5kIGh0bWw1cGxheWVyIGZpbGUnKTsKICAgICAgfQoKICAgICAgY29uc3QgaHRtbDVwbGF5ZXIgPSBuZXcgVVJMKGluZm8uaHRtbDVwbGF5ZXIsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICBmdW5jcy5wdXNoKHNpZy5kZWNpcGhlckZvcm1hdHMoaW5mby5mb3JtYXRzLCBodG1sNXBsYXllciwgb3B0aW9ucykpOwogICAgfQoKICAgIGlmIChoYXNNYW5pZmVzdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmRhc2hNYW5pZmVzdFVybCkgewogICAgICBsZXQgdXJsID0gaW5mby5wbGF5ZXJfcmVzcG9uc2Uuc3RyZWFtaW5nRGF0YS5kYXNoTWFuaWZlc3RVcmw7CiAgICAgIGZ1bmNzLnB1c2goZ2V0RGFzaE1hbmlmZXN0KHVybCwgb3B0aW9ucykpOwogICAgfQoKICAgIGlmIChoYXNNYW5pZmVzdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmhsc01hbmlmZXN0VXJsKSB7CiAgICAgIGxldCB1cmwgPSBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmhsc01hbmlmZXN0VXJsOwogICAgICBmdW5jcy5wdXNoKGdldE0zVTgodXJsLCBvcHRpb25zKSk7CiAgICB9CgogICAgbGV0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChmdW5jcyk7CiAgICBpbmZvLmZvcm1hdHMgPSBPYmplY3QudmFsdWVzKE9iamVjdC5hc3NpZ24oe30sIC4uLnJlc3VsdHMpKTsKICAgIGluZm8uZm9ybWF0cyA9IGluZm8uZm9ybWF0cy5tYXAoZm9ybWF0VXRpbHMuYWRkRm9ybWF0TWV0YSk7CiAgICBpbmZvLmZvcm1hdHMuc29ydChmb3JtYXRVdGlscy5zb3J0Rm9ybWF0cyk7CiAgICBpbmZvLmZ1bGwgPSB0cnVlOwogICAgcmV0dXJuIGluZm87CiAgfTsKICAvKioKICAgKiBHZXRzIGFkZGl0aW9uYWwgREFTSCBmb3JtYXRzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybAogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXkuPE9iamVjdD4+fQogICAqLwoKCiAgY29uc3QgZ2V0RGFzaE1hbmlmZXN0ID0gKHVybCwgb3B0aW9ucykgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgbGV0IGZvcm1hdHMgPSB7fTsKICAgIGNvbnN0IHBhcnNlciA9IHNheCQxLnBhcnNlcihmYWxzZSk7CiAgICBwYXJzZXIub25lcnJvciA9IHJlamVjdDsKICAgIGxldCBhZGFwdGF0aW9uU2V0OwoKICAgIHBhcnNlci5vbm9wZW50YWcgPSBub2RlID0+IHsKICAgICAgaWYgKG5vZGUubmFtZSA9PT0gJ0FEQVBUQVRJT05TRVQnKSB7CiAgICAgICAgYWRhcHRhdGlvblNldCA9IG5vZGUuYXR0cmlidXRlczsKICAgICAgfSBlbHNlIGlmIChub2RlLm5hbWUgPT09ICdSRVBSRVNFTlRBVElPTicpIHsKICAgICAgICBjb25zdCBpdGFnID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLklEKTsKCiAgICAgICAgaWYgKCFpc05hTihpdGFnKSkgewogICAgICAgICAgZm9ybWF0c1t1cmxdID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIGl0YWcsCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgYml0cmF0ZTogcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLkJBTkRXSURUSCksCiAgICAgICAgICAgIG1pbWVUeXBlOiBgJHthZGFwdGF0aW9uU2V0Lk1JTUVUWVBFfTsgY29kZWNzPSIke25vZGUuYXR0cmlidXRlcy5DT0RFQ1N9ImAKICAgICAgICAgIH0sIG5vZGUuYXR0cmlidXRlcy5IRUlHSFQgPyB7CiAgICAgICAgICAgIHdpZHRoOiBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMuV0lEVEgpLAogICAgICAgICAgICBoZWlnaHQ6IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5IRUlHSFQpLAogICAgICAgICAgICBmcHM6IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5GUkFNRVJBVEUpCiAgICAgICAgICB9IDogewogICAgICAgICAgICBhdWRpb1NhbXBsZVJhdGU6IG5vZGUuYXR0cmlidXRlcy5BVURJT1NBTVBMSU5HUkFURQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHBhcnNlci5vbmVuZCA9ICgpID0+IHsKICAgICAgcmVzb2x2ZShmb3JtYXRzKTsKICAgIH07CgogICAgY29uc3QgcmVxID0gdXRpbHMuZXhwb3NlZE1pbmlnZXQobmV3IFVSTCh1cmwsIEJBU0VfVVJMKS50b1N0cmluZygpLCBvcHRpb25zKTsKICAgIHJlcS5zZXRFbmNvZGluZygndXRmOCcpOwogICAgcmVxLm9uKCdlcnJvcicsIHJlamVjdCk7CiAgICByZXEub24oJ2RhdGEnLCBjaHVuayA9PiB7CiAgICAgIHBhcnNlci53cml0ZShjaHVuayk7CiAgICB9KTsKICAgIHJlcS5vbignZW5kJywgcGFyc2VyLmNsb3NlLmJpbmQocGFyc2VyKSk7CiAgfSk7CiAgLyoqCiAgICogR2V0cyBhZGRpdGlvbmFsIGZvcm1hdHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxBcnJheS48T2JqZWN0Pj59CiAgICovCgoKICBjb25zdCBnZXRNM1U4ID0gYXN5bmMgKHVybCwgb3B0aW9ucykgPT4gewogICAgdXJsID0gbmV3IFVSTCh1cmwsIEJBU0VfVVJMKTsKICAgIGNvbnN0IGJvZHkgPSBhd2FpdCB1dGlscy5leHBvc2VkTWluaWdldCh1cmwudG9TdHJpbmcoKSwgb3B0aW9ucykudGV4dCgpOwogICAgbGV0IGZvcm1hdHMgPSB7fTsKICAgIGJvZHkuc3BsaXQoJ1xuJykuZmlsdGVyKGxpbmUgPT4gL15odHRwcz86XC9cLy8udGVzdChsaW5lKSkuZm9yRWFjaChsaW5lID0+IHsKICAgICAgY29uc3QgaXRhZyA9IHBhcnNlSW50KGxpbmUubWF0Y2goL1wvaXRhZ1wvKFxkKylcLy8pWzFdKTsKICAgICAgZm9ybWF0c1tsaW5lXSA9IHsKICAgICAgICBpdGFnLAogICAgICAgIHVybDogbGluZQogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gZm9ybWF0czsKICB9OyAvLyBDYWNoZSBnZXQgaW5mbyBmdW5jdGlvbnMuCiAgLy8gSW4gY2FzZSBhIHVzZXIgd2FudHMgdG8gZ2V0IGEgdmlkZW8ncyBpbmZvIGJlZm9yZSBkb3dubG9hZGluZy4KCgogIGZvciAobGV0IGZ1bmNOYW1lIG9mIFsnZ2V0QmFzaWNJbmZvJywgJ2dldEluZm8nXSkgewogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGluawogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59CiAgICAgKi8KICAgIGNvbnN0IGZ1bmMgPSBleHBvcnRzW2Z1bmNOYW1lXTsKCiAgICBleHBvcnRzW2Z1bmNOYW1lXSA9IGFzeW5jIChsaW5rLCBvcHRpb25zID0ge30pID0+IHsKICAgICAgdXRpbHMuY2hlY2tGb3JVcGRhdGVzKCk7CiAgICAgIGxldCBpZCA9IGF3YWl0IHVybFV0aWxzLmdldFZpZGVvSUQobGluayk7CiAgICAgIGNvbnN0IGtleSA9IFtmdW5jTmFtZSwgaWQsIG9wdGlvbnMubGFuZ10uam9pbignLScpOwogICAgICByZXR1cm4gZXhwb3J0cy5jYWNoZS5nZXRPclNldChrZXksICgpID0+IGZ1bmMoaWQsIG9wdGlvbnMpKTsKICAgIH07CiAgfSAvLyBFeHBvcnQgYSBmZXcgaGVscGVycy4KCgogIGV4cG9ydHMudmFsaWRhdGVJRCA9IHVybFV0aWxzLnZhbGlkYXRlSUQ7CiAgZXhwb3J0cy52YWxpZGF0ZVVSTCA9IHVybFV0aWxzLnZhbGlkYXRlVVJMOwogIGV4cG9ydHMuZ2V0VVJMVmlkZW9JRCA9IHVybFV0aWxzLmdldFVSTFZpZGVvSUQ7CiAgZXhwb3J0cy5nZXRWaWRlb0lEID0gdXJsVXRpbHMuZ2V0VmlkZW9JRDsKfSkoaW5mbyk7Cgpjb25zdCBQYXNzVGhyb3VnaCA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMVsiZGVmYXVsdCJdLlBhc3NUaHJvdWdoOwpjb25zdCBnZXRJbmZvID0gaW5mbzsKY29uc3QgdXRpbHMgPSB1dGlscyQyOwpjb25zdCBmb3JtYXRVdGlscyA9IGZvcm1hdFV0aWxzJDE7CmNvbnN0IHVybFV0aWxzID0gdXJsVXRpbHMkMTsKY29uc3Qgc2lnID0gc2lnJDE7CmNvbnN0IG1pbmlnZXQgPSBkaXN0JDE7CmNvbnN0IG0zdThzdHJlYW0gPSBkaXN0Owpjb25zdCB7CiAgcGFyc2VUaW1lc3RhbXAKfSA9IGRpc3Q7Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gbGluawogKiBAcGFyYW0geyFPYmplY3R9IG9wdGlvbnMKICogQHJldHVybnMge1JlYWRhYmxlU3RyZWFtfQogKi8KCmNvbnN0IHl0ZGwgPSAobGluaywgb3B0aW9ucykgPT4gewogIGNvbnN0IHN0cmVhbSA9IGNyZWF0ZVN0cmVhbShvcHRpb25zKTsKICB5dGRsLmdldEluZm8obGluaywgb3B0aW9ucykudGhlbihpbmZvID0+IHsKICAgIGRvd25sb2FkRnJvbUluZm9DYWxsYmFjayhzdHJlYW0sIGluZm8sIG9wdGlvbnMpOwogIH0sIHN0cmVhbS5lbWl0LmJpbmQoc3RyZWFtLCAnZXJyb3InKSk7CiAgcmV0dXJuIHN0cmVhbTsKfTsKCnZhciBsaWIgPSB5dGRsOwp5dGRsLmdldEJhc2ljSW5mbyA9IGdldEluZm8uZ2V0QmFzaWNJbmZvOwp5dGRsLmdldEluZm8gPSBnZXRJbmZvLmdldEluZm87Cnl0ZGwuY2hvb3NlRm9ybWF0ID0gZm9ybWF0VXRpbHMuY2hvb3NlRm9ybWF0Owp5dGRsLmZpbHRlckZvcm1hdHMgPSBmb3JtYXRVdGlscy5maWx0ZXJGb3JtYXRzOwp5dGRsLnZhbGlkYXRlSUQgPSB1cmxVdGlscy52YWxpZGF0ZUlEOwp5dGRsLnZhbGlkYXRlVVJMID0gdXJsVXRpbHMudmFsaWRhdGVVUkw7Cnl0ZGwuZ2V0VVJMVmlkZW9JRCA9IHVybFV0aWxzLmdldFVSTFZpZGVvSUQ7Cnl0ZGwuZ2V0VmlkZW9JRCA9IHVybFV0aWxzLmdldFZpZGVvSUQ7Cnl0ZGwuY2FjaGUgPSB7CiAgc2lnOiBzaWcuY2FjaGUsCiAgaW5mbzogZ2V0SW5mby5jYWNoZSwKICB3YXRjaDogZ2V0SW5mby53YXRjaFBhZ2VDYWNoZSwKICBjb29raWU6IGdldEluZm8uY29va2llQ2FjaGUKfTsKeXRkbC52ZXJzaW9uID0gcmVxdWlyZSQkOC52ZXJzaW9uOwoKY29uc3QgY3JlYXRlU3RyZWFtID0gb3B0aW9ucyA9PiB7CiAgY29uc3Qgc3RyZWFtID0gbmV3IFBhc3NUaHJvdWdoKHsKICAgIGhpZ2hXYXRlck1hcms6IG9wdGlvbnMgJiYgb3B0aW9ucy5oaWdoV2F0ZXJNYXJrIHx8IDEwMjQgKiA1MTIKICB9KTsKCiAgc3RyZWFtLl9kZXN0cm95ID0gKCkgPT4gewogICAgc3RyZWFtLmRlc3Ryb3llZCA9IHRydWU7CiAgfTsKCiAgcmV0dXJuIHN0cmVhbTsKfTsKCmNvbnN0IHBpcGVBbmRTZXRFdmVudHMgPSAocmVxLCBzdHJlYW0sIGVuZCkgPT4gewogIC8vIEZvcndhcmQgZXZlbnRzIGZyb20gdGhlIHJlcXVlc3QgdG8gdGhlIHN0cmVhbS4KICBbJ2Fib3J0JywgJ3JlcXVlc3QnLCAncmVzcG9uc2UnLCAnZXJyb3InLCAncmVkaXJlY3QnLCAncmV0cnknLCAncmVjb25uZWN0J10uZm9yRWFjaChldmVudCA9PiB7CiAgICByZXEucHJlcGVuZExpc3RlbmVyKGV2ZW50LCBzdHJlYW0uZW1pdC5iaW5kKHN0cmVhbSwgZXZlbnQpKTsKICB9KTsKICByZXEucGlwZShzdHJlYW0sIHsKICAgIGVuZAogIH0pOwp9OwovKioKICogQ2hvb3NlcyBhIGZvcm1hdCB0byBkb3dubG9hZC4KICoKICogQHBhcmFtIHtzdHJlYW0uUmVhZGFibGV9IHN0cmVhbQogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogKi8KCgpjb25zdCBkb3dubG9hZEZyb21JbmZvQ2FsbGJhY2sgPSAoc3RyZWFtLCBpbmZvLCBvcHRpb25zKSA9PiB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgbGV0IGVyciA9IHV0aWxzLnBsYXlFcnJvcihpbmZvLnBsYXllcl9yZXNwb25zZSwgWydVTlBMQVlBQkxFJywgJ0xJVkVfU1RSRUFNX09GRkxJTkUnLCAnTE9HSU5fUkVRVUlSRUQnXSk7CgogIGlmIChlcnIpIHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIWluZm8uZm9ybWF0cy5sZW5ndGgpIHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIEVycm9yKCdUaGlzIHZpZGVvIGlzIHVuYXZhaWxhYmxlJykpOwogICAgcmV0dXJuOwogIH0KCiAgbGV0IGZvcm1hdDsKCiAgdHJ5IHsKICAgIGZvcm1hdCA9IGZvcm1hdFV0aWxzLmNob29zZUZvcm1hdChpbmZvLmZvcm1hdHMsIG9wdGlvbnMpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGUpOwogICAgcmV0dXJuOwogIH0KCiAgc3RyZWFtLmVtaXQoJ2luZm8nLCBpbmZvLCBmb3JtYXQpOwoKICBpZiAoc3RyZWFtLmRlc3Ryb3llZCkgewogICAgcmV0dXJuOwogIH0KCiAgbGV0IGNvbnRlbnRMZW5ndGgsCiAgICAgIGRvd25sb2FkZWQgPSAwOwoKICBjb25zdCBvbmRhdGEgPSBjaHVuayA9PiB7CiAgICBkb3dubG9hZGVkICs9IGNodW5rLmxlbmd0aDsKICAgIHN0cmVhbS5lbWl0KCdwcm9ncmVzcycsIGNodW5rLmxlbmd0aCwgZG93bmxvYWRlZCwgY29udGVudExlbmd0aCk7CiAgfTsKCiAgaWYgKG9wdGlvbnMuSVB2NkJsb2NrKSB7CiAgICBvcHRpb25zLnJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucywgewogICAgICBmYW1pbHk6IDYsCiAgICAgIGxvY2FsQWRkcmVzczogdXRpbHMuZ2V0UmFuZG9tSVB2NihvcHRpb25zLklQdjZCbG9jaykKICAgIH0pOwogIH0gLy8gRG93bmxvYWQgdGhlIGZpbGUgaW4gY2h1bmtzLCBpbiB0aGlzIGNhc2UgdGhlIGRlZmF1bHQgaXMgMTBNQiwKICAvLyBhbnl0aGluZyBvdmVyIHRoaXMgd2lsbCBjYXVzZSB5b3V0dWJlIHRvIHRocm90dGxlIHRoZSBkb3dubG9hZAoKCiAgY29uc3QgZGxDaHVua1NpemUgPSBvcHRpb25zLmRsQ2h1bmtTaXplIHx8IDEwMjQgKiAxMDI0ICogMTA7CiAgbGV0IHJlcTsKICBsZXQgc2hvdWxkRW5kID0gdHJ1ZTsKCiAgaWYgKGZvcm1hdC5pc0hMUyB8fCBmb3JtYXQuaXNEYXNoTVBEKSB7CiAgICByZXEgPSBtM3U4c3RyZWFtKGZvcm1hdC51cmwsIHsKICAgICAgY2h1bmtSZWFkYWhlYWQ6ICtpbmZvLmxpdmVfY2h1bmtfcmVhZGFoZWFkLAogICAgICBiZWdpbjogb3B0aW9ucy5iZWdpbiB8fCBmb3JtYXQuaXNMaXZlICYmIERhdGUubm93KCksCiAgICAgIGxpdmVCdWZmZXI6IG9wdGlvbnMubGl2ZUJ1ZmZlciwKICAgICAgcmVxdWVzdE9wdGlvbnM6IG9wdGlvbnMucmVxdWVzdE9wdGlvbnMsCiAgICAgIHBhcnNlcjogZm9ybWF0LmlzRGFzaE1QRCA/ICdkYXNoLW1wZCcgOiAnbTN1OCcsCiAgICAgIGlkOiBmb3JtYXQuaXRhZwogICAgfSk7CiAgICByZXEub24oJ3Byb2dyZXNzJywgKHNlZ21lbnQsIHRvdGFsU2VnbWVudHMpID0+IHsKICAgICAgc3RyZWFtLmVtaXQoJ3Byb2dyZXNzJywgc2VnbWVudC5zaXplLCBzZWdtZW50Lm51bSwgdG90YWxTZWdtZW50cyk7CiAgICB9KTsKICAgIHBpcGVBbmRTZXRFdmVudHMocmVxLCBzdHJlYW0sIHNob3VsZEVuZCk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucywgewogICAgICBtYXhSZWNvbm5lY3RzOiA2LAogICAgICBtYXhSZXRyaWVzOiAzLAogICAgICBiYWNrb2ZmOiB7CiAgICAgICAgaW5jOiA1MDAsCiAgICAgICAgbWF4OiAxMDAwMAogICAgICB9CiAgICB9KTsKICAgIGxldCBzaG91bGRCZUNodW5rZWQgPSBkbENodW5rU2l6ZSAhPT0gMCAmJiAoIWZvcm1hdC5oYXNBdWRpbyB8fCAhZm9ybWF0Lmhhc1ZpZGVvKTsKCiAgICBpZiAoc2hvdWxkQmVDaHVua2VkKSB7CiAgICAgIGxldCBzdGFydCA9IG9wdGlvbnMucmFuZ2UgJiYgb3B0aW9ucy5yYW5nZS5zdGFydCB8fCAwOwogICAgICBsZXQgZW5kID0gc3RhcnQgKyBkbENodW5rU2l6ZTsKICAgICAgY29uc3QgcmFuZ2VFbmQgPSBvcHRpb25zLnJhbmdlICYmIG9wdGlvbnMucmFuZ2UuZW5kOwogICAgICBjb250ZW50TGVuZ3RoID0gb3B0aW9ucy5yYW5nZSA/IChyYW5nZUVuZCA/IHJhbmdlRW5kICsgMSA6IHBhcnNlSW50KGZvcm1hdC5jb250ZW50TGVuZ3RoKSkgLSBzdGFydCA6IHBhcnNlSW50KGZvcm1hdC5jb250ZW50TGVuZ3RoKTsKCiAgICAgIGNvbnN0IGdldE5leHRDaHVuayA9ICgpID0+IHsKICAgICAgICBpZiAoIXJhbmdlRW5kICYmIGVuZCA+PSBjb250ZW50TGVuZ3RoKSBlbmQgPSAwOwogICAgICAgIGlmIChyYW5nZUVuZCAmJiBlbmQgPiByYW5nZUVuZCkgZW5kID0gcmFuZ2VFbmQ7CiAgICAgICAgc2hvdWxkRW5kID0gIWVuZCB8fCBlbmQgPT09IHJhbmdlRW5kOwogICAgICAgIHJlcXVlc3RPcHRpb25zLmhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCByZXF1ZXN0T3B0aW9ucy5oZWFkZXJzLCB7CiAgICAgICAgICBSYW5nZTogYGJ5dGVzPSR7c3RhcnR9LSR7ZW5kIHx8ICcnfWAKICAgICAgICB9KTsKICAgICAgICByZXEgPSBtaW5pZ2V0KGZvcm1hdC51cmwsIHJlcXVlc3RPcHRpb25zKTsKICAgICAgICByZXEub24oJ2RhdGEnLCBvbmRhdGEpOwogICAgICAgIHJlcS5vbignZW5kJywgKCkgPT4gewogICAgICAgICAgaWYgKHN0cmVhbS5kZXN0cm95ZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChlbmQgJiYgZW5kICE9PSByYW5nZUVuZCkgewogICAgICAgICAgICBzdGFydCA9IGVuZCArIDE7CiAgICAgICAgICAgIGVuZCArPSBkbENodW5rU2l6ZTsKICAgICAgICAgICAgZ2V0TmV4dENodW5rKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcGlwZUFuZFNldEV2ZW50cyhyZXEsIHN0cmVhbSwgc2hvdWxkRW5kKTsKICAgICAgfTsKCiAgICAgIGdldE5leHRDaHVuaygpOwogICAgfSBlbHNlIHsKICAgICAgLy8gQXVkaW8gb25seSBhbmQgdmlkZW8gb25seSBmb3JtYXRzIGRvbid0IHN1cHBvcnQgYmVnaW4KICAgICAgaWYgKG9wdGlvbnMuYmVnaW4pIHsKICAgICAgICBmb3JtYXQudXJsICs9IGAmYmVnaW49JHtwYXJzZVRpbWVzdGFtcChvcHRpb25zLmJlZ2luKX1gOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5yYW5nZSAmJiAob3B0aW9ucy5yYW5nZS5zdGFydCB8fCBvcHRpb25zLnJhbmdlLmVuZCkpIHsKICAgICAgICByZXF1ZXN0T3B0aW9ucy5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxdWVzdE9wdGlvbnMuaGVhZGVycywgewogICAgICAgICAgUmFuZ2U6IGBieXRlcz0ke29wdGlvbnMucmFuZ2Uuc3RhcnQgfHwgJzAnfS0ke29wdGlvbnMucmFuZ2UuZW5kIHx8ICcnfWAKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmVxID0gbWluaWdldChmb3JtYXQudXJsLCByZXF1ZXN0T3B0aW9ucyk7CiAgICAgIHJlcS5vbigncmVzcG9uc2UnLCByZXMgPT4gewogICAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb250ZW50TGVuZ3RoID0gY29udGVudExlbmd0aCB8fCBwYXJzZUludChyZXMuaGVhZGVyc1snY29udGVudC1sZW5ndGgnXSk7CiAgICAgIH0pOwogICAgICByZXEub24oJ2RhdGEnLCBvbmRhdGEpOwogICAgICBwaXBlQW5kU2V0RXZlbnRzKHJlcSwgc3RyZWFtLCBzaG91bGRFbmQpOwogICAgfQogIH0KCiAgc3RyZWFtLl9kZXN0cm95ID0gKCkgPT4gewogICAgc3RyZWFtLmRlc3Ryb3llZCA9IHRydWU7CiAgICByZXEuZGVzdHJveSgpOwogICAgcmVxLmVuZCgpOwogIH07Cn07Ci8qKgogKiBDYW4gYmUgdXNlZCB0byBkb3dubG9hZCB2aWRlbyBhZnRlciBpdHMgYGluZm9gIGlzIGdvdHRlbiB0aHJvdWdoCiAqIGB5dGRsLmdldEluZm8oKWAuIEluIGNhc2UgdGhlIHVzZXIgbWlnaHQgd2FudCB0byBsb29rIGF0IHRoZQogKiBgaW5mb2Agb2JqZWN0IGJlZm9yZSBkZWNpZGluZyB0byBkb3dubG9hZC4KICoKICogQHBhcmFtIHtPYmplY3R9IGluZm8KICogQHBhcmFtIHshT2JqZWN0fSBvcHRpb25zCiAqIEByZXR1cm5zIHtSZWFkYWJsZVN0cmVhbX0KICovCgoKeXRkbC5kb3dubG9hZEZyb21JbmZvID0gKGluZm8sIG9wdGlvbnMpID0+IHsKICBjb25zdCBzdHJlYW0gPSBjcmVhdGVTdHJlYW0ob3B0aW9ucyk7CgogIGlmICghaW5mby5mdWxsKSB7CiAgICB0aHJvdyBFcnJvcignQ2Fubm90IHVzZSBgeXRkbC5kb3dubG9hZEZyb21JbmZvKClgIHdoZW4gY2FsbGVkICcgKyAnd2l0aCBpbmZvIGZyb20gYHl0ZGwuZ2V0QmFzaWNJbmZvKClgJyk7CiAgfQoKICBzZXRJbW1lZGlhdGUoKCkgPT4gewogICAgZG93bmxvYWRGcm9tSW5mb0NhbGxiYWNrKHN0cmVhbSwgaW5mbywgb3B0aW9ucyk7CiAgfSk7CiAgcmV0dXJuIHN0cmVhbTsKfTsKCmZ1bmN0aW9uIGdldE1heGltdW0oZm9ybWF0cywgcXVhbGl0eSwgaXNWaWRlbykgewogIGlmIChpc1ZpZGVvKSB7CiAgICBsZXQgZm10ID0gZm9ybWF0cy5maW5kKHggPT4geC5oYXNWaWRlbyAmJiAheC5oYXNBdWRpbyAmJiB4LnF1YWxpdHlMYWJlbC5pbmNsdWRlcyhxdWFsaXR5KSk7CgogICAgaWYgKGZtdCkgewogICAgICByZXR1cm4gZm10OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGxpYi5jaG9vc2VGb3JtYXQoZm9ybWF0cywgewogICAgICAgIHF1YWxpdHk6ICJoaWdoZXN0dmlkZW8iCiAgICAgIH0pOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gbGliLmNob29zZUZvcm1hdChmb3JtYXRzLCB7CiAgICAgIHF1YWxpdHk6ICJoaWdoZXN0YXVkaW8iCiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGdldFlvdXR1YmVVcmwoKSB7CiAgdHJ5IHsKICAgIGxldCB0ZXh0ID0gY2hpbGRfcHJvY2Vzcy5leGVjU3luYygicG93ZXJzaGVsbCAtY29tbWFuZCBnZXQtY2xpcGJvYXJkIik7CgogICAgaWYgKHRleHQpIHsKICAgICAgdGV4dCA9IHRleHQudG9TdHJpbmcoKTsKCiAgICAgIGlmICh0ZXh0LnN0YXJ0c1dpdGgoJ2h0dHAnKSAmJiB0ZXh0LmluY2x1ZGVzKCd5b3V0dScpKSB7CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgIH0KICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KCihhc3luYyAoKSA9PiB7CiAgY29uc3QgYyA9ICguLi5hKSA9PiBwcm9jZXNzLnN0ZG91dC53cml0ZSguLi5hKTsKCiAgYygiXHgxYl0wbTtNZW51aWZ5IC0gSmF2YXNjcmlwdCBDb21tYW5kXHgwNyIpOwogIGNvbnNvbGUuY2xlYXIoKTsKICBjKCJceDFiWzg7Nzs4MHQiKTsKICBsZXQgcmF3VXJsID0gZ2V0WW91dHViZVVybCgpOwoKICBpZiAocHJvY2Vzcy5hcmd2Lmxlbmd0aCA+PSAzICYmIHJhd1VybCkgewogICAgbGV0IHZpZGVvID0gYXdhaXQgbGliLmdldEluZm8ocmF3VXJsKTsKICAgIGxldCB0aXRsZSA9IHZpZGVvLnZpZGVvRGV0YWlscy50aXRsZS5yZXBsYWNlQWxsKC9bXkEtWmEtejAtOSBcLVxfXChcKVxbXF1dL2csICIiKS5zdWJzdHJpbmcoMCwgMjU1KTsKICAgIGxldCBiZXN0dmlkZW8gPSBnZXRNYXhpbXVtKHZpZGVvLmZvcm1hdHMsICcxMDgwJywgdHJ1ZSk7CiAgICBsZXQgYmVzdGF1ZGlvID0gZ2V0TWF4aW11bSh2aWRlby5mb3JtYXRzLCAnJywgZmFsc2UpOwogICAgYygiXHgxYlszMDs0M20gRG93bmxvYWRpbmcgJyIgKyB2aWRlby52aWRlb0RldGFpbHMudGl0bGUgKyAiJyBceDFiWzBtXG4iKTsKICAgIGxldCBmaWxlID0gdGl0bGUgKz0gIi5tcDQiOwogICAgbGV0IGZpbGVQYXRoID0gcGF0aF9fZGVmYXVsdFsiZGVmYXVsdCJdLmpvaW4ocHJvY2Vzcy5hcmd2WzJdLCBmaWxlKTsKICAgIGNoaWxkX3Byb2Nlc3MuZXhlY1N5bmMoYGZmbXBlZyAtaSAiJHtiZXN0dmlkZW8udXJsfSIgLWkgIiR7YmVzdGF1ZGlvLnVybH0iIC1jIGNvcHkgIiR7ZmlsZVBhdGh9IiAtbG9nbGV2ZWwgcXVpZXRgLCB7CiAgICAgIHN0ZGlvOiAnaW5oZXJpdCcKICAgIH0pOwogIH0gZWxzZSB7CiAgICBjKCJceDA3Iik7CiAgICBjKCJceDFiWzI5OzQxbSBFcnJvcjogVGhpcyBzY3JpcHQgcmVxdWlyZXMgYSBmaWxlIHBhcmFtZXRlciBceDFiWzBtXG4iKTsKICAgIHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZSh0cnVlKTsKICAgIHByb2Nlc3Muc3RkaW4ucmVzdW1lKCk7CiAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKICAgICAgcHJvY2Vzcy5zdGRpbi5vbmNlKCdkYXRhJywgKCkgPT4gewogICAgICAgIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTsKICAgICAgICByKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQp9KSgpOwo=","type":{"name":"javascript"},"signature":"(SIGNED)"}},{"id":"ec3a75ac-67e8-4df6-a806-6cb166aa925c","name":"Download mp3","type":"precompiled","action":{"data":"J3VzZSBzdHJpY3QnOwoKdmFyIHJlcXVpcmUkJDAkMSA9IHJlcXVpcmUoJ3N0cmVhbScpOwp2YXIgcmVxdWlyZSQkMCQyID0gcmVxdWlyZSgncXVlcnlzdHJpbmcnKTsKdmFyIHJlcXVpcmUkJDEgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2RlcicpOwp2YXIgcmVxdWlyZSQkMCA9IHJlcXVpcmUoJ2h0dHAnKTsKdmFyIHJlcXVpcmUkJDEkMSA9IHJlcXVpcmUoJ2h0dHBzJyk7CnZhciByZXF1aXJlJCQwJDMgPSByZXF1aXJlKCd0aW1lcnMnKTsKdmFyIHJlcXVpcmUkJDMgPSByZXF1aXJlKCd2bScpOwp2YXIgY2hpbGRfcHJvY2VzcyA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTsKdmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7CgpmdW5jdGlvbiBfaW50ZXJvcERlZmF1bHRMZWdhY3kgKGUpIHsgcmV0dXJuIGUgJiYgdHlwZW9mIGUgPT09ICdvYmplY3QnICYmICdkZWZhdWx0JyBpbiBlID8gZSA6IHsgJ2RlZmF1bHQnOiBlIH07IH0KCnZhciByZXF1aXJlJCQwX19kZWZhdWx0JDEgPSAvKiNfX1BVUkVfXyovX2ludGVyb3BEZWZhdWx0TGVnYWN5KHJlcXVpcmUkJDAkMSk7CnZhciByZXF1aXJlJCQwX19kZWZhdWx0JDIgPSAvKiNfX1BVUkVfXyovX2ludGVyb3BEZWZhdWx0TGVnYWN5KHJlcXVpcmUkJDAkMik7CnZhciByZXF1aXJlJCQxX19kZWZhdWx0ID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShyZXF1aXJlJCQxKTsKdmFyIHJlcXVpcmUkJDBfX2RlZmF1bHQgPSAvKiNfX1BVUkVfXyovX2ludGVyb3BEZWZhdWx0TGVnYWN5KHJlcXVpcmUkJDApOwp2YXIgcmVxdWlyZSQkMV9fZGVmYXVsdCQxID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShyZXF1aXJlJCQxJDEpOwp2YXIgcmVxdWlyZSQkMF9fZGVmYXVsdCQzID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShyZXF1aXJlJCQwJDMpOwp2YXIgcmVxdWlyZSQkM19fZGVmYXVsdCA9IC8qI19fUFVSRV9fKi9faW50ZXJvcERlZmF1bHRMZWdhY3kocmVxdWlyZSQkMyk7CnZhciBwYXRoX19kZWZhdWx0ID0gLyojX19QVVJFX18qL19pbnRlcm9wRGVmYXVsdExlZ2FjeShwYXRoKTsKCnZhciBjb21tb25qc0dsb2JhbCA9IHR5cGVvZiBnbG9iYWxUaGlzICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbFRoaXMgOiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnID8gc2VsZiA6IHt9OwoKdmFyIGluZm8gPSB7fTsKCnZhciBzYXggPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICAoZnVuY3Rpb24gKHNheCkgewogICAgLy8gd3JhcHBlciBmb3Igbm9uLW5vZGUgZW52cwogICAgc2F4LnBhcnNlciA9IGZ1bmN0aW9uIChzdHJpY3QsIG9wdCkgewogICAgICByZXR1cm4gbmV3IFNBWFBhcnNlcihzdHJpY3QsIG9wdCk7CiAgICB9OwoKICAgIHNheC5TQVhQYXJzZXIgPSBTQVhQYXJzZXI7CiAgICBzYXguU0FYU3RyZWFtID0gU0FYU3RyZWFtOwogICAgc2F4LmNyZWF0ZVN0cmVhbSA9IGNyZWF0ZVN0cmVhbTsgLy8gV2hlbiB3ZSBwYXNzIHRoZSBNQVhfQlVGRkVSX0xFTkdUSCBwb3NpdGlvbiwgc3RhcnQgY2hlY2tpbmcgZm9yIGJ1ZmZlciBvdmVycnVucy4KICAgIC8vIFdoZW4gd2UgY2hlY2ssIHNjaGVkdWxlIHRoZSBuZXh0IGNoZWNrIGZvciBNQVhfQlVGRkVSX0xFTkdUSCAtIChtYXgoYnVmZmVyIGxlbmd0aHMpKSwKICAgIC8vIHNpbmNlIHRoYXQncyB0aGUgZWFybGllc3QgdGhhdCBhIGJ1ZmZlciBvdmVycnVuIGNvdWxkIG9jY3VyLiAgVGhpcyB3YXksIGNoZWNrcyBhcmUKICAgIC8vIGFzIHJhcmUgYXMgcmVxdWlyZWQsIGJ1dCBhcyBvZnRlbiBhcyBuZWNlc3NhcnkgdG8gZW5zdXJlIG5ldmVyIGNyb3NzaW5nIHRoaXMgYm91bmQuCiAgICAvLyBGdXJ0aGVybW9yZSwgYnVmZmVycyBhcmUgb25seSB0ZXN0ZWQgYXQgbW9zdCBvbmNlIHBlciB3cml0ZSgpLCBzbyBwYXNzaW5nIGEgdmVyeQogICAgLy8gbGFyZ2Ugc3RyaW5nIGludG8gd3JpdGUoKSBtaWdodCBoYXZlIHVuZGVzaXJhYmxlIGVmZmVjdHMsIGJ1dCB0aGlzIGlzIG1hbmFnZWFibGUgYnkKICAgIC8vIHRoZSBjYWxsZXIsIHNvIGl0IGlzIGFzc3VtZWQgdG8gYmUgc2FmZS4gIFRodXMsIGEgY2FsbCB0byB3cml0ZSgpIG1heSwgaW4gdGhlIGV4dHJlbWUKICAgIC8vIGVkZ2UgY2FzZSwgcmVzdWx0IGluIGNyZWF0aW5nIGF0IG1vc3Qgb25lIGNvbXBsZXRlIGNvcHkgb2YgdGhlIHN0cmluZyBwYXNzZWQgaW4uCiAgICAvLyBTZXQgdG8gSW5maW5pdHkgdG8gaGF2ZSB1bmxpbWl0ZWQgYnVmZmVycy4KCiAgICBzYXguTUFYX0JVRkZFUl9MRU5HVEggPSA2NCAqIDEwMjQ7CiAgICB2YXIgYnVmZmVycyA9IFsnY29tbWVudCcsICdzZ21sRGVjbCcsICd0ZXh0Tm9kZScsICd0YWdOYW1lJywgJ2RvY3R5cGUnLCAncHJvY0luc3ROYW1lJywgJ3Byb2NJbnN0Qm9keScsICdlbnRpdHknLCAnYXR0cmliTmFtZScsICdhdHRyaWJWYWx1ZScsICdjZGF0YScsICdzY3JpcHQnXTsKICAgIHNheC5FVkVOVFMgPSBbJ3RleHQnLCAncHJvY2Vzc2luZ2luc3RydWN0aW9uJywgJ3NnbWxkZWNsYXJhdGlvbicsICdkb2N0eXBlJywgJ2NvbW1lbnQnLCAnb3BlbnRhZ3N0YXJ0JywgJ2F0dHJpYnV0ZScsICdvcGVudGFnJywgJ2Nsb3NldGFnJywgJ29wZW5jZGF0YScsICdjZGF0YScsICdjbG9zZWNkYXRhJywgJ2Vycm9yJywgJ2VuZCcsICdyZWFkeScsICdzY3JpcHQnLCAnb3Blbm5hbWVzcGFjZScsICdjbG9zZW5hbWVzcGFjZSddOwoKICAgIGZ1bmN0aW9uIFNBWFBhcnNlcihzdHJpY3QsIG9wdCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU0FYUGFyc2VyKSkgewogICAgICAgIHJldHVybiBuZXcgU0FYUGFyc2VyKHN0cmljdCwgb3B0KTsKICAgICAgfQoKICAgICAgdmFyIHBhcnNlciA9IHRoaXM7CiAgICAgIGNsZWFyQnVmZmVycyhwYXJzZXIpOwogICAgICBwYXJzZXIucSA9IHBhcnNlci5jID0gJyc7CiAgICAgIHBhcnNlci5idWZmZXJDaGVja1Bvc2l0aW9uID0gc2F4Lk1BWF9CVUZGRVJfTEVOR1RIOwogICAgICBwYXJzZXIub3B0ID0gb3B0IHx8IHt9OwogICAgICBwYXJzZXIub3B0Lmxvd2VyY2FzZSA9IHBhcnNlci5vcHQubG93ZXJjYXNlIHx8IHBhcnNlci5vcHQubG93ZXJjYXNldGFnczsKICAgICAgcGFyc2VyLmxvb3NlQ2FzZSA9IHBhcnNlci5vcHQubG93ZXJjYXNlID8gJ3RvTG93ZXJDYXNlJyA6ICd0b1VwcGVyQ2FzZSc7CiAgICAgIHBhcnNlci50YWdzID0gW107CiAgICAgIHBhcnNlci5jbG9zZWQgPSBwYXJzZXIuY2xvc2VkUm9vdCA9IHBhcnNlci5zYXdSb290ID0gZmFsc2U7CiAgICAgIHBhcnNlci50YWcgPSBwYXJzZXIuZXJyb3IgPSBudWxsOwogICAgICBwYXJzZXIuc3RyaWN0ID0gISFzdHJpY3Q7CiAgICAgIHBhcnNlci5ub3NjcmlwdCA9ICEhKHN0cmljdCB8fCBwYXJzZXIub3B0Lm5vc2NyaXB0KTsKICAgICAgcGFyc2VyLnN0YXRlID0gUy5CRUdJTjsKICAgICAgcGFyc2VyLnN0cmljdEVudGl0aWVzID0gcGFyc2VyLm9wdC5zdHJpY3RFbnRpdGllczsKICAgICAgcGFyc2VyLkVOVElUSUVTID0gcGFyc2VyLnN0cmljdEVudGl0aWVzID8gT2JqZWN0LmNyZWF0ZShzYXguWE1MX0VOVElUSUVTKSA6IE9iamVjdC5jcmVhdGUoc2F4LkVOVElUSUVTKTsKICAgICAgcGFyc2VyLmF0dHJpYkxpc3QgPSBbXTsgLy8gbmFtZXNwYWNlcyBmb3JtIGEgcHJvdG90eXBlIGNoYWluLgogICAgICAvLyBpdCBhbHdheXMgcG9pbnRzIGF0IHRoZSBjdXJyZW50IHRhZywKICAgICAgLy8gd2hpY2ggcHJvdG9zIHRvIGl0cyBwYXJlbnQgdGFnLgoKICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMpIHsKICAgICAgICBwYXJzZXIubnMgPSBPYmplY3QuY3JlYXRlKHJvb3ROUyk7CiAgICAgIH0gLy8gbW9zdGx5IGp1c3QgZm9yIGVycm9yIHJlcG9ydGluZwoKCiAgICAgIHBhcnNlci50cmFja1Bvc2l0aW9uID0gcGFyc2VyLm9wdC5wb3NpdGlvbiAhPT0gZmFsc2U7CgogICAgICBpZiAocGFyc2VyLnRyYWNrUG9zaXRpb24pIHsKICAgICAgICBwYXJzZXIucG9zaXRpb24gPSBwYXJzZXIubGluZSA9IHBhcnNlci5jb2x1bW4gPSAwOwogICAgICB9CgogICAgICBlbWl0KHBhcnNlciwgJ29ucmVhZHknKTsKICAgIH0KCiAgICBpZiAoIU9iamVjdC5jcmVhdGUpIHsKICAgICAgT2JqZWN0LmNyZWF0ZSA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgZnVuY3Rpb24gRigpIHt9CgogICAgICAgIEYucHJvdG90eXBlID0gbzsKICAgICAgICB2YXIgbmV3ZiA9IG5ldyBGKCk7CiAgICAgICAgcmV0dXJuIG5ld2Y7CiAgICAgIH07CiAgICB9CgogICAgaWYgKCFPYmplY3Qua2V5cykgewogICAgICBPYmplY3Qua2V5cyA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgdmFyIGEgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaSBpbiBvKSBpZiAoby5oYXNPd25Qcm9wZXJ0eShpKSkgYS5wdXNoKGkpOwoKICAgICAgICByZXR1cm4gYTsKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja0J1ZmZlckxlbmd0aChwYXJzZXIpIHsKICAgICAgdmFyIG1heEFsbG93ZWQgPSBNYXRoLm1heChzYXguTUFYX0JVRkZFUl9MRU5HVEgsIDEwKTsKICAgICAgdmFyIG1heEFjdHVhbCA9IDA7CgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGJ1ZmZlcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdmFyIGxlbiA9IHBhcnNlcltidWZmZXJzW2ldXS5sZW5ndGg7CgogICAgICAgIGlmIChsZW4gPiBtYXhBbGxvd2VkKSB7CiAgICAgICAgICAvLyBUZXh0L2NkYXRhIG5vZGVzIGNhbiBnZXQgYmlnLCBhbmQgc2luY2UgdGhleSdyZSBidWZmZXJlZCwKICAgICAgICAgIC8vIHdlIGNhbiBnZXQgaGVyZSB1bmRlciBub3JtYWwgY29uZGl0aW9ucy4KICAgICAgICAgIC8vIEF2b2lkIGlzc3VlcyBieSBlbWl0dGluZyB0aGUgdGV4dCBub2RlIG5vdywKICAgICAgICAgIC8vIHNvIGF0IGxlYXN0IGl0IHdvbid0IGdldCBhbnkgYmlnZ2VyLgogICAgICAgICAgc3dpdGNoIChidWZmZXJzW2ldKSB7CiAgICAgICAgICAgIGNhc2UgJ3RleHROb2RlJzoKICAgICAgICAgICAgICBjbG9zZVRleHQocGFyc2VyKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2NkYXRhJzoKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmNkYXRhJywgcGFyc2VyLmNkYXRhKTsKICAgICAgICAgICAgICBwYXJzZXIuY2RhdGEgPSAnJzsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ3NjcmlwdCc6CiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25zY3JpcHQnLCBwYXJzZXIuc2NyaXB0KTsKICAgICAgICAgICAgICBwYXJzZXIuc2NyaXB0ID0gJyc7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGVycm9yKHBhcnNlciwgJ01heCBidWZmZXIgbGVuZ3RoIGV4Y2VlZGVkOiAnICsgYnVmZmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBtYXhBY3R1YWwgPSBNYXRoLm1heChtYXhBY3R1YWwsIGxlbik7CiAgICAgIH0gLy8gc2NoZWR1bGUgdGhlIG5leHQgY2hlY2sgZm9yIHRoZSBlYXJsaWVzdCBwb3NzaWJsZSBidWZmZXIgb3ZlcnJ1bi4KCgogICAgICB2YXIgbSA9IHNheC5NQVhfQlVGRkVSX0xFTkdUSCAtIG1heEFjdHVhbDsKICAgICAgcGFyc2VyLmJ1ZmZlckNoZWNrUG9zaXRpb24gPSBtICsgcGFyc2VyLnBvc2l0aW9uOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsZWFyQnVmZmVycyhwYXJzZXIpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBidWZmZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHBhcnNlcltidWZmZXJzW2ldXSA9ICcnOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZmx1c2hCdWZmZXJzKHBhcnNlcikgewogICAgICBjbG9zZVRleHQocGFyc2VyKTsKCiAgICAgIGlmIChwYXJzZXIuY2RhdGEgIT09ICcnKSB7CiAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jZGF0YScsIHBhcnNlci5jZGF0YSk7CiAgICAgICAgcGFyc2VyLmNkYXRhID0gJyc7CiAgICAgIH0KCiAgICAgIGlmIChwYXJzZXIuc2NyaXB0ICE9PSAnJykgewogICAgICAgIGVtaXROb2RlKHBhcnNlciwgJ29uc2NyaXB0JywgcGFyc2VyLnNjcmlwdCk7CiAgICAgICAgcGFyc2VyLnNjcmlwdCA9ICcnOwogICAgICB9CiAgICB9CgogICAgU0FYUGFyc2VyLnByb3RvdHlwZSA9IHsKICAgICAgZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgZW5kKHRoaXMpOwogICAgICB9LAogICAgICB3cml0ZTogd3JpdGUsCiAgICAgIHJlc3VtZTogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBjbG9zZTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLndyaXRlKG51bGwpOwogICAgICB9LAogICAgICBmbHVzaDogZnVuY3Rpb24gKCkgewogICAgICAgIGZsdXNoQnVmZmVycyh0aGlzKTsKICAgICAgfQogICAgfTsKICAgIHZhciBTdHJlYW07CgogICAgdHJ5IHsKICAgICAgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJykuU3RyZWFtOwogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgU3RyZWFtID0gZnVuY3Rpb24gKCkge307CiAgICB9CgogICAgdmFyIHN0cmVhbVdyYXBzID0gc2F4LkVWRU5UUy5maWx0ZXIoZnVuY3Rpb24gKGV2KSB7CiAgICAgIHJldHVybiBldiAhPT0gJ2Vycm9yJyAmJiBldiAhPT0gJ2VuZCc7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBjcmVhdGVTdHJlYW0oc3RyaWN0LCBvcHQpIHsKICAgICAgcmV0dXJuIG5ldyBTQVhTdHJlYW0oc3RyaWN0LCBvcHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIFNBWFN0cmVhbShzdHJpY3QsIG9wdCkgewogICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU0FYU3RyZWFtKSkgewogICAgICAgIHJldHVybiBuZXcgU0FYU3RyZWFtKHN0cmljdCwgb3B0KTsKICAgICAgfQoKICAgICAgU3RyZWFtLmFwcGx5KHRoaXMpOwogICAgICB0aGlzLl9wYXJzZXIgPSBuZXcgU0FYUGFyc2VyKHN0cmljdCwgb3B0KTsKICAgICAgdGhpcy53cml0YWJsZSA9IHRydWU7CiAgICAgIHRoaXMucmVhZGFibGUgPSB0cnVlOwogICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgdGhpcy5fcGFyc2VyLm9uZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgIG1lLmVtaXQoJ2VuZCcpOwogICAgICB9OwoKICAgICAgdGhpcy5fcGFyc2VyLm9uZXJyb3IgPSBmdW5jdGlvbiAoZXIpIHsKICAgICAgICBtZS5lbWl0KCdlcnJvcicsIGVyKTsgLy8gaWYgZGlkbid0IHRocm93LCB0aGVuIG1lYW5zIGVycm9yIHdhcyBoYW5kbGVkLgogICAgICAgIC8vIGdvIGFoZWFkIGFuZCBjbGVhciBlcnJvciwgc28gd2UgY2FuIHdyaXRlIGFnYWluLgoKICAgICAgICBtZS5fcGFyc2VyLmVycm9yID0gbnVsbDsKICAgICAgfTsKCiAgICAgIHRoaXMuX2RlY29kZXIgPSBudWxsOwogICAgICBzdHJlYW1XcmFwcy5mb3JFYWNoKGZ1bmN0aW9uIChldikgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShtZSwgJ29uJyArIGV2LCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1lLl9wYXJzZXJbJ29uJyArIGV2XTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChoKSB7CiAgICAgICAgICAgIGlmICghaCkgewogICAgICAgICAgICAgIG1lLnJlbW92ZUFsbExpc3RlbmVycyhldik7CiAgICAgICAgICAgICAgbWUuX3BhcnNlclsnb24nICsgZXZdID0gaDsKICAgICAgICAgICAgICByZXR1cm4gaDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWUub24oZXYsIGgpOwogICAgICAgICAgfSwKICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUsIHsKICAgICAgY29uc3RydWN0b3I6IHsKICAgICAgICB2YWx1ZTogU0FYU3RyZWFtCiAgICAgIH0KICAgIH0pOwoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodHlwZW9mIEJ1ZmZlciA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgQnVmZmVyLmlzQnVmZmVyID09PSAnZnVuY3Rpb24nICYmIEJ1ZmZlci5pc0J1ZmZlcihkYXRhKSkgewogICAgICAgIGlmICghdGhpcy5fZGVjb2RlcikgewogICAgICAgICAgdmFyIFNEID0gcmVxdWlyZSQkMV9fZGVmYXVsdFsiZGVmYXVsdCJdLlN0cmluZ0RlY29kZXI7CiAgICAgICAgICB0aGlzLl9kZWNvZGVyID0gbmV3IFNEKCd1dGY4Jyk7CiAgICAgICAgfQoKICAgICAgICBkYXRhID0gdGhpcy5fZGVjb2Rlci53cml0ZShkYXRhKTsKICAgICAgfQoKICAgICAgdGhpcy5fcGFyc2VyLndyaXRlKGRhdGEudG9TdHJpbmcoKSk7CgogICAgICB0aGlzLmVtaXQoJ2RhdGEnLCBkYXRhKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKGNodW5rKSB7CiAgICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpIHsKICAgICAgICB0aGlzLndyaXRlKGNodW5rKTsKICAgICAgfQoKICAgICAgdGhpcy5fcGFyc2VyLmVuZCgpOwoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIFNBWFN0cmVhbS5wcm90b3R5cGUub24gPSBmdW5jdGlvbiAoZXYsIGhhbmRsZXIpIHsKICAgICAgdmFyIG1lID0gdGhpczsKCiAgICAgIGlmICghbWUuX3BhcnNlclsnb24nICsgZXZdICYmIHN0cmVhbVdyYXBzLmluZGV4T2YoZXYpICE9PSAtMSkgewogICAgICAgIG1lLl9wYXJzZXJbJ29uJyArIGV2XSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IFthcmd1bWVudHNbMF1dIDogQXJyYXkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIGFyZ3Muc3BsaWNlKDAsIDAsIGV2KTsKICAgICAgICAgIG1lLmVtaXQuYXBwbHkobWUsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBTdHJlYW0ucHJvdG90eXBlLm9uLmNhbGwobWUsIGV2LCBoYW5kbGVyKTsKICAgIH07IC8vIHRoaXMgcmVhbGx5IG5lZWRzIHRvIGJlIHJlcGxhY2VkIHdpdGggY2hhcmFjdGVyIGNsYXNzZXMuCiAgICAvLyBYTUwgYWxsb3dzIGFsbCBtYW5uZXIgb2YgcmlkaWN1bG91cyBudW1iZXJzIGFuZCBkaWdpdHMuCgoKICAgIHZhciBDREFUQSA9ICdbQ0RBVEFbJzsKICAgIHZhciBET0NUWVBFID0gJ0RPQ1RZUEUnOwogICAgdmFyIFhNTF9OQU1FU1BBQ0UgPSAnaHR0cDovL3d3dy53My5vcmcvWE1MLzE5OTgvbmFtZXNwYWNlJzsKICAgIHZhciBYTUxOU19OQU1FU1BBQ0UgPSAnaHR0cDovL3d3dy53My5vcmcvMjAwMC94bWxucy8nOwogICAgdmFyIHJvb3ROUyA9IHsKICAgICAgeG1sOiBYTUxfTkFNRVNQQUNFLAogICAgICB4bWxuczogWE1MTlNfTkFNRVNQQUNFCiAgICB9OyAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9SRUMteG1sLyNOVC1OYW1lU3RhcnRDaGFyCiAgICAvLyBUaGlzIGltcGxlbWVudGF0aW9uIHdvcmtzIG9uIHN0cmluZ3MsIGEgc2luZ2xlIGNoYXJhY3RlciBhdCBhIHRpbWUKICAgIC8vIGFzIHN1Y2gsIGl0IGNhbm5vdCBldmVyIHN1cHBvcnQgYXN0cmFsLXBsYW5lIGNoYXJhY3RlcnMgKDEwMDAwLUVGRkZGKQogICAgLy8gd2l0aG91dCBhIHNpZ25pZmljYW50IGJyZWFraW5nIGNoYW5nZSB0byBlaXRoZXIgdGhpcyAgcGFyc2VyLCBvciB0aGUKICAgIC8vIEphdmFTY3JpcHQgbGFuZ3VhZ2UuICBJbXBsZW1lbnRhdGlvbiBvZiBhbiBlbW9qaS1jYXBhYmxlIHhtbCBwYXJzZXIKICAgIC8vIGlzIGxlZnQgYXMgYW4gZXhlcmNpc2UgZm9yIHRoZSByZWFkZXIuCgogICAgdmFyIG5hbWVTdGFydCA9IC9bOl9BLVphLXpcdTAwQzAtXHUwMEQ2XHUwMEQ4LVx1MDBGNlx1MDBGOC1cdTAyRkZcdTAzNzAtXHUwMzdEXHUwMzdGLVx1MUZGRlx1MjAwQy1cdTIwMERcdTIwNzAtXHUyMThGXHUyQzAwLVx1MkZFRlx1MzAwMS1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZGRF0vOwogICAgdmFyIG5hbWVCb2R5ID0gL1s6X0EtWmEtelx1MDBDMC1cdTAwRDZcdTAwRDgtXHUwMEY2XHUwMEY4LVx1MDJGRlx1MDM3MC1cdTAzN0RcdTAzN0YtXHUxRkZGXHUyMDBDLVx1MjAwRFx1MjA3MC1cdTIxOEZcdTJDMDAtXHUyRkVGXHUzMDAxLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkZEXHUwMEI3XHUwMzAwLVx1MDM2Rlx1MjAzRi1cdTIwNDAuXGQtXS87CiAgICB2YXIgZW50aXR5U3RhcnQgPSAvWyM6X0EtWmEtelx1MDBDMC1cdTAwRDZcdTAwRDgtXHUwMEY2XHUwMEY4LVx1MDJGRlx1MDM3MC1cdTAzN0RcdTAzN0YtXHUxRkZGXHUyMDBDLVx1MjAwRFx1MjA3MC1cdTIxOEZcdTJDMDAtXHUyRkVGXHUzMDAxLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkZEXS87CiAgICB2YXIgZW50aXR5Qm9keSA9IC9bIzpfQS1aYS16XHUwMEMwLVx1MDBENlx1MDBEOC1cdTAwRjZcdTAwRjgtXHUwMkZGXHUwMzcwLVx1MDM3RFx1MDM3Ri1cdTFGRkZcdTIwMEMtXHUyMDBEXHUyMDcwLVx1MjE4Rlx1MkMwMC1cdTJGRUZcdTMwMDEtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRkRcdTAwQjdcdTAzMDAtXHUwMzZGXHUyMDNGLVx1MjA0MC5cZC1dLzsKCiAgICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoYykgewogICAgICByZXR1cm4gYyA9PT0gJyAnIHx8IGMgPT09ICdcbicgfHwgYyA9PT0gJ1xyJyB8fCBjID09PSAnXHQnOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzUXVvdGUoYykgewogICAgICByZXR1cm4gYyA9PT0gJyInIHx8IGMgPT09ICdcJyc7CiAgICB9CgogICAgZnVuY3Rpb24gaXNBdHRyaWJFbmQoYykgewogICAgICByZXR1cm4gYyA9PT0gJz4nIHx8IGlzV2hpdGVzcGFjZShjKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc01hdGNoKHJlZ2V4LCBjKSB7CiAgICAgIHJldHVybiByZWdleC50ZXN0KGMpOwogICAgfQoKICAgIGZ1bmN0aW9uIG5vdE1hdGNoKHJlZ2V4LCBjKSB7CiAgICAgIHJldHVybiAhaXNNYXRjaChyZWdleCwgYyk7CiAgICB9CgogICAgdmFyIFMgPSAwOwogICAgc2F4LlNUQVRFID0gewogICAgICBCRUdJTjogUysrLAogICAgICAvLyBsZWFkaW5nIGJ5dGUgb3JkZXIgbWFyayBvciB3aGl0ZXNwYWNlCiAgICAgIEJFR0lOX1dISVRFU1BBQ0U6IFMrKywKICAgICAgLy8gbGVhZGluZyB3aGl0ZXNwYWNlCiAgICAgIFRFWFQ6IFMrKywKICAgICAgLy8gZ2VuZXJhbCBzdHVmZgogICAgICBURVhUX0VOVElUWTogUysrLAogICAgICAvLyAmYW1wIGFuZCBzdWNoLgogICAgICBPUEVOX1dBS0E6IFMrKywKICAgICAgLy8gPAogICAgICBTR01MX0RFQ0w6IFMrKywKICAgICAgLy8gPCFCTEFSRwogICAgICBTR01MX0RFQ0xfUVVPVEVEOiBTKyssCiAgICAgIC8vIDwhQkxBUkcgZm9vICJiYXIKICAgICAgRE9DVFlQRTogUysrLAogICAgICAvLyA8IURPQ1RZUEUKICAgICAgRE9DVFlQRV9RVU9URUQ6IFMrKywKICAgICAgLy8gPCFET0NUWVBFICIvL2JsYWgKICAgICAgRE9DVFlQRV9EVEQ6IFMrKywKICAgICAgLy8gPCFET0NUWVBFICIvL2JsYWgiIFsgLi4uCiAgICAgIERPQ1RZUEVfRFREX1FVT1RFRDogUysrLAogICAgICAvLyA8IURPQ1RZUEUgIi8vYmxhaCIgWyAiZm9vCiAgICAgIENPTU1FTlRfU1RBUlRJTkc6IFMrKywKICAgICAgLy8gPCEtCiAgICAgIENPTU1FTlQ6IFMrKywKICAgICAgLy8gPCEtLQogICAgICBDT01NRU5UX0VORElORzogUysrLAogICAgICAvLyA8IS0tIGJsYWggLQogICAgICBDT01NRU5UX0VOREVEOiBTKyssCiAgICAgIC8vIDwhLS0gYmxhaCAtLQogICAgICBDREFUQTogUysrLAogICAgICAvLyA8IVtDREFUQVsgc29tZXRoaW5nCiAgICAgIENEQVRBX0VORElORzogUysrLAogICAgICAvLyBdCiAgICAgIENEQVRBX0VORElOR18yOiBTKyssCiAgICAgIC8vIF1dCiAgICAgIFBST0NfSU5TVDogUysrLAogICAgICAvLyA8P2hpCiAgICAgIFBST0NfSU5TVF9CT0RZOiBTKyssCiAgICAgIC8vIDw/aGkgdGhlcmUKICAgICAgUFJPQ19JTlNUX0VORElORzogUysrLAogICAgICAvLyA8P2hpICJ0aGVyZSIgPwogICAgICBPUEVOX1RBRzogUysrLAogICAgICAvLyA8c3Ryb25nCiAgICAgIE9QRU5fVEFHX1NMQVNIOiBTKyssCiAgICAgIC8vIDxzdHJvbmcgLwogICAgICBBVFRSSUI6IFMrKywKICAgICAgLy8gPGEKICAgICAgQVRUUklCX05BTUU6IFMrKywKICAgICAgLy8gPGEgZm9vCiAgICAgIEFUVFJJQl9OQU1FX1NBV19XSElURTogUysrLAogICAgICAvLyA8YSBmb28gXwogICAgICBBVFRSSUJfVkFMVUU6IFMrKywKICAgICAgLy8gPGEgZm9vPQogICAgICBBVFRSSUJfVkFMVUVfUVVPVEVEOiBTKyssCiAgICAgIC8vIDxhIGZvbz0iYmFyCiAgICAgIEFUVFJJQl9WQUxVRV9DTE9TRUQ6IFMrKywKICAgICAgLy8gPGEgZm9vPSJiYXIiCiAgICAgIEFUVFJJQl9WQUxVRV9VTlFVT1RFRDogUysrLAogICAgICAvLyA8YSBmb289YmFyCiAgICAgIEFUVFJJQl9WQUxVRV9FTlRJVFlfUTogUysrLAogICAgICAvLyA8Zm9vIGJhcj0iJnF1b3Q7IgogICAgICBBVFRSSUJfVkFMVUVfRU5USVRZX1U6IFMrKywKICAgICAgLy8gPGZvbyBiYXI9JnF1b3QKICAgICAgQ0xPU0VfVEFHOiBTKyssCiAgICAgIC8vIDwvYQogICAgICBDTE9TRV9UQUdfU0FXX1dISVRFOiBTKyssCiAgICAgIC8vIDwvYSAgID4KICAgICAgU0NSSVBUOiBTKyssCiAgICAgIC8vIDxzY3JpcHQ+IC4uLgogICAgICBTQ1JJUFRfRU5ESU5HOiBTKysgLy8gPHNjcmlwdD4gLi4uIDwKCiAgICB9OwogICAgc2F4LlhNTF9FTlRJVElFUyA9IHsKICAgICAgJ2FtcCc6ICcmJywKICAgICAgJ2d0JzogJz4nLAogICAgICAnbHQnOiAnPCcsCiAgICAgICdxdW90JzogJyInLAogICAgICAnYXBvcyc6ICInIgogICAgfTsKICAgIHNheC5FTlRJVElFUyA9IHsKICAgICAgJ2FtcCc6ICcmJywKICAgICAgJ2d0JzogJz4nLAogICAgICAnbHQnOiAnPCcsCiAgICAgICdxdW90JzogJyInLAogICAgICAnYXBvcyc6ICInIiwKICAgICAgJ0FFbGlnJzogMTk4LAogICAgICAnQWFjdXRlJzogMTkzLAogICAgICAnQWNpcmMnOiAxOTQsCiAgICAgICdBZ3JhdmUnOiAxOTIsCiAgICAgICdBcmluZyc6IDE5NywKICAgICAgJ0F0aWxkZSc6IDE5NSwKICAgICAgJ0F1bWwnOiAxOTYsCiAgICAgICdDY2VkaWwnOiAxOTksCiAgICAgICdFVEgnOiAyMDgsCiAgICAgICdFYWN1dGUnOiAyMDEsCiAgICAgICdFY2lyYyc6IDIwMiwKICAgICAgJ0VncmF2ZSc6IDIwMCwKICAgICAgJ0V1bWwnOiAyMDMsCiAgICAgICdJYWN1dGUnOiAyMDUsCiAgICAgICdJY2lyYyc6IDIwNiwKICAgICAgJ0lncmF2ZSc6IDIwNCwKICAgICAgJ0l1bWwnOiAyMDcsCiAgICAgICdOdGlsZGUnOiAyMDksCiAgICAgICdPYWN1dGUnOiAyMTEsCiAgICAgICdPY2lyYyc6IDIxMiwKICAgICAgJ09ncmF2ZSc6IDIxMCwKICAgICAgJ09zbGFzaCc6IDIxNiwKICAgICAgJ090aWxkZSc6IDIxMywKICAgICAgJ091bWwnOiAyMTQsCiAgICAgICdUSE9STic6IDIyMiwKICAgICAgJ1VhY3V0ZSc6IDIxOCwKICAgICAgJ1VjaXJjJzogMjE5LAogICAgICAnVWdyYXZlJzogMjE3LAogICAgICAnVXVtbCc6IDIyMCwKICAgICAgJ1lhY3V0ZSc6IDIyMSwKICAgICAgJ2FhY3V0ZSc6IDIyNSwKICAgICAgJ2FjaXJjJzogMjI2LAogICAgICAnYWVsaWcnOiAyMzAsCiAgICAgICdhZ3JhdmUnOiAyMjQsCiAgICAgICdhcmluZyc6IDIyOSwKICAgICAgJ2F0aWxkZSc6IDIyNywKICAgICAgJ2F1bWwnOiAyMjgsCiAgICAgICdjY2VkaWwnOiAyMzEsCiAgICAgICdlYWN1dGUnOiAyMzMsCiAgICAgICdlY2lyYyc6IDIzNCwKICAgICAgJ2VncmF2ZSc6IDIzMiwKICAgICAgJ2V0aCc6IDI0MCwKICAgICAgJ2V1bWwnOiAyMzUsCiAgICAgICdpYWN1dGUnOiAyMzcsCiAgICAgICdpY2lyYyc6IDIzOCwKICAgICAgJ2lncmF2ZSc6IDIzNiwKICAgICAgJ2l1bWwnOiAyMzksCiAgICAgICdudGlsZGUnOiAyNDEsCiAgICAgICdvYWN1dGUnOiAyNDMsCiAgICAgICdvY2lyYyc6IDI0NCwKICAgICAgJ29ncmF2ZSc6IDI0MiwKICAgICAgJ29zbGFzaCc6IDI0OCwKICAgICAgJ290aWxkZSc6IDI0NSwKICAgICAgJ291bWwnOiAyNDYsCiAgICAgICdzemxpZyc6IDIyMywKICAgICAgJ3Rob3JuJzogMjU0LAogICAgICAndWFjdXRlJzogMjUwLAogICAgICAndWNpcmMnOiAyNTEsCiAgICAgICd1Z3JhdmUnOiAyNDksCiAgICAgICd1dW1sJzogMjUyLAogICAgICAneWFjdXRlJzogMjUzLAogICAgICAneXVtbCc6IDI1NSwKICAgICAgJ2NvcHknOiAxNjksCiAgICAgICdyZWcnOiAxNzQsCiAgICAgICduYnNwJzogMTYwLAogICAgICAnaWV4Y2wnOiAxNjEsCiAgICAgICdjZW50JzogMTYyLAogICAgICAncG91bmQnOiAxNjMsCiAgICAgICdjdXJyZW4nOiAxNjQsCiAgICAgICd5ZW4nOiAxNjUsCiAgICAgICdicnZiYXInOiAxNjYsCiAgICAgICdzZWN0JzogMTY3LAogICAgICAndW1sJzogMTY4LAogICAgICAnb3JkZic6IDE3MCwKICAgICAgJ2xhcXVvJzogMTcxLAogICAgICAnbm90JzogMTcyLAogICAgICAnc2h5JzogMTczLAogICAgICAnbWFjcic6IDE3NSwKICAgICAgJ2RlZyc6IDE3NiwKICAgICAgJ3BsdXNtbic6IDE3NywKICAgICAgJ3N1cDEnOiAxODUsCiAgICAgICdzdXAyJzogMTc4LAogICAgICAnc3VwMyc6IDE3OSwKICAgICAgJ2FjdXRlJzogMTgwLAogICAgICAnbWljcm8nOiAxODEsCiAgICAgICdwYXJhJzogMTgyLAogICAgICAnbWlkZG90JzogMTgzLAogICAgICAnY2VkaWwnOiAxODQsCiAgICAgICdvcmRtJzogMTg2LAogICAgICAncmFxdW8nOiAxODcsCiAgICAgICdmcmFjMTQnOiAxODgsCiAgICAgICdmcmFjMTInOiAxODksCiAgICAgICdmcmFjMzQnOiAxOTAsCiAgICAgICdpcXVlc3QnOiAxOTEsCiAgICAgICd0aW1lcyc6IDIxNSwKICAgICAgJ2RpdmlkZSc6IDI0NywKICAgICAgJ09FbGlnJzogMzM4LAogICAgICAnb2VsaWcnOiAzMzksCiAgICAgICdTY2Fyb24nOiAzNTIsCiAgICAgICdzY2Fyb24nOiAzNTMsCiAgICAgICdZdW1sJzogMzc2LAogICAgICAnZm5vZic6IDQwMiwKICAgICAgJ2NpcmMnOiA3MTAsCiAgICAgICd0aWxkZSc6IDczMiwKICAgICAgJ0FscGhhJzogOTEzLAogICAgICAnQmV0YSc6IDkxNCwKICAgICAgJ0dhbW1hJzogOTE1LAogICAgICAnRGVsdGEnOiA5MTYsCiAgICAgICdFcHNpbG9uJzogOTE3LAogICAgICAnWmV0YSc6IDkxOCwKICAgICAgJ0V0YSc6IDkxOSwKICAgICAgJ1RoZXRhJzogOTIwLAogICAgICAnSW90YSc6IDkyMSwKICAgICAgJ0thcHBhJzogOTIyLAogICAgICAnTGFtYmRhJzogOTIzLAogICAgICAnTXUnOiA5MjQsCiAgICAgICdOdSc6IDkyNSwKICAgICAgJ1hpJzogOTI2LAogICAgICAnT21pY3Jvbic6IDkyNywKICAgICAgJ1BpJzogOTI4LAogICAgICAnUmhvJzogOTI5LAogICAgICAnU2lnbWEnOiA5MzEsCiAgICAgICdUYXUnOiA5MzIsCiAgICAgICdVcHNpbG9uJzogOTMzLAogICAgICAnUGhpJzogOTM0LAogICAgICAnQ2hpJzogOTM1LAogICAgICAnUHNpJzogOTM2LAogICAgICAnT21lZ2EnOiA5MzcsCiAgICAgICdhbHBoYSc6IDk0NSwKICAgICAgJ2JldGEnOiA5NDYsCiAgICAgICdnYW1tYSc6IDk0NywKICAgICAgJ2RlbHRhJzogOTQ4LAogICAgICAnZXBzaWxvbic6IDk0OSwKICAgICAgJ3pldGEnOiA5NTAsCiAgICAgICdldGEnOiA5NTEsCiAgICAgICd0aGV0YSc6IDk1MiwKICAgICAgJ2lvdGEnOiA5NTMsCiAgICAgICdrYXBwYSc6IDk1NCwKICAgICAgJ2xhbWJkYSc6IDk1NSwKICAgICAgJ211JzogOTU2LAogICAgICAnbnUnOiA5NTcsCiAgICAgICd4aSc6IDk1OCwKICAgICAgJ29taWNyb24nOiA5NTksCiAgICAgICdwaSc6IDk2MCwKICAgICAgJ3Jobyc6IDk2MSwKICAgICAgJ3NpZ21hZic6IDk2MiwKICAgICAgJ3NpZ21hJzogOTYzLAogICAgICAndGF1JzogOTY0LAogICAgICAndXBzaWxvbic6IDk2NSwKICAgICAgJ3BoaSc6IDk2NiwKICAgICAgJ2NoaSc6IDk2NywKICAgICAgJ3BzaSc6IDk2OCwKICAgICAgJ29tZWdhJzogOTY5LAogICAgICAndGhldGFzeW0nOiA5NzcsCiAgICAgICd1cHNpaCc6IDk3OCwKICAgICAgJ3Bpdic6IDk4MiwKICAgICAgJ2Vuc3AnOiA4MTk0LAogICAgICAnZW1zcCc6IDgxOTUsCiAgICAgICd0aGluc3AnOiA4MjAxLAogICAgICAnenduaic6IDgyMDQsCiAgICAgICd6d2onOiA4MjA1LAogICAgICAnbHJtJzogODIwNiwKICAgICAgJ3JsbSc6IDgyMDcsCiAgICAgICduZGFzaCc6IDgyMTEsCiAgICAgICdtZGFzaCc6IDgyMTIsCiAgICAgICdsc3F1byc6IDgyMTYsCiAgICAgICdyc3F1byc6IDgyMTcsCiAgICAgICdzYnF1byc6IDgyMTgsCiAgICAgICdsZHF1byc6IDgyMjAsCiAgICAgICdyZHF1byc6IDgyMjEsCiAgICAgICdiZHF1byc6IDgyMjIsCiAgICAgICdkYWdnZXInOiA4MjI0LAogICAgICAnRGFnZ2VyJzogODIyNSwKICAgICAgJ2J1bGwnOiA4MjI2LAogICAgICAnaGVsbGlwJzogODIzMCwKICAgICAgJ3Blcm1pbCc6IDgyNDAsCiAgICAgICdwcmltZSc6IDgyNDIsCiAgICAgICdQcmltZSc6IDgyNDMsCiAgICAgICdsc2FxdW8nOiA4MjQ5LAogICAgICAncnNhcXVvJzogODI1MCwKICAgICAgJ29saW5lJzogODI1NCwKICAgICAgJ2ZyYXNsJzogODI2MCwKICAgICAgJ2V1cm8nOiA4MzY0LAogICAgICAnaW1hZ2UnOiA4NDY1LAogICAgICAnd2VpZXJwJzogODQ3MiwKICAgICAgJ3JlYWwnOiA4NDc2LAogICAgICAndHJhZGUnOiA4NDgyLAogICAgICAnYWxlZnN5bSc6IDg1MDEsCiAgICAgICdsYXJyJzogODU5MiwKICAgICAgJ3VhcnInOiA4NTkzLAogICAgICAncmFycic6IDg1OTQsCiAgICAgICdkYXJyJzogODU5NSwKICAgICAgJ2hhcnInOiA4NTk2LAogICAgICAnY3JhcnInOiA4NjI5LAogICAgICAnbEFycic6IDg2NTYsCiAgICAgICd1QXJyJzogODY1NywKICAgICAgJ3JBcnInOiA4NjU4LAogICAgICAnZEFycic6IDg2NTksCiAgICAgICdoQXJyJzogODY2MCwKICAgICAgJ2ZvcmFsbCc6IDg3MDQsCiAgICAgICdwYXJ0JzogODcwNiwKICAgICAgJ2V4aXN0JzogODcwNywKICAgICAgJ2VtcHR5JzogODcwOSwKICAgICAgJ25hYmxhJzogODcxMSwKICAgICAgJ2lzaW4nOiA4NzEyLAogICAgICAnbm90aW4nOiA4NzEzLAogICAgICAnbmknOiA4NzE1LAogICAgICAncHJvZCc6IDg3MTksCiAgICAgICdzdW0nOiA4NzIxLAogICAgICAnbWludXMnOiA4NzIyLAogICAgICAnbG93YXN0JzogODcyNywKICAgICAgJ3JhZGljJzogODczMCwKICAgICAgJ3Byb3AnOiA4NzMzLAogICAgICAnaW5maW4nOiA4NzM0LAogICAgICAnYW5nJzogODczNiwKICAgICAgJ2FuZCc6IDg3NDMsCiAgICAgICdvcic6IDg3NDQsCiAgICAgICdjYXAnOiA4NzQ1LAogICAgICAnY3VwJzogODc0NiwKICAgICAgJ2ludCc6IDg3NDcsCiAgICAgICd0aGVyZTQnOiA4NzU2LAogICAgICAnc2ltJzogODc2NCwKICAgICAgJ2NvbmcnOiA4NzczLAogICAgICAnYXN5bXAnOiA4Nzc2LAogICAgICAnbmUnOiA4ODAwLAogICAgICAnZXF1aXYnOiA4ODAxLAogICAgICAnbGUnOiA4ODA0LAogICAgICAnZ2UnOiA4ODA1LAogICAgICAnc3ViJzogODgzNCwKICAgICAgJ3N1cCc6IDg4MzUsCiAgICAgICduc3ViJzogODgzNiwKICAgICAgJ3N1YmUnOiA4ODM4LAogICAgICAnc3VwZSc6IDg4MzksCiAgICAgICdvcGx1cyc6IDg4NTMsCiAgICAgICdvdGltZXMnOiA4ODU1LAogICAgICAncGVycCc6IDg4NjksCiAgICAgICdzZG90JzogODkwMSwKICAgICAgJ2xjZWlsJzogODk2OCwKICAgICAgJ3JjZWlsJzogODk2OSwKICAgICAgJ2xmbG9vcic6IDg5NzAsCiAgICAgICdyZmxvb3InOiA4OTcxLAogICAgICAnbGFuZyc6IDkwMDEsCiAgICAgICdyYW5nJzogOTAwMiwKICAgICAgJ2xveic6IDk2NzQsCiAgICAgICdzcGFkZXMnOiA5ODI0LAogICAgICAnY2x1YnMnOiA5ODI3LAogICAgICAnaGVhcnRzJzogOTgyOSwKICAgICAgJ2RpYW1zJzogOTgzMAogICAgfTsKICAgIE9iamVjdC5rZXlzKHNheC5FTlRJVElFUykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBlID0gc2F4LkVOVElUSUVTW2tleV07CiAgICAgIHZhciBzID0gdHlwZW9mIGUgPT09ICdudW1iZXInID8gU3RyaW5nLmZyb21DaGFyQ29kZShlKSA6IGU7CiAgICAgIHNheC5FTlRJVElFU1trZXldID0gczsKICAgIH0pOwoKICAgIGZvciAodmFyIHMgaW4gc2F4LlNUQVRFKSB7CiAgICAgIHNheC5TVEFURVtzYXguU1RBVEVbc11dID0gczsKICAgIH0gLy8gc2hvcnRoYW5kCgoKICAgIFMgPSBzYXguU1RBVEU7CgogICAgZnVuY3Rpb24gZW1pdChwYXJzZXIsIGV2ZW50LCBkYXRhKSB7CiAgICAgIHBhcnNlcltldmVudF0gJiYgcGFyc2VyW2V2ZW50XShkYXRhKTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbWl0Tm9kZShwYXJzZXIsIG5vZGVUeXBlLCBkYXRhKSB7CiAgICAgIGlmIChwYXJzZXIudGV4dE5vZGUpIGNsb3NlVGV4dChwYXJzZXIpOwogICAgICBlbWl0KHBhcnNlciwgbm9kZVR5cGUsIGRhdGEpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsb3NlVGV4dChwYXJzZXIpIHsKICAgICAgcGFyc2VyLnRleHROb2RlID0gdGV4dG9wdHMocGFyc2VyLm9wdCwgcGFyc2VyLnRleHROb2RlKTsKICAgICAgaWYgKHBhcnNlci50ZXh0Tm9kZSkgZW1pdChwYXJzZXIsICdvbnRleHQnLCBwYXJzZXIudGV4dE5vZGUpOwogICAgICBwYXJzZXIudGV4dE5vZGUgPSAnJzsKICAgIH0KCiAgICBmdW5jdGlvbiB0ZXh0b3B0cyhvcHQsIHRleHQpIHsKICAgICAgaWYgKG9wdC50cmltKSB0ZXh0ID0gdGV4dC50cmltKCk7CiAgICAgIGlmIChvcHQubm9ybWFsaXplKSB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9ccysvZywgJyAnKTsKICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CgogICAgZnVuY3Rpb24gZXJyb3IocGFyc2VyLCBlcikgewogICAgICBjbG9zZVRleHQocGFyc2VyKTsKCiAgICAgIGlmIChwYXJzZXIudHJhY2tQb3NpdGlvbikgewogICAgICAgIGVyICs9ICdcbkxpbmU6ICcgKyBwYXJzZXIubGluZSArICdcbkNvbHVtbjogJyArIHBhcnNlci5jb2x1bW4gKyAnXG5DaGFyOiAnICsgcGFyc2VyLmM7CiAgICAgIH0KCiAgICAgIGVyID0gbmV3IEVycm9yKGVyKTsKICAgICAgcGFyc2VyLmVycm9yID0gZXI7CiAgICAgIGVtaXQocGFyc2VyLCAnb25lcnJvcicsIGVyKTsKICAgICAgcmV0dXJuIHBhcnNlcjsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmQocGFyc2VyKSB7CiAgICAgIGlmIChwYXJzZXIuc2F3Um9vdCAmJiAhcGFyc2VyLmNsb3NlZFJvb3QpIHN0cmljdEZhaWwocGFyc2VyLCAnVW5jbG9zZWQgcm9vdCB0YWcnKTsKCiAgICAgIGlmIChwYXJzZXIuc3RhdGUgIT09IFMuQkVHSU4gJiYgcGFyc2VyLnN0YXRlICE9PSBTLkJFR0lOX1dISVRFU1BBQ0UgJiYgcGFyc2VyLnN0YXRlICE9PSBTLlRFWFQpIHsKICAgICAgICBlcnJvcihwYXJzZXIsICdVbmV4cGVjdGVkIGVuZCcpOwogICAgICB9CgogICAgICBjbG9zZVRleHQocGFyc2VyKTsKICAgICAgcGFyc2VyLmMgPSAnJzsKICAgICAgcGFyc2VyLmNsb3NlZCA9IHRydWU7CiAgICAgIGVtaXQocGFyc2VyLCAnb25lbmQnKTsKICAgICAgU0FYUGFyc2VyLmNhbGwocGFyc2VyLCBwYXJzZXIuc3RyaWN0LCBwYXJzZXIub3B0KTsKICAgICAgcmV0dXJuIHBhcnNlcjsKICAgIH0KCiAgICBmdW5jdGlvbiBzdHJpY3RGYWlsKHBhcnNlciwgbWVzc2FnZSkgewogICAgICBpZiAodHlwZW9mIHBhcnNlciAhPT0gJ29iamVjdCcgfHwgIShwYXJzZXIgaW5zdGFuY2VvZiBTQVhQYXJzZXIpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdiYWQgY2FsbCB0byBzdHJpY3RGYWlsJyk7CiAgICAgIH0KCiAgICAgIGlmIChwYXJzZXIuc3RyaWN0KSB7CiAgICAgICAgZXJyb3IocGFyc2VyLCBtZXNzYWdlKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG5ld1RhZyhwYXJzZXIpIHsKICAgICAgaWYgKCFwYXJzZXIuc3RyaWN0KSBwYXJzZXIudGFnTmFtZSA9IHBhcnNlci50YWdOYW1lW3BhcnNlci5sb29zZUNhc2VdKCk7CiAgICAgIHZhciBwYXJlbnQgPSBwYXJzZXIudGFnc1twYXJzZXIudGFncy5sZW5ndGggLSAxXSB8fCBwYXJzZXI7CiAgICAgIHZhciB0YWcgPSBwYXJzZXIudGFnID0gewogICAgICAgIG5hbWU6IHBhcnNlci50YWdOYW1lLAogICAgICAgIGF0dHJpYnV0ZXM6IHt9CiAgICAgIH07IC8vIHdpbGwgYmUgb3ZlcnJpZGRlbiBpZiB0YWcgY29udGFpbHMgYW4geG1sbnM9ImZvbyIgb3IgeG1sbnM6Zm9vPSJiYXIiCgogICAgICBpZiAocGFyc2VyLm9wdC54bWxucykgewogICAgICAgIHRhZy5ucyA9IHBhcmVudC5uczsKICAgICAgfQoKICAgICAgcGFyc2VyLmF0dHJpYkxpc3QubGVuZ3RoID0gMDsKICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25vcGVudGFnc3RhcnQnLCB0YWcpOwogICAgfQoKICAgIGZ1bmN0aW9uIHFuYW1lKG5hbWUsIGF0dHJpYnV0ZSkgewogICAgICB2YXIgaSA9IG5hbWUuaW5kZXhPZignOicpOwogICAgICB2YXIgcXVhbE5hbWUgPSBpIDwgMCA/IFsnJywgbmFtZV0gOiBuYW1lLnNwbGl0KCc6Jyk7CiAgICAgIHZhciBwcmVmaXggPSBxdWFsTmFtZVswXTsKICAgICAgdmFyIGxvY2FsID0gcXVhbE5hbWVbMV07IC8vIDx4ICJ4bWxucyI9Imh0dHA6Ly9mb28iPgoKICAgICAgaWYgKGF0dHJpYnV0ZSAmJiBuYW1lID09PSAneG1sbnMnKSB7CiAgICAgICAgcHJlZml4ID0gJ3htbG5zJzsKICAgICAgICBsb2NhbCA9ICcnOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHByZWZpeDogcHJlZml4LAogICAgICAgIGxvY2FsOiBsb2NhbAogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGF0dHJpYihwYXJzZXIpIHsKICAgICAgaWYgKCFwYXJzZXIuc3RyaWN0KSB7CiAgICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBwYXJzZXIuYXR0cmliTmFtZVtwYXJzZXIubG9vc2VDYXNlXSgpOwogICAgICB9CgogICAgICBpZiAocGFyc2VyLmF0dHJpYkxpc3QuaW5kZXhPZihwYXJzZXIuYXR0cmliTmFtZSkgIT09IC0xIHx8IHBhcnNlci50YWcuYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwYXJzZXIuYXR0cmliTmFtZSkpIHsKICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSA9IHBhcnNlci5hdHRyaWJWYWx1ZSA9ICcnOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMpIHsKICAgICAgICB2YXIgcW4gPSBxbmFtZShwYXJzZXIuYXR0cmliTmFtZSwgdHJ1ZSk7CiAgICAgICAgdmFyIHByZWZpeCA9IHFuLnByZWZpeDsKICAgICAgICB2YXIgbG9jYWwgPSBxbi5sb2NhbDsKCiAgICAgICAgaWYgKHByZWZpeCA9PT0gJ3htbG5zJykgewogICAgICAgICAgLy8gbmFtZXNwYWNlIGJpbmRpbmcgYXR0cmlidXRlLiBwdXNoIHRoZSBiaW5kaW5nIGludG8gc2NvcGUKICAgICAgICAgIGlmIChsb2NhbCA9PT0gJ3htbCcgJiYgcGFyc2VyLmF0dHJpYlZhbHVlICE9PSBYTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAneG1sOiBwcmVmaXggbXVzdCBiZSBib3VuZCB0byAnICsgWE1MX05BTUVTUEFDRSArICdcbicgKyAnQWN0dWFsOiAnICsgcGFyc2VyLmF0dHJpYlZhbHVlKTsKICAgICAgICAgIH0gZWxzZSBpZiAobG9jYWwgPT09ICd4bWxucycgJiYgcGFyc2VyLmF0dHJpYlZhbHVlICE9PSBYTUxOU19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICd4bWxuczogcHJlZml4IG11c3QgYmUgYm91bmQgdG8gJyArIFhNTE5TX05BTUVTUEFDRSArICdcbicgKyAnQWN0dWFsOiAnICsgcGFyc2VyLmF0dHJpYlZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB0YWcgPSBwYXJzZXIudGFnOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyc2VyLnRhZ3NbcGFyc2VyLnRhZ3MubGVuZ3RoIC0gMV0gfHwgcGFyc2VyOwoKICAgICAgICAgICAgaWYgKHRhZy5ucyA9PT0gcGFyZW50Lm5zKSB7CiAgICAgICAgICAgICAgdGFnLm5zID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQubnMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0YWcubnNbbG9jYWxdID0gcGFyc2VyLmF0dHJpYlZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0gLy8gZGVmZXIgb25hdHRyaWJ1dGUgZXZlbnRzIHVudGlsIGFsbCBhdHRyaWJ1dGVzIGhhdmUgYmVlbiBzZWVuCiAgICAgICAgLy8gc28gYW55IG5ldyBiaW5kaW5ncyBjYW4gdGFrZSBlZmZlY3QuIHByZXNlcnZlIGF0dHJpYnV0ZSBvcmRlcgogICAgICAgIC8vIHNvIGRlZmVycmVkIGV2ZW50cyBjYW4gYmUgZW1pdHRlZCBpbiBkb2N1bWVudCBvcmRlcgoKCiAgICAgICAgcGFyc2VyLmF0dHJpYkxpc3QucHVzaChbcGFyc2VyLmF0dHJpYk5hbWUsIHBhcnNlci5hdHRyaWJWYWx1ZV0pOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGluIG5vbi14bWxucyBtb2RlLCB3ZSBjYW4gZW1pdCB0aGUgZXZlbnQgcmlnaHQgYXdheQogICAgICAgIHBhcnNlci50YWcuYXR0cmlidXRlc1twYXJzZXIuYXR0cmliTmFtZV0gPSBwYXJzZXIuYXR0cmliVmFsdWU7CiAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25hdHRyaWJ1dGUnLCB7CiAgICAgICAgICBuYW1lOiBwYXJzZXIuYXR0cmliTmFtZSwKICAgICAgICAgIHZhbHVlOiBwYXJzZXIuYXR0cmliVmFsdWUKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBwYXJzZXIuYXR0cmliVmFsdWUgPSAnJzsKICAgIH0KCiAgICBmdW5jdGlvbiBvcGVuVGFnKHBhcnNlciwgc2VsZkNsb3NpbmcpIHsKICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMpIHsKICAgICAgICAvLyBlbWl0IG5hbWVzcGFjZSBiaW5kaW5nIGV2ZW50cwogICAgICAgIHZhciB0YWcgPSBwYXJzZXIudGFnOyAvLyBhZGQgbmFtZXNwYWNlIGluZm8gdG8gdGFnCgogICAgICAgIHZhciBxbiA9IHFuYW1lKHBhcnNlci50YWdOYW1lKTsKICAgICAgICB0YWcucHJlZml4ID0gcW4ucHJlZml4OwogICAgICAgIHRhZy5sb2NhbCA9IHFuLmxvY2FsOwogICAgICAgIHRhZy51cmkgPSB0YWcubnNbcW4ucHJlZml4XSB8fCAnJzsKCiAgICAgICAgaWYgKHRhZy5wcmVmaXggJiYgIXRhZy51cmkpIHsKICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5ib3VuZCBuYW1lc3BhY2UgcHJlZml4OiAnICsgSlNPTi5zdHJpbmdpZnkocGFyc2VyLnRhZ05hbWUpKTsKICAgICAgICAgIHRhZy51cmkgPSBxbi5wcmVmaXg7CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyZW50ID0gcGFyc2VyLnRhZ3NbcGFyc2VyLnRhZ3MubGVuZ3RoIC0gMV0gfHwgcGFyc2VyOwoKICAgICAgICBpZiAodGFnLm5zICYmIHBhcmVudC5ucyAhPT0gdGFnLm5zKSB7CiAgICAgICAgICBPYmplY3Qua2V5cyh0YWcubnMpLmZvckVhY2goZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25vcGVubmFtZXNwYWNlJywgewogICAgICAgICAgICAgIHByZWZpeDogcCwKICAgICAgICAgICAgICB1cmk6IHRhZy5uc1twXQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0gLy8gaGFuZGxlIGRlZmVycmVkIG9uYXR0cmlidXRlIGV2ZW50cwogICAgICAgIC8vIE5vdGU6IGRvIG5vdCBhcHBseSBkZWZhdWx0IG5zIHRvIGF0dHJpYnV0ZXM6CiAgICAgICAgLy8gICBodHRwOi8vd3d3LnczLm9yZy9UUi9SRUMteG1sLW5hbWVzLyNkZWZhdWx0aW5nCgoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHBhcnNlci5hdHRyaWJMaXN0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdmFyIG52ID0gcGFyc2VyLmF0dHJpYkxpc3RbaV07CiAgICAgICAgICB2YXIgbmFtZSA9IG52WzBdOwogICAgICAgICAgdmFyIHZhbHVlID0gbnZbMV07CiAgICAgICAgICB2YXIgcXVhbE5hbWUgPSBxbmFtZShuYW1lLCB0cnVlKTsKICAgICAgICAgIHZhciBwcmVmaXggPSBxdWFsTmFtZS5wcmVmaXg7CiAgICAgICAgICB2YXIgbG9jYWwgPSBxdWFsTmFtZS5sb2NhbDsKICAgICAgICAgIHZhciB1cmkgPSBwcmVmaXggPT09ICcnID8gJycgOiB0YWcubnNbcHJlZml4XSB8fCAnJzsKICAgICAgICAgIHZhciBhID0gewogICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgIHByZWZpeDogcHJlZml4LAogICAgICAgICAgICBsb2NhbDogbG9jYWwsCiAgICAgICAgICAgIHVyaTogdXJpCiAgICAgICAgICB9OyAvLyBpZiB0aGVyZSdzIGFueSBhdHRyaWJ1dGVzIHdpdGggYW4gdW5kZWZpbmVkIG5hbWVzcGFjZSwKICAgICAgICAgIC8vIHRoZW4gZmFpbCBvbiB0aGVtIG5vdy4KCiAgICAgICAgICBpZiAocHJlZml4ICYmIHByZWZpeCAhPT0gJ3htbG5zJyAmJiAhdXJpKSB7CiAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5ib3VuZCBuYW1lc3BhY2UgcHJlZml4OiAnICsgSlNPTi5zdHJpbmdpZnkocHJlZml4KSk7CiAgICAgICAgICAgIGEudXJpID0gcHJlZml4OwogICAgICAgICAgfQoKICAgICAgICAgIHBhcnNlci50YWcuYXR0cmlidXRlc1tuYW1lXSA9IGE7CiAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmF0dHJpYnV0ZScsIGEpOwogICAgICAgIH0KCiAgICAgICAgcGFyc2VyLmF0dHJpYkxpc3QubGVuZ3RoID0gMDsKICAgICAgfQoKICAgICAgcGFyc2VyLnRhZy5pc1NlbGZDbG9zaW5nID0gISFzZWxmQ2xvc2luZzsgLy8gcHJvY2VzcyB0aGUgdGFnCgogICAgICBwYXJzZXIuc2F3Um9vdCA9IHRydWU7CiAgICAgIHBhcnNlci50YWdzLnB1c2gocGFyc2VyLnRhZyk7CiAgICAgIGVtaXROb2RlKHBhcnNlciwgJ29ub3BlbnRhZycsIHBhcnNlci50YWcpOwoKICAgICAgaWYgKCFzZWxmQ2xvc2luZykgewogICAgICAgIC8vIHNwZWNpYWwgY2FzZSBmb3IgPHNjcmlwdD4gaW4gbm9uLXN0cmljdCBtb2RlLgogICAgICAgIGlmICghcGFyc2VyLm5vc2NyaXB0ICYmIHBhcnNlci50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzY3JpcHQnKSB7CiAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNDUklQVDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgIH0KCiAgICAgICAgcGFyc2VyLnRhZyA9IG51bGw7CiAgICAgICAgcGFyc2VyLnRhZ05hbWUgPSAnJzsKICAgICAgfQoKICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBwYXJzZXIuYXR0cmliVmFsdWUgPSAnJzsKICAgICAgcGFyc2VyLmF0dHJpYkxpc3QubGVuZ3RoID0gMDsKICAgIH0KCiAgICBmdW5jdGlvbiBjbG9zZVRhZyhwYXJzZXIpIHsKICAgICAgaWYgKCFwYXJzZXIudGFnTmFtZSkgewogICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnV2VpcmQgZW1wdHkgY2xvc2UgdGFnLicpOwogICAgICAgIHBhcnNlci50ZXh0Tm9kZSArPSAnPC8+JzsKICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFQ7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAocGFyc2VyLnNjcmlwdCkgewogICAgICAgIGlmIChwYXJzZXIudGFnTmFtZSAhPT0gJ3NjcmlwdCcpIHsKICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gJzwvJyArIHBhcnNlci50YWdOYW1lICsgJz4nOwogICAgICAgICAgcGFyc2VyLnRhZ05hbWUgPSAnJzsKICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuU0NSSVBUOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25zY3JpcHQnLCBwYXJzZXIuc2NyaXB0KTsKICAgICAgICBwYXJzZXIuc2NyaXB0ID0gJyc7CiAgICAgIH0gLy8gZmlyc3QgbWFrZSBzdXJlIHRoYXQgdGhlIGNsb3NpbmcgdGFnIGFjdHVhbGx5IGV4aXN0cy4KICAgICAgLy8gPGE+PGI+PC9jPjwvYj48L2E+IHdpbGwgY2xvc2UgZXZlcnl0aGluZywgb3RoZXJ3aXNlLgoKCiAgICAgIHZhciB0ID0gcGFyc2VyLnRhZ3MubGVuZ3RoOwogICAgICB2YXIgdGFnTmFtZSA9IHBhcnNlci50YWdOYW1lOwoKICAgICAgaWYgKCFwYXJzZXIuc3RyaWN0KSB7CiAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWVbcGFyc2VyLmxvb3NlQ2FzZV0oKTsKICAgICAgfQoKICAgICAgdmFyIGNsb3NlVG8gPSB0YWdOYW1lOwoKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHZhciBjbG9zZSA9IHBhcnNlci50YWdzW3RdOwoKICAgICAgICBpZiAoY2xvc2UubmFtZSAhPT0gY2xvc2VUbykgewogICAgICAgICAgLy8gZmFpbCB0aGUgZmlyc3QgdGltZSBpbiBzdHJpY3QgbW9kZQogICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdVbmV4cGVjdGVkIGNsb3NlIHRhZycpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gLy8gZGlkbid0IGZpbmQgaXQuICB3ZSBhbHJlYWR5IGZhaWxlZCBmb3Igc3RyaWN0LCBzbyBqdXN0IGFib3J0LgoKCiAgICAgIGlmICh0IDwgMCkgewogICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5tYXRjaGVkIGNsb3NpbmcgdGFnOiAnICsgcGFyc2VyLnRhZ05hbWUpOwogICAgICAgIHBhcnNlci50ZXh0Tm9kZSArPSAnPC8nICsgcGFyc2VyLnRhZ05hbWUgKyAnPic7CiAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcGFyc2VyLnRhZ05hbWUgPSB0YWdOYW1lOwogICAgICB2YXIgcyA9IHBhcnNlci50YWdzLmxlbmd0aDsKCiAgICAgIHdoaWxlIChzLS0gPiB0KSB7CiAgICAgICAgdmFyIHRhZyA9IHBhcnNlci50YWcgPSBwYXJzZXIudGFncy5wb3AoKTsKICAgICAgICBwYXJzZXIudGFnTmFtZSA9IHBhcnNlci50YWcubmFtZTsKICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmNsb3NldGFnJywgcGFyc2VyLnRhZ05hbWUpOwogICAgICAgIHZhciB4ID0ge307CgogICAgICAgIGZvciAodmFyIGkgaW4gdGFnLm5zKSB7CiAgICAgICAgICB4W2ldID0gdGFnLm5zW2ldOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBhcmVudCA9IHBhcnNlci50YWdzW3BhcnNlci50YWdzLmxlbmd0aCAtIDFdIHx8IHBhcnNlcjsKCiAgICAgICAgaWYgKHBhcnNlci5vcHQueG1sbnMgJiYgdGFnLm5zICE9PSBwYXJlbnQubnMpIHsKICAgICAgICAgIC8vIHJlbW92ZSBuYW1lc3BhY2UgYmluZGluZ3MgaW50cm9kdWNlZCBieSB0YWcKICAgICAgICAgIE9iamVjdC5rZXlzKHRhZy5ucykuZm9yRWFjaChmdW5jdGlvbiAocCkgewogICAgICAgICAgICB2YXIgbiA9IHRhZy5uc1twXTsKICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jbG9zZW5hbWVzcGFjZScsIHsKICAgICAgICAgICAgICBwcmVmaXg6IHAsCiAgICAgICAgICAgICAgdXJpOiBuCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodCA9PT0gMCkgcGFyc2VyLmNsb3NlZFJvb3QgPSB0cnVlOwogICAgICBwYXJzZXIudGFnTmFtZSA9IHBhcnNlci5hdHRyaWJWYWx1ZSA9IHBhcnNlci5hdHRyaWJOYW1lID0gJyc7CiAgICAgIHBhcnNlci5hdHRyaWJMaXN0Lmxlbmd0aCA9IDA7CiAgICAgIHBhcnNlci5zdGF0ZSA9IFMuVEVYVDsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZUVudGl0eShwYXJzZXIpIHsKICAgICAgdmFyIGVudGl0eSA9IHBhcnNlci5lbnRpdHk7CiAgICAgIHZhciBlbnRpdHlMQyA9IGVudGl0eS50b0xvd2VyQ2FzZSgpOwogICAgICB2YXIgbnVtOwogICAgICB2YXIgbnVtU3RyID0gJyc7CgogICAgICBpZiAocGFyc2VyLkVOVElUSUVTW2VudGl0eV0pIHsKICAgICAgICByZXR1cm4gcGFyc2VyLkVOVElUSUVTW2VudGl0eV07CiAgICAgIH0KCiAgICAgIGlmIChwYXJzZXIuRU5USVRJRVNbZW50aXR5TENdKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlci5FTlRJVElFU1tlbnRpdHlMQ107CiAgICAgIH0KCiAgICAgIGVudGl0eSA9IGVudGl0eUxDOwoKICAgICAgaWYgKGVudGl0eS5jaGFyQXQoMCkgPT09ICcjJykgewogICAgICAgIGlmIChlbnRpdHkuY2hhckF0KDEpID09PSAneCcpIHsKICAgICAgICAgIGVudGl0eSA9IGVudGl0eS5zbGljZSgyKTsKICAgICAgICAgIG51bSA9IHBhcnNlSW50KGVudGl0eSwgMTYpOwogICAgICAgICAgbnVtU3RyID0gbnVtLnRvU3RyaW5nKDE2KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZW50aXR5ID0gZW50aXR5LnNsaWNlKDEpOwogICAgICAgICAgbnVtID0gcGFyc2VJbnQoZW50aXR5LCAxMCk7CiAgICAgICAgICBudW1TdHIgPSBudW0udG9TdHJpbmcoMTApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZW50aXR5ID0gZW50aXR5LnJlcGxhY2UoL14wKy8sICcnKTsKCiAgICAgIGlmIChpc05hTihudW0pIHx8IG51bVN0ci50b0xvd2VyQ2FzZSgpICE9PSBlbnRpdHkpIHsKICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ0ludmFsaWQgY2hhcmFjdGVyIGVudGl0eScpOwogICAgICAgIHJldHVybiAnJicgKyBwYXJzZXIuZW50aXR5ICsgJzsnOwogICAgICB9CgogICAgICByZXR1cm4gU3RyaW5nLmZyb21Db2RlUG9pbnQobnVtKTsKICAgIH0KCiAgICBmdW5jdGlvbiBiZWdpbldoaXRlU3BhY2UocGFyc2VyLCBjKSB7CiAgICAgIGlmIChjID09PSAnPCcpIHsKICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLk9QRU5fV0FLQTsKICAgICAgICBwYXJzZXIuc3RhcnRUYWdQb3NpdGlvbiA9IHBhcnNlci5wb3NpdGlvbjsKICAgICAgfSBlbHNlIGlmICghaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgLy8gaGF2ZSB0byBwcm9jZXNzIHRoaXMgYXMgYSB0ZXh0IG5vZGUuCiAgICAgICAgLy8gd2VpcmQsIGJ1dCBoYXBwZW5zLgogICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnTm9uLXdoaXRlc3BhY2UgYmVmb3JlIGZpcnN0IHRhZy4nKTsKICAgICAgICBwYXJzZXIudGV4dE5vZGUgPSBjOwogICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuVEVYVDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNoYXJBdChjaHVuaywgaSkgewogICAgICB2YXIgcmVzdWx0ID0gJyc7CgogICAgICBpZiAoaSA8IGNodW5rLmxlbmd0aCkgewogICAgICAgIHJlc3VsdCA9IGNodW5rLmNoYXJBdChpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiB3cml0ZShjaHVuaykgewogICAgICB2YXIgcGFyc2VyID0gdGhpczsKCiAgICAgIGlmICh0aGlzLmVycm9yKSB7CiAgICAgICAgdGhyb3cgdGhpcy5lcnJvcjsKICAgICAgfQoKICAgICAgaWYgKHBhcnNlci5jbG9zZWQpIHsKICAgICAgICByZXR1cm4gZXJyb3IocGFyc2VyLCAnQ2Fubm90IHdyaXRlIGFmdGVyIGNsb3NlLiBBc3NpZ24gYW4gb25yZWFkeSBoYW5kbGVyLicpOwogICAgICB9CgogICAgICBpZiAoY2h1bmsgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZW5kKHBhcnNlcik7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdvYmplY3QnKSB7CiAgICAgICAgY2h1bmsgPSBjaHVuay50b1N0cmluZygpOwogICAgICB9CgogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBjID0gJyc7CgogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGMgPSBjaGFyQXQoY2h1bmssIGkrKyk7CiAgICAgICAgcGFyc2VyLmMgPSBjOwoKICAgICAgICBpZiAoIWMpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgaWYgKHBhcnNlci50cmFja1Bvc2l0aW9uKSB7CiAgICAgICAgICBwYXJzZXIucG9zaXRpb24rKzsKCiAgICAgICAgICBpZiAoYyA9PT0gJ1xuJykgewogICAgICAgICAgICBwYXJzZXIubGluZSsrOwogICAgICAgICAgICBwYXJzZXIuY29sdW1uID0gMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcnNlci5jb2x1bW4rKzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN3aXRjaCAocGFyc2VyLnN0YXRlKSB7CiAgICAgICAgICBjYXNlIFMuQkVHSU46CiAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQkVHSU5fV0hJVEVTUEFDRTsKCiAgICAgICAgICAgIGlmIChjID09PSAnXHVGRUZGJykgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBiZWdpbldoaXRlU3BhY2UocGFyc2VyLCBjKTsKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkJFR0lOX1dISVRFU1BBQ0U6CiAgICAgICAgICAgIGJlZ2luV2hpdGVTcGFjZShwYXJzZXIsIGMpOwogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuVEVYVDoKICAgICAgICAgICAgaWYgKHBhcnNlci5zYXdSb290ICYmICFwYXJzZXIuY2xvc2VkUm9vdCkgewogICAgICAgICAgICAgIHZhciBzdGFydGkgPSBpIC0gMTsKCiAgICAgICAgICAgICAgd2hpbGUgKGMgJiYgYyAhPT0gJzwnICYmIGMgIT09ICcmJykgewogICAgICAgICAgICAgICAgYyA9IGNoYXJBdChjaHVuaywgaSsrKTsKCiAgICAgICAgICAgICAgICBpZiAoYyAmJiBwYXJzZXIudHJhY2tQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICBwYXJzZXIucG9zaXRpb24rKzsKCiAgICAgICAgICAgICAgICAgIGlmIChjID09PSAnXG4nKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VyLmxpbmUrKzsKICAgICAgICAgICAgICAgICAgICBwYXJzZXIuY29sdW1uID0gMDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwYXJzZXIuY29sdW1uKys7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHBhcnNlci50ZXh0Tm9kZSArPSBjaHVuay5zdWJzdHJpbmcoc3RhcnRpLCBpIC0gMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjID09PSAnPCcgJiYgIShwYXJzZXIuc2F3Um9vdCAmJiBwYXJzZXIuY2xvc2VkUm9vdCAmJiAhcGFyc2VyLnN0cmljdCkpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLk9QRU5fV0FLQTsKICAgICAgICAgICAgICBwYXJzZXIuc3RhcnRUYWdQb3NpdGlvbiA9IHBhcnNlci5wb3NpdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWlzV2hpdGVzcGFjZShjKSAmJiAoIXBhcnNlci5zYXdSb290IHx8IHBhcnNlci5jbG9zZWRSb290KSkgewogICAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdUZXh0IGRhdGEgb3V0c2lkZSBvZiByb290IG5vZGUuJyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoYyA9PT0gJyYnKSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFRfRU5USVRZOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJzZXIudGV4dE5vZGUgKz0gYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5TQ1JJUFQ6CiAgICAgICAgICAgIC8vIG9ubHkgbm9uLXN0cmljdAogICAgICAgICAgICBpZiAoYyA9PT0gJzwnKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5TQ1JJUFRfRU5ESU5HOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gYzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLlNDUklQVF9FTkRJTkc6CiAgICAgICAgICAgIGlmIChjID09PSAnLycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNMT1NFX1RBRzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuc2NyaXB0ICs9ICc8JyArIGM7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5TQ1JJUFQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5PUEVOX1dBS0E6CiAgICAgICAgICAgIC8vIGVpdGhlciBhIC8sID8sICEsIG9yIHRleHQgaXMgY29taW5nIG5leHQuCiAgICAgICAgICAgIGlmIChjID09PSAnIScpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNHTUxfREVDTDsKICAgICAgICAgICAgICBwYXJzZXIuc2dtbERlY2wgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1doaXRlc3BhY2UoYykpIDsgZWxzZSBpZiAoaXNNYXRjaChuYW1lU3RhcnQsIGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5PUEVOX1RBRzsKICAgICAgICAgICAgICBwYXJzZXIudGFnTmFtZSA9IGM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gJy8nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DTE9TRV9UQUc7CiAgICAgICAgICAgICAgcGFyc2VyLnRhZ05hbWUgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSAnPycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlBST0NfSU5TVDsKICAgICAgICAgICAgICBwYXJzZXIucHJvY0luc3ROYW1lID0gcGFyc2VyLnByb2NJbnN0Qm9keSA9ICcnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5lbmNvZGVkIDwnKTsgLy8gaWYgdGhlcmUgd2FzIHNvbWUgd2hpdGVzcGFjZSwgdGhlbiBhZGQgdGhhdCBpbi4KCiAgICAgICAgICAgICAgaWYgKHBhcnNlci5zdGFydFRhZ1Bvc2l0aW9uICsgMSA8IHBhcnNlci5wb3NpdGlvbikgewogICAgICAgICAgICAgICAgdmFyIHBhZCA9IHBhcnNlci5wb3NpdGlvbiAtIHBhcnNlci5zdGFydFRhZ1Bvc2l0aW9uOwogICAgICAgICAgICAgICAgYyA9IG5ldyBBcnJheShwYWQpLmpvaW4oJyAnKSArIGM7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwYXJzZXIudGV4dE5vZGUgKz0gJzwnICsgYzsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5TR01MX0RFQ0w6CiAgICAgICAgICAgIGlmICgocGFyc2VyLnNnbWxEZWNsICsgYykudG9VcHBlckNhc2UoKSA9PT0gQ0RBVEEpIHsKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbm9wZW5jZGF0YScpOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ0RBVEE7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhID0gJyc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocGFyc2VyLnNnbWxEZWNsICsgYyA9PT0gJy0tJykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ09NTUVOVDsKICAgICAgICAgICAgICBwYXJzZXIuY29tbWVudCA9ICcnOwogICAgICAgICAgICAgIHBhcnNlci5zZ21sRGVjbCA9ICcnOwogICAgICAgICAgICB9IGVsc2UgaWYgKChwYXJzZXIuc2dtbERlY2wgKyBjKS50b1VwcGVyQ2FzZSgpID09PSBET0NUWVBFKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFOwoKICAgICAgICAgICAgICBpZiAocGFyc2VyLmRvY3R5cGUgfHwgcGFyc2VyLnNhd1Jvb3QpIHsKICAgICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW5hcHByb3ByaWF0ZWx5IGxvY2F0ZWQgZG9jdHlwZSBkZWNsYXJhdGlvbicpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcGFyc2VyLmRvY3R5cGUgPSAnJzsKICAgICAgICAgICAgICBwYXJzZXIuc2dtbERlY2wgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbnNnbWxkZWNsYXJhdGlvbicsIHBhcnNlci5zZ21sRGVjbCk7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUXVvdGUoYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNHTUxfREVDTF9RVU9URUQ7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLnNnbWxEZWNsICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5TR01MX0RFQ0xfUVVPVEVEOgogICAgICAgICAgICBpZiAoYyA9PT0gcGFyc2VyLnEpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlNHTUxfREVDTDsKICAgICAgICAgICAgICBwYXJzZXIucSA9ICcnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwYXJzZXIuc2dtbERlY2wgKz0gYzsKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkRPQ1RZUEU6CiAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlRFWFQ7CiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25kb2N0eXBlJywgcGFyc2VyLmRvY3R5cGUpOwogICAgICAgICAgICAgIHBhcnNlci5kb2N0eXBlID0gdHJ1ZTsgLy8ganVzdCByZW1lbWJlciB0aGF0IHdlIHNhdyBpdC4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuZG9jdHlwZSArPSBjOwoKICAgICAgICAgICAgICBpZiAoYyA9PT0gJ1snKSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkRPQ1RZUEVfRFREOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNRdW90ZShjKSkgewogICAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFX1FVT1RFRDsKICAgICAgICAgICAgICAgIHBhcnNlci5xID0gYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5ET0NUWVBFX1FVT1RFRDoKICAgICAgICAgICAgcGFyc2VyLmRvY3R5cGUgKz0gYzsKCiAgICAgICAgICAgIGlmIChjID09PSBwYXJzZXIucSkgewogICAgICAgICAgICAgIHBhcnNlci5xID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuRE9DVFlQRV9EVEQ6CiAgICAgICAgICAgIHBhcnNlci5kb2N0eXBlICs9IGM7CgogICAgICAgICAgICBpZiAoYyA9PT0gJ10nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5ET0NUWVBFOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUXVvdGUoYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkRPQ1RZUEVfRFREX1FVT1RFRDsKICAgICAgICAgICAgICBwYXJzZXIucSA9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5ET0NUWVBFX0RURF9RVU9URUQ6CiAgICAgICAgICAgIHBhcnNlci5kb2N0eXBlICs9IGM7CgogICAgICAgICAgICBpZiAoYyA9PT0gcGFyc2VyLnEpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkRPQ1RZUEVfRFREOwogICAgICAgICAgICAgIHBhcnNlci5xID0gJyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DT01NRU5UOgogICAgICAgICAgICBpZiAoYyA9PT0gJy0nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DT01NRU5UX0VORElORzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuY29tbWVudCArPSBjOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuQ09NTUVOVF9FTkRJTkc6CiAgICAgICAgICAgIGlmIChjID09PSAnLScpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNPTU1FTlRfRU5ERUQ7CiAgICAgICAgICAgICAgcGFyc2VyLmNvbW1lbnQgPSB0ZXh0b3B0cyhwYXJzZXIub3B0LCBwYXJzZXIuY29tbWVudCk7CgogICAgICAgICAgICAgIGlmIChwYXJzZXIuY29tbWVudCkgewogICAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jb21tZW50JywgcGFyc2VyLmNvbW1lbnQpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcGFyc2VyLmNvbW1lbnQgPSAnJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIuY29tbWVudCArPSAnLScgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ09NTUVOVDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkNPTU1FTlRfRU5ERUQ6CiAgICAgICAgICAgIGlmIChjICE9PSAnPicpIHsKICAgICAgICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ01hbGZvcm1lZCBjb21tZW50Jyk7IC8vIGFsbG93IDwhLS0gYmxhaCAtLSBibG9vIC0tPiBpbiBub24tc3RyaWN0IG1vZGUsCiAgICAgICAgICAgICAgLy8gd2hpY2ggaXMgYSBjb21tZW50IG9mICIgYmxhaCAtLSBibG9vICIKCiAgICAgICAgICAgICAgcGFyc2VyLmNvbW1lbnQgKz0gJy0tJyArIGM7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DT01NRU5UOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuVEVYVDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkNEQVRBOgogICAgICAgICAgICBpZiAoYyA9PT0gJ10nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5DREFUQV9FTkRJTkc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DREFUQV9FTkRJTkc6CiAgICAgICAgICAgIGlmIChjID09PSAnXScpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNEQVRBX0VORElOR18yOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5jZGF0YSArPSAnXScgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ0RBVEE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DREFUQV9FTkRJTkdfMjoKICAgICAgICAgICAgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgIGlmIChwYXJzZXIuY2RhdGEpIHsKICAgICAgICAgICAgICAgIGVtaXROb2RlKHBhcnNlciwgJ29uY2RhdGEnLCBwYXJzZXIuY2RhdGEpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25jbG9zZWNkYXRhJyk7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICddJykgewogICAgICAgICAgICAgIHBhcnNlci5jZGF0YSArPSAnXSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLmNkYXRhICs9ICddXScgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQ0RBVEE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5QUk9DX0lOU1Q6CiAgICAgICAgICAgIGlmIChjID09PSAnPycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlBST0NfSU5TVF9FTkRJTkc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5QUk9DX0lOU1RfQk9EWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIucHJvY0luc3ROYW1lICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5QUk9DX0lOU1RfQk9EWToKICAgICAgICAgICAgaWYgKCFwYXJzZXIucHJvY0luc3RCb2R5ICYmIGlzV2hpdGVzcGFjZShjKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICc/JykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuUFJPQ19JTlNUX0VORElORzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYXJzZXIucHJvY0luc3RCb2R5ICs9IGM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5QUk9DX0lOU1RfRU5ESU5HOgogICAgICAgICAgICBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgZW1pdE5vZGUocGFyc2VyLCAnb25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24nLCB7CiAgICAgICAgICAgICAgICBuYW1lOiBwYXJzZXIucHJvY0luc3ROYW1lLAogICAgICAgICAgICAgICAgYm9keTogcGFyc2VyLnByb2NJbnN0Qm9keQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBhcnNlci5wcm9jSW5zdE5hbWUgPSBwYXJzZXIucHJvY0luc3RCb2R5ID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5URVhUOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlci5wcm9jSW5zdEJvZHkgKz0gJz8nICsgYzsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLlBST0NfSU5TVF9CT0RZOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuT1BFTl9UQUc6CiAgICAgICAgICAgIGlmIChpc01hdGNoKG5hbWVCb2R5LCBjKSkgewogICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3VGFnKHBhcnNlcik7CgogICAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICAgIG9wZW5UYWcocGFyc2VyKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICcvJykgewogICAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5PUEVOX1RBR19TTEFTSDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFpc1doaXRlc3BhY2UoYykpIHsKICAgICAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIGNoYXJhY3RlciBpbiB0YWcgbmFtZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLk9QRU5fVEFHX1NMQVNIOgogICAgICAgICAgICBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgb3BlblRhZyhwYXJzZXIsIHRydWUpOwogICAgICAgICAgICAgIGNsb3NlVGFnKHBhcnNlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdGb3J3YXJkLXNsYXNoIGluIG9wZW5pbmcgdGFnIG5vdCBmb2xsb3dlZCBieSA+Jyk7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5BVFRSSUI6CiAgICAgICAgICAgIC8vIGhhdmVuJ3QgcmVhZCB0aGUgYXR0cmlidXRlIG5hbWUgeWV0LgogICAgICAgICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgb3BlblRhZyhwYXJzZXIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICcvJykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuT1BFTl9UQUdfU0xBU0g7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChuYW1lU3RhcnQsIGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSBjOwogICAgICAgICAgICAgIHBhcnNlci5hdHRyaWJWYWx1ZSA9ICcnOwogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX05BTUU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5BVFRSSUJfTkFNRToKICAgICAgICAgICAgaWYgKGMgPT09ICc9JykgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX1ZBTFVFOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnQXR0cmlidXRlIHdpdGhvdXQgdmFsdWUnKTsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgPSBwYXJzZXIuYXR0cmliTmFtZTsKICAgICAgICAgICAgICBhdHRyaWIocGFyc2VyKTsKICAgICAgICAgICAgICBvcGVuVGFnKHBhcnNlcik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfTkFNRV9TQVdfV0hJVEU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChuYW1lQm9keSwgYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSArPSBjOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW52YWxpZCBhdHRyaWJ1dGUgbmFtZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuQVRUUklCX05BTUVfU0FXX1dISVRFOgogICAgICAgICAgICBpZiAoYyA9PT0gJz0nKSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdBdHRyaWJ1dGUgd2l0aG91dCB2YWx1ZScpOwogICAgICAgICAgICAgIHBhcnNlci50YWcuYXR0cmlidXRlc1twYXJzZXIuYXR0cmliTmFtZV0gPSAnJzsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgPSAnJzsKICAgICAgICAgICAgICBlbWl0Tm9kZShwYXJzZXIsICdvbmF0dHJpYnV0ZScsIHsKICAgICAgICAgICAgICAgIG5hbWU6IHBhcnNlci5hdHRyaWJOYW1lLAogICAgICAgICAgICAgICAgdmFsdWU6ICcnCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYk5hbWUgPSAnJzsKCiAgICAgICAgICAgICAgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgICAgb3BlblRhZyhwYXJzZXIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChuYW1lU3RhcnQsIGMpKSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSA9IGM7CiAgICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkFUVFJJQl9OQU1FOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ0ludmFsaWQgYXR0cmlidXRlIG5hbWUnKTsKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkFUVFJJQl9WQUxVRToKICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUXVvdGUoYykpIHsKICAgICAgICAgICAgICBwYXJzZXIucSA9IGM7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUVfUVVPVEVEOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnVW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlJyk7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUVfVU5RVU9URUQ7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYlZhbHVlID0gYzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkFUVFJJQl9WQUxVRV9RVU9URUQ6CiAgICAgICAgICAgIGlmIChjICE9PSBwYXJzZXIucSkgewogICAgICAgICAgICAgIGlmIChjID09PSAnJicpIHsKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX1ZBTFVFX0VOVElUWV9ROwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgKz0gYzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhdHRyaWIocGFyc2VyKTsKICAgICAgICAgICAgcGFyc2VyLnEgPSAnJzsKICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfVkFMVUVfQ0xPU0VEOwogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICBjYXNlIFMuQVRUUklCX1ZBTFVFX0NMT1NFRDoKICAgICAgICAgICAgaWYgKGlzV2hpdGVzcGFjZShjKSkgewogICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCOwogICAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICc+JykgewogICAgICAgICAgICAgIG9wZW5UYWcocGFyc2VyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjID09PSAnLycpIHsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLk9QRU5fVEFHX1NMQVNIOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzTWF0Y2gobmFtZVN0YXJ0LCBjKSkgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnTm8gd2hpdGVzcGFjZSBiZXR3ZWVuIGF0dHJpYnV0ZXMnKTsKICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliTmFtZSA9IGM7CiAgICAgICAgICAgICAgcGFyc2VyLmF0dHJpYlZhbHVlID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUJfTkFNRTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHJpY3RGYWlsKHBhcnNlciwgJ0ludmFsaWQgYXR0cmlidXRlIG5hbWUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgY2FzZSBTLkFUVFJJQl9WQUxVRV9VTlFVT1RFRDoKICAgICAgICAgICAgaWYgKCFpc0F0dHJpYkVuZChjKSkgewogICAgICAgICAgICAgIGlmIChjID09PSAnJicpIHsKICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuQVRUUklCX1ZBTFVFX0VOVElUWV9VOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJzZXIuYXR0cmliVmFsdWUgKz0gYzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhdHRyaWIocGFyc2VyKTsKCiAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBvcGVuVGFnKHBhcnNlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5BVFRSSUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DTE9TRV9UQUc6CiAgICAgICAgICAgIGlmICghcGFyc2VyLnRhZ05hbWUpIHsKICAgICAgICAgICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vdE1hdGNoKG5hbWVTdGFydCwgYykpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJzZXIuc2NyaXB0KSB7CiAgICAgICAgICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gJzwvJyArIGM7CiAgICAgICAgICAgICAgICAgIHBhcnNlci5zdGF0ZSA9IFMuU0NSSVBUOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIHRhZ25hbWUgaW4gY2xvc2luZyB0YWcuJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lID0gYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gJz4nKSB7CiAgICAgICAgICAgICAgY2xvc2VUYWcocGFyc2VyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc01hdGNoKG5hbWVCb2R5LCBjKSkgewogICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocGFyc2VyLnNjcmlwdCkgewogICAgICAgICAgICAgIHBhcnNlci5zY3JpcHQgKz0gJzwvJyArIHBhcnNlci50YWdOYW1lOwogICAgICAgICAgICAgIHBhcnNlci50YWdOYW1lID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gUy5TQ1JJUFQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpc1doaXRlc3BhY2UoYykpIHsKICAgICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW52YWxpZCB0YWduYW1lIGluIGNsb3NpbmcgdGFnJyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSBTLkNMT1NFX1RBR19TQVdfV0hJVEU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5DTE9TRV9UQUdfU0FXX1dISVRFOgogICAgICAgICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjID09PSAnPicpIHsKICAgICAgICAgICAgICBjbG9zZVRhZyhwYXJzZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmljdEZhaWwocGFyc2VyLCAnSW52YWxpZCBjaGFyYWN0ZXJzIGluIGNsb3NpbmcgdGFnJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIGNhc2UgUy5URVhUX0VOVElUWToKICAgICAgICAgIGNhc2UgUy5BVFRSSUJfVkFMVUVfRU5USVRZX1E6CiAgICAgICAgICBjYXNlIFMuQVRUUklCX1ZBTFVFX0VOVElUWV9VOgogICAgICAgICAgICB2YXIgcmV0dXJuU3RhdGU7CiAgICAgICAgICAgIHZhciBidWZmZXI7CgogICAgICAgICAgICBzd2l0Y2ggKHBhcnNlci5zdGF0ZSkgewogICAgICAgICAgICAgIGNhc2UgUy5URVhUX0VOVElUWToKICAgICAgICAgICAgICAgIHJldHVyblN0YXRlID0gUy5URVhUOwogICAgICAgICAgICAgICAgYnVmZmVyID0gJ3RleHROb2RlJzsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIFMuQVRUUklCX1ZBTFVFX0VOVElUWV9ROgogICAgICAgICAgICAgICAgcmV0dXJuU3RhdGUgPSBTLkFUVFJJQl9WQUxVRV9RVU9URUQ7CiAgICAgICAgICAgICAgICBidWZmZXIgPSAnYXR0cmliVmFsdWUnOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgUy5BVFRSSUJfVkFMVUVfRU5USVRZX1U6CiAgICAgICAgICAgICAgICByZXR1cm5TdGF0ZSA9IFMuQVRUUklCX1ZBTFVFX1VOUVVPVEVEOwogICAgICAgICAgICAgICAgYnVmZmVyID0gJ2F0dHJpYlZhbHVlJzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYyA9PT0gJzsnKSB7CiAgICAgICAgICAgICAgcGFyc2VyW2J1ZmZlcl0gKz0gcGFyc2VFbnRpdHkocGFyc2VyKTsKICAgICAgICAgICAgICBwYXJzZXIuZW50aXR5ID0gJyc7CiAgICAgICAgICAgICAgcGFyc2VyLnN0YXRlID0gcmV0dXJuU3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNYXRjaChwYXJzZXIuZW50aXR5Lmxlbmd0aCA/IGVudGl0eUJvZHkgOiBlbnRpdHlTdGFydCwgYykpIHsKICAgICAgICAgICAgICBwYXJzZXIuZW50aXR5ICs9IGM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyaWN0RmFpbChwYXJzZXIsICdJbnZhbGlkIGNoYXJhY3RlciBpbiBlbnRpdHkgbmFtZScpOwogICAgICAgICAgICAgIHBhcnNlcltidWZmZXJdICs9ICcmJyArIHBhcnNlci5lbnRpdHkgKyBjOwogICAgICAgICAgICAgIHBhcnNlci5lbnRpdHkgPSAnJzsKICAgICAgICAgICAgICBwYXJzZXIuc3RhdGUgPSByZXR1cm5TdGF0ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHBhcnNlciwgJ1Vua25vd24gc3RhdGU6ICcgKyBwYXJzZXIuc3RhdGUpOwogICAgICAgIH0KICAgICAgfSAvLyB3aGlsZQoKCiAgICAgIGlmIChwYXJzZXIucG9zaXRpb24gPj0gcGFyc2VyLmJ1ZmZlckNoZWNrUG9zaXRpb24pIHsKICAgICAgICBjaGVja0J1ZmZlckxlbmd0aChwYXJzZXIpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyc2VyOwogICAgfQogICAgLyohIGh0dHA6Ly9tdGhzLmJlL2Zyb21jb2RlcG9pbnQgdjAuMS4wIGJ5IEBtYXRoaWFzICovCgogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgogICAgaWYgKCFTdHJpbmcuZnJvbUNvZGVQb2ludCkgewogICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzdHJpbmdGcm9tQ2hhckNvZGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlOwogICAgICAgIHZhciBmbG9vciA9IE1hdGguZmxvb3I7CgogICAgICAgIHZhciBmcm9tQ29kZVBvaW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIE1BWF9TSVpFID0gMHg0MDAwOwogICAgICAgICAgdmFyIGNvZGVVbml0cyA9IFtdOwogICAgICAgICAgdmFyIGhpZ2hTdXJyb2dhdGU7CiAgICAgICAgICB2YXIgbG93U3Vycm9nYXRlOwogICAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsKCiAgICAgICAgICBpZiAoIWxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJlc3VsdCA9ICcnOwoKICAgICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBjb2RlUG9pbnQgPSBOdW1iZXIoYXJndW1lbnRzW2luZGV4XSk7CgogICAgICAgICAgICBpZiAoIWlzRmluaXRlKGNvZGVQb2ludCkgfHwgLy8gYE5hTmAsIGArSW5maW5pdHlgLCBvciBgLUluZmluaXR5YAogICAgICAgICAgICBjb2RlUG9pbnQgPCAwIHx8IC8vIG5vdCBhIHZhbGlkIFVuaWNvZGUgY29kZSBwb2ludAogICAgICAgICAgICBjb2RlUG9pbnQgPiAweDEwRkZGRiB8fCAvLyBub3QgYSB2YWxpZCBVbmljb2RlIGNvZGUgcG9pbnQKICAgICAgICAgICAgZmxvb3IoY29kZVBvaW50KSAhPT0gY29kZVBvaW50IC8vIG5vdCBhbiBpbnRlZ2VyCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRocm93IFJhbmdlRXJyb3IoJ0ludmFsaWQgY29kZSBwb2ludDogJyArIGNvZGVQb2ludCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjb2RlUG9pbnQgPD0gMHhGRkZGKSB7CiAgICAgICAgICAgICAgLy8gQk1QIGNvZGUgcG9pbnQKICAgICAgICAgICAgICBjb2RlVW5pdHMucHVzaChjb2RlUG9pbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIEFzdHJhbCBjb2RlIHBvaW50OyBzcGxpdCBpbiBzdXJyb2dhdGUgaGFsdmVzCiAgICAgICAgICAgICAgLy8gaHR0cDovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZyNzdXJyb2dhdGUtZm9ybXVsYWUKICAgICAgICAgICAgICBjb2RlUG9pbnQgLT0gMHgxMDAwMDsKICAgICAgICAgICAgICBoaWdoU3Vycm9nYXRlID0gKGNvZGVQb2ludCA+PiAxMCkgKyAweEQ4MDA7CiAgICAgICAgICAgICAgbG93U3Vycm9nYXRlID0gY29kZVBvaW50ICUgMHg0MDAgKyAweERDMDA7CiAgICAgICAgICAgICAgY29kZVVuaXRzLnB1c2goaGlnaFN1cnJvZ2F0ZSwgbG93U3Vycm9nYXRlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGluZGV4ICsgMSA9PT0gbGVuZ3RoIHx8IGNvZGVVbml0cy5sZW5ndGggPiBNQVhfU0laRSkgewogICAgICAgICAgICAgIHJlc3VsdCArPSBzdHJpbmdGcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgY29kZVVuaXRzKTsKICAgICAgICAgICAgICBjb2RlVW5pdHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgICAgICAgaWYgKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0cmluZywgJ2Zyb21Db2RlUG9pbnQnLCB7CiAgICAgICAgICAgIHZhbHVlOiBmcm9tQ29kZVBvaW50LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgU3RyaW5nLmZyb21Db2RlUG9pbnQgPSBmcm9tQ29kZVBvaW50OwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9KShleHBvcnRzKTsKfSkoc2F4KTsKCnZhciBfX2ltcG9ydERlZmF1bHQkMiA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9faW1wb3J0RGVmYXVsdCB8fCBmdW5jdGlvbiAobW9kKSB7CiAgcmV0dXJuIG1vZCAmJiBtb2QuX19lc01vZHVsZSA/IG1vZCA6IHsKICAgICJkZWZhdWx0IjogbW9kCiAgfTsKfTsKCmNvbnN0IGh0dHBfMSA9IF9faW1wb3J0RGVmYXVsdCQyKHJlcXVpcmUkJDBfX2RlZmF1bHRbImRlZmF1bHQiXSk7Cgpjb25zdCBodHRwc18xID0gX19pbXBvcnREZWZhdWx0JDIocmVxdWlyZSQkMV9fZGVmYXVsdCQxWyJkZWZhdWx0Il0pOwoKY29uc3Qgc3RyZWFtXzEkMyA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMVsiZGVmYXVsdCJdOwpjb25zdCBodHRwTGlicyA9IHsKICAnaHR0cDonOiBodHRwXzEuZGVmYXVsdCwKICAnaHR0cHM6JzogaHR0cHNfMS5kZWZhdWx0Cn07CmNvbnN0IHJlZGlyZWN0U3RhdHVzQ29kZXMgPSBuZXcgU2V0KFszMDEsIDMwMiwgMzAzLCAzMDcsIDMwOF0pOwpjb25zdCByZXRyeVN0YXR1c0NvZGVzID0gbmV3IFNldChbNDI5LCA1MDNdKTsgLy8gYHJlcXVlc3RgLCBgcmVzcG9uc2VgLCBgYWJvcnRgLCBsZWZ0IG91dCwgbWluaWdldCB3aWxsIGVtaXQgdGhlc2UuCgpjb25zdCByZXF1ZXN0RXZlbnRzID0gWydjb25uZWN0JywgJ2NvbnRpbnVlJywgJ2luZm9ybWF0aW9uJywgJ3NvY2tldCcsICd0aW1lb3V0JywgJ3VwZ3JhZGUnXTsKY29uc3QgcmVzcG9uc2VFdmVudHMgPSBbJ2Fib3J0ZWQnXTsKTWluaWdldC5NaW5pZ2V0RXJyb3IgPSBjbGFzcyBNaW5pZ2V0RXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgc3RhdHVzQ29kZSkgewogICAgc3VwZXIobWVzc2FnZSk7CiAgICB0aGlzLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogIH0KCn07Ck1pbmlnZXQuZGVmYXVsdE9wdGlvbnMgPSB7CiAgbWF4UmVkaXJlY3RzOiAxMCwKICBtYXhSZXRyaWVzOiAyLAogIG1heFJlY29ubmVjdHM6IDAsCiAgYmFja29mZjogewogICAgaW5jOiAxMDAsCiAgICBtYXg6IDEwMDAwCiAgfQp9OwoKZnVuY3Rpb24gTWluaWdldCh1cmwsIG9wdGlvbnMgPSB7fSkgewogIHZhciBfYTsKCiAgY29uc3Qgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIE1pbmlnZXQuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpOwogIGNvbnN0IHN0cmVhbSA9IG5ldyBzdHJlYW1fMSQzLlBhc3NUaHJvdWdoKHsKICAgIGhpZ2hXYXRlck1hcms6IG9wdHMuaGlnaFdhdGVyTWFyawogIH0pOwogIHN0cmVhbS5kZXN0cm95ZWQgPSBzdHJlYW0uYWJvcnRlZCA9IGZhbHNlOwogIGxldCBhY3RpdmVSZXF1ZXN0OwogIGxldCBhY3RpdmVSZXNwb25zZTsKICBsZXQgYWN0aXZlRGVjb2RlZFN0cmVhbTsKICBsZXQgcmVkaXJlY3RzID0gMDsKICBsZXQgcmV0cmllcyA9IDA7CiAgbGV0IHJldHJ5VGltZW91dDsKICBsZXQgcmVjb25uZWN0cyA9IDA7CiAgbGV0IGNvbnRlbnRMZW5ndGg7CiAgbGV0IGFjY2VwdFJhbmdlcyA9IGZhbHNlOwogIGxldCByYW5nZVN0YXJ0ID0gMCwKICAgICAgcmFuZ2VFbmQ7CiAgbGV0IGRvd25sb2FkZWQgPSAwOyAvLyBDaGVjayBpZiB0aGlzIGlzIGEgcmFuZ2VkIHJlcXVlc3QuCgogIGlmICgoX2EgPSBvcHRzLmhlYWRlcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5SYW5nZSkgewogICAgbGV0IHIgPSAvYnl0ZXM9KFxkKyktKFxkKyk/Ly5leGVjKGAke29wdHMuaGVhZGVycy5SYW5nZX1gKTsKCiAgICBpZiAocikgewogICAgICByYW5nZVN0YXJ0ID0gcGFyc2VJbnQoclsxXSwgMTApOwogICAgICByYW5nZUVuZCA9IHBhcnNlSW50KHJbMl0sIDEwKTsKICAgIH0KICB9IC8vIEFkZCBgQWNjZXB0LUVuY29kaW5nYCBoZWFkZXIuCgoKICBpZiAob3B0cy5hY2NlcHRFbmNvZGluZykgewogICAgb3B0cy5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICdBY2NlcHQtRW5jb2RpbmcnOiBPYmplY3Qua2V5cyhvcHRzLmFjY2VwdEVuY29kaW5nKS5qb2luKCcsICcpCiAgICB9LCBvcHRzLmhlYWRlcnMpOwogIH0KCiAgY29uc3QgZG93bmxvYWRIYXNTdGFydGVkID0gKCkgPT4gYWN0aXZlRGVjb2RlZFN0cmVhbSAmJiBkb3dubG9hZGVkID4gMDsKCiAgY29uc3QgZG93bmxvYWRDb21wbGV0ZSA9ICgpID0+ICFhY2NlcHRSYW5nZXMgfHwgZG93bmxvYWRlZCA9PT0gY29udGVudExlbmd0aDsKCiAgY29uc3QgcmVjb25uZWN0ID0gZXJyID0+IHsKICAgIGFjdGl2ZURlY29kZWRTdHJlYW0gPSBudWxsOwogICAgcmV0cmllcyA9IDA7CiAgICBsZXQgaW5jID0gb3B0cy5iYWNrb2ZmLmluYzsKICAgIGxldCBtcyA9IE1hdGgubWluKGluYywgb3B0cy5iYWNrb2ZmLm1heCk7CiAgICByZXRyeVRpbWVvdXQgPSBzZXRUaW1lb3V0KGRvRG93bmxvYWQsIG1zKTsKICAgIHN0cmVhbS5lbWl0KCdyZWNvbm5lY3QnLCByZWNvbm5lY3RzLCBlcnIpOwogIH07CgogIGNvbnN0IHJlY29ubmVjdElmRW5kZWRFYXJseSA9IGVyciA9PiB7CiAgICBpZiAob3B0aW9ucy5tZXRob2QgIT09ICdIRUFEJyAmJiAhZG93bmxvYWRDb21wbGV0ZSgpICYmIHJlY29ubmVjdHMrKyA8IG9wdHMubWF4UmVjb25uZWN0cykgewogICAgICByZWNvbm5lY3QoZXJyKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH07CgogIGNvbnN0IHJldHJ5UmVxdWVzdCA9IHJldHJ5T3B0aW9ucyA9PiB7CiAgICBpZiAoc3RyZWFtLmRlc3Ryb3llZCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKGRvd25sb2FkSGFzU3RhcnRlZCgpKSB7CiAgICAgIHJldHVybiByZWNvbm5lY3RJZkVuZGVkRWFybHkocmV0cnlPcHRpb25zLmVycik7CiAgICB9IGVsc2UgaWYgKCghcmV0cnlPcHRpb25zLmVyciB8fCByZXRyeU9wdGlvbnMuZXJyLm1lc3NhZ2UgPT09ICdFTk9URk9VTkQnKSAmJiByZXRyaWVzKysgPCBvcHRzLm1heFJldHJpZXMpIHsKICAgICAgbGV0IG1zID0gcmV0cnlPcHRpb25zLnJldHJ5QWZ0ZXIgfHwgTWF0aC5taW4ocmV0cmllcyAqIG9wdHMuYmFja29mZi5pbmMsIG9wdHMuYmFja29mZi5tYXgpOwogICAgICByZXRyeVRpbWVvdXQgPSBzZXRUaW1lb3V0KGRvRG93bmxvYWQsIG1zKTsKICAgICAgc3RyZWFtLmVtaXQoJ3JldHJ5JywgcmV0cmllcywgcmV0cnlPcHRpb25zLmVycik7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9OwoKICBjb25zdCBmb3J3YXJkRXZlbnRzID0gKGVlLCBldmVudHMpID0+IHsKICAgIGZvciAobGV0IGV2ZW50IG9mIGV2ZW50cykgewogICAgICBlZS5vbihldmVudCwgc3RyZWFtLmVtaXQuYmluZChzdHJlYW0sIGV2ZW50KSk7CiAgICB9CiAgfTsKCiAgY29uc3QgZG9Eb3dubG9hZCA9ICgpID0+IHsKICAgIGxldCBwYXJzZWQgPSB7fSwKICAgICAgICBodHRwTGliOwoKICAgIHRyeSB7CiAgICAgIGxldCB1cmxPYmogPSB0eXBlb2YgdXJsID09PSAnc3RyaW5nJyA/IG5ldyBVUkwodXJsKSA6IHVybDsKICAgICAgcGFyc2VkID0gT2JqZWN0LmFzc2lnbih7fSwgewogICAgICAgIGhvc3Q6IHVybE9iai5ob3N0LAogICAgICAgIGhvc3RuYW1lOiB1cmxPYmouaG9zdG5hbWUsCiAgICAgICAgcGF0aDogdXJsT2JqLnBhdGhuYW1lICsgdXJsT2JqLnNlYXJjaCArIHVybE9iai5oYXNoLAogICAgICAgIHBvcnQ6IHVybE9iai5wb3J0LAogICAgICAgIHByb3RvY29sOiB1cmxPYmoucHJvdG9jb2wKICAgICAgfSk7CgogICAgICBpZiAodXJsT2JqLnVzZXJuYW1lKSB7CiAgICAgICAgcGFyc2VkLmF1dGggPSBgJHt1cmxPYmoudXNlcm5hbWV9OiR7dXJsT2JqLnBhc3N3b3JkfWA7CiAgICAgIH0KCiAgICAgIGh0dHBMaWIgPSBodHRwTGlic1tTdHJpbmcocGFyc2VkLnByb3RvY29sKV07CiAgICB9IGNhdGNoIChlcnIpIHsvLyBMZXQgdGhlIGVycm9yIGJlIGNhdWdodCBieSB0aGUgaWYgc3RhdGVtZW50IGJlbG93LgogICAgfQoKICAgIGlmICghaHR0cExpYikgewogICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBuZXcgTWluaWdldC5NaW5pZ2V0RXJyb3IoYEludmFsaWQgVVJMOiAke3VybH1gKSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBPYmplY3QuYXNzaWduKHBhcnNlZCwgb3B0cyk7CgogICAgaWYgKGFjY2VwdFJhbmdlcyAmJiBkb3dubG9hZGVkID4gMCkgewogICAgICBsZXQgc3RhcnQgPSBkb3dubG9hZGVkICsgcmFuZ2VTdGFydDsKICAgICAgbGV0IGVuZCA9IHJhbmdlRW5kIHx8ICcnOwogICAgICBwYXJzZWQuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHBhcnNlZC5oZWFkZXJzLCB7CiAgICAgICAgUmFuZ2U6IGBieXRlcz0ke3N0YXJ0fS0ke2VuZH1gCiAgICAgIH0pOwogICAgfQoKICAgIGlmIChvcHRzLnRyYW5zZm9ybSkgewogICAgICB0cnkgewogICAgICAgIHBhcnNlZCA9IG9wdHMudHJhbnNmb3JtKHBhcnNlZCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXBhcnNlZCB8fCBwYXJzZWQucHJvdG9jb2wpIHsKICAgICAgICBodHRwTGliID0gaHR0cExpYnNbU3RyaW5nKHBhcnNlZCA9PT0gbnVsbCB8fCBwYXJzZWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhcnNlZC5wcm90b2NvbCldOwoKICAgICAgICBpZiAoIWh0dHBMaWIpIHsKICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIG5ldyBNaW5pZ2V0Lk1pbmlnZXRFcnJvcignSW52YWxpZCBVUkwgb2JqZWN0IGZyb20gYHRyYW5zZm9ybWAgZnVuY3Rpb24nKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY29uc3Qgb25FcnJvciA9IGVyciA9PiB7CiAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkIHx8IHN0cmVhbS5yZWFkYWJsZUVuZGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjbGVhbnVwKCk7CgogICAgICBpZiAoIXJldHJ5UmVxdWVzdCh7CiAgICAgICAgZXJyCiAgICAgIH0pKSB7CiAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhY3RpdmVSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uUmVxdWVzdENsb3NlKTsKICAgICAgfQogICAgfTsKCiAgICBjb25zdCBvblJlcXVlc3RDbG9zZSA9ICgpID0+IHsKICAgICAgY2xlYW51cCgpOwogICAgICByZXRyeVJlcXVlc3Qoe30pOwogICAgfTsKCiAgICBjb25zdCBjbGVhbnVwID0gKCkgPT4gewogICAgICBhY3RpdmVSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uUmVxdWVzdENsb3NlKTsKICAgICAgYWN0aXZlUmVzcG9uc2UgPT09IG51bGwgfHwgYWN0aXZlUmVzcG9uc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVJlc3BvbnNlLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgb25EYXRhKTsKICAgICAgYWN0aXZlRGVjb2RlZFN0cmVhbSA9PT0gbnVsbCB8fCBhY3RpdmVEZWNvZGVkU3RyZWFtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVEZWNvZGVkU3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdlbmQnLCBvbkVuZCk7CiAgICB9OwoKICAgIGNvbnN0IG9uRGF0YSA9IGNodW5rID0+IHsKICAgICAgZG93bmxvYWRlZCArPSBjaHVuay5sZW5ndGg7CiAgICB9OwoKICAgIGNvbnN0IG9uRW5kID0gKCkgPT4gewogICAgICBjbGVhbnVwKCk7CgogICAgICBpZiAoIXJlY29ubmVjdElmRW5kZWRFYXJseSgpKSB7CiAgICAgICAgc3RyZWFtLmVuZCgpOwogICAgICB9CiAgICB9OwoKICAgIGFjdGl2ZVJlcXVlc3QgPSBodHRwTGliLnJlcXVlc3QocGFyc2VkLCByZXMgPT4gewogICAgICAvLyBOZWVkZWQgZm9yIG5vZGUgdjEwLCB2MTIuCiAgICAgIC8vIGlzdGFuYnVsIGlnbm9yZSBuZXh0CiAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAocmVkaXJlY3RTdGF0dXNDb2Rlcy5oYXMocmVzLnN0YXR1c0NvZGUpKSB7CiAgICAgICAgaWYgKHJlZGlyZWN0cysrID49IG9wdHMubWF4UmVkaXJlY3RzKSB7CiAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBuZXcgTWluaWdldC5NaW5pZ2V0RXJyb3IoJ1RvbyBtYW55IHJlZGlyZWN0cycpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHJlcy5oZWFkZXJzLmxvY2F0aW9uKSB7CiAgICAgICAgICAgIHVybCA9IHJlcy5oZWFkZXJzLmxvY2F0aW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IGVyciA9IG5ldyBNaW5pZ2V0Lk1pbmlnZXRFcnJvcignUmVkaXJlY3Qgc3RhdHVzIGNvZGUgZ2l2ZW4gd2l0aCBubyBsb2NhdGlvbicsIHJlcy5zdGF0dXNDb2RlKTsKICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgc2V0VGltZW91dChkb0Rvd25sb2FkLCBwYXJzZUludChyZXMuaGVhZGVyc1sncmV0cnktYWZ0ZXInXSB8fCAnMCcsIDEwKSAqIDEwMDApOwogICAgICAgICAgc3RyZWFtLmVtaXQoJ3JlZGlyZWN0JywgdXJsKTsKICAgICAgICB9CgogICAgICAgIGNsZWFudXAoKTsKICAgICAgICByZXR1cm47IC8vIENoZWNrIGZvciByYXRlIGxpbWl0aW5nLgogICAgICB9IGVsc2UgaWYgKHJldHJ5U3RhdHVzQ29kZXMuaGFzKHJlcy5zdGF0dXNDb2RlKSkgewogICAgICAgIGlmICghcmV0cnlSZXF1ZXN0KHsKICAgICAgICAgIHJldHJ5QWZ0ZXI6IHBhcnNlSW50KHJlcy5oZWFkZXJzWydyZXRyeS1hZnRlciddIHx8ICcwJywgMTApCiAgICAgICAgfSkpIHsKICAgICAgICAgIGxldCBlcnIgPSBuZXcgTWluaWdldC5NaW5pZ2V0RXJyb3IoYFN0YXR1cyBjb2RlOiAke3Jlcy5zdGF0dXNDb2RlfWAsIHJlcy5zdGF0dXNDb2RlKTsKICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgfQoKICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKHJlcy5zdGF0dXNDb2RlICYmIChyZXMuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXMuc3RhdHVzQ29kZSA+PSA0MDApKSB7CiAgICAgICAgbGV0IGVyciA9IG5ldyBNaW5pZ2V0Lk1pbmlnZXRFcnJvcihgU3RhdHVzIGNvZGU6ICR7cmVzLnN0YXR1c0NvZGV9YCwgcmVzLnN0YXR1c0NvZGUpOwoKICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPj0gNTAwKSB7CiAgICAgICAgICBvbkVycm9yKGVycik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgfQoKICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID0gcmVzOwoKICAgICAgaWYgKG9wdHMuYWNjZXB0RW5jb2RpbmcgJiYgcmVzLmhlYWRlcnNbJ2NvbnRlbnQtZW5jb2RpbmcnXSkgewogICAgICAgIGZvciAobGV0IGVuYyBvZiByZXMuaGVhZGVyc1snY29udGVudC1lbmNvZGluZyddLnNwbGl0KCcsICcpLnJldmVyc2UoKSkgewogICAgICAgICAgbGV0IGZuID0gb3B0cy5hY2NlcHRFbmNvZGluZ1tlbmNdOwoKICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID0gYWN0aXZlRGVjb2RlZFN0cmVhbS5waXBlKGZuKCkpOwogICAgICAgICAgICBhY3RpdmVEZWNvZGVkU3RyZWFtLm9uKCdlcnJvcicsIG9uRXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFjb250ZW50TGVuZ3RoKSB7CiAgICAgICAgY29udGVudExlbmd0aCA9IHBhcnNlSW50KGAke3Jlcy5oZWFkZXJzWydjb250ZW50LWxlbmd0aCddfWAsIDEwKTsKICAgICAgICBhY2NlcHRSYW5nZXMgPSByZXMuaGVhZGVyc1snYWNjZXB0LXJhbmdlcyddID09PSAnYnl0ZXMnICYmIGNvbnRlbnRMZW5ndGggPiAwICYmIG9wdHMubWF4UmVjb25uZWN0cyA+IDA7CiAgICAgIH0KCiAgICAgIHJlcy5vbignZGF0YScsIG9uRGF0YSk7CiAgICAgIGFjdGl2ZURlY29kZWRTdHJlYW0ub24oJ2VuZCcsIG9uRW5kKTsKICAgICAgYWN0aXZlRGVjb2RlZFN0cmVhbS5waXBlKHN0cmVhbSwgewogICAgICAgIGVuZDogIWFjY2VwdFJhbmdlcwogICAgICB9KTsKICAgICAgYWN0aXZlUmVzcG9uc2UgPSByZXM7CiAgICAgIHN0cmVhbS5lbWl0KCdyZXNwb25zZScsIHJlcyk7CiAgICAgIHJlcy5vbignZXJyb3InLCBvbkVycm9yKTsKICAgICAgZm9yd2FyZEV2ZW50cyhyZXMsIHJlc3BvbnNlRXZlbnRzKTsKICAgIH0pOwogICAgYWN0aXZlUmVxdWVzdC5vbignZXJyb3InLCBvbkVycm9yKTsKICAgIGFjdGl2ZVJlcXVlc3Qub24oJ2Nsb3NlJywgb25SZXF1ZXN0Q2xvc2UpOwogICAgZm9yd2FyZEV2ZW50cyhhY3RpdmVSZXF1ZXN0LCByZXF1ZXN0RXZlbnRzKTsKCiAgICBpZiAoc3RyZWFtLmRlc3Ryb3llZCkgewogICAgICBzdHJlYW1EZXN0cm95KC4uLmRlc3Ryb3lBcmdzKTsKICAgIH0KCiAgICBzdHJlYW0uZW1pdCgncmVxdWVzdCcsIGFjdGl2ZVJlcXVlc3QpOwogICAgYWN0aXZlUmVxdWVzdC5lbmQoKTsKICB9OwoKICBzdHJlYW0uYWJvcnQgPSBlcnIgPT4gewogICAgY29uc29sZS53YXJuKCdgTWluaWdldFN0cmVhbSNhYm9ydCgpYCBoYXMgYmVlbiBkZXByZWNhdGVkIGluIGZhdm9yIG9mIGBNaW5pZ2V0U3RyZWFtI2Rlc3Ryb3koKWAnKTsKICAgIHN0cmVhbS5hYm9ydGVkID0gdHJ1ZTsKICAgIHN0cmVhbS5lbWl0KCdhYm9ydCcpOwogICAgc3RyZWFtLmRlc3Ryb3koZXJyKTsKICB9OwoKICBsZXQgZGVzdHJveUFyZ3M7CgogIGNvbnN0IHN0cmVhbURlc3Ryb3kgPSBlcnIgPT4gewogICAgYWN0aXZlUmVxdWVzdC5kZXN0cm95KGVycik7CiAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID09PSBudWxsIHx8IGFjdGl2ZURlY29kZWRTdHJlYW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZURlY29kZWRTdHJlYW0udW5waXBlKHN0cmVhbSk7CiAgICBhY3RpdmVEZWNvZGVkU3RyZWFtID09PSBudWxsIHx8IGFjdGl2ZURlY29kZWRTdHJlYW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZURlY29kZWRTdHJlYW0uZGVzdHJveSgpOwogICAgY2xlYXJUaW1lb3V0KHJldHJ5VGltZW91dCk7CiAgfTsKCiAgc3RyZWFtLl9kZXN0cm95ID0gKC4uLmFyZ3MpID0+IHsKICAgIHN0cmVhbS5kZXN0cm95ZWQgPSB0cnVlOwoKICAgIGlmIChhY3RpdmVSZXF1ZXN0KSB7CiAgICAgIHN0cmVhbURlc3Ryb3koLi4uYXJncyk7CiAgICB9IGVsc2UgewogICAgICBkZXN0cm95QXJncyA9IGFyZ3M7CiAgICB9CiAgfTsKCiAgc3RyZWFtLnRleHQgPSAoKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBsZXQgYm9keSA9ICcnOwogICAgc3RyZWFtLnNldEVuY29kaW5nKCd1dGY4Jyk7CiAgICBzdHJlYW0ub24oJ2RhdGEnLCBjaHVuayA9PiBib2R5ICs9IGNodW5rKTsKICAgIHN0cmVhbS5vbignZW5kJywgKCkgPT4gcmVzb2x2ZShib2R5KSk7CiAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTsKICB9KTsKCiAgcHJvY2Vzcy5uZXh0VGljayhkb0Rvd25sb2FkKTsKICByZXR1cm4gc3RyZWFtOwp9Cgp2YXIgZGlzdCQxID0gTWluaWdldDsKCnZhciB1dGlscyQyID0ge307Cgp2YXIgbmFtZSA9ICJ5dGRsLWNvcmUiOwp2YXIgZGVzY3JpcHRpb24gPSAiWW91VHViZSB2aWRlbyBkb3dubG9hZGVyIGluIHB1cmUgamF2YXNjcmlwdC4iOwp2YXIga2V5d29yZHMgPSBbCgkieW91dHViZSIsCgkidmlkZW8iLAoJImRvd25sb2FkIgpdOwp2YXIgdmVyc2lvbiA9ICI0LjExLjAiOwp2YXIgcmVwb3NpdG9yeSA9IHsKCXR5cGU6ICJnaXQiLAoJdXJsOiAiZ2l0Oi8vZ2l0aHViLmNvbS9mZW50L25vZGUteXRkbC1jb3JlLmdpdCIKfTsKdmFyIGF1dGhvciA9ICJmZW50IDxmZW50Ym94QGdtYWlsLmNvbT4gKGh0dHBzOi8vZ2l0aHViLmNvbS9mZW50KSI7CnZhciBjb250cmlidXRvcnMgPSBbCgkiVG9iaWFzIEt1dHNjaGEgKGh0dHBzOi8vZ2l0aHViLmNvbS9UaW1lRm9yQU5pbmphKSIsCgkiQW5kcmV3IEtlbGxleSAoaHR0cHM6Ly9naXRodWIuY29tL2FuZHJld3JrKSIsCgkiTWF1cmljaW8gQWxsZW5kZSAoaHR0cHM6Ly9naXRodWIuY29tL21hbGxlbmRlbykiLAoJIlJvZHJpZ28gQWx0YW1pcmFubyAoaHR0cHM6Ly9naXRodWIuY29tL3JhbHRhbWlyYW5vKSIsCgkiSmltIEJ1Y2sgKGh0dHBzOi8vZ2l0aHViLmNvbS9KaW1teUJvaCkiLAoJIlBhd2XFgiBSdWNpxYRza2kgKGh0dHBzOi8vZ2l0aHViLmNvbS9Sb2tpMTAwKSIsCgkiQWxleGFuZGVyIFBhb2xpbmkgKGh0dHBzOi8vZ2l0aHViLmNvbS9NaWxsaW9uOTAwbykiCl07CnZhciBtYWluID0gIi4vbGliL2luZGV4LmpzIjsKdmFyIHR5cGVzID0gIi4vdHlwaW5ncy9pbmRleC5kLnRzIjsKdmFyIGZpbGVzID0gWwoJImxpYiIsCgkidHlwaW5ncyIKXTsKdmFyIHNjcmlwdHMgPSB7Cgl0ZXN0OiAibnljIC0tcmVwb3J0ZXI9bGNvdiAtLXJlcG9ydGVyPXRleHQtc3VtbWFyeSBucG0gcnVuIHRlc3Q6dW5pdCIsCgkidGVzdDp1bml0IjogIm1vY2hhIC0taWdub3JlIHRlc3QvaXJsLXRlc3QuanMgdGVzdC8qLXRlc3QuanMgLS10aW1lb3V0IDQwMDAiLAoJInRlc3Q6aXJsIjogIm1vY2hhIC0tdGltZW91dCAxNjAwMCB0ZXN0L2lybC10ZXN0LmpzIiwKCWxpbnQ6ICJlc2xpbnQgLi8iLAoJImxpbnQ6Zml4IjogImVzbGludCAtLWZpeCAuLyIsCgkibGludDp0eXBpbmdzIjogInRzbGludCB0eXBpbmdzL2luZGV4LmQudHMiLAoJImxpbnQ6dHlwaW5nczpmaXgiOiAidHNsaW50IC0tZml4IHR5cGluZ3MvaW5kZXguZC50cyIKfTsKdmFyIGRlcGVuZGVuY2llcyA9IHsKCW0zdThzdHJlYW06ICJeMC44LjYiLAoJbWluaWdldDogIl40LjIuMiIsCglzYXg6ICJeMS4xLjMiCn07CnZhciBkZXZEZXBlbmRlbmNpZXMgPSB7CgkiQHR5cGVzL25vZGUiOiAiXjEzLjEuMCIsCgkiYXNzZXJ0LWRpZmYiOiAiXjMuMC4xIiwKCWR0c2xpbnQ6ICJeMy42LjE0IiwKCWVzbGludDogIl42LjguMCIsCgltb2NoYTogIl43LjAuMCIsCgkibXVrLXJlcXVpcmUiOiAiXjEuMi4wIiwKCW5vY2s6ICJeMTMuMC40IiwKCW55YzogIl4xNS4wLjAiLAoJc2lub246ICJeOS4wLjAiLAoJInN0cmVhbS1lcXVhbCI6ICJ+MS4xLjAiLAoJdHlwZXNjcmlwdDogIl4zLjkuNyIKfTsKdmFyIGVuZ2luZXMgPSB7Cglub2RlOiAiPj0xMiIKfTsKdmFyIGxpY2Vuc2UgPSAiTUlUIjsKdmFyIHJlcXVpcmUkJDggPSB7CgluYW1lOiBuYW1lLAoJZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLAoJa2V5d29yZHM6IGtleXdvcmRzLAoJdmVyc2lvbjogdmVyc2lvbiwKCXJlcG9zaXRvcnk6IHJlcG9zaXRvcnksCglhdXRob3I6IGF1dGhvciwKCWNvbnRyaWJ1dG9yczogY29udHJpYnV0b3JzLAoJbWFpbjogbWFpbiwKCXR5cGVzOiB0eXBlcywKCWZpbGVzOiBmaWxlcywKCXNjcmlwdHM6IHNjcmlwdHMsCglkZXBlbmRlbmNpZXM6IGRlcGVuZGVuY2llcywKCWRldkRlcGVuZGVuY2llczogZGV2RGVwZW5kZW5jaWVzLAoJZW5naW5lczogZW5naW5lcywKCWxpY2Vuc2U6IGxpY2Vuc2UKfTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewogIGNvbnN0IG1pbmlnZXQgPSBkaXN0JDE7CiAgLyoqCiAgICogRXh0cmFjdCBzdHJpbmcgaW5iZXR3ZWVuIGFub3RoZXIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaGF5c3RhY2sKICAgKiBAcGFyYW0ge3N0cmluZ30gbGVmdAogICAqIEBwYXJhbSB7c3RyaW5nfSByaWdodAogICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgICovCgogIGV4cG9ydHMuYmV0d2VlbiA9IChoYXlzdGFjaywgbGVmdCwgcmlnaHQpID0+IHsKICAgIGxldCBwb3M7CgogICAgaWYgKGxlZnQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgY29uc3QgbWF0Y2ggPSBoYXlzdGFjay5tYXRjaChsZWZ0KTsKCiAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KCiAgICAgIHBvcyA9IG1hdGNoLmluZGV4ICsgbWF0Y2hbMF0ubGVuZ3RoOwogICAgfSBlbHNlIHsKICAgICAgcG9zID0gaGF5c3RhY2suaW5kZXhPZihsZWZ0KTsKCiAgICAgIGlmIChwb3MgPT09IC0xKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CgogICAgICBwb3MgKz0gbGVmdC5sZW5ndGg7CiAgICB9CgogICAgaGF5c3RhY2sgPSBoYXlzdGFjay5zbGljZShwb3MpOwogICAgcG9zID0gaGF5c3RhY2suaW5kZXhPZihyaWdodCk7CgogICAgaWYgKHBvcyA9PT0gLTEpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQoKICAgIGhheXN0YWNrID0gaGF5c3RhY2suc2xpY2UoMCwgcG9zKTsKICAgIHJldHVybiBoYXlzdGFjazsKICB9OwogIC8qKgogICAqIEdldCBhIG51bWJlciBmcm9tIGFuIGFiYnJldmlhdGVkIG51bWJlciBzdHJpbmcuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nCiAgICogQHJldHVybnMge251bWJlcn0KICAgKi8KCgogIGV4cG9ydHMucGFyc2VBYmJyZXZpYXRlZE51bWJlciA9IHN0cmluZyA9PiB7CiAgICBjb25zdCBtYXRjaCA9IHN0cmluZy5yZXBsYWNlKCcsJywgJy4nKS5yZXBsYWNlKCcgJywgJycpLm1hdGNoKC8oW1xkLC5dKykoW01LXT8pLyk7CgogICAgaWYgKG1hdGNoKSB7CiAgICAgIGxldCBbLCBudW0sIG11bHRpXSA9IG1hdGNoOwogICAgICBudW0gPSBwYXJzZUZsb2F0KG51bSk7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKG11bHRpID09PSAnTScgPyBudW0gKiAxMDAwMDAwIDogbXVsdGkgPT09ICdLJyA/IG51bSAqIDEwMDAgOiBudW0pOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CiAgLyoqCiAgICogTWF0Y2ggYmVnaW4gYW5kIGVuZCBicmFjZXMgb2YgaW5wdXQgSlNPTiwgcmV0dXJuIG9ubHkganNvbgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG1peGVkSnNvbgogICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgKi8KCgogIGV4cG9ydHMuY3V0QWZ0ZXJKU09OID0gbWl4ZWRKc29uID0+IHsKICAgIGxldCBvcGVuLCBjbG9zZTsKCiAgICBpZiAobWl4ZWRKc29uWzBdID09PSAnWycpIHsKICAgICAgb3BlbiA9ICdbJzsKICAgICAgY2xvc2UgPSAnXSc7CiAgICB9IGVsc2UgaWYgKG1peGVkSnNvblswXSA9PT0gJ3snKSB7CiAgICAgIG9wZW4gPSAneyc7CiAgICAgIGNsb3NlID0gJ30nOwogICAgfQoKICAgIGlmICghb3BlbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGN1dCB1bnN1cHBvcnRlZCBKU09OIChuZWVkIHRvIGJlZ2luIHdpdGggWyBvciB7ICkgYnV0IGdvdDogJHttaXhlZEpzb25bMF19YCk7CiAgICB9IC8vIFN0YXRlcyBpZiB0aGUgbG9vcCBpcyBjdXJyZW50bHkgaW4gYSBzdHJpbmcKCgogICAgbGV0IGlzU3RyaW5nID0gZmFsc2U7IC8vIFN0YXRlcyBpZiB0aGUgY3VycmVudCBjaGFyYWN0ZXIgaXMgdHJlYXRlZCBhcyBlc2NhcGVkIG9yIG5vdAoKICAgIGxldCBpc0VzY2FwZWQgPSBmYWxzZTsgLy8gQ3VycmVudCBvcGVuIGJyYWNrZXRzIHRvIGJlIGNsb3NlZAoKICAgIGxldCBjb3VudGVyID0gMDsKICAgIGxldCBpOwoKICAgIGZvciAoaSA9IDA7IGkgPCBtaXhlZEpzb24ubGVuZ3RoOyBpKyspIHsKICAgICAgLy8gVG9nZ2xlIHRoZSBpc1N0cmluZyBib29sZWFuIHdoZW4gbGVhdmluZy9lbnRlcmluZyBzdHJpbmcKICAgICAgaWYgKG1peGVkSnNvbltpXSA9PT0gJyInICYmICFpc0VzY2FwZWQpIHsKICAgICAgICBpc1N0cmluZyA9ICFpc1N0cmluZzsKICAgICAgICBjb250aW51ZTsKICAgICAgfSAvLyBUb2dnbGUgdGhlIGlzRXNjYXBlZCBib29sZWFuIGZvciBldmVyeSBiYWNrc2xhc2gKICAgICAgLy8gUmVzZXQgZm9yIGV2ZXJ5IHJlZ3VsYXIgY2hhcmFjdGVyCgoKICAgICAgaXNFc2NhcGVkID0gbWl4ZWRKc29uW2ldID09PSAnXFwnICYmICFpc0VzY2FwZWQ7CiAgICAgIGlmIChpc1N0cmluZykgY29udGludWU7CgogICAgICBpZiAobWl4ZWRKc29uW2ldID09PSBvcGVuKSB7CiAgICAgICAgY291bnRlcisrOwogICAgICB9IGVsc2UgaWYgKG1peGVkSnNvbltpXSA9PT0gY2xvc2UpIHsKICAgICAgICBjb3VudGVyLS07CiAgICAgIH0gLy8gQWxsIGJyYWNrZXRzIGhhdmUgYmVlbiBjbG9zZWQsIHRodXMgZW5kIG9mIEpTT04gaXMgcmVhY2hlZAoKCiAgICAgIGlmIChjb3VudGVyID09PSAwKSB7CiAgICAgICAgLy8gUmV0dXJuIHRoZSBjdXQgSlNPTgogICAgICAgIHJldHVybiBtaXhlZEpzb24uc3Vic3RyKDAsIGkgKyAxKTsKICAgICAgfQogICAgfSAvLyBXZSByYW4gdGhyb3VnaCB0aGUgd2hvbGUgc3RyaW5nIGFuZCBlbmRlZCB1cCB3aXRoIGFuIHVuY2xvc2VkIGJyYWNrZXQKCgogICAgdGhyb3cgRXJyb3IoIkNhbid0IGN1dCB1bnN1cHBvcnRlZCBKU09OIChubyBtYXRjaGluZyBjbG9zaW5nIGJyYWNrZXQgZm91bmQpIik7CiAgfTsKICAvKioKICAgKiBDaGVja3MgaWYgdGhlcmUgaXMgYSBwbGF5YWJpbGl0eSBlcnJvci4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBwbGF5ZXJfcmVzcG9uc2UKICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+fSBzdGF0dXNlcwogICAqIEBwYXJhbSB7RXJyb3J9IEVycm9yVHlwZQogICAqIEByZXR1cm5zIHshRXJyb3J9CiAgICovCgoKICBleHBvcnRzLnBsYXlFcnJvciA9IChwbGF5ZXJfcmVzcG9uc2UsIHN0YXR1c2VzLCBFcnJvclR5cGUgPSBFcnJvcikgPT4gewogICAgbGV0IHBsYXlhYmlsaXR5ID0gcGxheWVyX3Jlc3BvbnNlICYmIHBsYXllcl9yZXNwb25zZS5wbGF5YWJpbGl0eVN0YXR1czsKCiAgICBpZiAocGxheWFiaWxpdHkgJiYgc3RhdHVzZXMuaW5jbHVkZXMocGxheWFiaWxpdHkuc3RhdHVzKSkgewogICAgICByZXR1cm4gbmV3IEVycm9yVHlwZShwbGF5YWJpbGl0eS5yZWFzb24gfHwgcGxheWFiaWxpdHkubWVzc2FnZXMgJiYgcGxheWFiaWxpdHkubWVzc2FnZXNbMF0pOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CiAgLyoqCiAgICogRG9lcyBhIG1pbmlnZXQgcmVxdWVzdCBhbmQgY2FsbHMgb3B0aW9ucy5yZXF1ZXN0Q2FsbGJhY2sgaWYgcHJlc2VudAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCB0aGUgcmVxdWVzdCB1cmwKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBhbiBvYmplY3Qgd2l0aCBvcHRpb25hbCByZXF1ZXN0T3B0aW9ucyBhbmQgcmVxdWVzdENhbGxiYWNrIHBhcmFtZXRlcnMKICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdE9wdGlvbnNPdmVyd3JpdGUgb3ZlcndyaXRlIG9mIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMKICAgKiBAcmV0dXJucyB7bWluaWdldC5TdHJlYW19CiAgICovCgoKICBleHBvcnRzLmV4cG9zZWRNaW5pZ2V0ID0gKHVybCwgb3B0aW9ucyA9IHt9LCByZXF1ZXN0T3B0aW9uc092ZXJ3cml0ZSkgPT4gewogICAgY29uc3QgcmVxID0gbWluaWdldCh1cmwsIHJlcXVlc3RPcHRpb25zT3ZlcndyaXRlIHx8IG9wdGlvbnMucmVxdWVzdE9wdGlvbnMpOwogICAgaWYgKHR5cGVvZiBvcHRpb25zLnJlcXVlc3RDYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgb3B0aW9ucy5yZXF1ZXN0Q2FsbGJhY2socmVxKTsKICAgIHJldHVybiByZXE7CiAgfTsKICAvKioKICAgKiBUZW1wb3JhcnkgaGVscGVyIHRvIGhlbHAgZGVwcmVjYXRpbmcgYSBmZXcgcHJvcGVydGllcy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmoKICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcAogICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRQYXRoCiAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1BhdGgKICAgKi8KCgogIGV4cG9ydHMuZGVwcmVjYXRlID0gKG9iaiwgcHJvcCwgdmFsdWUsIG9sZFBhdGgsIG5ld1BhdGgpID0+IHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIHByb3AsIHsKICAgICAgZ2V0OiAoKSA9PiB7CiAgICAgICAgY29uc29sZS53YXJuKGBcYCR7b2xkUGF0aH1cYCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBuZWFyIGZ1dHVyZSByZWxlYXNlLCBgICsgYHVzZSBcYCR7bmV3UGF0aH1cYCBpbnN0ZWFkLmApOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgfTsgLy8gQ2hlY2sgZm9yIHVwZGF0ZXMuCgoKICBjb25zdCBwa2cgPSByZXF1aXJlJCQ4OwogIGNvbnN0IFVQREFURV9JTlRFUlZBTCA9IDEwMDAgKiA2MCAqIDYwICogMTI7CiAgZXhwb3J0cy5sYXN0VXBkYXRlQ2hlY2sgPSAwOwoKICBleHBvcnRzLmNoZWNrRm9yVXBkYXRlcyA9ICgpID0+IHsKICAgIGlmICghcHJvY2Vzcy5lbnYuWVRETF9OT19VUERBVEUgJiYgIXBrZy52ZXJzaW9uLnN0YXJ0c1dpdGgoJzAuMC4wLScpICYmIERhdGUubm93KCkgLSBleHBvcnRzLmxhc3RVcGRhdGVDaGVjayA+PSBVUERBVEVfSU5URVJWQUwpIHsKICAgICAgZXhwb3J0cy5sYXN0VXBkYXRlQ2hlY2sgPSBEYXRlLm5vdygpOwogICAgICByZXR1cm4gbWluaWdldCgnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9mZW50L25vZGUteXRkbC1jb3JlL3JlbGVhc2VzL2xhdGVzdCcsIHsKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAnVXNlci1BZ2VudCc6ICd5dGRsLWNvcmUnCiAgICAgICAgfQogICAgICB9KS50ZXh0KCkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgaWYgKEpTT04ucGFyc2UocmVzcG9uc2UpLnRhZ19uYW1lICE9PSBgdiR7cGtnLnZlcnNpb259YCkgewogICAgICAgICAgY29uc29sZS53YXJuKCdceDFiWzMzbVdBUk5JTkc6XHgxQlswbSB5dGRsLWNvcmUgaXMgb3V0IG9mIGRhdGUhIFVwZGF0ZSB3aXRoICJucG0gaW5zdGFsbCB5dGRsLWNvcmVAbGF0ZXN0Ii4nKTsKICAgICAgICB9CiAgICAgIH0sIGVyciA9PiB7CiAgICAgICAgY29uc29sZS53YXJuKCdFcnJvciBjaGVja2luZyBmb3IgdXBkYXRlczonLCBlcnIubWVzc2FnZSk7CiAgICAgICAgY29uc29sZS53YXJuKCdZb3UgY2FuIGRpc2FibGUgdGhpcyBjaGVjayBieSBzZXR0aW5nIHRoZSBgWVRETF9OT19VUERBVEVgIGVudiB2YXJpYWJsZS4nKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfTsKICAvKioKICAgKiBHZXRzIHJhbmRvbSBJUHY2IEFkZHJlc3MgZnJvbSBhIGJsb2NrCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaXAgdGhlIElQdjYgYmxvY2sgaW4gQ0lEUi1Ob3RhdGlvbgogICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgICovCgoKICBleHBvcnRzLmdldFJhbmRvbUlQdjYgPSBpcCA9PiB7CiAgICAvLyBTdGFydCB3aXRoIGEgZmFzdCBSZWdleC1DaGVjawogICAgaWYgKCFpc0lQdjYoaXApKSB0aHJvdyBFcnJvcignSW52YWxpZCBJUHY2IGZvcm1hdCcpOyAvLyBTdGFydCBieSBzcGxpdHRpbmcgYW5kIG5vcm1hbGl6aW5nIGFkZHIgYW5kIG1hc2sKCiAgICBjb25zdCBbcmF3QWRkciwgcmF3TWFza10gPSBpcC5zcGxpdCgnLycpOwogICAgbGV0IGJhc2UxME1hc2sgPSBwYXJzZUludChyYXdNYXNrKTsKICAgIGlmICghYmFzZTEwTWFzayB8fCBiYXNlMTBNYXNrID4gMTI4IHx8IGJhc2UxME1hc2sgPCAyNCkgdGhyb3cgRXJyb3IoJ0ludmFsaWQgSVB2NiBzdWJuZXQnKTsKICAgIGNvbnN0IGJhc2UxMGFkZHIgPSBub3JtYWxpemVJUChyYXdBZGRyKTsgLy8gR2V0IHJhbmRvbSBhZGRyIHRvIHBhZCB3aXRoCiAgICAvLyB1c2luZyBNYXRoLnJhbmRvbSBzaW5jZSB3ZSdyZSBub3QgcmVxdWlyaW5nIGhpZ2ggbGV2ZWwgb2YgcmFuZG9tbmVzcwoKICAgIGNvbnN0IHJhbmRvbUFkZHIgPSBuZXcgQXJyYXkoOCkuZmlsbCgxKS5tYXAoKCkgPT4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMHhmZmZmKSk7IC8vIE1lcmdlIGJhc2UxMGFkZHIgd2l0aCByYW5kb21BZGRyCgogICAgY29uc3QgbWVyZ2VkQWRkciA9IHJhbmRvbUFkZHIubWFwKChyYW5kb21JdGVtLCBpZHgpID0+IHsKICAgICAgLy8gQ2FsY3VsYXRlIHRoZSBhbW91bnQgb2Ygc3RhdGljIGJpdHMKICAgICAgY29uc3Qgc3RhdGljQml0cyA9IE1hdGgubWluKGJhc2UxME1hc2ssIDE2KTsgLy8gQWRqdXN0IHRoZSBiaXRtYXNrIHdpdGggdGhlIHN0YXRpY0JpdHMKCiAgICAgIGJhc2UxME1hc2sgLT0gc3RhdGljQml0czsgLy8gQ2FsY3VsYXRlIHRoZSBiaXRtYXNrCiAgICAgIC8vIGxzYiBtYWtlcyB0aGUgY2FsY3VsYXRpb24gd2F5IG1vcmUgY29tcGxpY2F0ZWQKCiAgICAgIGNvbnN0IG1hc2sgPSAweGZmZmYgLSAoMiAqKiAoMTYgLSBzdGF0aWNCaXRzKSAtIDEpOyAvLyBDb21iaW5lIGJhc2UxMGFkZHIgYW5kIHJhbmRvbQoKICAgICAgcmV0dXJuIChiYXNlMTBhZGRyW2lkeF0gJiBtYXNrKSArIChyYW5kb21JdGVtICYgKG1hc2sgXiAweGZmZmYpKTsKICAgIH0pOyAvLyBSZXR1cm4gbmV3IGFkZHIKCiAgICByZXR1cm4gbWVyZ2VkQWRkci5tYXAoeCA9PiB4LnRvU3RyaW5nKCcxNicpKS5qb2luKCc6Jyk7CiAgfTsgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW4KCgogIGNvbnN0IElQVjZfUkVHRVggPSAvXigoWzAtOWEtZl17MSw0fTopKDpbMC05YS1mXXsxLDR9KXsxLDZ9fChbMC05YS1mXXsxLDR9Oil7MSwyfSg6WzAtOWEtZl17MSw0fSl7MSw1fXwoWzAtOWEtZl17MSw0fTopezEsM30oOlswLTlhLWZdezEsNH0pezEsNH18KFswLTlhLWZdezEsNH06KXsxLDR9KDpbMC05YS1mXXsxLDR9KXsxLDN9fChbMC05YS1mXXsxLDR9Oil7MSw1fSg6WzAtOWEtZl17MSw0fSl7MSwyfXwoWzAtOWEtZl17MSw0fTopezEsNn0oOlswLTlhLWZdezEsNH0pfChbMC05YS1mXXsxLDR9Oil7MSw3fSgoWzAtOWEtZl17MSw0fSl8OikpXC8oMVswLTFdXGR8MTJbMC04XXxcZHsxLDJ9KSQvOwogIC8qKgogICAqIFF1aWNrIGNoZWNrIGZvciBhIHZhbGlkIElQdjYKICAgKiBUaGUgUmVnZXggb25seSBhY2NlcHRzIGEgc3Vic2V0IG9mIGFsbCBJUHY2IEFkZHJlc3NlcwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlwIHRoZSBJUHY2IGJsb2NrIGluIENJRFItTm90YXRpb24gdG8gdGVzdAogICAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIHZhbGlkCiAgICovCgogIGNvbnN0IGlzSVB2NiA9IGV4cG9ydHMuaXNJUHY2ID0gaXAgPT4gSVBWNl9SRUdFWC50ZXN0KGlwKTsKICAvKioKICAgKiBOb3JtYWxpc2UgYW4gSVAgQWRkcmVzcwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlwIHRoZSBJUHY2IEFkZHIKICAgKiBAcmV0dXJucyB7bnVtYmVyW119IHRoZSA4IHBhcnRzIG9mIHRoZSBJUHY2IGFzIEludGVnZXJzCiAgICovCgoKICBjb25zdCBub3JtYWxpemVJUCA9IGV4cG9ydHMubm9ybWFsaXplSVAgPSBpcCA9PiB7CiAgICAvLyBTcGxpdCBieSBmaWxsIHBvc2l0aW9uCiAgICBjb25zdCBwYXJ0cyA9IGlwLnNwbGl0KCc6OicpLm1hcCh4ID0+IHguc3BsaXQoJzonKSk7IC8vIE5vcm1hbGl6ZSBzdGFydCBhbmQgZW5kCgogICAgY29uc3QgcGFydFN0YXJ0ID0gcGFydHNbMF0gfHwgW107CiAgICBjb25zdCBwYXJ0RW5kID0gcGFydHNbMV0gfHwgW107CiAgICBwYXJ0RW5kLnJldmVyc2UoKTsgLy8gUGxhY2Vob2xkZXIgZm9yIGZ1bGwgaXAKCiAgICBjb25zdCBmdWxsSVAgPSBuZXcgQXJyYXkoOCkuZmlsbCgwKTsgLy8gRmlsbCBpbiBzdGFydCBhbmQgZW5kIHBhcnRzCgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNYXRoLm1pbihwYXJ0U3RhcnQubGVuZ3RoLCA4KTsgaSsrKSB7CiAgICAgIGZ1bGxJUFtpXSA9IHBhcnNlSW50KHBhcnRTdGFydFtpXSwgMTYpIHx8IDA7CiAgICB9CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNYXRoLm1pbihwYXJ0RW5kLmxlbmd0aCwgOCk7IGkrKykgewogICAgICBmdWxsSVBbNyAtIGldID0gcGFyc2VJbnQocGFydEVuZFtpXSwgMTYpIHx8IDA7CiAgICB9CgogICAgcmV0dXJuIGZ1bGxJUDsKICB9Owp9KSh1dGlscyQyKTsKCnZhciBmb3JtYXRVdGlscyQxID0ge307CgovKioKICogaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Zb3VUdWJlI1F1YWxpdHlfYW5kX2Zvcm1hdHMKICovCnZhciBmb3JtYXRzID0gewogIDU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vZmx2OyBjb2RlY3M9IlNvcmVuc29uIEguMjgzLCBtcDMiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAnLAogICAgYml0cmF0ZTogMjUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA2NAogIH0sCiAgNjogewogICAgbWltZVR5cGU6ICd2aWRlby9mbHY7IGNvZGVjcz0iU29yZW5zb24gSC4yNjMsIG1wMyInLAogICAgcXVhbGl0eUxhYmVsOiAnMjcwcCcsCiAgICBiaXRyYXRlOiA4MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDY0CiAgfSwKICAxMzogewogICAgbWltZVR5cGU6ICd2aWRlby8zZ3A7IGNvZGVjcz0iTVBFRy00IFZpc3VhbCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiA1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDE3OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvLzNncDsgY29kZWNzPSJNUEVHLTQgVmlzdWFsLCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzE0NHAnLAogICAgYml0cmF0ZTogNTAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDI0CiAgfSwKICAxODogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiA1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDk2CiAgfSwKICAyMjogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNzIwcCcsCiAgICBiaXRyYXRlOiAyMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAxOTIKICB9LAogIDM0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL2ZsdjsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICczNjBwJywKICAgIGJpdHJhdGU6IDUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICAzNTogewogICAgbWltZVR5cGU6ICd2aWRlby9mbHY7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNDgwcCcsCiAgICBiaXRyYXRlOiA4MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgMzY6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vM2dwOyBjb2RlY3M9Ik1QRUctNCBWaXN1YWwsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMjQwcCcsCiAgICBiaXRyYXRlOiAxNzUwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDMyCiAgfSwKICAzNzogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMTA4MHAnLAogICAgYml0cmF0ZTogMzAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICAzODogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzA3MnAnLAogICAgYml0cmF0ZTogMzUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICA0MzogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOCwgdm9yYmlzIicsCiAgICBxdWFsaXR5TGFiZWw6ICczNjBwJywKICAgIGJpdHJhdGU6IDUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICA0NDogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOCwgdm9yYmlzIicsCiAgICBxdWFsaXR5TGFiZWw6ICc0ODBwJywKICAgIGJpdHJhdGU6IDEwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgNDU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDgsIHZvcmJpcyInLAogICAgcXVhbGl0eUxhYmVsOiAnNzIwcCcsCiAgICBiaXRyYXRlOiAyMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAxOTIKICB9LAogIDQ2OiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3dlYm07IGNvZGVjcz0idnA4LCB2b3JiaXMiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE5MgogIH0sCiAgODI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzM2MHAnLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA5NgogIH0sCiAgODM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAnLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA5NgogIH0sCiAgODQ6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzcyMHAnLAogICAgYml0cmF0ZTogMjAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICA4NTogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMTA4MHAnLAogICAgYml0cmF0ZTogMzAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogMTkyCiAgfSwKICA5MTogewogICAgbWltZVR5cGU6ICd2aWRlby90czsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICcxNDRwJywKICAgIGJpdHJhdGU6IDEwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogNDgKICB9LAogIDkyOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3RzOyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAnLAogICAgYml0cmF0ZTogMTUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiA0OAogIH0sCiAgOTM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiA1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgOTQ6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNDgwcCcsCiAgICBiaXRyYXRlOiA4MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgOTU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnNzIwcCcsCiAgICBiaXRyYXRlOiAxNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAyNTYKICB9LAogIDk2OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3RzOyBjb2RlY3M9IkguMjY0LCBhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IDI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDI1NgogIH0sCiAgMTAwOiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3dlYm07IGNvZGVjcz0iVlA4LCB2b3JiaXMiJywKICAgIHF1YWxpdHlMYWJlbDogJzM2MHAnLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICAxMDE6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vd2VibTsgY29kZWNzPSJWUDgsIHZvcmJpcyInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiAxOTIKICB9LAogIDEwMjogewogICAgbWltZVR5cGU6ICdhdWRpby93ZWJtOyBjb2RlY3M9IlZQOCwgdm9yYmlzIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE5MgogIH0sCiAgMTIwOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL2ZsdjsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDIwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDEyOAogIH0sCiAgMTI3OiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3RzOyBjb2RlY3M9ImFhYyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogOTYKICB9LAogIDEyODogewogICAgbWltZVR5cGU6ICdhdWRpby90czsgY29kZWNzPSJhYWMiJywKICAgIHF1YWxpdHlMYWJlbDogbnVsbCwKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDk2CiAgfSwKICAxMzI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vdHM7IGNvZGVjcz0iSC4yNjQsIGFhYyInLAogICAgcXVhbGl0eUxhYmVsOiAnMjQwcCcsCiAgICBiaXRyYXRlOiAxNTAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDQ4CiAgfSwKICAxMzM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0IicsCiAgICBxdWFsaXR5TGFiZWw6ICcyNDBwJywKICAgIGJpdHJhdGU6IDIwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMTM0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMzYwcCcsCiAgICBiaXRyYXRlOiAzMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDEzNTogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzQ4MHAnLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAxMzY6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0IicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDEwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDEzNzogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IDI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDEzODogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzQzMjBwJywKICAgIGJpdHJhdGU6IDEzNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAxMzk6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vbXA0OyBjb2RlY3M9ImFhYyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogNDgKICB9LAogIDE0MDogewogICAgbWltZVR5cGU6ICdhdWRpby9tNGE7IGNvZGVjcz0iYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiAxMjgKICB9LAogIDE0MTogewogICAgbWltZVR5cGU6ICdhdWRpby9tcDQ7IGNvZGVjcz0iYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiAyNTYKICB9LAogIDE1MTogewogICAgbWltZVR5cGU6ICd2aWRlby90czsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiAyNAogIH0sCiAgMTYwOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0cCcsCiAgICBiaXRyYXRlOiAxMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDE3MTogewogICAgbWltZVR5cGU6ICdhdWRpby93ZWJtOyBjb2RlY3M9InZvcmJpcyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogMTI4CiAgfSwKICAxNzI6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vd2VibTsgY29kZWNzPSJ2b3JiaXMiJywKICAgIHF1YWxpdHlMYWJlbDogbnVsbCwKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE5MgogIH0sCiAgMjQyOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcyNDBwJywKICAgIGJpdHJhdGU6IDEwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQzOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICczNjBwJywKICAgIGJpdHJhdGU6IDI1MDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQ0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICc0ODBwJywKICAgIGJpdHJhdGU6IDUwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQ3OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDcwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjQ4OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxMDgwcCcsCiAgICBiaXRyYXRlOiAxNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAyNDk6IHsKICAgIG1pbWVUeXBlOiAnYXVkaW8vd2VibTsgY29kZWNzPSJvcHVzIicsCiAgICBxdWFsaXR5TGFiZWw6IG51bGwsCiAgICBiaXRyYXRlOiBudWxsLAogICAgYXVkaW9CaXRyYXRlOiA0OAogIH0sCiAgMjUwOiB7CiAgICBtaW1lVHlwZTogJ2F1ZGlvL3dlYm07IGNvZGVjcz0ib3B1cyInLAogICAgcXVhbGl0eUxhYmVsOiBudWxsLAogICAgYml0cmF0ZTogbnVsbCwKICAgIGF1ZGlvQml0cmF0ZTogNjQKICB9LAogIDI1MTogewogICAgbWltZVR5cGU6ICdhdWRpby93ZWJtOyBjb2RlY3M9Im9wdXMiJywKICAgIHF1YWxpdHlMYWJlbDogbnVsbCwKICAgIGJpdHJhdGU6IG51bGwsCiAgICBhdWRpb0JpdHJhdGU6IDE2MAogIH0sCiAgMjY0OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0MHAnLAogICAgYml0cmF0ZTogNDAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjY2OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL21wNDsgY29kZWNzPSJILjI2NCInLAogICAgcXVhbGl0eUxhYmVsOiAnMjE2MHAnLAogICAgYml0cmF0ZTogMTI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDI3MTogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0MHAnLAogICAgYml0cmF0ZTogOTAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjcyOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICc0MzIwcCcsCiAgICBiaXRyYXRlOiAyMDAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMjc4OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxNDRwIDMwZnBzJywKICAgIGJpdHJhdGU6IDgwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAyOTg6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vbXA0OyBjb2RlY3M9IkguMjY0IicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDMwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDI5OTogewogICAgbWltZVR5cGU6ICd2aWRlby9tcDQ7IGNvZGVjcz0iSC4yNjQiJywKICAgIHF1YWxpdHlMYWJlbDogJzEwODBwJywKICAgIGJpdHJhdGU6IDU1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMwMDogewogICAgbWltZVR5cGU6ICd2aWRlby90czsgY29kZWNzPSJILjI2NCwgYWFjIicsCiAgICBxdWFsaXR5TGFiZWw6ICc3MjBwJywKICAgIGJpdHJhdGU6IDEzMTgwMDAsCiAgICBhdWRpb0JpdHJhdGU6IDQ4CiAgfSwKICAzMDI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzcyMHAgSEZSJywKICAgIGJpdHJhdGU6IDI1MDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMwMzogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMTA4MHAgSEZSJywKICAgIGJpdHJhdGU6IDUwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMwODogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMTQ0MHAgSEZSJywKICAgIGJpdHJhdGU6IDEwMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMTM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzIxNjBwJywKICAgIGJpdHJhdGU6IDEzMDAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMTU6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzIxNjBwIEhGUicsCiAgICBiaXRyYXRlOiAyMDAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMzMwOiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxNDRwIEhEUiwgSEZSJywKICAgIGJpdHJhdGU6IDgwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzE6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzI6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzM2MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMjUwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzM6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzI0MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzQ6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzcyMHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMTAwMDAwMCwKICAgIGF1ZGlvQml0cmF0ZTogbnVsbAogIH0sCiAgMzM1OiB7CiAgICBtaW1lVHlwZTogJ3ZpZGVvL3dlYm07IGNvZGVjcz0iVlA5IicsCiAgICBxdWFsaXR5TGFiZWw6ICcxMDgwcCBIRFIsIEhGUicsCiAgICBiaXRyYXRlOiAxNTAwMDAwLAogICAgYXVkaW9CaXRyYXRlOiBudWxsCiAgfSwKICAzMzY6IHsKICAgIG1pbWVUeXBlOiAndmlkZW8vd2VibTsgY29kZWNzPSJWUDkiJywKICAgIHF1YWxpdHlMYWJlbDogJzE0NDBwIEhEUiwgSEZSJywKICAgIGJpdHJhdGU6IDUwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9LAogIDMzNzogewogICAgbWltZVR5cGU6ICd2aWRlby93ZWJtOyBjb2RlY3M9IlZQOSInLAogICAgcXVhbGl0eUxhYmVsOiAnMjE2MHAgSERSLCBIRlInLAogICAgYml0cmF0ZTogMTIwMDAwMDAsCiAgICBhdWRpb0JpdHJhdGU6IG51bGwKICB9Cn07CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKICBjb25zdCB1dGlscyA9IHV0aWxzJDI7CiAgY29uc3QgRk9STUFUUyA9IGZvcm1hdHM7IC8vIFVzZSB0aGVzZSB0byBoZWxwIHNvcnQgZm9ybWF0cywgaGlnaGVyIGluZGV4IGlzIGJldHRlci4KCiAgY29uc3QgYXVkaW9FbmNvZGluZ1JhbmtzID0gWydtcDRhJywgJ21wMycsICd2b3JiaXMnLCAnYWFjJywgJ29wdXMnLCAnZmxhYyddOwogIGNvbnN0IHZpZGVvRW5jb2RpbmdSYW5rcyA9IFsnbXA0dicsICdhdmMxJywgJ1NvcmVuc29uIEguMjgzJywgJ01QRUctNCBWaXN1YWwnLCAnVlA4JywgJ1ZQOScsICdILjI2NCddOwoKICBjb25zdCBnZXRWaWRlb0JpdHJhdGUgPSBmb3JtYXQgPT4gZm9ybWF0LmJpdHJhdGUgfHwgMDsKCiAgY29uc3QgZ2V0VmlkZW9FbmNvZGluZ1JhbmsgPSBmb3JtYXQgPT4gdmlkZW9FbmNvZGluZ1JhbmtzLmZpbmRJbmRleChlbmMgPT4gZm9ybWF0LmNvZGVjcyAmJiBmb3JtYXQuY29kZWNzLmluY2x1ZGVzKGVuYykpOwoKICBjb25zdCBnZXRBdWRpb0JpdHJhdGUgPSBmb3JtYXQgPT4gZm9ybWF0LmF1ZGlvQml0cmF0ZSB8fCAwOwoKICBjb25zdCBnZXRBdWRpb0VuY29kaW5nUmFuayA9IGZvcm1hdCA9PiBhdWRpb0VuY29kaW5nUmFua3MuZmluZEluZGV4KGVuYyA9PiBmb3JtYXQuY29kZWNzICYmIGZvcm1hdC5jb2RlY3MuaW5jbHVkZXMoZW5jKSk7CiAgLyoqCiAgICogU29ydCBmb3JtYXRzIGJ5IGEgbGlzdCBvZiBmdW5jdGlvbnMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gYQogICAqIEBwYXJhbSB7T2JqZWN0fSBiCiAgICogQHBhcmFtIHtBcnJheS48RnVuY3Rpb24+fSBzb3J0QnkKICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqLwoKCiAgY29uc3Qgc29ydEZvcm1hdHNCeSA9IChhLCBiLCBzb3J0QnkpID0+IHsKICAgIGxldCByZXMgPSAwOwoKICAgIGZvciAobGV0IGZuIG9mIHNvcnRCeSkgewogICAgICByZXMgPSBmbihiKSAtIGZuKGEpOwoKICAgICAgaWYgKHJlcyAhPT0gMCkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9OwoKICBjb25zdCBzb3J0Rm9ybWF0c0J5VmlkZW8gPSAoYSwgYikgPT4gc29ydEZvcm1hdHNCeShhLCBiLCBbZm9ybWF0ID0+IHBhcnNlSW50KGZvcm1hdC5xdWFsaXR5TGFiZWwpLCBnZXRWaWRlb0JpdHJhdGUsIGdldFZpZGVvRW5jb2RpbmdSYW5rXSk7CgogIGNvbnN0IHNvcnRGb3JtYXRzQnlBdWRpbyA9IChhLCBiKSA9PiBzb3J0Rm9ybWF0c0J5KGEsIGIsIFtnZXRBdWRpb0JpdHJhdGUsIGdldEF1ZGlvRW5jb2RpbmdSYW5rXSk7CiAgLyoqCiAgICogU29ydCBmb3JtYXRzIGZyb20gaGlnaGVzdCBxdWFsaXR5IHRvIGxvd2VzdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBhCiAgICogQHBhcmFtIHtPYmplY3R9IGIKICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqLwoKCiAgZXhwb3J0cy5zb3J0Rm9ybWF0cyA9IChhLCBiKSA9PiBzb3J0Rm9ybWF0c0J5KGEsIGIsIFsvLyBGb3JtYXRzIHdpdGggYm90aCB2aWRlbyBhbmQgYXVkaW8gYXJlIHJhbmtlZCBoaWdoZXN0LgogIGZvcm1hdCA9PiArISFmb3JtYXQuaXNITFMsIGZvcm1hdCA9PiArISFmb3JtYXQuaXNEYXNoTVBELCBmb3JtYXQgPT4gKyhmb3JtYXQuY29udGVudExlbmd0aCA+IDApLCBmb3JtYXQgPT4gKyhmb3JtYXQuaGFzVmlkZW8gJiYgZm9ybWF0Lmhhc0F1ZGlvKSwgZm9ybWF0ID0+ICtmb3JtYXQuaGFzVmlkZW8sIGZvcm1hdCA9PiBwYXJzZUludChmb3JtYXQucXVhbGl0eUxhYmVsKSB8fCAwLCBnZXRWaWRlb0JpdHJhdGUsIGdldEF1ZGlvQml0cmF0ZSwgZ2V0VmlkZW9FbmNvZGluZ1JhbmssIGdldEF1ZGlvRW5jb2RpbmdSYW5rXSk7CiAgLyoqCiAgICogQ2hvb3NlIGEgZm9ybWF0IGRlcGVuZGluZyBvbiB0aGUgZ2l2ZW4gb3B0aW9ucy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXkuPE9iamVjdD59IGZvcm1hdHMKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICogQHRocm93cyB7RXJyb3J9IHdoZW4gbm8gZm9ybWF0IG1hdGNoZXMgdGhlIGZpbHRlci9mb3JtYXQgcnVsZXMKICAgKi8KCgogIGV4cG9ydHMuY2hvb3NlRm9ybWF0ID0gKGZvcm1hdHMsIG9wdGlvbnMpID0+IHsKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5mb3JtYXQgPT09ICdvYmplY3QnKSB7CiAgICAgIGlmICghb3B0aW9ucy5mb3JtYXQudXJsKSB7CiAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgZm9ybWF0IGdpdmVuLCBkaWQgeW91IHVzZSBgeXRkbC5nZXRJbmZvKClgPycpOwogICAgICB9CgogICAgICByZXR1cm4gb3B0aW9ucy5mb3JtYXQ7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuZmlsdGVyKSB7CiAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgb3B0aW9ucy5maWx0ZXIpOwogICAgfSAvLyBXZSBjdXJyZW50bHkgb25seSBzdXBwb3J0IEhMUy1Gb3JtYXRzIGZvciBsaXZlc3RyZWFtcwogICAgLy8gU28gd2UgKG5vdykgcmVtb3ZlIGFsbCBub24tSExTIHN0cmVhbXMKCgogICAgaWYgKGZvcm1hdHMuc29tZShmbXQgPT4gZm10LmlzSExTKSkgewogICAgICBmb3JtYXRzID0gZm9ybWF0cy5maWx0ZXIoZm10ID0+IGZtdC5pc0hMUyB8fCAhZm10LmlzTGl2ZSk7CiAgICB9CgogICAgbGV0IGZvcm1hdDsKICAgIGNvbnN0IHF1YWxpdHkgPSBvcHRpb25zLnF1YWxpdHkgfHwgJ2hpZ2hlc3QnOwoKICAgIHN3aXRjaCAocXVhbGl0eSkgewogICAgICBjYXNlICdoaWdoZXN0JzoKICAgICAgICBmb3JtYXQgPSBmb3JtYXRzWzBdOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnbG93ZXN0JzoKICAgICAgICBmb3JtYXQgPSBmb3JtYXRzW2Zvcm1hdHMubGVuZ3RoIC0gMV07CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdoaWdoZXN0YXVkaW8nOgogICAgICAgIHsKICAgICAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgJ2F1ZGlvJyk7CiAgICAgICAgICBmb3JtYXRzLnNvcnQoc29ydEZvcm1hdHNCeUF1ZGlvKTsgLy8gRmlsdGVyIGZvciBvbmx5IHRoZSBiZXN0IGF1ZGlvIGZvcm1hdAoKICAgICAgICAgIGNvbnN0IGJlc3RBdWRpb0Zvcm1hdCA9IGZvcm1hdHNbMF07CiAgICAgICAgICBmb3JtYXRzID0gZm9ybWF0cy5maWx0ZXIoZiA9PiBzb3J0Rm9ybWF0c0J5QXVkaW8oYmVzdEF1ZGlvRm9ybWF0LCBmKSA9PT0gMCk7IC8vIENoZWNrIGZvciB0aGUgd29yc3QgdmlkZW8gcXVhbGl0eSBmb3IgdGhlIGJlc3QgYXVkaW8gcXVhbGl0eSBhbmQgcGljayBhY2NvcmRpbmcKICAgICAgICAgIC8vIFRoaXMgZG9lcyBub3QgbG9vc2UgZGVmYXVsdCBzb3J0aW5nIG9mIHZpZGVvIGVuY29kaW5nIGFuZCBiaXRyYXRlCgogICAgICAgICAgY29uc3Qgd29yc3RWaWRlb1F1YWxpdHkgPSBmb3JtYXRzLm1hcChmID0+IHBhcnNlSW50KGYucXVhbGl0eUxhYmVsKSB8fCAwKS5zb3J0KChhLCBiKSA9PiBhIC0gYilbMF07CiAgICAgICAgICBmb3JtYXQgPSBmb3JtYXRzLmZpbmQoZiA9PiAocGFyc2VJbnQoZi5xdWFsaXR5TGFiZWwpIHx8IDApID09PSB3b3JzdFZpZGVvUXVhbGl0eSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdsb3dlc3RhdWRpbyc6CiAgICAgICAgZm9ybWF0cyA9IGV4cG9ydHMuZmlsdGVyRm9ybWF0cyhmb3JtYXRzLCAnYXVkaW8nKTsKICAgICAgICBmb3JtYXRzLnNvcnQoc29ydEZvcm1hdHNCeUF1ZGlvKTsKICAgICAgICBmb3JtYXQgPSBmb3JtYXRzW2Zvcm1hdHMubGVuZ3RoIC0gMV07CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdoaWdoZXN0dmlkZW8nOgogICAgICAgIHsKICAgICAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgJ3ZpZGVvJyk7CiAgICAgICAgICBmb3JtYXRzLnNvcnQoc29ydEZvcm1hdHNCeVZpZGVvKTsgLy8gRmlsdGVyIGZvciBvbmx5IHRoZSBiZXN0IHZpZGVvIGZvcm1hdAoKICAgICAgICAgIGNvbnN0IGJlc3RWaWRlb0Zvcm1hdCA9IGZvcm1hdHNbMF07CiAgICAgICAgICBmb3JtYXRzID0gZm9ybWF0cy5maWx0ZXIoZiA9PiBzb3J0Rm9ybWF0c0J5VmlkZW8oYmVzdFZpZGVvRm9ybWF0LCBmKSA9PT0gMCk7IC8vIENoZWNrIGZvciB0aGUgd29yc3QgYXVkaW8gcXVhbGl0eSBmb3IgdGhlIGJlc3QgdmlkZW8gcXVhbGl0eSBhbmQgcGljayBhY2NvcmRpbmcKICAgICAgICAgIC8vIFRoaXMgZG9lcyBub3QgbG9vc2UgZGVmYXVsdCBzb3J0aW5nIG9mIGF1ZGlvIGVuY29kaW5nIGFuZCBiaXRyYXRlCgogICAgICAgICAgY29uc3Qgd29yc3RBdWRpb1F1YWxpdHkgPSBmb3JtYXRzLm1hcChmID0+IGYuYXVkaW9CaXRyYXRlIHx8IDApLnNvcnQoKGEsIGIpID0+IGEgLSBiKVswXTsKICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdHMuZmluZChmID0+IChmLmF1ZGlvQml0cmF0ZSB8fCAwKSA9PT0gd29yc3RBdWRpb1F1YWxpdHkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnbG93ZXN0dmlkZW8nOgogICAgICAgIGZvcm1hdHMgPSBleHBvcnRzLmZpbHRlckZvcm1hdHMoZm9ybWF0cywgJ3ZpZGVvJyk7CiAgICAgICAgZm9ybWF0cy5zb3J0KHNvcnRGb3JtYXRzQnlWaWRlbyk7CiAgICAgICAgZm9ybWF0ID0gZm9ybWF0c1tmb3JtYXRzLmxlbmd0aCAtIDFdOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICBmb3JtYXQgPSBnZXRGb3JtYXRCeVF1YWxpdHkocXVhbGl0eSwgZm9ybWF0cyk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgaWYgKCFmb3JtYXQpIHsKICAgICAgdGhyb3cgRXJyb3IoYE5vIHN1Y2ggZm9ybWF0IGZvdW5kOiAke3F1YWxpdHl9YCk7CiAgICB9CgogICAgcmV0dXJuIGZvcm1hdDsKICB9OwogIC8qKgogICAqIEdldHMgYSBmb3JtYXQgYmFzZWQgb24gcXVhbGl0eSBvciBhcnJheSBvZiBxdWFsaXR5J3MKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfFtzdHJpbmddfSBxdWFsaXR5CiAgICogQHBhcmFtIHtbT2JqZWN0XX0gZm9ybWF0cwogICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICovCgoKICBjb25zdCBnZXRGb3JtYXRCeVF1YWxpdHkgPSAocXVhbGl0eSwgZm9ybWF0cykgPT4gewogICAgbGV0IGdldEZvcm1hdCA9IGl0YWcgPT4gZm9ybWF0cy5maW5kKGZvcm1hdCA9PiBgJHtmb3JtYXQuaXRhZ31gID09PSBgJHtpdGFnfWApOwoKICAgIGlmIChBcnJheS5pc0FycmF5KHF1YWxpdHkpKSB7CiAgICAgIHJldHVybiBnZXRGb3JtYXQocXVhbGl0eS5maW5kKHEgPT4gZ2V0Rm9ybWF0KHEpKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZ2V0Rm9ybWF0KHF1YWxpdHkpOwogICAgfQogIH07CiAgLyoqCiAgICogQHBhcmFtIHtBcnJheS48T2JqZWN0Pn0gZm9ybWF0cwogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlcgogICAqIEByZXR1cm5zIHtBcnJheS48T2JqZWN0Pn0KICAgKi8KCgogIGV4cG9ydHMuZmlsdGVyRm9ybWF0cyA9IChmb3JtYXRzLCBmaWx0ZXIpID0+IHsKICAgIGxldCBmbjsKCiAgICBzd2l0Y2ggKGZpbHRlcikgewogICAgICBjYXNlICd2aWRlb2FuZGF1ZGlvJzoKICAgICAgY2FzZSAnYXVkaW9hbmR2aWRlbyc6CiAgICAgICAgZm4gPSBmb3JtYXQgPT4gZm9ybWF0Lmhhc1ZpZGVvICYmIGZvcm1hdC5oYXNBdWRpbzsKCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICd2aWRlbyc6CiAgICAgICAgZm4gPSBmb3JtYXQgPT4gZm9ybWF0Lmhhc1ZpZGVvOwoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3ZpZGVvb25seSc6CiAgICAgICAgZm4gPSBmb3JtYXQgPT4gZm9ybWF0Lmhhc1ZpZGVvICYmICFmb3JtYXQuaGFzQXVkaW87CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnYXVkaW8nOgogICAgICAgIGZuID0gZm9ybWF0ID0+IGZvcm1hdC5oYXNBdWRpbzsKCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdhdWRpb29ubHknOgogICAgICAgIGZuID0gZm9ybWF0ID0+ICFmb3JtYXQuaGFzVmlkZW8gJiYgZm9ybWF0Lmhhc0F1ZGlvOwoKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKHR5cGVvZiBmaWx0ZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGZuID0gZmlsdGVyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoYEdpdmVuIGZpbHRlciAoJHtmaWx0ZXJ9KSBpcyBub3Qgc3VwcG9ydGVkYCk7CiAgICAgICAgfQoKICAgIH0KCiAgICByZXR1cm4gZm9ybWF0cy5maWx0ZXIoZm9ybWF0ID0+ICEhZm9ybWF0LnVybCAmJiBmbihmb3JtYXQpKTsKICB9OwogIC8qKgogICAqIEBwYXJhbSB7T2JqZWN0fSBmb3JtYXQKICAgKiBAcmV0dXJucyB7T2JqZWN0fQogICAqLwoKCiAgZXhwb3J0cy5hZGRGb3JtYXRNZXRhID0gZm9ybWF0ID0+IHsKICAgIGZvcm1hdCA9IE9iamVjdC5hc3NpZ24oe30sIEZPUk1BVFNbZm9ybWF0Lml0YWddLCBmb3JtYXQpOwogICAgZm9ybWF0Lmhhc1ZpZGVvID0gISFmb3JtYXQucXVhbGl0eUxhYmVsOwogICAgZm9ybWF0Lmhhc0F1ZGlvID0gISFmb3JtYXQuYXVkaW9CaXRyYXRlOwogICAgZm9ybWF0LmNvbnRhaW5lciA9IGZvcm1hdC5taW1lVHlwZSA/IGZvcm1hdC5taW1lVHlwZS5zcGxpdCgnOycpWzBdLnNwbGl0KCcvJylbMV0gOiBudWxsOwogICAgZm9ybWF0LmNvZGVjcyA9IGZvcm1hdC5taW1lVHlwZSA/IHV0aWxzLmJldHdlZW4oZm9ybWF0Lm1pbWVUeXBlLCAnY29kZWNzPSInLCAnIicpIDogbnVsbDsKICAgIGZvcm1hdC52aWRlb0NvZGVjID0gZm9ybWF0Lmhhc1ZpZGVvICYmIGZvcm1hdC5jb2RlY3MgPyBmb3JtYXQuY29kZWNzLnNwbGl0KCcsICcpWzBdIDogbnVsbDsKICAgIGZvcm1hdC5hdWRpb0NvZGVjID0gZm9ybWF0Lmhhc0F1ZGlvICYmIGZvcm1hdC5jb2RlY3MgPyBmb3JtYXQuY29kZWNzLnNwbGl0KCcsICcpLnNsaWNlKC0xKVswXSA6IG51bGw7CiAgICBmb3JtYXQuaXNMaXZlID0gL1xic291cmNlWy89XXl0X2xpdmVfYnJvYWRjYXN0XGIvLnRlc3QoZm9ybWF0LnVybCk7CiAgICBmb3JtYXQuaXNITFMgPSAvXC9tYW5pZmVzdFwvaGxzXyh2YXJpYW50fHBsYXlsaXN0KVwvLy50ZXN0KGZvcm1hdC51cmwpOwogICAgZm9ybWF0LmlzRGFzaE1QRCA9IC9cL21hbmlmZXN0XC9kYXNoXC8vLnRlc3QoZm9ybWF0LnVybCk7CiAgICByZXR1cm4gZm9ybWF0OwogIH07Cn0pKGZvcm1hdFV0aWxzJDEpOwoKdmFyIHVybFV0aWxzJDEgPSB7fTsKCi8qKgogKiBHZXQgdmlkZW8gSUQuCiAqCiAqIFRoZXJlIGFyZSBhIGZldyB0eXBlIG9mIHZpZGVvIFVSTCBmb3JtYXRzLgogKiAgLSBodHRwczovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PVZJREVPX0lECiAqICAtIGh0dHBzOi8vbS55b3V0dWJlLmNvbS93YXRjaD92PVZJREVPX0lECiAqICAtIGh0dHBzOi8veW91dHUuYmUvVklERU9fSUQKICogIC0gaHR0cHM6Ly93d3cueW91dHViZS5jb20vdi9WSURFT19JRAogKiAgLSBodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC9WSURFT19JRAogKiAgLSBodHRwczovL211c2ljLnlvdXR1YmUuY29tL3dhdGNoP3Y9VklERU9fSUQKICogIC0gaHR0cHM6Ly9nYW1pbmcueW91dHViZS5jb20vd2F0Y2g/dj1WSURFT19JRAogKgogKiBAcGFyYW0ge3N0cmluZ30gbGluawogKiBAcmV0dXJuIHtzdHJpbmd9CiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB1bmFibGUgdG8gZmluZCBhIGlkCiAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gSWYgdmlkZW9pZCBkb2Vzbid0IG1hdGNoIHNwZWNzCiAqLwoKKGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgY29uc3QgdmFsaWRRdWVyeURvbWFpbnMgPSBuZXcgU2V0KFsneW91dHViZS5jb20nLCAnd3d3LnlvdXR1YmUuY29tJywgJ20ueW91dHViZS5jb20nLCAnbXVzaWMueW91dHViZS5jb20nLCAnZ2FtaW5nLnlvdXR1YmUuY29tJ10pOwogIGNvbnN0IHZhbGlkUGF0aERvbWFpbnMgPSAvXmh0dHBzPzpcL1wvKHlvdXR1XC5iZVwvfCh3d3dcLik/eW91dHViZVwuY29tXC8oZW1iZWR8dnxzaG9ydHMpXC8pLzsKCiAgZXhwb3J0cy5nZXRVUkxWaWRlb0lEID0gbGluayA9PiB7CiAgICBjb25zdCBwYXJzZWQgPSBuZXcgVVJMKGxpbmsudHJpbSgpKTsKICAgIGxldCBpZCA9IHBhcnNlZC5zZWFyY2hQYXJhbXMuZ2V0KCd2Jyk7CgogICAgaWYgKHZhbGlkUGF0aERvbWFpbnMudGVzdChsaW5rLnRyaW0oKSkgJiYgIWlkKSB7CiAgICAgIGNvbnN0IHBhdGhzID0gcGFyc2VkLnBhdGhuYW1lLnNwbGl0KCcvJyk7CiAgICAgIGlkID0gcGFyc2VkLmhvc3QgPT09ICd5b3V0dS5iZScgPyBwYXRoc1sxXSA6IHBhdGhzWzJdOwogICAgfSBlbHNlIGlmIChwYXJzZWQuaG9zdG5hbWUgJiYgIXZhbGlkUXVlcnlEb21haW5zLmhhcyhwYXJzZWQuaG9zdG5hbWUpKSB7CiAgICAgIHRocm93IEVycm9yKCdOb3QgYSBZb3VUdWJlIGRvbWFpbicpOwogICAgfQoKICAgIGlmICghaWQpIHsKICAgICAgdGhyb3cgRXJyb3IoYE5vIHZpZGVvIGlkIGZvdW5kOiAiJHtsaW5rfSJgKTsKICAgIH0KCiAgICBpZCA9IGlkLnN1YnN0cmluZygwLCAxMSk7CgogICAgaWYgKCFleHBvcnRzLnZhbGlkYXRlSUQoaWQpKSB7CiAgICAgIHRocm93IFR5cGVFcnJvcihgVmlkZW8gaWQgKCR7aWR9KSBkb2VzIG5vdCBtYXRjaCBleHBlY3RlZCBgICsgYGZvcm1hdCAoJHtpZFJlZ2V4LnRvU3RyaW5nKCl9KWApOwogICAgfQoKICAgIHJldHVybiBpZDsKICB9OwogIC8qKgogICAqIEdldHMgdmlkZW8gSUQgZWl0aGVyIGZyb20gYSB1cmwgb3IgYnkgY2hlY2tpbmcgaWYgdGhlIGdpdmVuIHN0cmluZwogICAqIG1hdGNoZXMgdGhlIHZpZGVvIElEIGZvcm1hdC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBzdHIKICAgKiBAcmV0dXJucyB7c3RyaW5nfQogICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB1bmFibGUgdG8gZmluZCBhIGlkCiAgICogQHRocm93cyB7VHlwZUVycm9yfSBJZiB2aWRlb2lkIGRvZXNuJ3QgbWF0Y2ggc3BlY3MKICAgKi8KCgogIGNvbnN0IHVybFJlZ2V4ID0gL15odHRwcz86XC9cLy87CgogIGV4cG9ydHMuZ2V0VmlkZW9JRCA9IHN0ciA9PiB7CiAgICBpZiAoZXhwb3J0cy52YWxpZGF0ZUlEKHN0cikpIHsKICAgICAgcmV0dXJuIHN0cjsKICAgIH0gZWxzZSBpZiAodXJsUmVnZXgudGVzdChzdHIudHJpbSgpKSkgewogICAgICByZXR1cm4gZXhwb3J0cy5nZXRVUkxWaWRlb0lEKHN0cik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBFcnJvcihgTm8gdmlkZW8gaWQgZm91bmQ6ICR7c3RyfWApOwogICAgfQogIH07CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIGdpdmVuIGlkIHNhdGlmaWVzIFlvdVR1YmUncyBpZCBmb3JtYXQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaWQKICAgKiBAcmV0dXJuIHtib29sZWFufQogICAqLwoKCiAgY29uc3QgaWRSZWdleCA9IC9eW2EtekEtWjAtOS1fXXsxMX0kLzsKCiAgZXhwb3J0cy52YWxpZGF0ZUlEID0gaWQgPT4gaWRSZWdleC50ZXN0KGlkLnRyaW0oKSk7CiAgLyoqCiAgICogQ2hlY2tzIHdldGhlciB0aGUgaW5wdXQgc3RyaW5nIGluY2x1ZGVzIGEgdmFsaWQgaWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nCiAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICovCgoKICBleHBvcnRzLnZhbGlkYXRlVVJMID0gc3RyaW5nID0+IHsKICAgIHRyeSB7CiAgICAgIGV4cG9ydHMuZ2V0VVJMVmlkZW9JRChzdHJpbmcpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07Cn0pKHVybFV0aWxzJDEpOwoKdmFyIGluZm9FeHRyYXMgPSB7fTsKCnZhciBtM3U4UGFyc2VyJDEgPSB7fTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShtM3U4UGFyc2VyJDEsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCBzdHJlYW1fMSQyID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQxWyJkZWZhdWx0Il07Ci8qKgogKiBBIHZlcnkgc2ltcGxlIG0zdTggcGxheWxpc3QgZmlsZSBwYXJzZXIgdGhhdCBkZXRlY3RzIHRhZ3MgYW5kIHNlZ21lbnRzLgogKi8KCmNsYXNzIG0zdThQYXJzZXIgZXh0ZW5kcyBzdHJlYW1fMSQyLldyaXRhYmxlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLl9sYXN0TGluZSA9ICcnOwogICAgdGhpcy5fc2VxID0gMDsKICAgIHRoaXMuX25leHRJdGVtRHVyYXRpb24gPSBudWxsOwogICAgdGhpcy5fbmV4dEl0ZW1SYW5nZSA9IG51bGw7CiAgICB0aGlzLl9sYXN0SXRlbVJhbmdlRW5kID0gMDsKICAgIHRoaXMub24oJ2ZpbmlzaCcsICgpID0+IHsKICAgICAgdGhpcy5fcGFyc2VMaW5lKHRoaXMuX2xhc3RMaW5lKTsKCiAgICAgIHRoaXMuZW1pdCgnZW5kJyk7CiAgICB9KTsKICB9CgogIF9wYXJzZUF0dHJMaXN0KHZhbHVlKSB7CiAgICBsZXQgYXR0cnMgPSB7fTsKICAgIGxldCByZWdleCA9IC8oW0EtWjAtOS1dKyk9KD86IihbXiJdKj8pInwoW14sXSo/KSkvZzsKICAgIGxldCBtYXRjaDsKCiAgICB3aGlsZSAoKG1hdGNoID0gcmVnZXguZXhlYyh2YWx1ZSkpICE9PSBudWxsKSB7CiAgICAgIGF0dHJzW21hdGNoWzFdXSA9IG1hdGNoWzJdIHx8IG1hdGNoWzNdOwogICAgfQoKICAgIHJldHVybiBhdHRyczsKICB9CgogIF9wYXJzZVJhbmdlKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlKSByZXR1cm4gbnVsbDsKICAgIGxldCBzdmFsdWUgPSB2YWx1ZS5zcGxpdCgnQCcpOwogICAgbGV0IHN0YXJ0ID0gc3ZhbHVlWzFdID8gcGFyc2VJbnQoc3ZhbHVlWzFdKSA6IHRoaXMuX2xhc3RJdGVtUmFuZ2VFbmQgKyAxOwogICAgbGV0IGVuZCA9IHN0YXJ0ICsgcGFyc2VJbnQoc3ZhbHVlWzBdKSAtIDE7CiAgICBsZXQgcmFuZ2UgPSB7CiAgICAgIHN0YXJ0LAogICAgICBlbmQKICAgIH07CiAgICB0aGlzLl9sYXN0SXRlbVJhbmdlRW5kID0gcmFuZ2UuZW5kOwogICAgcmV0dXJuIHJhbmdlOwogIH0KCiAgX3BhcnNlTGluZShsaW5lKSB7CiAgICBsZXQgbWF0Y2ggPSBsaW5lLm1hdGNoKC9eIyhFWFRbQS1aMC05LV0rKSg/OjooLiopKT8vKTsKCiAgICBpZiAobWF0Y2gpIHsKICAgICAgLy8gVGhpcyBpcyBhIHRhZy4KICAgICAgY29uc3QgdGFnID0gbWF0Y2hbMV07CiAgICAgIGNvbnN0IHZhbHVlID0gbWF0Y2hbMl0gfHwgJyc7CgogICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgIGNhc2UgJ0VYVC1YLVBST0dSQU0tREFURS1USU1FJzoKICAgICAgICAgIHRoaXMuZW1pdCgnc3RhcnR0aW1lJywgbmV3IERhdGUodmFsdWUpLmdldFRpbWUoKSk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRVhULVgtTUVESUEtU0VRVUVOQ0UnOgogICAgICAgICAgdGhpcy5fc2VxID0gcGFyc2VJbnQodmFsdWUpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0VYVC1YLU1BUCc6CiAgICAgICAgICB7CiAgICAgICAgICAgIGxldCBhdHRycyA9IHRoaXMuX3BhcnNlQXR0ckxpc3QodmFsdWUpOwoKICAgICAgICAgICAgaWYgKCFhdHRycy5VUkkpIHsKICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3kobmV3IEVycm9yKCdgRVhULVgtTUFQYCBmb3VuZCB3aXRob3V0IHJlcXVpcmVkIGF0dHJpYnV0ZSBgVVJJYCcpKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICB1cmw6IGF0dHJzLlVSSSwKICAgICAgICAgICAgICBzZXE6IHRoaXMuX3NlcSwKICAgICAgICAgICAgICBpbml0OiB0cnVlLAogICAgICAgICAgICAgIGR1cmF0aW9uOiAwLAogICAgICAgICAgICAgIHJhbmdlOiB0aGlzLl9wYXJzZVJhbmdlKGF0dHJzLkJZVEVSQU5HRSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICBjYXNlICdFWFQtWC1CWVRFUkFOR0UnOgogICAgICAgICAgewogICAgICAgICAgICB0aGlzLl9uZXh0SXRlbVJhbmdlID0gdGhpcy5fcGFyc2VSYW5nZSh2YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICBjYXNlICdFWFRJTkYnOgogICAgICAgICAgdGhpcy5fbmV4dEl0ZW1EdXJhdGlvbiA9IE1hdGgucm91bmQocGFyc2VGbG9hdCh2YWx1ZS5zcGxpdCgnLCcpWzBdKSAqIDEwMDApOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0VYVC1YLUVORExJU1QnOgogICAgICAgICAgdGhpcy5lbWl0KCdlbmRsaXN0Jyk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfSBlbHNlIGlmICghL14jLy50ZXN0KGxpbmUpICYmIGxpbmUudHJpbSgpKSB7CiAgICAgIC8vIFRoaXMgaXMgYSBzZWdtZW50CiAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICB1cmw6IGxpbmUudHJpbSgpLAogICAgICAgIHNlcTogdGhpcy5fc2VxKyssCiAgICAgICAgZHVyYXRpb246IHRoaXMuX25leHRJdGVtRHVyYXRpb24sCiAgICAgICAgcmFuZ2U6IHRoaXMuX25leHRJdGVtUmFuZ2UKICAgICAgfSk7CiAgICAgIHRoaXMuX25leHRJdGVtUmFuZ2UgPSBudWxsOwogICAgfQogIH0KCiAgX3dyaXRlKGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spIHsKICAgIGxldCBsaW5lcyA9IGNodW5rLnRvU3RyaW5nKCd1dGY4Jykuc3BsaXQoJ1xuJyk7CgogICAgaWYgKHRoaXMuX2xhc3RMaW5lKSB7CiAgICAgIGxpbmVzWzBdID0gdGhpcy5fbGFzdExpbmUgKyBsaW5lc1swXTsKICAgIH0KCiAgICBsaW5lcy5mb3JFYWNoKChsaW5lLCBpKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuOwoKICAgICAgaWYgKGkgPCBsaW5lcy5sZW5ndGggLSAxKSB7CiAgICAgICAgdGhpcy5fcGFyc2VMaW5lKGxpbmUpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNhdmUgdGhlIGxhc3QgbGluZSBpbiBjYXNlIGl0IGhhcyBiZWVuIGJyb2tlbiB1cC4KICAgICAgICB0aGlzLl9sYXN0TGluZSA9IGxpbmU7CiAgICAgIH0KICAgIH0pOwogICAgY2FsbGJhY2soKTsKICB9Cgp9CgptM3U4UGFyc2VyJDEuZGVmYXVsdCA9IG0zdThQYXJzZXI7Cgp2YXIgZGFzaE1wZFBhcnNlciA9IHt9OwoKdmFyIHBhcnNlVGltZSA9IHt9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHBhcnNlVGltZSwgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CnBhcnNlVGltZS5kdXJhdGlvblN0ciA9IHBhcnNlVGltZS5odW1hblN0ciA9IHZvaWQgMDsKY29uc3QgbnVtYmVyRm9ybWF0ID0gL15cZCskLzsKY29uc3QgdGltZUZvcm1hdCA9IC9eKD86KD86KFxkKyk6KT8oXGR7MSwyfSk6KT8oXGR7MSwyfSkoPzpcLihcZHszfSkpPyQvOwpjb25zdCB0aW1lVW5pdHMgPSB7CiAgbXM6IDEsCiAgczogMTAwMCwKICBtOiA2MDAwMCwKICBoOiAzNjAwMDAwCn07Ci8qKgogKiBDb252ZXJ0cyBodW1hbiBmcmllbmRseSB0aW1lIHRvIG1pbGxpc2Vjb25kcy4gU3VwcG9ydHMgdGhlIGZvcm1hdAogKiAwMDowMDowMC4wMDAgZm9yIGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzLCBhbmQgbWlsbGlzZWNvbmRzIHJlc3BlY3RpdmVseS4KICogQW5kIDBtcywgMHMsIDBtLCAwaCwgYW5kIHRvZ2V0aGVyIDFtMXMuCiAqCiAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gdGltZQogKiBAcmV0dXJucyB7bnVtYmVyfQogKi8KCnBhcnNlVGltZS5odW1hblN0ciA9IHRpbWUgPT4gewogIGlmICh0eXBlb2YgdGltZSA9PT0gJ251bWJlcicpIHsKICAgIHJldHVybiB0aW1lOwogIH0KCiAgaWYgKG51bWJlckZvcm1hdC50ZXN0KHRpbWUpKSB7CiAgICByZXR1cm4gK3RpbWU7CiAgfQoKICBjb25zdCBmaXJzdEZvcm1hdCA9IHRpbWVGb3JtYXQuZXhlYyh0aW1lKTsKCiAgaWYgKGZpcnN0Rm9ybWF0KSB7CiAgICByZXR1cm4gKyhmaXJzdEZvcm1hdFsxXSB8fCAwKSAqIHRpbWVVbml0cy5oICsgKyhmaXJzdEZvcm1hdFsyXSB8fCAwKSAqIHRpbWVVbml0cy5tICsgK2ZpcnN0Rm9ybWF0WzNdICogdGltZVVuaXRzLnMgKyArKGZpcnN0Rm9ybWF0WzRdIHx8IDApOwogIH0gZWxzZSB7CiAgICBsZXQgdG90YWwgPSAwOwogICAgY29uc3QgciA9IC8oLT9cZCspKG1zfHN8bXxoKS9nOwogICAgbGV0IHJzOwoKICAgIHdoaWxlICgocnMgPSByLmV4ZWModGltZSkpICE9PSBudWxsKSB7CiAgICAgIHRvdGFsICs9ICtyc1sxXSAqIHRpbWVVbml0c1tyc1syXV07CiAgICB9CgogICAgcmV0dXJuIHRvdGFsOwogIH0KfTsKLyoqCiAqIFBhcnNlcyBhIGR1cmF0aW9uIHN0cmluZyBpbiB0aGUgZm9ybSBvZiAiMTIzLjQ1NlMiLCByZXR1cm5zIG1pbGxpc2Vjb25kcy4KICoKICogQHBhcmFtIHtzdHJpbmd9IHRpbWUKICogQHJldHVybnMge251bWJlcn0KICovCgoKcGFyc2VUaW1lLmR1cmF0aW9uU3RyID0gdGltZSA9PiB7CiAgbGV0IHRvdGFsID0gMDsKICBjb25zdCByID0gLyhcZCsoPzpcLlxkKyk/KShTfE18SCkvZzsKICBsZXQgcnM7CgogIHdoaWxlICgocnMgPSByLmV4ZWModGltZSkpICE9PSBudWxsKSB7CiAgICB0b3RhbCArPSArcnNbMV0gKiB0aW1lVW5pdHNbcnNbMl0udG9Mb3dlckNhc2UoKV07CiAgfQoKICByZXR1cm4gdG90YWw7Cn07Cgp2YXIgX19pbXBvcnREZWZhdWx0JDEgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2ltcG9ydERlZmF1bHQgfHwgZnVuY3Rpb24gKG1vZCkgewogIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAiZGVmYXVsdCI6IG1vZAogIH07Cn07CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZGFzaE1wZFBhcnNlciwgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmNvbnN0IHN0cmVhbV8xJDEgPSByZXF1aXJlJCQwX19kZWZhdWx0JDFbImRlZmF1bHQiXTsKCmNvbnN0IHNheF8xID0gX19pbXBvcnREZWZhdWx0JDEoc2F4KTsKCmNvbnN0IHBhcnNlX3RpbWVfMSQxID0gcGFyc2VUaW1lOwovKioKICogQSB3cmFwcGVyIGFyb3VuZCBzYXggdGhhdCBlbWl0cyBzZWdtZW50cy4KICovCgpjbGFzcyBEYXNoTVBEUGFyc2VyIGV4dGVuZHMgc3RyZWFtXzEkMS5Xcml0YWJsZSB7CiAgY29uc3RydWN0b3IodGFyZ2V0SUQpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLl9wYXJzZXIgPSBzYXhfMS5kZWZhdWx0LmNyZWF0ZVN0cmVhbShmYWxzZSwgewogICAgICBsb3dlcmNhc2U6IHRydWUKICAgIH0pOwoKICAgIHRoaXMuX3BhcnNlci5vbignZXJyb3InLCB0aGlzLmRlc3Ryb3kuYmluZCh0aGlzKSk7CgogICAgbGV0IGxhc3RUYWc7CiAgICBsZXQgY3VycnRpbWUgPSAwOwogICAgbGV0IHNlcSA9IDA7CiAgICBsZXQgc2VnbWVudFRlbXBsYXRlOwogICAgbGV0IHRpbWVzY2FsZSwgb2Zmc2V0LCBkdXJhdGlvbiwgYmFzZVVSTDsKICAgIGxldCB0aW1lbGluZSA9IFtdOwogICAgbGV0IGdldFNlZ21lbnRzID0gZmFsc2U7CiAgICBsZXQgZ290U2VnbWVudHMgPSBmYWxzZTsKICAgIGxldCBpc1N0YXRpYzsKICAgIGxldCB0cmVlTGV2ZWw7CiAgICBsZXQgcGVyaW9kU3RhcnQ7CgogICAgY29uc3QgdG1wbCA9IHN0ciA9PiB7CiAgICAgIGNvbnN0IGNvbnRleHQgPSB7CiAgICAgICAgUmVwcmVzZW50YXRpb25JRDogdGFyZ2V0SUQsCiAgICAgICAgTnVtYmVyOiBzZXEsCiAgICAgICAgVGltZTogY3VycnRpbWUKICAgICAgfTsKICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9cJChcdyspXCQvZywgKG0sIHAxKSA9PiBgJHtjb250ZXh0W3AxXX1gKTsKICAgIH07CgogICAgdGhpcy5fcGFyc2VyLm9uKCdvcGVudGFnJywgbm9kZSA9PiB7CiAgICAgIHN3aXRjaCAobm9kZS5uYW1lKSB7CiAgICAgICAgY2FzZSAnbXBkJzoKICAgICAgICAgIGN1cnJ0aW1lID0gbm9kZS5hdHRyaWJ1dGVzLmF2YWlsYWJpbGl0eXN0YXJ0dGltZSA/IG5ldyBEYXRlKG5vZGUuYXR0cmlidXRlcy5hdmFpbGFiaWxpdHlzdGFydHRpbWUpLmdldFRpbWUoKSA6IDA7CiAgICAgICAgICBpc1N0YXRpYyA9IG5vZGUuYXR0cmlidXRlcy50eXBlICE9PSAnZHluYW1pYyc7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncGVyaW9kJzoKICAgICAgICAgIC8vIFJlc2V0IGV2ZXJ5dGhpbmcgb24gPFBlcmlvZD4gdGFnLgogICAgICAgICAgc2VxID0gMDsKICAgICAgICAgIHRpbWVzY2FsZSA9IDEwMDA7CiAgICAgICAgICBkdXJhdGlvbiA9IDA7CiAgICAgICAgICBvZmZzZXQgPSAwOwogICAgICAgICAgYmFzZVVSTCA9IFtdOwogICAgICAgICAgdHJlZUxldmVsID0gMDsKICAgICAgICAgIHBlcmlvZFN0YXJ0ID0gcGFyc2VfdGltZV8xJDEuZHVyYXRpb25TdHIobm9kZS5hdHRyaWJ1dGVzLnN0YXJ0KSB8fCAwOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3NlZ21lbnRsaXN0JzoKICAgICAgICAgIHNlcSA9IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5zdGFydG51bWJlcikgfHwgc2VxOwogICAgICAgICAgdGltZXNjYWxlID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLnRpbWVzY2FsZSkgfHwgdGltZXNjYWxlOwogICAgICAgICAgZHVyYXRpb24gPSBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMuZHVyYXRpb24pIHx8IGR1cmF0aW9uOwogICAgICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLnByZXNlbnRhdGlvbnRpbWVvZmZzZXQpIHx8IG9mZnNldDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdzZWdtZW50dGVtcGxhdGUnOgogICAgICAgICAgc2VnbWVudFRlbXBsYXRlID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgc2VxID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLnN0YXJ0bnVtYmVyKSB8fCBzZXE7CiAgICAgICAgICB0aW1lc2NhbGUgPSBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMudGltZXNjYWxlKSB8fCB0aW1lc2NhbGU7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc2VnbWVudHRpbWVsaW5lJzoKICAgICAgICBjYXNlICdiYXNldXJsJzoKICAgICAgICAgIGxhc3RUYWcgPSBub2RlLm5hbWU7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncyc6CiAgICAgICAgICB0aW1lbGluZS5wdXNoKHsKICAgICAgICAgICAgZHVyYXRpb246IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5kKSwKICAgICAgICAgICAgcmVwZWF0OiBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMuciksCiAgICAgICAgICAgIHRpbWU6IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy50KQogICAgICAgICAgfSk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnYWRhcHRhdGlvbnNldCc6CiAgICAgICAgY2FzZSAncmVwcmVzZW50YXRpb24nOgogICAgICAgICAgdHJlZUxldmVsKys7CgogICAgICAgICAgaWYgKCF0YXJnZXRJRCkgewogICAgICAgICAgICB0YXJnZXRJRCA9IG5vZGUuYXR0cmlidXRlcy5pZDsKICAgICAgICAgIH0KCiAgICAgICAgICBnZXRTZWdtZW50cyA9IG5vZGUuYXR0cmlidXRlcy5pZCA9PT0gYCR7dGFyZ2V0SUR9YDsKCiAgICAgICAgICBpZiAoZ2V0U2VnbWVudHMpIHsKICAgICAgICAgICAgaWYgKHBlcmlvZFN0YXJ0KSB7CiAgICAgICAgICAgICAgY3VycnRpbWUgKz0gcGVyaW9kU3RhcnQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvZmZzZXQpIHsKICAgICAgICAgICAgICBjdXJydGltZSAtPSBvZmZzZXQgLyB0aW1lc2NhbGUgKiAxMDAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmVtaXQoJ3N0YXJ0dGltZScsIGN1cnJ0aW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnaW5pdGlhbGl6YXRpb24nOgogICAgICAgICAgaWYgKGdldFNlZ21lbnRzKSB7CiAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICB1cmw6IGJhc2VVUkwuZmlsdGVyKHMgPT4gISFzKS5qb2luKCcnKSArIG5vZGUuYXR0cmlidXRlcy5zb3VyY2V1cmwsCiAgICAgICAgICAgICAgc2VxOiBzZXEsCiAgICAgICAgICAgICAgaW5pdDogdHJ1ZSwKICAgICAgICAgICAgICBkdXJhdGlvbjogMAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc2VnbWVudHVybCc6CiAgICAgICAgICBpZiAoZ2V0U2VnbWVudHMpIHsKICAgICAgICAgICAgZ290U2VnbWVudHMgPSB0cnVlOwogICAgICAgICAgICBsZXQgdGwgPSB0aW1lbGluZS5zaGlmdCgpOwogICAgICAgICAgICBsZXQgc2VnbWVudER1cmF0aW9uID0gKCh0bCA9PT0gbnVsbCB8fCB0bCA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGwuZHVyYXRpb24pIHx8IGR1cmF0aW9uKSAvIHRpbWVzY2FsZSAqIDEwMDA7CiAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICB1cmw6IGJhc2VVUkwuZmlsdGVyKHMgPT4gISFzKS5qb2luKCcnKSArIG5vZGUuYXR0cmlidXRlcy5tZWRpYSwKICAgICAgICAgICAgICBzZXE6IHNlcSsrLAogICAgICAgICAgICAgIGR1cmF0aW9uOiBzZWdtZW50RHVyYXRpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGN1cnJ0aW1lICs9IHNlZ21lbnREdXJhdGlvbjsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfSk7CgogICAgY29uc3Qgb25FbmQgPSAoKSA9PiB7CiAgICAgIGlmIChpc1N0YXRpYykgewogICAgICAgIHRoaXMuZW1pdCgnZW5kbGlzdCcpOwogICAgICB9CgogICAgICBpZiAoIWdldFNlZ21lbnRzKSB7CiAgICAgICAgdGhpcy5kZXN0cm95KEVycm9yKGBSZXByZXNlbnRhdGlvbiAnJHt0YXJnZXRJRH0nIG5vdCBmb3VuZGApKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmVtaXQoJ2VuZCcpOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuX3BhcnNlci5vbignY2xvc2V0YWcnLCB0YWdOYW1lID0+IHsKICAgICAgc3dpdGNoICh0YWdOYW1lKSB7CiAgICAgICAgY2FzZSAnYWRhcHRhdGlvbnNldCc6CiAgICAgICAgY2FzZSAncmVwcmVzZW50YXRpb24nOgogICAgICAgICAgdHJlZUxldmVsLS07CgogICAgICAgICAgaWYgKHNlZ21lbnRUZW1wbGF0ZSAmJiB0aW1lbGluZS5sZW5ndGgpIHsKICAgICAgICAgICAgZ290U2VnbWVudHMgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHNlZ21lbnRUZW1wbGF0ZS5pbml0aWFsaXphdGlvbikgewogICAgICAgICAgICAgIHRoaXMuZW1pdCgnaXRlbScsIHsKICAgICAgICAgICAgICAgIHVybDogYmFzZVVSTC5maWx0ZXIocyA9PiAhIXMpLmpvaW4oJycpICsgdG1wbChzZWdtZW50VGVtcGxhdGUuaW5pdGlhbGl6YXRpb24pLAogICAgICAgICAgICAgICAgc2VxOiBzZXEsCiAgICAgICAgICAgICAgICBpbml0OiB0cnVlLAogICAgICAgICAgICAgICAgZHVyYXRpb246IDAKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChsZXQgewogICAgICAgICAgICAgIGR1cmF0aW9uOiBpdGVtRHVyYXRpb24sCiAgICAgICAgICAgICAgcmVwZWF0LAogICAgICAgICAgICAgIHRpbWUKICAgICAgICAgICAgfSBvZiB0aW1lbGluZSkgewogICAgICAgICAgICAgIGl0ZW1EdXJhdGlvbiA9IGl0ZW1EdXJhdGlvbiAvIHRpbWVzY2FsZSAqIDEwMDA7CiAgICAgICAgICAgICAgcmVwZWF0ID0gcmVwZWF0IHx8IDE7CiAgICAgICAgICAgICAgY3VycnRpbWUgPSB0aW1lIHx8IGN1cnJ0aW1lOwoKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlcGVhdDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2l0ZW0nLCB7CiAgICAgICAgICAgICAgICAgIHVybDogYmFzZVVSTC5maWx0ZXIocyA9PiAhIXMpLmpvaW4oJycpICsgdG1wbChzZWdtZW50VGVtcGxhdGUubWVkaWEpLAogICAgICAgICAgICAgICAgICBzZXE6IHNlcSsrLAogICAgICAgICAgICAgICAgICBkdXJhdGlvbjogaXRlbUR1cmF0aW9uCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGN1cnJ0aW1lICs9IGl0ZW1EdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoZ290U2VnbWVudHMpIHsKICAgICAgICAgICAgdGhpcy5lbWl0KCdlbmRlYXJseScpOwogICAgICAgICAgICBvbkVuZCgpOwoKICAgICAgICAgICAgdGhpcy5fcGFyc2VyLnJlbW92ZUFsbExpc3RlbmVycygpOwoKICAgICAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2ZpbmlzaCcpOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLl9wYXJzZXIub24oJ3RleHQnLCB0ZXh0ID0+IHsKICAgICAgaWYgKGxhc3RUYWcgPT09ICdiYXNldXJsJykgewogICAgICAgIGJhc2VVUkxbdHJlZUxldmVsXSA9IHRleHQ7CiAgICAgICAgbGFzdFRhZyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMub24oJ2ZpbmlzaCcsIG9uRW5kKTsKICB9CgogIF93cml0ZShjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7CiAgICB0aGlzLl9wYXJzZXIud3JpdGUoY2h1bmspOwoKICAgIGNhbGxiYWNrKCk7CiAgfQoKfQoKZGFzaE1wZFBhcnNlci5kZWZhdWx0ID0gRGFzaE1QRFBhcnNlcjsKCnZhciBxdWV1ZSA9IHt9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHF1ZXVlLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKcXVldWUuUXVldWUgPSB2b2lkIDA7CgpjbGFzcyBRdWV1ZSB7CiAgLyoqCiAgICogQSByZWFsbHkgc2ltcGxlIHF1ZXVlIHdpdGggY29uY3VycmVuY3kuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSB3b3JrZXIKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEBwYXJhbSB7IW51bWJlcn0gb3B0aW9ucy5jb25jdXJyZW5jeQogICAqLwogIGNvbnN0cnVjdG9yKHdvcmtlciwgb3B0aW9ucyA9IHt9KSB7CiAgICB0aGlzLl93b3JrZXIgPSB3b3JrZXI7CiAgICB0aGlzLl9jb25jdXJyZW5jeSA9IG9wdGlvbnMuY29uY3VycmVuY3kgfHwgMTsKICAgIHRoaXMudGFza3MgPSBbXTsKICAgIHRoaXMudG90YWwgPSAwOwogICAgdGhpcy5hY3RpdmUgPSAwOwogIH0KICAvKioKICAgKiBQdXNoIGEgdGFzayB0byB0aGUgcXVldWUuCiAgICoKICAgKiAgQHBhcmFtIHtUfSBpdGVtCiAgICogIEBwYXJhbSB7IUZ1bmN0aW9ufSBjYWxsYmFjawogICAqLwoKCiAgcHVzaChpdGVtLCBjYWxsYmFjaykgewogICAgdGhpcy50YXNrcy5wdXNoKHsKICAgICAgaXRlbSwKICAgICAgY2FsbGJhY2sKICAgIH0pOwogICAgdGhpcy50b3RhbCsrOwoKICAgIHRoaXMuX25leHQoKTsKICB9CiAgLyoqCiAgICogUHJvY2VzcyBuZXh0IGpvYiBpbiBxdWV1ZS4KICAgKi8KCgogIF9uZXh0KCkgewogICAgaWYgKHRoaXMuYWN0aXZlID49IHRoaXMuX2NvbmN1cnJlbmN5IHx8ICF0aGlzLnRhc2tzLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgewogICAgICBpdGVtLAogICAgICBjYWxsYmFjawogICAgfSA9IHRoaXMudGFza3Muc2hpZnQoKTsKICAgIGxldCBjYWxsYmFja0NhbGxlZCA9IGZhbHNlOwogICAgdGhpcy5hY3RpdmUrKzsKCiAgICB0aGlzLl93b3JrZXIoaXRlbSwgKGVyciwgcmVzdWx0KSA9PiB7CiAgICAgIGlmIChjYWxsYmFja0NhbGxlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5hY3RpdmUtLTsKICAgICAgY2FsbGJhY2tDYWxsZWQgPSB0cnVlOwogICAgICBjYWxsYmFjayA9PT0gbnVsbCB8fCBjYWxsYmFjayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2FsbGJhY2soZXJyLCByZXN1bHQpOwoKICAgICAgdGhpcy5fbmV4dCgpOwogICAgfSk7CiAgfQogIC8qKgogICAqIFN0b3BzIHByb2Nlc3NpbmcgcXVldWVkIGpvYnMuCiAgICovCgoKICBkaWUoKSB7CiAgICB0aGlzLnRhc2tzID0gW107CiAgfQoKfQoKcXVldWUuUXVldWUgPSBRdWV1ZTsKCnZhciBfX2ltcG9ydERlZmF1bHQgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2ltcG9ydERlZmF1bHQgfHwgZnVuY3Rpb24gKG1vZCkgewogIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAiZGVmYXVsdCI6IG1vZAogIH07Cn07Cgpjb25zdCBzdHJlYW1fMSA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMVsiZGVmYXVsdCJdOwoKY29uc3QgbWluaWdldF8xID0gX19pbXBvcnREZWZhdWx0KGRpc3QkMSk7Cgpjb25zdCBtM3U4X3BhcnNlcl8xID0gX19pbXBvcnREZWZhdWx0KG0zdThQYXJzZXIkMSk7Cgpjb25zdCBkYXNoX21wZF9wYXJzZXJfMSA9IF9faW1wb3J0RGVmYXVsdChkYXNoTXBkUGFyc2VyKTsKCmNvbnN0IHF1ZXVlXzEgPSBxdWV1ZTsKY29uc3QgcGFyc2VfdGltZV8xID0gcGFyc2VUaW1lOwpjb25zdCBzdXBwb3J0ZWRQYXJzZXJzID0gewogIG0zdTg6IG0zdThfcGFyc2VyXzEuZGVmYXVsdCwKICAnZGFzaC1tcGQnOiBkYXNoX21wZF9wYXJzZXJfMS5kZWZhdWx0Cn07CgpsZXQgbTN1OHN0cmVhbSQxID0gKHBsYXlsaXN0VVJMLCBvcHRpb25zID0ge30pID0+IHsKICBjb25zdCBzdHJlYW0gPSBuZXcgc3RyZWFtXzEuUGFzc1Rocm91Z2goewogICAgaGlnaFdhdGVyTWFyazogb3B0aW9ucy5oaWdoV2F0ZXJNYXJrCiAgfSk7CiAgY29uc3QgY2h1bmtSZWFkYWhlYWQgPSBvcHRpb25zLmNodW5rUmVhZGFoZWFkIHx8IDM7IC8vIDIwIHNlY29uZHMuCgogIGNvbnN0IGxpdmVCdWZmZXIgPSBvcHRpb25zLmxpdmVCdWZmZXIgfHwgMjAwMDA7CiAgY29uc3QgcmVxdWVzdE9wdGlvbnMgPSBvcHRpb25zLnJlcXVlc3RPcHRpb25zOwogIGNvbnN0IFBhcnNlciA9IHN1cHBvcnRlZFBhcnNlcnNbb3B0aW9ucy5wYXJzZXIgfHwgKC9cLm1wZCQvLnRlc3QocGxheWxpc3RVUkwpID8gJ2Rhc2gtbXBkJyA6ICdtM3U4JyldOwoKICBpZiAoIVBhcnNlcikgewogICAgdGhyb3cgVHlwZUVycm9yKGBwYXJzZXIgJyR7b3B0aW9ucy5wYXJzZXJ9JyBub3Qgc3VwcG9ydGVkYCk7CiAgfQoKICBsZXQgYmVnaW4gPSAwOwoKICBpZiAodHlwZW9mIG9wdGlvbnMuYmVnaW4gIT09ICd1bmRlZmluZWQnKSB7CiAgICBiZWdpbiA9IHR5cGVvZiBvcHRpb25zLmJlZ2luID09PSAnc3RyaW5nJyA/IHBhcnNlX3RpbWVfMS5odW1hblN0cihvcHRpb25zLmJlZ2luKSA6IE1hdGgubWF4KG9wdGlvbnMuYmVnaW4gLSBsaXZlQnVmZmVyLCAwKTsKICB9CgogIGNvbnN0IGZvcndhcmRFdmVudHMgPSByZXEgPT4gewogICAgZm9yIChsZXQgZXZlbnQgb2YgWydhYm9ydCcsICdyZXF1ZXN0JywgJ3Jlc3BvbnNlJywgJ3JlZGlyZWN0JywgJ3JldHJ5JywgJ3JlY29ubmVjdCddKSB7CiAgICAgIHJlcS5vbihldmVudCwgc3RyZWFtLmVtaXQuYmluZChzdHJlYW0sIGV2ZW50KSk7CiAgICB9CiAgfTsKCiAgbGV0IGN1cnJTZWdtZW50OwogIGNvbnN0IHN0cmVhbVF1ZXVlID0gbmV3IHF1ZXVlXzEuUXVldWUoKHJlcSwgY2FsbGJhY2spID0+IHsKICAgIGN1cnJTZWdtZW50ID0gcmVxOyAvLyBDb3VudCB0aGUgc2l6ZSBtYW51YWxseSwgc2luY2UgdGhlIGBjb250ZW50LWxlbmd0aGAgaGVhZGVyIGlzIG5vdAogICAgLy8gYWx3YXlzIHRoZXJlLgoKICAgIGxldCBzaXplID0gMDsKICAgIHJlcS5vbignZGF0YScsIGNodW5rID0+IHNpemUgKz0gY2h1bmsubGVuZ3RoKTsKICAgIHJlcS5waXBlKHN0cmVhbSwgewogICAgICBlbmQ6IGZhbHNlCiAgICB9KTsKICAgIHJlcS5vbignZW5kJywgKCkgPT4gY2FsbGJhY2sobnVsbCwgc2l6ZSkpOwogIH0sIHsKICAgIGNvbmN1cnJlbmN5OiAxCiAgfSk7CiAgbGV0IHNlZ21lbnROdW1iZXIgPSAwOwogIGxldCBkb3dubG9hZGVkID0gMDsKICBjb25zdCByZXF1ZXN0UXVldWUgPSBuZXcgcXVldWVfMS5RdWV1ZSgoc2VnbWVudCwgY2FsbGJhY2spID0+IHsKICAgIGxldCByZXFPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxdWVzdE9wdGlvbnMpOwoKICAgIGlmIChzZWdtZW50LnJhbmdlKSB7CiAgICAgIHJlcU9wdGlvbnMuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHJlcU9wdGlvbnMuaGVhZGVycywgewogICAgICAgIFJhbmdlOiBgYnl0ZXM9JHtzZWdtZW50LnJhbmdlLnN0YXJ0fS0ke3NlZ21lbnQucmFuZ2UuZW5kfWAKICAgICAgfSk7CiAgICB9CgogICAgbGV0IHJlcSA9IG1pbmlnZXRfMS5kZWZhdWx0KG5ldyBVUkwoc2VnbWVudC51cmwsIHBsYXlsaXN0VVJMKS50b1N0cmluZygpLCByZXFPcHRpb25zKTsKICAgIHJlcS5vbignZXJyb3InLCBjYWxsYmFjayk7CiAgICBmb3J3YXJkRXZlbnRzKHJlcSk7CiAgICBzdHJlYW1RdWV1ZS5wdXNoKHJlcSwgKF8sIHNpemUpID0+IHsKICAgICAgZG93bmxvYWRlZCArPSArc2l6ZTsKICAgICAgc3RyZWFtLmVtaXQoJ3Byb2dyZXNzJywgewogICAgICAgIG51bTogKytzZWdtZW50TnVtYmVyLAogICAgICAgIHNpemU6IHNpemUsCiAgICAgICAgZHVyYXRpb246IHNlZ21lbnQuZHVyYXRpb24sCiAgICAgICAgdXJsOiBzZWdtZW50LnVybAogICAgICB9LCByZXF1ZXN0UXVldWUudG90YWwsIGRvd25sb2FkZWQpOwogICAgICBjYWxsYmFjayhudWxsKTsKICAgIH0pOwogIH0sIHsKICAgIGNvbmN1cnJlbmN5OiBjaHVua1JlYWRhaGVhZAogIH0pOwoKICBjb25zdCBvbkVycm9yID0gZXJyID0+IHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7IC8vIFN0b3Agb24gYW55IGVycm9yLgoKICAgIHN0cmVhbS5lbmQoKTsKICB9OyAvLyBXaGVuIHRvIGxvb2sgZm9yIGl0ZW1zIGFnYWluLgoKCiAgbGV0IHJlZnJlc2hUaHJlc2hvbGQ7CiAgbGV0IG1pblJlZnJlc2hUaW1lOwogIGxldCByZWZyZXNoVGltZW91dDsKICBsZXQgZmV0Y2hpbmdQbGF5bGlzdCA9IHRydWU7CiAgbGV0IGVuZGVkID0gZmFsc2U7CiAgbGV0IGlzU3RhdGljID0gZmFsc2U7CiAgbGV0IGxhc3RSZWZyZXNoOwoKICBjb25zdCBvblF1ZXVlZEVuZCA9IGVyciA9PiB7CiAgICBjdXJyU2VnbWVudCA9IG51bGw7CgogICAgaWYgKGVycikgewogICAgICBvbkVycm9yKGVycik7CiAgICB9IGVsc2UgaWYgKCFmZXRjaGluZ1BsYXlsaXN0ICYmICFlbmRlZCAmJiAhaXNTdGF0aWMgJiYgcmVxdWVzdFF1ZXVlLnRhc2tzLmxlbmd0aCArIHJlcXVlc3RRdWV1ZS5hY3RpdmUgPD0gcmVmcmVzaFRocmVzaG9sZCkgewogICAgICBsZXQgbXMgPSBNYXRoLm1heCgwLCBtaW5SZWZyZXNoVGltZSAtIChEYXRlLm5vdygpIC0gbGFzdFJlZnJlc2gpKTsKICAgICAgZmV0Y2hpbmdQbGF5bGlzdCA9IHRydWU7CiAgICAgIHJlZnJlc2hUaW1lb3V0ID0gc2V0VGltZW91dChyZWZyZXNoUGxheWxpc3QsIG1zKTsKICAgIH0gZWxzZSBpZiAoKGVuZGVkIHx8IGlzU3RhdGljKSAmJiAhcmVxdWVzdFF1ZXVlLnRhc2tzLmxlbmd0aCAmJiAhcmVxdWVzdFF1ZXVlLmFjdGl2ZSkgewogICAgICBzdHJlYW0uZW5kKCk7CiAgICB9CiAgfTsKCiAgbGV0IGN1cnJQbGF5bGlzdDsKICBsZXQgbGFzdFNlcTsKICBsZXQgc3RhcnR0aW1lID0gMDsKCiAgY29uc3QgcmVmcmVzaFBsYXlsaXN0ID0gKCkgPT4gewogICAgbGFzdFJlZnJlc2ggPSBEYXRlLm5vdygpOwogICAgY3VyclBsYXlsaXN0ID0gbWluaWdldF8xLmRlZmF1bHQocGxheWxpc3RVUkwsIHJlcXVlc3RPcHRpb25zKTsKICAgIGN1cnJQbGF5bGlzdC5vbignZXJyb3InLCBvbkVycm9yKTsKICAgIGZvcndhcmRFdmVudHMoY3VyclBsYXlsaXN0KTsKICAgIGNvbnN0IHBhcnNlciA9IGN1cnJQbGF5bGlzdC5waXBlKG5ldyBQYXJzZXIob3B0aW9ucy5pZCkpOwogICAgcGFyc2VyLm9uKCdzdGFydHRpbWUnLCBhID0+IHsKICAgICAgaWYgKHN0YXJ0dGltZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgc3RhcnR0aW1lID0gYTsKCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5iZWdpbiA9PT0gJ3N0cmluZycgJiYgYmVnaW4gPj0gMCkgewogICAgICAgIGJlZ2luICs9IHN0YXJ0dGltZTsKICAgICAgfQogICAgfSk7CiAgICBwYXJzZXIub24oJ2VuZGxpc3QnLCAoKSA9PiB7CiAgICAgIGlzU3RhdGljID0gdHJ1ZTsKICAgIH0pOwogICAgcGFyc2VyLm9uKCdlbmRlYXJseScsIGN1cnJQbGF5bGlzdC51bnBpcGUuYmluZChjdXJyUGxheWxpc3QsIHBhcnNlcikpOwogICAgbGV0IGFkZGVkSXRlbXMgPSBbXTsKCiAgICBjb25zdCBhZGRJdGVtID0gaXRlbSA9PiB7CiAgICAgIGlmICghaXRlbS5pbml0KSB7CiAgICAgICAgaWYgKGl0ZW0uc2VxIDw9IGxhc3RTZXEpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxhc3RTZXEgPSBpdGVtLnNlcTsKICAgICAgfQoKICAgICAgYmVnaW4gPSBpdGVtLnRpbWU7CiAgICAgIHJlcXVlc3RRdWV1ZS5wdXNoKGl0ZW0sIG9uUXVldWVkRW5kKTsKICAgICAgYWRkZWRJdGVtcy5wdXNoKGl0ZW0pOwogICAgfTsKCiAgICBsZXQgdGFpbGVkSXRlbXMgPSBbXSwKICAgICAgICB0YWlsZWRJdGVtc0R1cmF0aW9uID0gMDsKICAgIHBhcnNlci5vbignaXRlbScsIGl0ZW0gPT4gewogICAgICBsZXQgdGltZWRJdGVtID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICAgdGltZTogc3RhcnR0aW1lCiAgICAgIH0sIGl0ZW0pOwoKICAgICAgaWYgKGJlZ2luIDw9IHRpbWVkSXRlbS50aW1lKSB7CiAgICAgICAgYWRkSXRlbSh0aW1lZEl0ZW0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRhaWxlZEl0ZW1zLnB1c2godGltZWRJdGVtKTsKICAgICAgICB0YWlsZWRJdGVtc0R1cmF0aW9uICs9IHRpbWVkSXRlbS5kdXJhdGlvbjsgLy8gT25seSBrZWVwIHRoZSBsYXN0IGBsaXZlQnVmZmVyYCBvZiBpdGVtcy4KCiAgICAgICAgd2hpbGUgKHRhaWxlZEl0ZW1zLmxlbmd0aCA+IDEgJiYgdGFpbGVkSXRlbXNEdXJhdGlvbiAtIHRhaWxlZEl0ZW1zWzBdLmR1cmF0aW9uID4gbGl2ZUJ1ZmZlcikgewogICAgICAgICAgY29uc3QgbGFzdEl0ZW0gPSB0YWlsZWRJdGVtcy5zaGlmdCgpOwogICAgICAgICAgdGFpbGVkSXRlbXNEdXJhdGlvbiAtPSBsYXN0SXRlbS5kdXJhdGlvbjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHN0YXJ0dGltZSArPSB0aW1lZEl0ZW0uZHVyYXRpb247CiAgICB9KTsKICAgIHBhcnNlci5vbignZW5kJywgKCkgPT4gewogICAgICBjdXJyUGxheWxpc3QgPSBudWxsOyAvLyBJZiB3ZSBhcmUgdG9vIGFoZWFkIG9mIHRoZSBzdHJlYW0sIG1ha2Ugc3VyZSB0byBnZXQgdGhlCiAgICAgIC8vIGxhdGVzdCBhdmFpbGFibGUgaXRlbXMgd2l0aCBhIHNtYWxsIGJ1ZmZlci4KCiAgICAgIGlmICghYWRkZWRJdGVtcy5sZW5ndGggJiYgdGFpbGVkSXRlbXMubGVuZ3RoKSB7CiAgICAgICAgdGFpbGVkSXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICAgIGFkZEl0ZW0oaXRlbSk7CiAgICAgICAgfSk7CiAgICAgIH0gLy8gUmVmcmVzaCB0aGUgcGxheWxpc3Qgd2hlbiByZW1haW5pbmcgc2VnbWVudHMgZ2V0IGxvdy4KCgogICAgICByZWZyZXNoVGhyZXNob2xkID0gTWF0aC5tYXgoMSwgTWF0aC5jZWlsKGFkZGVkSXRlbXMubGVuZ3RoICogMC4wMSkpOyAvLyBUaHJvdHRsZSByZWZyZXNoaW5nIHRoZSBwbGF5bGlzdCBieSBsb29raW5nIGF0IHRoZSBkdXJhdGlvbgogICAgICAvLyBvZiBsaXZlIGl0ZW1zIGFkZGVkIG9uIHRoaXMgcmVmcmVzaC4KCiAgICAgIG1pblJlZnJlc2hUaW1lID0gYWRkZWRJdGVtcy5yZWR1Y2UoKHRvdGFsLCBpdGVtKSA9PiBpdGVtLmR1cmF0aW9uICsgdG90YWwsIDApOwogICAgICBmZXRjaGluZ1BsYXlsaXN0ID0gZmFsc2U7CiAgICAgIG9uUXVldWVkRW5kKG51bGwpOwogICAgfSk7CiAgfTsKCiAgcmVmcmVzaFBsYXlsaXN0KCk7CgogIHN0cmVhbS5lbmQgPSAoKSA9PiB7CiAgICBlbmRlZCA9IHRydWU7CiAgICBzdHJlYW1RdWV1ZS5kaWUoKTsKICAgIHJlcXVlc3RRdWV1ZS5kaWUoKTsKICAgIGNsZWFyVGltZW91dChyZWZyZXNoVGltZW91dCk7CiAgICBjdXJyUGxheWxpc3QgPT09IG51bGwgfHwgY3VyclBsYXlsaXN0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyUGxheWxpc3QuZGVzdHJveSgpOwogICAgY3VyclNlZ21lbnQgPT09IG51bGwgfHwgY3VyclNlZ21lbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGN1cnJTZWdtZW50LmRlc3Ryb3koKTsKICAgIHN0cmVhbV8xLlBhc3NUaHJvdWdoLnByb3RvdHlwZS5lbmQuY2FsbChzdHJlYW0sIG51bGwpOwogICAgcmV0dXJuIHN0cmVhbTsKICB9OwoKICByZXR1cm4gc3RyZWFtOwp9OwoKbTN1OHN0cmVhbSQxLnBhcnNlVGltZXN0YW1wID0gcGFyc2VfdGltZV8xLmh1bWFuU3RyOwp2YXIgZGlzdCA9IG0zdThzdHJlYW0kMTsKCmNvbnN0IHV0aWxzJDEgPSB1dGlscyQyOwpjb25zdCBxcyA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMlsiZGVmYXVsdCJdOwpjb25zdCB7CiAgcGFyc2VUaW1lc3RhbXA6IHBhcnNlVGltZXN0YW1wJDEKfSA9IGRpc3Q7CmNvbnN0IEJBU0VfVVJMID0gJ2h0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9JzsKY29uc3QgVElUTEVfVE9fQ0FURUdPUlkgPSB7CiAgc29uZzogewogICAgbmFtZTogJ011c2ljJywKICAgIHVybDogJ2h0dHBzOi8vbXVzaWMueW91dHViZS5jb20vJwogIH0KfTsKCmNvbnN0IGdldFRleHQgPSBvYmogPT4gb2JqID8gb2JqLnJ1bnMgPyBvYmoucnVuc1swXS50ZXh0IDogb2JqLnNpbXBsZVRleHQgOiBudWxsOwovKioKICogR2V0IHZpZGVvIG1lZGlhLgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7T2JqZWN0fQogKi8KCgppbmZvRXh0cmFzLmdldE1lZGlhID0gaW5mbyA9PiB7CiAgbGV0IG1lZGlhID0ge307CiAgbGV0IHJlc3VsdHMgPSBbXTsKCiAgdHJ5IHsKICAgIHJlc3VsdHMgPSBpbmZvLnJlc3BvbnNlLmNvbnRlbnRzLnR3b0NvbHVtbldhdGNoTmV4dFJlc3VsdHMucmVzdWx0cy5yZXN1bHRzLmNvbnRlbnRzOwogIH0gY2F0Y2ggKGVycikgey8vIERvIG5vdGhpbmcKICB9CgogIGxldCByZXN1bHQgPSByZXN1bHRzLmZpbmQodiA9PiB2LnZpZGVvU2Vjb25kYXJ5SW5mb1JlbmRlcmVyKTsKCiAgaWYgKCFyZXN1bHQpIHsKICAgIHJldHVybiB7fTsKICB9CgogIHRyeSB7CiAgICBsZXQgbWV0YWRhdGFSb3dzID0gKHJlc3VsdC5tZXRhZGF0YVJvd0NvbnRhaW5lciB8fCByZXN1bHQudmlkZW9TZWNvbmRhcnlJbmZvUmVuZGVyZXIubWV0YWRhdGFSb3dDb250YWluZXIpLm1ldGFkYXRhUm93Q29udGFpbmVyUmVuZGVyZXIucm93czsKCiAgICBmb3IgKGxldCByb3cgb2YgbWV0YWRhdGFSb3dzKSB7CiAgICAgIGlmIChyb3cubWV0YWRhdGFSb3dSZW5kZXJlcikgewogICAgICAgIGxldCB0aXRsZSA9IGdldFRleHQocm93Lm1ldGFkYXRhUm93UmVuZGVyZXIudGl0bGUpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgbGV0IGNvbnRlbnRzID0gcm93Lm1ldGFkYXRhUm93UmVuZGVyZXIuY29udGVudHNbMF07CiAgICAgICAgbWVkaWFbdGl0bGVdID0gZ2V0VGV4dChjb250ZW50cyk7CiAgICAgICAgbGV0IHJ1bnMgPSBjb250ZW50cy5ydW5zOwoKICAgICAgICBpZiAocnVucyAmJiBydW5zWzBdLm5hdmlnYXRpb25FbmRwb2ludCkgewogICAgICAgICAgbWVkaWFbYCR7dGl0bGV9X3VybGBdID0gbmV3IFVSTChydW5zWzBdLm5hdmlnYXRpb25FbmRwb2ludC5jb21tYW5kTWV0YWRhdGEud2ViQ29tbWFuZE1ldGFkYXRhLnVybCwgQkFTRV9VUkwpLnRvU3RyaW5nKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGl0bGUgaW4gVElUTEVfVE9fQ0FURUdPUlkpIHsKICAgICAgICAgIG1lZGlhLmNhdGVnb3J5ID0gVElUTEVfVE9fQ0FURUdPUllbdGl0bGVdLm5hbWU7CiAgICAgICAgICBtZWRpYS5jYXRlZ29yeV91cmwgPSBUSVRMRV9UT19DQVRFR09SWVt0aXRsZV0udXJsOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChyb3cucmljaE1ldGFkYXRhUm93UmVuZGVyZXIpIHsKICAgICAgICBsZXQgY29udGVudHMgPSByb3cucmljaE1ldGFkYXRhUm93UmVuZGVyZXIuY29udGVudHM7CiAgICAgICAgbGV0IGJveEFydCA9IGNvbnRlbnRzLmZpbHRlcihtZXRhID0+IG1ldGEucmljaE1ldGFkYXRhUmVuZGVyZXIuc3R5bGUgPT09ICdSSUNIX01FVEFEQVRBX1JFTkRFUkVSX1NUWUxFX0JPWF9BUlQnKTsKCiAgICAgICAgZm9yIChsZXQgewogICAgICAgICAgcmljaE1ldGFkYXRhUmVuZGVyZXIKICAgICAgICB9IG9mIGJveEFydCkgewogICAgICAgICAgbGV0IG1ldGEgPSByaWNoTWV0YWRhdGFSZW5kZXJlcjsKICAgICAgICAgIG1lZGlhLnllYXIgPSBnZXRUZXh0KG1ldGEuc3VidGl0bGUpOwogICAgICAgICAgbGV0IHR5cGUgPSBnZXRUZXh0KG1ldGEuY2FsbFRvQWN0aW9uKS5zcGxpdCgnICcpWzFdOwogICAgICAgICAgbWVkaWFbdHlwZV0gPSBnZXRUZXh0KG1ldGEudGl0bGUpOwogICAgICAgICAgbWVkaWFbYCR7dHlwZX1fdXJsYF0gPSBuZXcgVVJMKG1ldGEuZW5kcG9pbnQuY29tbWFuZE1ldGFkYXRhLndlYkNvbW1hbmRNZXRhZGF0YS51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICAgICAgbWVkaWEudGh1bWJuYWlscyA9IG1ldGEudGh1bWJuYWlsLnRodW1ibmFpbHM7CiAgICAgICAgfQoKICAgICAgICBsZXQgdG9waWMgPSBjb250ZW50cy5maWx0ZXIobWV0YSA9PiBtZXRhLnJpY2hNZXRhZGF0YVJlbmRlcmVyLnN0eWxlID09PSAnUklDSF9NRVRBREFUQV9SRU5ERVJFUl9TVFlMRV9UT1BJQycpOwoKICAgICAgICBmb3IgKGxldCB7CiAgICAgICAgICByaWNoTWV0YWRhdGFSZW5kZXJlcgogICAgICAgIH0gb2YgdG9waWMpIHsKICAgICAgICAgIGxldCBtZXRhID0gcmljaE1ldGFkYXRhUmVuZGVyZXI7CiAgICAgICAgICBtZWRpYS5jYXRlZ29yeSA9IGdldFRleHQobWV0YS50aXRsZSk7CiAgICAgICAgICBtZWRpYS5jYXRlZ29yeV91cmwgPSBuZXcgVVJMKG1ldGEuZW5kcG9pbnQuY29tbWFuZE1ldGFkYXRhLndlYkNvbW1hbmRNZXRhZGF0YS51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gY2F0Y2ggKGVycikgey8vIERvIG5vdGhpbmcuCiAgfQoKICByZXR1cm4gbWVkaWE7Cn07Cgpjb25zdCBpc1ZlcmlmaWVkID0gYmFkZ2VzID0+ICEhKGJhZGdlcyAmJiBiYWRnZXMuZmluZChiID0+IGIubWV0YWRhdGFCYWRnZVJlbmRlcmVyLnRvb2x0aXAgPT09ICdWZXJpZmllZCcpKTsKLyoqCiAqIEdldCB2aWRlbyBhdXRob3IuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvCiAqIEByZXR1cm5zIHtPYmplY3R9CiAqLwoKCmluZm9FeHRyYXMuZ2V0QXV0aG9yID0gaW5mbyA9PiB7CiAgbGV0IGNoYW5uZWxJZCwKICAgICAgdGh1bWJuYWlscyA9IFtdLAogICAgICBzdWJzY3JpYmVyQ291bnQsCiAgICAgIHZlcmlmaWVkID0gZmFsc2U7CgogIHRyeSB7CiAgICBsZXQgcmVzdWx0cyA9IGluZm8ucmVzcG9uc2UuY29udGVudHMudHdvQ29sdW1uV2F0Y2hOZXh0UmVzdWx0cy5yZXN1bHRzLnJlc3VsdHMuY29udGVudHM7CiAgICBsZXQgdiA9IHJlc3VsdHMuZmluZCh2MiA9PiB2Mi52aWRlb1NlY29uZGFyeUluZm9SZW5kZXJlciAmJiB2Mi52aWRlb1NlY29uZGFyeUluZm9SZW5kZXJlci5vd25lciAmJiB2Mi52aWRlb1NlY29uZGFyeUluZm9SZW5kZXJlci5vd25lci52aWRlb093bmVyUmVuZGVyZXIpOwogICAgbGV0IHZpZGVvT3duZXJSZW5kZXJlciA9IHYudmlkZW9TZWNvbmRhcnlJbmZvUmVuZGVyZXIub3duZXIudmlkZW9Pd25lclJlbmRlcmVyOwogICAgY2hhbm5lbElkID0gdmlkZW9Pd25lclJlbmRlcmVyLm5hdmlnYXRpb25FbmRwb2ludC5icm93c2VFbmRwb2ludC5icm93c2VJZDsKICAgIHRodW1ibmFpbHMgPSB2aWRlb093bmVyUmVuZGVyZXIudGh1bWJuYWlsLnRodW1ibmFpbHMubWFwKHRodW1ibmFpbCA9PiB7CiAgICAgIHRodW1ibmFpbC51cmwgPSBuZXcgVVJMKHRodW1ibmFpbC51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICByZXR1cm4gdGh1bWJuYWlsOwogICAgfSk7CiAgICBzdWJzY3JpYmVyQ291bnQgPSB1dGlscyQxLnBhcnNlQWJicmV2aWF0ZWROdW1iZXIoZ2V0VGV4dCh2aWRlb093bmVyUmVuZGVyZXIuc3Vic2NyaWJlckNvdW50VGV4dCkpOwogICAgdmVyaWZpZWQgPSBpc1ZlcmlmaWVkKHZpZGVvT3duZXJSZW5kZXJlci5iYWRnZXMpOwogIH0gY2F0Y2ggKGVycikgey8vIERvIG5vdGhpbmcuCiAgfQoKICB0cnkgewogICAgbGV0IHZpZGVvRGV0YWlscyA9IGluZm8ucGxheWVyX3Jlc3BvbnNlLm1pY3JvZm9ybWF0ICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLm1pY3JvZm9ybWF0LnBsYXllck1pY3JvZm9ybWF0UmVuZGVyZXI7CiAgICBsZXQgaWQgPSB2aWRlb0RldGFpbHMgJiYgdmlkZW9EZXRhaWxzLmNoYW5uZWxJZCB8fCBjaGFubmVsSWQgfHwgaW5mby5wbGF5ZXJfcmVzcG9uc2UudmlkZW9EZXRhaWxzLmNoYW5uZWxJZDsKICAgIGxldCBhdXRob3IgPSB7CiAgICAgIGlkOiBpZCwKICAgICAgbmFtZTogdmlkZW9EZXRhaWxzID8gdmlkZW9EZXRhaWxzLm93bmVyQ2hhbm5lbE5hbWUgOiBpbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMuYXV0aG9yLAogICAgICB1c2VyOiB2aWRlb0RldGFpbHMgPyB2aWRlb0RldGFpbHMub3duZXJQcm9maWxlVXJsLnNwbGl0KCcvJykuc2xpY2UoLTEpWzBdIDogbnVsbCwKICAgICAgY2hhbm5lbF91cmw6IGBodHRwczovL3d3dy55b3V0dWJlLmNvbS9jaGFubmVsLyR7aWR9YCwKICAgICAgZXh0ZXJuYWxfY2hhbm5lbF91cmw6IHZpZGVvRGV0YWlscyA/IGBodHRwczovL3d3dy55b3V0dWJlLmNvbS9jaGFubmVsLyR7dmlkZW9EZXRhaWxzLmV4dGVybmFsQ2hhbm5lbElkfWAgOiAnJywKICAgICAgdXNlcl91cmw6IHZpZGVvRGV0YWlscyA/IG5ldyBVUkwodmlkZW9EZXRhaWxzLm93bmVyUHJvZmlsZVVybCwgQkFTRV9VUkwpLnRvU3RyaW5nKCkgOiAnJywKICAgICAgdGh1bWJuYWlscywKICAgICAgdmVyaWZpZWQsCiAgICAgIHN1YnNjcmliZXJfY291bnQ6IHN1YnNjcmliZXJDb3VudAogICAgfTsKCiAgICBpZiAodGh1bWJuYWlscy5sZW5ndGgpIHsKICAgICAgdXRpbHMkMS5kZXByZWNhdGUoYXV0aG9yLCAnYXZhdGFyJywgYXV0aG9yLnRodW1ibmFpbHNbMF0udXJsLCAnYXV0aG9yLmF2YXRhcicsICdhdXRob3IudGh1bWJuYWlsc1swXS51cmwnKTsKICAgIH0KCiAgICByZXR1cm4gYXV0aG9yOwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIHt9OwogIH0KfTsKCmNvbnN0IHBhcnNlUmVsYXRlZFZpZGVvID0gKGRldGFpbHMsIHJ2c1BhcmFtcykgPT4gewogIGlmICghZGV0YWlscykgcmV0dXJuOwoKICB0cnkgewogICAgbGV0IHZpZXdDb3VudCA9IGdldFRleHQoZGV0YWlscy52aWV3Q291bnRUZXh0KTsKICAgIGxldCBzaG9ydFZpZXdDb3VudCA9IGdldFRleHQoZGV0YWlscy5zaG9ydFZpZXdDb3VudFRleHQpOwogICAgbGV0IHJ2c0RldGFpbHMgPSBydnNQYXJhbXMuZmluZChlbGVtID0+IGVsZW0uaWQgPT09IGRldGFpbHMudmlkZW9JZCk7CgogICAgaWYgKCEvXlxkLy50ZXN0KHNob3J0Vmlld0NvdW50KSkgewogICAgICBzaG9ydFZpZXdDb3VudCA9IHJ2c0RldGFpbHMgJiYgcnZzRGV0YWlscy5zaG9ydF92aWV3X2NvdW50X3RleHQgfHwgJyc7CiAgICB9CgogICAgdmlld0NvdW50ID0gKC9eXGQvLnRlc3Qodmlld0NvdW50KSA/IHZpZXdDb3VudCA6IHNob3J0Vmlld0NvdW50KS5zcGxpdCgnICcpWzBdOwogICAgbGV0IGJyb3dzZUVuZHBvaW50ID0gZGV0YWlscy5zaG9ydEJ5bGluZVRleHQucnVuc1swXS5uYXZpZ2F0aW9uRW5kcG9pbnQuYnJvd3NlRW5kcG9pbnQ7CiAgICBsZXQgY2hhbm5lbElkID0gYnJvd3NlRW5kcG9pbnQuYnJvd3NlSWQ7CiAgICBsZXQgbmFtZSA9IGdldFRleHQoZGV0YWlscy5zaG9ydEJ5bGluZVRleHQpOwogICAgbGV0IHVzZXIgPSAoYnJvd3NlRW5kcG9pbnQuY2Fub25pY2FsQmFzZVVybCB8fCAnJykuc3BsaXQoJy8nKS5zbGljZSgtMSlbMF07CiAgICBsZXQgdmlkZW8gPSB7CiAgICAgIGlkOiBkZXRhaWxzLnZpZGVvSWQsCiAgICAgIHRpdGxlOiBnZXRUZXh0KGRldGFpbHMudGl0bGUpLAogICAgICBwdWJsaXNoZWQ6IGdldFRleHQoZGV0YWlscy5wdWJsaXNoZWRUaW1lVGV4dCksCiAgICAgIGF1dGhvcjogewogICAgICAgIGlkOiBjaGFubmVsSWQsCiAgICAgICAgbmFtZSwKICAgICAgICB1c2VyLAogICAgICAgIGNoYW5uZWxfdXJsOiBgaHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC8ke2NoYW5uZWxJZH1gLAogICAgICAgIHVzZXJfdXJsOiBgaHR0cHM6Ly93d3cueW91dHViZS5jb20vdXNlci8ke3VzZXJ9YCwKICAgICAgICB0aHVtYm5haWxzOiBkZXRhaWxzLmNoYW5uZWxUaHVtYm5haWwudGh1bWJuYWlscy5tYXAodGh1bWJuYWlsID0+IHsKICAgICAgICAgIHRodW1ibmFpbC51cmwgPSBuZXcgVVJMKHRodW1ibmFpbC51cmwsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICAgICAgcmV0dXJuIHRodW1ibmFpbDsKICAgICAgICB9KSwKICAgICAgICB2ZXJpZmllZDogaXNWZXJpZmllZChkZXRhaWxzLm93bmVyQmFkZ2VzKSwKCiAgICAgICAgW1N5bWJvbC50b1ByaW1pdGl2ZV0oKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oYFxgcmVsYXRlZFZpZGVvLmF1dGhvclxgIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIG5lYXIgZnV0dXJlIHJlbGVhc2UsIGAgKyBgdXNlIFxgcmVsYXRlZFZpZGVvLmF1dGhvci5uYW1lXGAgaW5zdGVhZC5gKTsKICAgICAgICAgIHJldHVybiB2aWRlby5hdXRob3IubmFtZTsKICAgICAgICB9CgogICAgICB9LAogICAgICBzaG9ydF92aWV3X2NvdW50X3RleHQ6IHNob3J0Vmlld0NvdW50LnNwbGl0KCcgJylbMF0sCiAgICAgIHZpZXdfY291bnQ6IHZpZXdDb3VudC5yZXBsYWNlKC8sL2csICcnKSwKICAgICAgbGVuZ3RoX3NlY29uZHM6IGRldGFpbHMubGVuZ3RoVGV4dCA/IE1hdGguZmxvb3IocGFyc2VUaW1lc3RhbXAkMShnZXRUZXh0KGRldGFpbHMubGVuZ3RoVGV4dCkpIC8gMTAwMCkgOiBydnNQYXJhbXMgJiYgYCR7cnZzUGFyYW1zLmxlbmd0aF9zZWNvbmRzfWAsCiAgICAgIHRodW1ibmFpbHM6IGRldGFpbHMudGh1bWJuYWlsLnRodW1ibmFpbHMsCiAgICAgIHJpY2hUaHVtYm5haWxzOiBkZXRhaWxzLnJpY2hUaHVtYm5haWwgPyBkZXRhaWxzLnJpY2hUaHVtYm5haWwubW92aW5nVGh1bWJuYWlsUmVuZGVyZXIubW92aW5nVGh1bWJuYWlsRGV0YWlscy50aHVtYm5haWxzIDogW10sCiAgICAgIGlzTGl2ZTogISEoZGV0YWlscy5iYWRnZXMgJiYgZGV0YWlscy5iYWRnZXMuZmluZChiID0+IGIubWV0YWRhdGFCYWRnZVJlbmRlcmVyLmxhYmVsID09PSAnTElWRSBOT1cnKSkKICAgIH07CiAgICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlbywgJ2F1dGhvcl90aHVtYm5haWwnLCB2aWRlby5hdXRob3IudGh1bWJuYWlsc1swXS51cmwsICdyZWxhdGVkVmlkZW8uYXV0aG9yX3RodW1ibmFpbCcsICdyZWxhdGVkVmlkZW8uYXV0aG9yLnRodW1ibmFpbHNbMF0udXJsJyk7CiAgICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlbywgJ3VjaWQnLCB2aWRlby5hdXRob3IuaWQsICdyZWxhdGVkVmlkZW8udWNpZCcsICdyZWxhdGVkVmlkZW8uYXV0aG9yLmlkJyk7CiAgICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlbywgJ3ZpZGVvX3RodW1ibmFpbCcsIHZpZGVvLnRodW1ibmFpbHNbMF0udXJsLCAncmVsYXRlZFZpZGVvLnZpZGVvX3RodW1ibmFpbCcsICdyZWxhdGVkVmlkZW8udGh1bWJuYWlsc1swXS51cmwnKTsKICAgIHJldHVybiB2aWRlbzsKICB9IGNhdGNoIChlcnIpIHsvLyBTa2lwLgogIH0KfTsKLyoqCiAqIEdldCByZWxhdGVkIHZpZGVvcy4KICoKICogQHBhcmFtIHtPYmplY3R9IGluZm8KICogQHJldHVybnMge0FycmF5LjxPYmplY3Q+fQogKi8KCgppbmZvRXh0cmFzLmdldFJlbGF0ZWRWaWRlb3MgPSBpbmZvID0+IHsKICBsZXQgcnZzUGFyYW1zID0gW10sCiAgICAgIHNlY29uZGFyeVJlc3VsdHMgPSBbXTsKCiAgdHJ5IHsKICAgIHJ2c1BhcmFtcyA9IGluZm8ucmVzcG9uc2Uud2ViV2F0Y2hOZXh0UmVzcG9uc2VFeHRlbnNpb25EYXRhLnJlbGF0ZWRWaWRlb0FyZ3Muc3BsaXQoJywnKS5tYXAoZSA9PiBxcy5wYXJzZShlKSk7CiAgfSBjYXRjaCAoZXJyKSB7Ly8gRG8gbm90aGluZy4KICB9CgogIHRyeSB7CiAgICBzZWNvbmRhcnlSZXN1bHRzID0gaW5mby5yZXNwb25zZS5jb250ZW50cy50d29Db2x1bW5XYXRjaE5leHRSZXN1bHRzLnNlY29uZGFyeVJlc3VsdHMuc2Vjb25kYXJ5UmVzdWx0cy5yZXN1bHRzOwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIFtdOwogIH0KCiAgbGV0IHZpZGVvcyA9IFtdOwoKICBmb3IgKGxldCByZXN1bHQgb2Ygc2Vjb25kYXJ5UmVzdWx0cyB8fCBbXSkgewogICAgbGV0IGRldGFpbHMgPSByZXN1bHQuY29tcGFjdFZpZGVvUmVuZGVyZXI7CgogICAgaWYgKGRldGFpbHMpIHsKICAgICAgbGV0IHZpZGVvID0gcGFyc2VSZWxhdGVkVmlkZW8oZGV0YWlscywgcnZzUGFyYW1zKTsKICAgICAgaWYgKHZpZGVvKSB2aWRlb3MucHVzaCh2aWRlbyk7CiAgICB9IGVsc2UgewogICAgICBsZXQgYXV0b3BsYXkgPSByZXN1bHQuY29tcGFjdEF1dG9wbGF5UmVuZGVyZXIgfHwgcmVzdWx0Lml0ZW1TZWN0aW9uUmVuZGVyZXI7CiAgICAgIGlmICghYXV0b3BsYXkgfHwgIUFycmF5LmlzQXJyYXkoYXV0b3BsYXkuY29udGVudHMpKSBjb250aW51ZTsKCiAgICAgIGZvciAobGV0IGNvbnRlbnQgb2YgYXV0b3BsYXkuY29udGVudHMpIHsKICAgICAgICBsZXQgdmlkZW8gPSBwYXJzZVJlbGF0ZWRWaWRlbyhjb250ZW50LmNvbXBhY3RWaWRlb1JlbmRlcmVyLCBydnNQYXJhbXMpOwogICAgICAgIGlmICh2aWRlbykgdmlkZW9zLnB1c2godmlkZW8pOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gdmlkZW9zOwp9OwovKioKICogR2V0IGxpa2UgY291bnQuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvCiAqIEByZXR1cm5zIHtudW1iZXJ9CiAqLwoKCmluZm9FeHRyYXMuZ2V0TGlrZXMgPSBpbmZvID0+IHsKICB0cnkgewogICAgbGV0IGNvbnRlbnRzID0gaW5mby5yZXNwb25zZS5jb250ZW50cy50d29Db2x1bW5XYXRjaE5leHRSZXN1bHRzLnJlc3VsdHMucmVzdWx0cy5jb250ZW50czsKICAgIGxldCB2aWRlbyA9IGNvbnRlbnRzLmZpbmQociA9PiByLnZpZGVvUHJpbWFyeUluZm9SZW5kZXJlcik7CiAgICBsZXQgYnV0dG9ucyA9IHZpZGVvLnZpZGVvUHJpbWFyeUluZm9SZW5kZXJlci52aWRlb0FjdGlvbnMubWVudVJlbmRlcmVyLnRvcExldmVsQnV0dG9uczsKICAgIGxldCBsaWtlID0gYnV0dG9ucy5maW5kKGIgPT4gYi50b2dnbGVCdXR0b25SZW5kZXJlciAmJiBiLnRvZ2dsZUJ1dHRvblJlbmRlcmVyLmRlZmF1bHRJY29uLmljb25UeXBlID09PSAnTElLRScpOwogICAgcmV0dXJuIHBhcnNlSW50KGxpa2UudG9nZ2xlQnV0dG9uUmVuZGVyZXIuZGVmYXVsdFRleHQuYWNjZXNzaWJpbGl0eS5hY2Nlc3NpYmlsaXR5RGF0YS5sYWJlbC5yZXBsYWNlKC9cRCsvZywgJycpKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKLyoqCiAqIEdldCBkaXNsaWtlIGNvdW50LgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7bnVtYmVyfQogKi8KCgppbmZvRXh0cmFzLmdldERpc2xpa2VzID0gaW5mbyA9PiB7CiAgdHJ5IHsKICAgIGxldCBjb250ZW50cyA9IGluZm8ucmVzcG9uc2UuY29udGVudHMudHdvQ29sdW1uV2F0Y2hOZXh0UmVzdWx0cy5yZXN1bHRzLnJlc3VsdHMuY29udGVudHM7CiAgICBsZXQgdmlkZW8gPSBjb250ZW50cy5maW5kKHIgPT4gci52aWRlb1ByaW1hcnlJbmZvUmVuZGVyZXIpOwogICAgbGV0IGJ1dHRvbnMgPSB2aWRlby52aWRlb1ByaW1hcnlJbmZvUmVuZGVyZXIudmlkZW9BY3Rpb25zLm1lbnVSZW5kZXJlci50b3BMZXZlbEJ1dHRvbnM7CiAgICBsZXQgZGlzbGlrZSA9IGJ1dHRvbnMuZmluZChiID0+IGIudG9nZ2xlQnV0dG9uUmVuZGVyZXIgJiYgYi50b2dnbGVCdXR0b25SZW5kZXJlci5kZWZhdWx0SWNvbi5pY29uVHlwZSA9PT0gJ0RJU0xJS0UnKTsKICAgIHJldHVybiBwYXJzZUludChkaXNsaWtlLnRvZ2dsZUJ1dHRvblJlbmRlcmVyLmRlZmF1bHRUZXh0LmFjY2Vzc2liaWxpdHkuYWNjZXNzaWJpbGl0eURhdGEubGFiZWwucmVwbGFjZSgvXEQrL2csICcnKSk7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn07Ci8qKgogKiBDbGVhbnMgdXAgYSBmZXcgZmllbGRzIG9uIGB2aWRlb0RldGFpbHNgLgogKgogKiBAcGFyYW0ge09iamVjdH0gdmlkZW9EZXRhaWxzCiAqIEBwYXJhbSB7T2JqZWN0fSBpbmZvCiAqIEByZXR1cm5zIHtPYmplY3R9CiAqLwoKCmluZm9FeHRyYXMuY2xlYW5WaWRlb0RldGFpbHMgPSAodmlkZW9EZXRhaWxzLCBpbmZvKSA9PiB7CiAgdmlkZW9EZXRhaWxzLnRodW1ibmFpbHMgPSB2aWRlb0RldGFpbHMudGh1bWJuYWlsLnRodW1ibmFpbHM7CiAgZGVsZXRlIHZpZGVvRGV0YWlscy50aHVtYm5haWw7CiAgdXRpbHMkMS5kZXByZWNhdGUodmlkZW9EZXRhaWxzLCAndGh1bWJuYWlsJywgewogICAgdGh1bWJuYWlsczogdmlkZW9EZXRhaWxzLnRodW1ibmFpbHMKICB9LCAndmlkZW9EZXRhaWxzLnRodW1ibmFpbC50aHVtYm5haWxzJywgJ3ZpZGVvRGV0YWlscy50aHVtYm5haWxzJyk7CiAgdmlkZW9EZXRhaWxzLmRlc2NyaXB0aW9uID0gdmlkZW9EZXRhaWxzLnNob3J0RGVzY3JpcHRpb24gfHwgZ2V0VGV4dCh2aWRlb0RldGFpbHMuZGVzY3JpcHRpb24pOwogIGRlbGV0ZSB2aWRlb0RldGFpbHMuc2hvcnREZXNjcmlwdGlvbjsKICB1dGlscyQxLmRlcHJlY2F0ZSh2aWRlb0RldGFpbHMsICdzaG9ydERlc2NyaXB0aW9uJywgdmlkZW9EZXRhaWxzLmRlc2NyaXB0aW9uLCAndmlkZW9EZXRhaWxzLnNob3J0RGVzY3JpcHRpb24nLCAndmlkZW9EZXRhaWxzLmRlc2NyaXB0aW9uJyk7IC8vIFVzZSBtb3JlIHJlbGlhYmxlIGBsZW5ndGhTZWNvbmRzYCBmcm9tIGBwbGF5ZXJNaWNyb2Zvcm1hdFJlbmRlcmVyYC4KCiAgdmlkZW9EZXRhaWxzLmxlbmd0aFNlY29uZHMgPSBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdC5wbGF5ZXJNaWNyb2Zvcm1hdFJlbmRlcmVyLmxlbmd0aFNlY29uZHMgfHwgaW5mby5wbGF5ZXJfcmVzcG9uc2UudmlkZW9EZXRhaWxzLmxlbmd0aFNlY29uZHM7CiAgcmV0dXJuIHZpZGVvRGV0YWlsczsKfTsKLyoqCiAqIEdldCBzdG9yeWJvYXJkcyBpbmZvLgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7QXJyYXkuPE9iamVjdD59CiAqLwoKCmluZm9FeHRyYXMuZ2V0U3Rvcnlib2FyZHMgPSBpbmZvID0+IHsKICBjb25zdCBwYXJ0cyA9IGluZm8ucGxheWVyX3Jlc3BvbnNlLnN0b3J5Ym9hcmRzICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLnN0b3J5Ym9hcmRzLnBsYXllclN0b3J5Ym9hcmRTcGVjUmVuZGVyZXIgJiYgaW5mby5wbGF5ZXJfcmVzcG9uc2Uuc3Rvcnlib2FyZHMucGxheWVyU3Rvcnlib2FyZFNwZWNSZW5kZXJlci5zcGVjICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLnN0b3J5Ym9hcmRzLnBsYXllclN0b3J5Ym9hcmRTcGVjUmVuZGVyZXIuc3BlYy5zcGxpdCgnfCcpOwogIGlmICghcGFydHMpIHJldHVybiBbXTsKICBjb25zdCB1cmwgPSBuZXcgVVJMKHBhcnRzLnNoaWZ0KCkpOwogIHJldHVybiBwYXJ0cy5tYXAoKHBhcnQsIGkpID0+IHsKICAgIGxldCBbdGh1bWJuYWlsV2lkdGgsIHRodW1ibmFpbEhlaWdodCwgdGh1bWJuYWlsQ291bnQsIGNvbHVtbnMsIHJvd3MsIGludGVydmFsLCBuYW1lUmVwbGFjZW1lbnQsIHNpZ2hdID0gcGFydC5zcGxpdCgnIycpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3NpZ2gnLCBzaWdoKTsKICAgIHRodW1ibmFpbENvdW50ID0gcGFyc2VJbnQodGh1bWJuYWlsQ291bnQsIDEwKTsKICAgIGNvbHVtbnMgPSBwYXJzZUludChjb2x1bW5zLCAxMCk7CiAgICByb3dzID0gcGFyc2VJbnQocm93cywgMTApOwogICAgY29uc3Qgc3Rvcnlib2FyZENvdW50ID0gTWF0aC5jZWlsKHRodW1ibmFpbENvdW50IC8gKGNvbHVtbnMgKiByb3dzKSk7CiAgICByZXR1cm4gewogICAgICB0ZW1wbGF0ZVVybDogdXJsLnRvU3RyaW5nKCkucmVwbGFjZSgnJEwnLCBpKS5yZXBsYWNlKCckTicsIG5hbWVSZXBsYWNlbWVudCksCiAgICAgIHRodW1ibmFpbFdpZHRoOiBwYXJzZUludCh0aHVtYm5haWxXaWR0aCwgMTApLAogICAgICB0aHVtYm5haWxIZWlnaHQ6IHBhcnNlSW50KHRodW1ibmFpbEhlaWdodCwgMTApLAogICAgICB0aHVtYm5haWxDb3VudCwKICAgICAgaW50ZXJ2YWw6IHBhcnNlSW50KGludGVydmFsLCAxMCksCiAgICAgIGNvbHVtbnMsCiAgICAgIHJvd3MsCiAgICAgIHN0b3J5Ym9hcmRDb3VudAogICAgfTsKICB9KTsKfTsKLyoqCiAqIEdldCBjaGFwdGVycyBpbmZvLgogKgogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcmV0dXJucyB7QXJyYXkuPE9iamVjdD59CiAqLwoKCmluZm9FeHRyYXMuZ2V0Q2hhcHRlcnMgPSBpbmZvID0+IHsKICBjb25zdCBwbGF5ZXJPdmVybGF5UmVuZGVyZXIgPSBpbmZvLnJlc3BvbnNlICYmIGluZm8ucmVzcG9uc2UucGxheWVyT3ZlcmxheXMgJiYgaW5mby5yZXNwb25zZS5wbGF5ZXJPdmVybGF5cy5wbGF5ZXJPdmVybGF5UmVuZGVyZXI7CiAgY29uc3QgcGxheWVyQmFyID0gcGxheWVyT3ZlcmxheVJlbmRlcmVyICYmIHBsYXllck92ZXJsYXlSZW5kZXJlci5kZWNvcmF0ZWRQbGF5ZXJCYXJSZW5kZXJlciAmJiBwbGF5ZXJPdmVybGF5UmVuZGVyZXIuZGVjb3JhdGVkUGxheWVyQmFyUmVuZGVyZXIuZGVjb3JhdGVkUGxheWVyQmFyUmVuZGVyZXIgJiYgcGxheWVyT3ZlcmxheVJlbmRlcmVyLmRlY29yYXRlZFBsYXllckJhclJlbmRlcmVyLmRlY29yYXRlZFBsYXllckJhclJlbmRlcmVyLnBsYXllckJhcjsKICBjb25zdCBtYXJrZXJzTWFwID0gcGxheWVyQmFyICYmIHBsYXllckJhci5tdWx0aU1hcmtlcnNQbGF5ZXJCYXJSZW5kZXJlciAmJiBwbGF5ZXJCYXIubXVsdGlNYXJrZXJzUGxheWVyQmFyUmVuZGVyZXIubWFya2Vyc01hcDsKICBjb25zdCBtYXJrZXIgPSBBcnJheS5pc0FycmF5KG1hcmtlcnNNYXApICYmIG1hcmtlcnNNYXAuZmluZChtID0+IG0udmFsdWUgJiYgQXJyYXkuaXNBcnJheShtLnZhbHVlLmNoYXB0ZXJzKSk7CiAgaWYgKCFtYXJrZXIpIHJldHVybiBbXTsKICBjb25zdCBjaGFwdGVycyA9IG1hcmtlci52YWx1ZS5jaGFwdGVyczsKICByZXR1cm4gY2hhcHRlcnMubWFwKGNoYXB0ZXIgPT4gKHsKICAgIHRpdGxlOiBnZXRUZXh0KGNoYXB0ZXIuY2hhcHRlclJlbmRlcmVyLnRpdGxlKSwKICAgIHN0YXJ0X3RpbWU6IGNoYXB0ZXIuY2hhcHRlclJlbmRlcmVyLnRpbWVSYW5nZVN0YXJ0TWlsbGlzIC8gMTAwMAogIH0pKTsKfTsKCnZhciBzaWckMSA9IHt9OwoKY29uc3QgewogIHNldFRpbWVvdXQ6IHNldFRpbWVvdXQkMQp9ID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQzWyJkZWZhdWx0Il07IC8vIEEgY2FjaGUgdGhhdCBleHBpcmVzLgoKdmFyIGNhY2hlID0gY2xhc3MgQ2FjaGUgZXh0ZW5kcyBNYXAgewogIGNvbnN0cnVjdG9yKHRpbWVvdXQgPSAxMDAwKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy50aW1lb3V0ID0gdGltZW91dDsKICB9CgogIHNldChrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5oYXMoa2V5KSkgewogICAgICBjbGVhclRpbWVvdXQoc3VwZXIuZ2V0KGtleSkudGlkKTsKICAgIH0KCiAgICBzdXBlci5zZXQoa2V5LCB7CiAgICAgIHRpZDogc2V0VGltZW91dCQxKHRoaXMuZGVsZXRlLmJpbmQodGhpcywga2V5KSwgdGhpcy50aW1lb3V0KS51bnJlZigpLAogICAgICB2YWx1ZQogICAgfSk7CiAgfQoKICBnZXQoa2V5KSB7CiAgICBsZXQgZW50cnkgPSBzdXBlci5nZXQoa2V5KTsKCiAgICBpZiAoZW50cnkpIHsKICAgICAgcmV0dXJuIGVudHJ5LnZhbHVlOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0KCiAgZ2V0T3JTZXQoa2V5LCBmbikgewogICAgaWYgKHRoaXMuaGFzKGtleSkpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0KGtleSk7CiAgICB9IGVsc2UgewogICAgICBsZXQgdmFsdWUgPSBmbigpOwogICAgICB0aGlzLnNldChrZXksIHZhbHVlKTsKCiAgICAgIChhc3luYyAoKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHZhbHVlOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgdGhpcy5kZWxldGUoa2V5KTsKICAgICAgICB9CiAgICAgIH0pKCk7CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfQoKICBkZWxldGUoa2V5KSB7CiAgICBsZXQgZW50cnkgPSBzdXBlci5nZXQoa2V5KTsKCiAgICBpZiAoZW50cnkpIHsKICAgICAgY2xlYXJUaW1lb3V0KGVudHJ5LnRpZCk7CiAgICAgIHN1cGVyLmRlbGV0ZShrZXkpOwogICAgfQogIH0KCiAgY2xlYXIoKSB7CiAgICBmb3IgKGxldCBlbnRyeSBvZiB0aGlzLnZhbHVlcygpKSB7CiAgICAgIGNsZWFyVGltZW91dChlbnRyeS50aWQpOwogICAgfQoKICAgIHN1cGVyLmNsZWFyKCk7CiAgfQoKfTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewogIGNvbnN0IHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQyWyJkZWZhdWx0Il07CiAgY29uc3QgQ2FjaGUgPSBjYWNoZTsKICBjb25zdCB1dGlscyA9IHV0aWxzJDI7CiAgY29uc3Qgdm0gPSByZXF1aXJlJCQzX19kZWZhdWx0WyJkZWZhdWx0Il07IC8vIEEgc2hhcmVkIGNhY2hlIHRvIGtlZXAgdHJhY2sgb2YgaHRtbDVwbGF5ZXIganMgZnVuY3Rpb25zLgoKICBleHBvcnRzLmNhY2hlID0gbmV3IENhY2hlKCk7CiAgLyoqCiAgICogRXh0cmFjdCBzaWduYXR1cmUgZGVjaXBoZXJpbmcgYW5kIG4gcGFyYW1ldGVyIHRyYW5zZm9ybSBmdW5jdGlvbnMgZnJvbSBodG1sNXBsYXllciBmaWxlLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGh0bWw1cGxheWVyZmlsZQogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXkuPHN0cmluZz4+fQogICAqLwoKICBleHBvcnRzLmdldEZ1bmN0aW9ucyA9IChodG1sNXBsYXllcmZpbGUsIG9wdGlvbnMpID0+IGV4cG9ydHMuY2FjaGUuZ2V0T3JTZXQoaHRtbDVwbGF5ZXJmaWxlLCBhc3luYyAoKSA9PiB7CiAgICBjb25zdCBib2R5ID0gYXdhaXQgdXRpbHMuZXhwb3NlZE1pbmlnZXQoaHRtbDVwbGF5ZXJmaWxlLCBvcHRpb25zKS50ZXh0KCk7CiAgICBjb25zdCBmdW5jdGlvbnMgPSBleHBvcnRzLmV4dHJhY3RGdW5jdGlvbnMoYm9keSk7CgogICAgaWYgKCFmdW5jdGlvbnMgfHwgIWZ1bmN0aW9ucy5sZW5ndGgpIHsKICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBleHRyYWN0IGZ1bmN0aW9ucycpOwogICAgfQoKICAgIGV4cG9ydHMuY2FjaGUuc2V0KGh0bWw1cGxheWVyZmlsZSwgZnVuY3Rpb25zKTsKICAgIHJldHVybiBmdW5jdGlvbnM7CiAgfSk7CiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIGFjdGlvbnMgdGhhdCBzaG91bGQgYmUgdGFrZW4gdG8gZGVjaXBoZXIgYSBzaWduYXR1cmUKICAgKiBhbmQgdHJhbmZvcm0gdGhlIG4gcGFyYW1ldGVyCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gYm9keQogICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0KICAgKi8KCgogIGV4cG9ydHMuZXh0cmFjdEZ1bmN0aW9ucyA9IGJvZHkgPT4gewogICAgY29uc3QgZnVuY3Rpb25zID0gW107CgogICAgY29uc3QgZXh0cmFjdE1hbmlwdWxhdGlvbnMgPSBjYWxsZXIgPT4gewogICAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSB1dGlscy5iZXR3ZWVuKGNhbGxlciwgYGE9YS5zcGxpdCgiIik7YCwgYC5gKTsKICAgICAgaWYgKCFmdW5jdGlvbk5hbWUpIHJldHVybiAnJzsKICAgICAgY29uc3QgZnVuY3Rpb25TdGFydCA9IGB2YXIgJHtmdW5jdGlvbk5hbWV9PXtgOwogICAgICBjb25zdCBuZHggPSBib2R5LmluZGV4T2YoZnVuY3Rpb25TdGFydCk7CiAgICAgIGlmIChuZHggPCAwKSByZXR1cm4gJyc7CiAgICAgIGNvbnN0IHN1YkJvZHkgPSBib2R5LnNsaWNlKG5keCArIGZ1bmN0aW9uU3RhcnQubGVuZ3RoIC0gMSk7CiAgICAgIHJldHVybiBgdmFyICR7ZnVuY3Rpb25OYW1lfT0ke3V0aWxzLmN1dEFmdGVySlNPTihzdWJCb2R5KX1gOwogICAgfTsKCiAgICBjb25zdCBleHRyYWN0RGVjaXBoZXIgPSAoKSA9PiB7CiAgICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IHV0aWxzLmJldHdlZW4oYm9keSwgYGEuc2V0KCJhbHIiLCJ5ZXMiKTtjJiYoYz1gLCBgKGRlY29kZVVSSUNgKTsKCiAgICAgIGlmIChmdW5jdGlvbk5hbWUgJiYgZnVuY3Rpb25OYW1lLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGZ1bmN0aW9uU3RhcnQgPSBgJHtmdW5jdGlvbk5hbWV9PWZ1bmN0aW9uKGEpYDsKICAgICAgICBjb25zdCBuZHggPSBib2R5LmluZGV4T2YoZnVuY3Rpb25TdGFydCk7CgogICAgICAgIGlmIChuZHggPj0gMCkgewogICAgICAgICAgY29uc3Qgc3ViQm9keSA9IGJvZHkuc2xpY2UobmR4ICsgZnVuY3Rpb25TdGFydC5sZW5ndGgpOwogICAgICAgICAgbGV0IGZ1bmN0aW9uQm9keSA9IGB2YXIgJHtmdW5jdGlvblN0YXJ0fSR7dXRpbHMuY3V0QWZ0ZXJKU09OKHN1YkJvZHkpfWA7CiAgICAgICAgICBmdW5jdGlvbkJvZHkgPSBgJHtleHRyYWN0TWFuaXB1bGF0aW9ucyhmdW5jdGlvbkJvZHkpfTske2Z1bmN0aW9uQm9keX07JHtmdW5jdGlvbk5hbWV9KHNpZyk7YDsKICAgICAgICAgIGZ1bmN0aW9ucy5wdXNoKGZ1bmN0aW9uQm9keSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGNvbnN0IGV4dHJhY3ROQ29kZSA9ICgpID0+IHsKICAgICAgbGV0IGZ1bmN0aW9uTmFtZSA9IHV0aWxzLmJldHdlZW4oYm9keSwgYCYmKGI9YS5nZXQoIm4iKSkmJihiPWAsIGAoYilgKTsKICAgICAgaWYgKGZ1bmN0aW9uTmFtZS5pbmNsdWRlcygnWycpKSBmdW5jdGlvbk5hbWUgPSB1dGlscy5iZXR3ZWVuKGJvZHksIGAke2Z1bmN0aW9uTmFtZS5zcGxpdCgnWycpWzBdfT1bYCwgYF1gKTsKCiAgICAgIGlmIChmdW5jdGlvbk5hbWUgJiYgZnVuY3Rpb25OYW1lLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGZ1bmN0aW9uU3RhcnQgPSBgJHtmdW5jdGlvbk5hbWV9PWZ1bmN0aW9uKGEpYDsKICAgICAgICBjb25zdCBuZHggPSBib2R5LmluZGV4T2YoZnVuY3Rpb25TdGFydCk7CgogICAgICAgIGlmIChuZHggPj0gMCkgewogICAgICAgICAgY29uc3Qgc3ViQm9keSA9IGJvZHkuc2xpY2UobmR4ICsgZnVuY3Rpb25TdGFydC5sZW5ndGgpOwogICAgICAgICAgY29uc3QgZnVuY3Rpb25Cb2R5ID0gYHZhciAke2Z1bmN0aW9uU3RhcnR9JHt1dGlscy5jdXRBZnRlckpTT04oc3ViQm9keSl9OyR7ZnVuY3Rpb25OYW1lfShuY29kZSk7YDsKICAgICAgICAgIGZ1bmN0aW9ucy5wdXNoKGZ1bmN0aW9uQm9keSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGV4dHJhY3REZWNpcGhlcigpOwogICAgZXh0cmFjdE5Db2RlKCk7CiAgICByZXR1cm4gZnVuY3Rpb25zOwogIH07CiAgLyoqCiAgICogQXBwbHkgZGVjaXBoZXIgYW5kIG4tdHJhbnNmb3JtIHRvIGluZGl2aWR1YWwgZm9ybWF0CiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZm9ybWF0CiAgICogQHBhcmFtIHt2bS5TY3JpcHR9IGRlY2lwaGVyU2NyaXB0CiAgICogQHBhcmFtIHt2bS5TY3JpcHR9IG5UcmFuc2Zvcm1TY3JpcHQKICAgKi8KCgogIGV4cG9ydHMuc2V0RG93bmxvYWRVUkwgPSAoZm9ybWF0LCBkZWNpcGhlclNjcmlwdCwgblRyYW5zZm9ybVNjcmlwdCkgPT4gewogICAgY29uc3QgZGVjaXBoZXIgPSB1cmwgPT4gewogICAgICBjb25zdCBhcmdzID0gcXVlcnlzdHJpbmcucGFyc2UodXJsKTsKICAgICAgaWYgKCFhcmdzLnMgfHwgIWRlY2lwaGVyU2NyaXB0KSByZXR1cm4gYXJncy51cmw7CiAgICAgIGNvbnN0IGNvbXBvbmVudHMgPSBuZXcgVVJMKGRlY29kZVVSSUNvbXBvbmVudChhcmdzLnVybCkpOwogICAgICBjb21wb25lbnRzLnNlYXJjaFBhcmFtcy5zZXQoYXJncy5zcCA/IGFyZ3Muc3AgOiAnc2lnbmF0dXJlJywgZGVjaXBoZXJTY3JpcHQucnVuSW5OZXdDb250ZXh0KHsKICAgICAgICBzaWc6IGRlY29kZVVSSUNvbXBvbmVudChhcmdzLnMpCiAgICAgIH0pKTsKICAgICAgcmV0dXJuIGNvbXBvbmVudHMudG9TdHJpbmcoKTsKICAgIH07CgogICAgY29uc3QgbmNvZGUgPSB1cmwgPT4gewogICAgICBjb25zdCBjb21wb25lbnRzID0gbmV3IFVSTChkZWNvZGVVUklDb21wb25lbnQodXJsKSk7CiAgICAgIGNvbnN0IG4gPSBjb21wb25lbnRzLnNlYXJjaFBhcmFtcy5nZXQoJ24nKTsKICAgICAgaWYgKCFuIHx8ICFuVHJhbnNmb3JtU2NyaXB0KSByZXR1cm4gdXJsOwogICAgICBjb21wb25lbnRzLnNlYXJjaFBhcmFtcy5zZXQoJ24nLCBuVHJhbnNmb3JtU2NyaXB0LnJ1bkluTmV3Q29udGV4dCh7CiAgICAgICAgbmNvZGU6IG4KICAgICAgfSkpOwogICAgICByZXR1cm4gY29tcG9uZW50cy50b1N0cmluZygpOwogICAgfTsKCiAgICBjb25zdCBjaXBoZXIgPSAhZm9ybWF0LnVybDsKICAgIGNvbnN0IHVybCA9IGZvcm1hdC51cmwgfHwgZm9ybWF0LnNpZ25hdHVyZUNpcGhlciB8fCBmb3JtYXQuY2lwaGVyOwogICAgZm9ybWF0LnVybCA9IGNpcGhlciA/IG5jb2RlKGRlY2lwaGVyKHVybCkpIDogbmNvZGUodXJsKTsKICAgIGRlbGV0ZSBmb3JtYXQuc2lnbmF0dXJlQ2lwaGVyOwogICAgZGVsZXRlIGZvcm1hdC5jaXBoZXI7CiAgfTsKICAvKioKICAgKiBBcHBsaWVzIGRlY2lwaGVyIGFuZCBuIHBhcmFtZXRlciB0cmFuc2Zvcm1zIHRvIGFsbCBmb3JtYXQgVVJMJ3MuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5LjxPYmplY3Q+fSBmb3JtYXRzCiAgICogQHBhcmFtIHtzdHJpbmd9IGh0bWw1cGxheWVyCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKi8KCgogIGV4cG9ydHMuZGVjaXBoZXJGb3JtYXRzID0gYXN5bmMgKGZvcm1hdHMsIGh0bWw1cGxheWVyLCBvcHRpb25zKSA9PiB7CiAgICBsZXQgZGVjaXBoZXJlZEZvcm1hdHMgPSB7fTsKICAgIGxldCBmdW5jdGlvbnMgPSBhd2FpdCBleHBvcnRzLmdldEZ1bmN0aW9ucyhodG1sNXBsYXllciwgb3B0aW9ucyk7CiAgICBjb25zdCBkZWNpcGhlclNjcmlwdCA9IGZ1bmN0aW9ucy5sZW5ndGggPyBuZXcgdm0uU2NyaXB0KGZ1bmN0aW9uc1swXSkgOiBudWxsOwogICAgY29uc3QgblRyYW5zZm9ybVNjcmlwdCA9IGZ1bmN0aW9ucy5sZW5ndGggPiAxID8gbmV3IHZtLlNjcmlwdChmdW5jdGlvbnNbMV0pIDogbnVsbDsKICAgIGZvcm1hdHMuZm9yRWFjaChmb3JtYXQgPT4gewogICAgICBleHBvcnRzLnNldERvd25sb2FkVVJMKGZvcm1hdCwgZGVjaXBoZXJTY3JpcHQsIG5UcmFuc2Zvcm1TY3JpcHQpOwogICAgICBkZWNpcGhlcmVkRm9ybWF0c1tmb3JtYXQudXJsXSA9IGZvcm1hdDsKICAgIH0pOwogICAgcmV0dXJuIGRlY2lwaGVyZWRGb3JtYXRzOwogIH07Cn0pKHNpZyQxKTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewogIGNvbnN0IHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQyWyJkZWZhdWx0Il07CiAgY29uc3Qgc2F4JDEgPSBzYXg7CiAgY29uc3QgbWluaWdldCA9IGRpc3QkMTsKICBjb25zdCB1dGlscyA9IHV0aWxzJDI7IC8vIEZvcmNlcyBOb2RlIEpTIHZlcnNpb24gb2Ygc2V0VGltZW91dCBmb3IgRWxlY3Ryb24gYmFzZWQgYXBwbGljYXRpb25zCgogIGNvbnN0IHsKICAgIHNldFRpbWVvdXQKICB9ID0gcmVxdWlyZSQkMF9fZGVmYXVsdCQzWyJkZWZhdWx0Il07CiAgY29uc3QgZm9ybWF0VXRpbHMgPSBmb3JtYXRVdGlscyQxOwogIGNvbnN0IHVybFV0aWxzID0gdXJsVXRpbHMkMTsKICBjb25zdCBleHRyYXMgPSBpbmZvRXh0cmFzOwogIGNvbnN0IHNpZyA9IHNpZyQxOwogIGNvbnN0IENhY2hlID0gY2FjaGU7CiAgY29uc3QgQkFTRV9VUkwgPSAnaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0nOyAvLyBDYWNoZWQgZm9yIHN0b3JpbmcgYmFzaWMvZnVsbCBpbmZvLgoKICBleHBvcnRzLmNhY2hlID0gbmV3IENhY2hlKCk7CiAgZXhwb3J0cy5jb29raWVDYWNoZSA9IG5ldyBDYWNoZSgxMDAwICogNjAgKiA2MCAqIDI0KTsKICBleHBvcnRzLndhdGNoUGFnZUNhY2hlID0gbmV3IENhY2hlKCk7IC8vIENhY2hlIGZvciBjdmVyIHVzZWQgaW4gZ2V0VmlkZW9JbmZvUGFnZQoKICBsZXQgY3ZlciA9ICcyLjIwMjEwNjIyLjEwLjAwJzsgLy8gU3BlY2lhbCBlcnJvciBjbGFzcyB1c2VkIHRvIGRldGVybWluZSBpZiBhbiBlcnJvciBpcyB1bnJlY292ZXJhYmxlLAogIC8vIGFzIGluLCB5dGRsLWNvcmUgc2hvdWxkIG5vdCB0cnkgYWdhaW4gdG8gZmV0Y2ggdGhlIHZpZGVvIG1ldGFkYXRhLgogIC8vIEluIHRoaXMgY2FzZSwgdGhlIHZpZGVvIGlzIHVzdWFsbHkgdW5hdmFpbGFibGUgaW4gc29tZSB3YXkuCgogIGNsYXNzIFVucmVjb3ZlcmFibGVFcnJvciBleHRlbmRzIEVycm9yIHt9IC8vIExpc3Qgb2YgVVJMcyB0aGF0IHNob3cgdXAgaW4gYG5vdGljZV91cmxgIGZvciBhZ2UgcmVzdHJpY3RlZCB2aWRlb3MuCgoKICBjb25zdCBBR0VfUkVTVFJJQ1RFRF9VUkxTID0gWydzdXBwb3J0Lmdvb2dsZS5jb20veW91dHViZS8/cD1hZ2VfcmVzdHJpY3Rpb25zJywgJ3lvdXR1YmUuY29tL3QvY29tbXVuaXR5X2d1aWRlbGluZXMnXTsKICAvKioKICAgKiBHZXRzIGluZm8gZnJvbSBhIHZpZGVvIHdpdGhvdXQgZ2V0dGluZyBhZGRpdGlvbmFsIGZvcm1hdHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaWQKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59CiAgKi8KCiAgZXhwb3J0cy5nZXRCYXNpY0luZm8gPSBhc3luYyAoaWQsIG9wdGlvbnMpID0+IHsKICAgIGlmIChvcHRpb25zLklQdjZCbG9jaykgewogICAgICBvcHRpb25zLnJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucywgewogICAgICAgIGZhbWlseTogNiwKICAgICAgICBsb2NhbEFkZHJlc3M6IHV0aWxzLmdldFJhbmRvbUlQdjYob3B0aW9ucy5JUHY2QmxvY2spCiAgICAgIH0pOwogICAgfQoKICAgIGNvbnN0IHJldHJ5T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG1pbmlnZXQuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMpOwogICAgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMsIHt9KTsKICAgIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW4KICAgICAgJ1VzZXItQWdlbnQnOiAnTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzg3LjAuNDI4MC4xMDEgU2FmYXJpLzUzNy4zNicKICAgIH0sIG9wdGlvbnMucmVxdWVzdE9wdGlvbnMuaGVhZGVycyk7CgogICAgY29uc3QgdmFsaWRhdGUgPSBpbmZvID0+IHsKICAgICAgbGV0IHBsYXlFcnIgPSB1dGlscy5wbGF5RXJyb3IoaW5mby5wbGF5ZXJfcmVzcG9uc2UsIFsnRVJST1InXSwgVW5yZWNvdmVyYWJsZUVycm9yKTsKICAgICAgbGV0IHByaXZhdGVFcnIgPSBwcml2YXRlVmlkZW9FcnJvcihpbmZvLnBsYXllcl9yZXNwb25zZSk7CgogICAgICBpZiAocGxheUVyciB8fCBwcml2YXRlRXJyKSB7CiAgICAgICAgdGhyb3cgcGxheUVyciB8fCBwcml2YXRlRXJyOwogICAgICB9CgogICAgICByZXR1cm4gaW5mbyAmJiBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiAoaW5mby5wbGF5ZXJfcmVzcG9uc2Uuc3RyZWFtaW5nRGF0YSB8fCBpc1JlbnRhbChpbmZvLnBsYXllcl9yZXNwb25zZSkgfHwgaXNOb3RZZXRCcm9hZGNhc3RlZChpbmZvLnBsYXllcl9yZXNwb25zZSkpOwogICAgfTsKCiAgICBsZXQgaW5mbyA9IGF3YWl0IHBpcGVsaW5lKFtpZCwgb3B0aW9uc10sIHZhbGlkYXRlLCByZXRyeU9wdGlvbnMsIFtnZXRXYXRjaEhUTUxQYWdlLCBnZXRXYXRjaEpTT05QYWdlLCBnZXRWaWRlb0luZm9QYWdlXSk7CiAgICBPYmplY3QuYXNzaWduKGluZm8sIHsKICAgICAgZm9ybWF0czogcGFyc2VGb3JtYXRzKGluZm8ucGxheWVyX3Jlc3BvbnNlKSwKICAgICAgcmVsYXRlZF92aWRlb3M6IGV4dHJhcy5nZXRSZWxhdGVkVmlkZW9zKGluZm8pCiAgICB9KTsgLy8gQWRkIGFkZGl0aW9uYWwgcHJvcGVydGllcyB0byBpbmZvLgoKICAgIGNvbnN0IG1lZGlhID0gZXh0cmFzLmdldE1lZGlhKGluZm8pOwogICAgY29uc3QgYWRkaXRpb25hbCA9IHsKICAgICAgYXV0aG9yOiBleHRyYXMuZ2V0QXV0aG9yKGluZm8pLAogICAgICBtZWRpYSwKICAgICAgbGlrZXM6IGV4dHJhcy5nZXRMaWtlcyhpbmZvKSwKICAgICAgZGlzbGlrZXM6IGV4dHJhcy5nZXREaXNsaWtlcyhpbmZvKSwKICAgICAgYWdlX3Jlc3RyaWN0ZWQ6ICEhKG1lZGlhICYmIEFHRV9SRVNUUklDVEVEX1VSTFMuc29tZSh1cmwgPT4gT2JqZWN0LnZhbHVlcyhtZWRpYSkuc29tZSh2ID0+IHR5cGVvZiB2ID09PSAnc3RyaW5nJyAmJiB2LmluY2x1ZGVzKHVybCkpKSksCiAgICAgIC8vIEdpdmUgdGhlIHN0YW5kYXJkIGxpbmsgdG8gdGhlIHZpZGVvLgogICAgICB2aWRlb191cmw6IEJBU0VfVVJMICsgaWQsCiAgICAgIHN0b3J5Ym9hcmRzOiBleHRyYXMuZ2V0U3Rvcnlib2FyZHMoaW5mbyksCiAgICAgIGNoYXB0ZXJzOiBleHRyYXMuZ2V0Q2hhcHRlcnMoaW5mbykKICAgIH07CiAgICBpbmZvLnZpZGVvRGV0YWlscyA9IGV4dHJhcy5jbGVhblZpZGVvRGV0YWlscyhPYmplY3QuYXNzaWduKHt9LCBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5taWNyb2Zvcm1hdC5wbGF5ZXJNaWNyb2Zvcm1hdFJlbmRlcmVyLCBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMsIGFkZGl0aW9uYWwpLCBpbmZvKTsKICAgIHJldHVybiBpbmZvOwogIH07CgogIGNvbnN0IHByaXZhdGVWaWRlb0Vycm9yID0gcGxheWVyX3Jlc3BvbnNlID0+IHsKICAgIGxldCBwbGF5YWJpbGl0eSA9IHBsYXllcl9yZXNwb25zZSAmJiBwbGF5ZXJfcmVzcG9uc2UucGxheWFiaWxpdHlTdGF0dXM7CgogICAgaWYgKHBsYXlhYmlsaXR5ICYmIHBsYXlhYmlsaXR5LnN0YXR1cyA9PT0gJ0xPR0lOX1JFUVVJUkVEJyAmJiBwbGF5YWJpbGl0eS5tZXNzYWdlcyAmJiBwbGF5YWJpbGl0eS5tZXNzYWdlcy5maWx0ZXIobSA9PiAvVGhpcyBpcyBhIHByaXZhdGUgdmlkZW8vLnRlc3QobSkpLmxlbmd0aCkgewogICAgICByZXR1cm4gbmV3IFVucmVjb3ZlcmFibGVFcnJvcihwbGF5YWJpbGl0eS5yZWFzb24gfHwgcGxheWFiaWxpdHkubWVzc2FnZXMgJiYgcGxheWFiaWxpdHkubWVzc2FnZXNbMF0pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfTsKCiAgY29uc3QgaXNSZW50YWwgPSBwbGF5ZXJfcmVzcG9uc2UgPT4gewogICAgbGV0IHBsYXlhYmlsaXR5ID0gcGxheWVyX3Jlc3BvbnNlLnBsYXlhYmlsaXR5U3RhdHVzOwogICAgcmV0dXJuIHBsYXlhYmlsaXR5ICYmIHBsYXlhYmlsaXR5LnN0YXR1cyA9PT0gJ1VOUExBWUFCTEUnICYmIHBsYXlhYmlsaXR5LmVycm9yU2NyZWVuICYmIHBsYXlhYmlsaXR5LmVycm9yU2NyZWVuLnBsYXllckxlZ2FjeURlc2t0b3BZcGNPZmZlclJlbmRlcmVyOwogIH07CgogIGNvbnN0IGlzTm90WWV0QnJvYWRjYXN0ZWQgPSBwbGF5ZXJfcmVzcG9uc2UgPT4gewogICAgbGV0IHBsYXlhYmlsaXR5ID0gcGxheWVyX3Jlc3BvbnNlLnBsYXlhYmlsaXR5U3RhdHVzOwogICAgcmV0dXJuIHBsYXlhYmlsaXR5ICYmIHBsYXlhYmlsaXR5LnN0YXR1cyA9PT0gJ0xJVkVfU1RSRUFNX09GRkxJTkUnOwogIH07CgogIGNvbnN0IGdldFdhdGNoSFRNTFVSTCA9IChpZCwgb3B0aW9ucykgPT4gYCR7QkFTRV9VUkwgKyBpZH0maGw9JHtvcHRpb25zLmxhbmcgfHwgJ2VuJ31gOwoKICBjb25zdCBnZXRXYXRjaEhUTUxQYWdlQm9keSA9IChpZCwgb3B0aW9ucykgPT4gewogICAgY29uc3QgdXJsID0gZ2V0V2F0Y2hIVE1MVVJMKGlkLCBvcHRpb25zKTsKICAgIHJldHVybiBleHBvcnRzLndhdGNoUGFnZUNhY2hlLmdldE9yU2V0KHVybCwgKCkgPT4gdXRpbHMuZXhwb3NlZE1pbmlnZXQodXJsLCBvcHRpb25zKS50ZXh0KCkpOwogIH07CgogIGNvbnN0IEVNQkVEX1VSTCA9ICdodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC8nOwoKICBjb25zdCBnZXRFbWJlZFBhZ2VCb2R5ID0gKGlkLCBvcHRpb25zKSA9PiB7CiAgICBjb25zdCBlbWJlZFVybCA9IGAke0VNQkVEX1VSTCArIGlkfT9obD0ke29wdGlvbnMubGFuZyB8fCAnZW4nfWA7CiAgICByZXR1cm4gdXRpbHMuZXhwb3NlZE1pbmlnZXQoZW1iZWRVcmwsIG9wdGlvbnMpLnRleHQoKTsKICB9OwoKICBjb25zdCBnZXRIVE1MNXBsYXllciA9IGJvZHkgPT4gewogICAgbGV0IGh0bWw1cGxheWVyUmVzID0gLzxzY3JpcHRccytzcmM9IihbXiJdKykiKD86XHMrdHlwZT0idGV4dFwvamF2YXNjcmlwdCIpP1xzK25hbWU9InBsYXllcl9pYXNcL2Jhc2UiXHMqPnwianNVcmwiOiIoW14iXSspIi8uZXhlYyhib2R5KTsKICAgIHJldHVybiBodG1sNXBsYXllclJlcyA/IGh0bWw1cGxheWVyUmVzWzFdIHx8IGh0bWw1cGxheWVyUmVzWzJdIDogbnVsbDsKICB9OwoKICBjb25zdCBnZXRJZGVudGl0eVRva2VuID0gKGlkLCBvcHRpb25zLCBrZXksIHRocm93SWZOb3RGb3VuZCkgPT4gZXhwb3J0cy5jb29raWVDYWNoZS5nZXRPclNldChrZXksIGFzeW5jICgpID0+IHsKICAgIGxldCBwYWdlID0gYXdhaXQgZ2V0V2F0Y2hIVE1MUGFnZUJvZHkoaWQsIG9wdGlvbnMpOwogICAgbGV0IG1hdGNoID0gcGFnZS5tYXRjaCgvKFsiJ10pSURfVE9LRU5cMVs6LF1ccz8iKFteIl0rKSIvKTsKCiAgICBpZiAoIW1hdGNoICYmIHRocm93SWZOb3RGb3VuZCkgewogICAgICB0aHJvdyBuZXcgVW5yZWNvdmVyYWJsZUVycm9yKCdDb29raWUgaGVhZGVyIHVzZWQgaW4gcmVxdWVzdCwgYnV0IHVuYWJsZSB0byBmaW5kIFlvdVR1YmUgaWRlbnRpdHkgdG9rZW4nKTsKICAgIH0KCiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMl07CiAgfSk7CiAgLyoqCiAgICogR29lcyB0aHJvdWdoIGVhY2ggZW5kcG9pbnQgaW4gdGhlIHBpcGVsaW5lLCByZXRyeWluZyBvbiBmYWlsdXJlIGlmIHRoZSBlcnJvciBpcyByZWNvdmVyYWJsZS4KICAgKiBJZiB1bmFibGUgdG8gc3VjY2VlZCB3aXRoIG9uZSBlbmRwb2ludCwgbW92ZXMgb250byB0aGUgbmV4dCBvbmUuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5LjxPYmplY3Q+fSBhcmdzCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gdmFsaWRhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gcmV0cnlPcHRpb25zCiAgICogQHBhcmFtIHtBcnJheS48RnVuY3Rpb24+fSBlbmRwb2ludHMKICAgKiBAcmV0dXJucyB7W09iamVjdCwgT2JqZWN0LCBPYmplY3RdfQogICAqLwoKCiAgY29uc3QgcGlwZWxpbmUgPSBhc3luYyAoYXJncywgdmFsaWRhdGUsIHJldHJ5T3B0aW9ucywgZW5kcG9pbnRzKSA9PiB7CiAgICBsZXQgaW5mbzsKCiAgICBmb3IgKGxldCBmdW5jIG9mIGVuZHBvaW50cykgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IG5ld0luZm8gPSBhd2FpdCByZXRyeUZ1bmMoZnVuYywgYXJncy5jb25jYXQoW2luZm9dKSwgcmV0cnlPcHRpb25zKTsKCiAgICAgICAgaWYgKG5ld0luZm8ucGxheWVyX3Jlc3BvbnNlKSB7CiAgICAgICAgICBuZXdJbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMgPSBhc3NpZ24oaW5mbyAmJiBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS52aWRlb0RldGFpbHMsIG5ld0luZm8ucGxheWVyX3Jlc3BvbnNlLnZpZGVvRGV0YWlscyk7CiAgICAgICAgICBuZXdJbmZvLnBsYXllcl9yZXNwb25zZSA9IGFzc2lnbihpbmZvICYmIGluZm8ucGxheWVyX3Jlc3BvbnNlLCBuZXdJbmZvLnBsYXllcl9yZXNwb25zZSk7CiAgICAgICAgfQoKICAgICAgICBpbmZvID0gYXNzaWduKGluZm8sIG5ld0luZm8pOwoKICAgICAgICBpZiAodmFsaWRhdGUoaW5mbywgZmFsc2UpKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBVbnJlY292ZXJhYmxlRXJyb3IgfHwgZnVuYyA9PT0gZW5kcG9pbnRzW2VuZHBvaW50cy5sZW5ndGggLSAxXSkgewogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0gLy8gVW5hYmxlIHRvIGZpbmQgdmlkZW8gbWV0YWRhdGEuLi4gc28gdHJ5IG5leHQgZW5kcG9pbnQuCgogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluZm87CiAgfTsKICAvKioKICAgKiBMaWtlIE9iamVjdC5hc3NpZ24oKSwgYnV0IGlnbm9yZXMgYG51bGxgIGFuZCBgdW5kZWZpbmVkYCBmcm9tIGBzb3VyY2VgLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldAogICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UKICAgKiBAcmV0dXJucyB7T2JqZWN0fQogICAqLwoKCiAgY29uc3QgYXNzaWduID0gKHRhcmdldCwgc291cmNlKSA9PiB7CiAgICBpZiAoIXRhcmdldCB8fCAhc291cmNlKSB7CiAgICAgIHJldHVybiB0YXJnZXQgfHwgc291cmNlOwogICAgfQoKICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzb3VyY2UpKSB7CiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGFyZ2V0W2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0YXJnZXQ7CiAgfTsKICAvKioKICAgKiBHaXZlbiBhIGZ1bmN0aW9uLCBjYWxscyBpdCB3aXRoIGBhcmdzYCB1bnRpbCBpdCdzIHN1Y2Nlc3NmdWwsCiAgICogb3IgdW50aWwgaXQgZW5jb3VudGVycyBhbiB1bnJlY292ZXJhYmxlIGVycm9yLgogICAqIEN1cnJlbnRseSwgYW55IGVycm9yIGZyb20gbWluaWdldCBpcyBjb25zaWRlcmVkIHVucmVjb3ZlcmFibGUuIEVycm9ycyBzdWNoIGFzCiAgICogdG9vIG1hbnkgcmVkaXJlY3RzLCBpbnZhbGlkIFVSTCwgc3RhdHVzIGNvZGUgNDA0LCBzdGF0dXMgY29kZSA1MDIuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jCiAgICogQHBhcmFtIHtBcnJheS48T2JqZWN0Pn0gYXJncwogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubWF4UmV0cmllcwogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLmJhY2tvZmYKICAgKiBAcGFyYW0ge251bWJlcn0gb3B0aW9ucy5iYWNrb2ZmLmluYwogICAqLwoKCiAgY29uc3QgcmV0cnlGdW5jID0gYXN5bmMgKGZ1bmMsIGFyZ3MsIG9wdGlvbnMpID0+IHsKICAgIGxldCBjdXJyZW50VHJ5ID0gMCwKICAgICAgICByZXN1bHQ7CgogICAgd2hpbGUgKGN1cnJlbnRUcnkgPD0gb3B0aW9ucy5tYXhSZXRyaWVzKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmVzdWx0ID0gYXdhaXQgZnVuYyguLi5hcmdzKTsKICAgICAgICBicmVhazsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFVucmVjb3ZlcmFibGVFcnJvciB8fCBlcnIgaW5zdGFuY2VvZiBtaW5pZ2V0Lk1pbmlnZXRFcnJvciAmJiBlcnIuc3RhdHVzQ29kZSA8IDUwMCB8fCBjdXJyZW50VHJ5ID49IG9wdGlvbnMubWF4UmV0cmllcykgewogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KCiAgICAgICAgbGV0IHdhaXQgPSBNYXRoLm1pbigrK2N1cnJlbnRUcnkgKiBvcHRpb25zLmJhY2tvZmYuaW5jLCBvcHRpb25zLmJhY2tvZmYubWF4KTsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgd2FpdCkpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICBjb25zdCBqc29uQ2xvc2luZ0NoYXJzID0gL15bKVxdfSdcc10rLzsKCiAgY29uc3QgcGFyc2VKU09OID0gKHNvdXJjZSwgdmFyTmFtZSwganNvbikgPT4gewogICAgaWYgKCFqc29uIHx8IHR5cGVvZiBqc29uID09PSAnb2JqZWN0JykgewogICAgICByZXR1cm4ganNvbjsKICAgIH0gZWxzZSB7CiAgICAgIHRyeSB7CiAgICAgICAganNvbiA9IGpzb24ucmVwbGFjZShqc29uQ2xvc2luZ0NoYXJzLCAnJyk7CiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoanNvbik7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHRocm93IEVycm9yKGBFcnJvciBwYXJzaW5nICR7dmFyTmFtZX0gaW4gJHtzb3VyY2V9OiAke2Vyci5tZXNzYWdlfWApOwogICAgICB9CiAgICB9CiAgfTsKCiAgY29uc3QgZmluZEpTT04gPSAoc291cmNlLCB2YXJOYW1lLCBib2R5LCBsZWZ0LCByaWdodCwgcHJlcGVuZEpTT04pID0+IHsKICAgIGxldCBqc29uU3RyID0gdXRpbHMuYmV0d2Vlbihib2R5LCBsZWZ0LCByaWdodCk7CgogICAgaWYgKCFqc29uU3RyKSB7CiAgICAgIHRocm93IEVycm9yKGBDb3VsZCBub3QgZmluZCAke3Zhck5hbWV9IGluICR7c291cmNlfWApOwogICAgfQoKICAgIHJldHVybiBwYXJzZUpTT04oc291cmNlLCB2YXJOYW1lLCB1dGlscy5jdXRBZnRlckpTT04oYCR7cHJlcGVuZEpTT059JHtqc29uU3RyfWApKTsKICB9OwoKICBjb25zdCBmaW5kUGxheWVyUmVzcG9uc2UgPSAoc291cmNlLCBpbmZvKSA9PiB7CiAgICBjb25zdCBwbGF5ZXJfcmVzcG9uc2UgPSBpbmZvICYmIChpbmZvLmFyZ3MgJiYgaW5mby5hcmdzLnBsYXllcl9yZXNwb25zZSB8fCBpbmZvLnBsYXllcl9yZXNwb25zZSB8fCBpbmZvLnBsYXllclJlc3BvbnNlIHx8IGluZm8uZW1iZWRkZWRfcGxheWVyX3Jlc3BvbnNlKTsKICAgIHJldHVybiBwYXJzZUpTT04oc291cmNlLCAncGxheWVyX3Jlc3BvbnNlJywgcGxheWVyX3Jlc3BvbnNlKTsKICB9OwoKICBjb25zdCBnZXRXYXRjaEpTT05VUkwgPSAoaWQsIG9wdGlvbnMpID0+IGAke2dldFdhdGNoSFRNTFVSTChpZCwgb3B0aW9ucyl9JnBiaj0xYDsKCiAgY29uc3QgZ2V0V2F0Y2hKU09OUGFnZSA9IGFzeW5jIChpZCwgb3B0aW9ucykgPT4gewogICAgY29uc3QgcmVxT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oewogICAgICBoZWFkZXJzOiB7fQogICAgfSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucyk7CiAgICBsZXQgY29va2llID0gcmVxT3B0aW9ucy5oZWFkZXJzLkNvb2tpZSB8fCByZXFPcHRpb25zLmhlYWRlcnMuY29va2llOwogICAgcmVxT3B0aW9ucy5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICd4LXlvdXR1YmUtY2xpZW50LW5hbWUnOiAnMScsCiAgICAgICd4LXlvdXR1YmUtY2xpZW50LXZlcnNpb24nOiBjdmVyLAogICAgICAneC15b3V0dWJlLWlkZW50aXR5LXRva2VuJzogZXhwb3J0cy5jb29raWVDYWNoZS5nZXQoY29va2llIHx8ICdicm93c2VyJykgfHwgJycKICAgIH0sIHJlcU9wdGlvbnMuaGVhZGVycyk7CgogICAgY29uc3Qgc2V0SWRlbnRpdHlUb2tlbiA9IGFzeW5jIChrZXksIHRocm93SWZOb3RGb3VuZCkgPT4gewogICAgICBpZiAocmVxT3B0aW9ucy5oZWFkZXJzWyd4LXlvdXR1YmUtaWRlbnRpdHktdG9rZW4nXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgcmVxT3B0aW9ucy5oZWFkZXJzWyd4LXlvdXR1YmUtaWRlbnRpdHktdG9rZW4nXSA9IGF3YWl0IGdldElkZW50aXR5VG9rZW4oaWQsIG9wdGlvbnMsIGtleSwgdGhyb3dJZk5vdEZvdW5kKTsKICAgIH07CgogICAgaWYgKGNvb2tpZSkgewogICAgICBhd2FpdCBzZXRJZGVudGl0eVRva2VuKGNvb2tpZSwgdHJ1ZSk7CiAgICB9CgogICAgY29uc3QganNvblVybCA9IGdldFdhdGNoSlNPTlVSTChpZCwgb3B0aW9ucyk7CiAgICBjb25zdCBib2R5ID0gYXdhaXQgdXRpbHMuZXhwb3NlZE1pbmlnZXQoanNvblVybCwgb3B0aW9ucywgcmVxT3B0aW9ucykudGV4dCgpOwogICAgbGV0IHBhcnNlZEJvZHkgPSBwYXJzZUpTT04oJ3dhdGNoLmpzb24nLCAnYm9keScsIGJvZHkpOwoKICAgIGlmIChwYXJzZWRCb2R5LnJlbG9hZCA9PT0gJ25vdycpIHsKICAgICAgYXdhaXQgc2V0SWRlbnRpdHlUb2tlbignYnJvd3NlcicsIGZhbHNlKTsKICAgIH0KCiAgICBpZiAocGFyc2VkQm9keS5yZWxvYWQgPT09ICdub3cnIHx8ICFBcnJheS5pc0FycmF5KHBhcnNlZEJvZHkpKSB7CiAgICAgIHRocm93IEVycm9yKCdVbmFibGUgdG8gcmV0cmlldmUgdmlkZW8gbWV0YWRhdGEgaW4gd2F0Y2guanNvbicpOwogICAgfQoKICAgIGxldCBpbmZvID0gcGFyc2VkQm9keS5yZWR1Y2UoKHBhcnQsIGN1cnIpID0+IE9iamVjdC5hc3NpZ24oY3VyciwgcGFydCksIHt9KTsKICAgIGluZm8ucGxheWVyX3Jlc3BvbnNlID0gZmluZFBsYXllclJlc3BvbnNlKCd3YXRjaC5qc29uJywgaW5mbyk7CiAgICBpbmZvLmh0bWw1cGxheWVyID0gaW5mby5wbGF5ZXIgJiYgaW5mby5wbGF5ZXIuYXNzZXRzICYmIGluZm8ucGxheWVyLmFzc2V0cy5qczsKICAgIHJldHVybiBpbmZvOwogIH07CgogIGNvbnN0IGdldFdhdGNoSFRNTFBhZ2UgPSBhc3luYyAoaWQsIG9wdGlvbnMpID0+IHsKICAgIGxldCBib2R5ID0gYXdhaXQgZ2V0V2F0Y2hIVE1MUGFnZUJvZHkoaWQsIG9wdGlvbnMpOwogICAgbGV0IGluZm8gPSB7CiAgICAgIHBhZ2U6ICd3YXRjaCcKICAgIH07CgogICAgdHJ5IHsKICAgICAgY3ZlciA9IHV0aWxzLmJldHdlZW4oYm9keSwgJ3sia2V5IjoiY3ZlciIsInZhbHVlIjoiJywgJyJ9Jyk7CiAgICAgIGluZm8ucGxheWVyX3Jlc3BvbnNlID0gZmluZEpTT04oJ3dhdGNoLmh0bWwnLCAncGxheWVyX3Jlc3BvbnNlJywgYm9keSwgL1xieXRJbml0aWFsUGxheWVyUmVzcG9uc2Vccyo9XHMqXHsvaSwgJzwvc2NyaXB0PicsICd7Jyk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgbGV0IGFyZ3MgPSBmaW5kSlNPTignd2F0Y2guaHRtbCcsICdwbGF5ZXJfcmVzcG9uc2UnLCBib2R5LCAvXGJ5dHBsYXllclwuY29uZmlnXHMqPVxzKnsvLCAnPC9zY3JpcHQ+JywgJ3snKTsKICAgICAgaW5mby5wbGF5ZXJfcmVzcG9uc2UgPSBmaW5kUGxheWVyUmVzcG9uc2UoJ3dhdGNoLmh0bWwnLCBhcmdzKTsKICAgIH0KCiAgICBpbmZvLnJlc3BvbnNlID0gZmluZEpTT04oJ3dhdGNoLmh0bWwnLCAncmVzcG9uc2UnLCBib2R5LCAvXGJ5dEluaXRpYWxEYXRhKCJcXSk/XHMqPVxzKlx7L2ksICc8L3NjcmlwdD4nLCAneycpOwogICAgaW5mby5odG1sNXBsYXllciA9IGdldEhUTUw1cGxheWVyKGJvZHkpOwogICAgcmV0dXJuIGluZm87CiAgfTsKCiAgY29uc3QgSU5GT19IT1NUID0gJ3d3dy55b3V0dWJlLmNvbSc7CiAgY29uc3QgSU5GT19QQVRIID0gJy9nZXRfdmlkZW9faW5mbyc7CiAgY29uc3QgVklERU9fRVVSTCA9ICdodHRwczovL3lvdXR1YmUuZ29vZ2xlYXBpcy5jb20vdi8nOwoKICBjb25zdCBnZXRWaWRlb0luZm9QYWdlID0gYXN5bmMgKGlkLCBvcHRpb25zKSA9PiB7CiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGBodHRwczovLyR7SU5GT19IT1NUfSR7SU5GT19QQVRIfWApOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3ZpZGVvX2lkJywgaWQpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2MnLCAnVFZIVE1MNScpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2N2ZXInLCBgNyR7Y3Zlci5zdWJzdHIoMSl9YCk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnZXVybCcsIFZJREVPX0VVUkwgKyBpZCk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgncHMnLCAnZGVmYXVsdCcpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2dsJywgJ1VTJyk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnaGwnLCBvcHRpb25zLmxhbmcgfHwgJ2VuJyk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnaHRtbDUnLCAnMScpOwogICAgY29uc3QgYm9keSA9IGF3YWl0IHV0aWxzLmV4cG9zZWRNaW5pZ2V0KHVybC50b1N0cmluZygpLCBvcHRpb25zKS50ZXh0KCk7CiAgICBsZXQgaW5mbyA9IHF1ZXJ5c3RyaW5nLnBhcnNlKGJvZHkpOwogICAgaW5mby5wbGF5ZXJfcmVzcG9uc2UgPSBmaW5kUGxheWVyUmVzcG9uc2UoJ2dldF92aWRlb19pbmZvJywgaW5mbyk7CiAgICByZXR1cm4gaW5mbzsKICB9OwogIC8qKgogICAqIEBwYXJhbSB7T2JqZWN0fSBwbGF5ZXJfcmVzcG9uc2UKICAgKiBAcmV0dXJucyB7QXJyYXkuPE9iamVjdD59CiAgICovCgoKICBjb25zdCBwYXJzZUZvcm1hdHMgPSBwbGF5ZXJfcmVzcG9uc2UgPT4gewogICAgbGV0IGZvcm1hdHMgPSBbXTsKCiAgICBpZiAocGxheWVyX3Jlc3BvbnNlICYmIHBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhKSB7CiAgICAgIGZvcm1hdHMgPSBmb3JtYXRzLmNvbmNhdChwbGF5ZXJfcmVzcG9uc2Uuc3RyZWFtaW5nRGF0YS5mb3JtYXRzIHx8IFtdKS5jb25jYXQocGxheWVyX3Jlc3BvbnNlLnN0cmVhbWluZ0RhdGEuYWRhcHRpdmVGb3JtYXRzIHx8IFtdKTsKICAgIH0KCiAgICByZXR1cm4gZm9ybWF0czsKICB9OwogIC8qKgogICAqIEdldHMgaW5mbyBmcm9tIGEgdmlkZW8gYWRkaXRpb25hbCBmb3JtYXRzIGFuZCBkZWNpcGhlcmVkIFVSTHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaWQKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59CiAgICovCgoKICBleHBvcnRzLmdldEluZm8gPSBhc3luYyAoaWQsIG9wdGlvbnMpID0+IHsKICAgIGxldCBpbmZvID0gYXdhaXQgZXhwb3J0cy5nZXRCYXNpY0luZm8oaWQsIG9wdGlvbnMpOwogICAgY29uc3QgaGFzTWFuaWZlc3QgPSBpbmZvLnBsYXllcl9yZXNwb25zZSAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhICYmIChpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmRhc2hNYW5pZmVzdFVybCB8fCBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmhsc01hbmlmZXN0VXJsKTsKICAgIGxldCBmdW5jcyA9IFtdOwoKICAgIGlmIChpbmZvLmZvcm1hdHMubGVuZ3RoKSB7CiAgICAgIGluZm8uaHRtbDVwbGF5ZXIgPSBpbmZvLmh0bWw1cGxheWVyIHx8IGdldEhUTUw1cGxheWVyKGF3YWl0IGdldFdhdGNoSFRNTFBhZ2VCb2R5KGlkLCBvcHRpb25zKSkgfHwgZ2V0SFRNTDVwbGF5ZXIoYXdhaXQgZ2V0RW1iZWRQYWdlQm9keShpZCwgb3B0aW9ucykpOwoKICAgICAgaWYgKCFpbmZvLmh0bWw1cGxheWVyKSB7CiAgICAgICAgdGhyb3cgRXJyb3IoJ1VuYWJsZSB0byBmaW5kIGh0bWw1cGxheWVyIGZpbGUnKTsKICAgICAgfQoKICAgICAgY29uc3QgaHRtbDVwbGF5ZXIgPSBuZXcgVVJMKGluZm8uaHRtbDVwbGF5ZXIsIEJBU0VfVVJMKS50b1N0cmluZygpOwogICAgICBmdW5jcy5wdXNoKHNpZy5kZWNpcGhlckZvcm1hdHMoaW5mby5mb3JtYXRzLCBodG1sNXBsYXllciwgb3B0aW9ucykpOwogICAgfQoKICAgIGlmIChoYXNNYW5pZmVzdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmRhc2hNYW5pZmVzdFVybCkgewogICAgICBsZXQgdXJsID0gaW5mby5wbGF5ZXJfcmVzcG9uc2Uuc3RyZWFtaW5nRGF0YS5kYXNoTWFuaWZlc3RVcmw7CiAgICAgIGZ1bmNzLnB1c2goZ2V0RGFzaE1hbmlmZXN0KHVybCwgb3B0aW9ucykpOwogICAgfQoKICAgIGlmIChoYXNNYW5pZmVzdCAmJiBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmhsc01hbmlmZXN0VXJsKSB7CiAgICAgIGxldCB1cmwgPSBpbmZvLnBsYXllcl9yZXNwb25zZS5zdHJlYW1pbmdEYXRhLmhsc01hbmlmZXN0VXJsOwogICAgICBmdW5jcy5wdXNoKGdldE0zVTgodXJsLCBvcHRpb25zKSk7CiAgICB9CgogICAgbGV0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChmdW5jcyk7CiAgICBpbmZvLmZvcm1hdHMgPSBPYmplY3QudmFsdWVzKE9iamVjdC5hc3NpZ24oe30sIC4uLnJlc3VsdHMpKTsKICAgIGluZm8uZm9ybWF0cyA9IGluZm8uZm9ybWF0cy5tYXAoZm9ybWF0VXRpbHMuYWRkRm9ybWF0TWV0YSk7CiAgICBpbmZvLmZvcm1hdHMuc29ydChmb3JtYXRVdGlscy5zb3J0Rm9ybWF0cyk7CiAgICBpbmZvLmZ1bGwgPSB0cnVlOwogICAgcmV0dXJuIGluZm87CiAgfTsKICAvKioKICAgKiBHZXRzIGFkZGl0aW9uYWwgREFTSCBmb3JtYXRzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybAogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXkuPE9iamVjdD4+fQogICAqLwoKCiAgY29uc3QgZ2V0RGFzaE1hbmlmZXN0ID0gKHVybCwgb3B0aW9ucykgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgbGV0IGZvcm1hdHMgPSB7fTsKICAgIGNvbnN0IHBhcnNlciA9IHNheCQxLnBhcnNlcihmYWxzZSk7CiAgICBwYXJzZXIub25lcnJvciA9IHJlamVjdDsKICAgIGxldCBhZGFwdGF0aW9uU2V0OwoKICAgIHBhcnNlci5vbm9wZW50YWcgPSBub2RlID0+IHsKICAgICAgaWYgKG5vZGUubmFtZSA9PT0gJ0FEQVBUQVRJT05TRVQnKSB7CiAgICAgICAgYWRhcHRhdGlvblNldCA9IG5vZGUuYXR0cmlidXRlczsKICAgICAgfSBlbHNlIGlmIChub2RlLm5hbWUgPT09ICdSRVBSRVNFTlRBVElPTicpIHsKICAgICAgICBjb25zdCBpdGFnID0gcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLklEKTsKCiAgICAgICAgaWYgKCFpc05hTihpdGFnKSkgewogICAgICAgICAgZm9ybWF0c1t1cmxdID0gT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIGl0YWcsCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgYml0cmF0ZTogcGFyc2VJbnQobm9kZS5hdHRyaWJ1dGVzLkJBTkRXSURUSCksCiAgICAgICAgICAgIG1pbWVUeXBlOiBgJHthZGFwdGF0aW9uU2V0Lk1JTUVUWVBFfTsgY29kZWNzPSIke25vZGUuYXR0cmlidXRlcy5DT0RFQ1N9ImAKICAgICAgICAgIH0sIG5vZGUuYXR0cmlidXRlcy5IRUlHSFQgPyB7CiAgICAgICAgICAgIHdpZHRoOiBwYXJzZUludChub2RlLmF0dHJpYnV0ZXMuV0lEVEgpLAogICAgICAgICAgICBoZWlnaHQ6IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5IRUlHSFQpLAogICAgICAgICAgICBmcHM6IHBhcnNlSW50KG5vZGUuYXR0cmlidXRlcy5GUkFNRVJBVEUpCiAgICAgICAgICB9IDogewogICAgICAgICAgICBhdWRpb1NhbXBsZVJhdGU6IG5vZGUuYXR0cmlidXRlcy5BVURJT1NBTVBMSU5HUkFURQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHBhcnNlci5vbmVuZCA9ICgpID0+IHsKICAgICAgcmVzb2x2ZShmb3JtYXRzKTsKICAgIH07CgogICAgY29uc3QgcmVxID0gdXRpbHMuZXhwb3NlZE1pbmlnZXQobmV3IFVSTCh1cmwsIEJBU0VfVVJMKS50b1N0cmluZygpLCBvcHRpb25zKTsKICAgIHJlcS5zZXRFbmNvZGluZygndXRmOCcpOwogICAgcmVxLm9uKCdlcnJvcicsIHJlamVjdCk7CiAgICByZXEub24oJ2RhdGEnLCBjaHVuayA9PiB7CiAgICAgIHBhcnNlci53cml0ZShjaHVuayk7CiAgICB9KTsKICAgIHJlcS5vbignZW5kJywgcGFyc2VyLmNsb3NlLmJpbmQocGFyc2VyKSk7CiAgfSk7CiAgLyoqCiAgICogR2V0cyBhZGRpdGlvbmFsIGZvcm1hdHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxBcnJheS48T2JqZWN0Pj59CiAgICovCgoKICBjb25zdCBnZXRNM1U4ID0gYXN5bmMgKHVybCwgb3B0aW9ucykgPT4gewogICAgdXJsID0gbmV3IFVSTCh1cmwsIEJBU0VfVVJMKTsKICAgIGNvbnN0IGJvZHkgPSBhd2FpdCB1dGlscy5leHBvc2VkTWluaWdldCh1cmwudG9TdHJpbmcoKSwgb3B0aW9ucykudGV4dCgpOwogICAgbGV0IGZvcm1hdHMgPSB7fTsKICAgIGJvZHkuc3BsaXQoJ1xuJykuZmlsdGVyKGxpbmUgPT4gL15odHRwcz86XC9cLy8udGVzdChsaW5lKSkuZm9yRWFjaChsaW5lID0+IHsKICAgICAgY29uc3QgaXRhZyA9IHBhcnNlSW50KGxpbmUubWF0Y2goL1wvaXRhZ1wvKFxkKylcLy8pWzFdKTsKICAgICAgZm9ybWF0c1tsaW5lXSA9IHsKICAgICAgICBpdGFnLAogICAgICAgIHVybDogbGluZQogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gZm9ybWF0czsKICB9OyAvLyBDYWNoZSBnZXQgaW5mbyBmdW5jdGlvbnMuCiAgLy8gSW4gY2FzZSBhIHVzZXIgd2FudHMgdG8gZ2V0IGEgdmlkZW8ncyBpbmZvIGJlZm9yZSBkb3dubG9hZGluZy4KCgogIGZvciAobGV0IGZ1bmNOYW1lIG9mIFsnZ2V0QmFzaWNJbmZvJywgJ2dldEluZm8nXSkgewogICAgLyoqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGluawogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59CiAgICAgKi8KICAgIGNvbnN0IGZ1bmMgPSBleHBvcnRzW2Z1bmNOYW1lXTsKCiAgICBleHBvcnRzW2Z1bmNOYW1lXSA9IGFzeW5jIChsaW5rLCBvcHRpb25zID0ge30pID0+IHsKICAgICAgdXRpbHMuY2hlY2tGb3JVcGRhdGVzKCk7CiAgICAgIGxldCBpZCA9IGF3YWl0IHVybFV0aWxzLmdldFZpZGVvSUQobGluayk7CiAgICAgIGNvbnN0IGtleSA9IFtmdW5jTmFtZSwgaWQsIG9wdGlvbnMubGFuZ10uam9pbignLScpOwogICAgICByZXR1cm4gZXhwb3J0cy5jYWNoZS5nZXRPclNldChrZXksICgpID0+IGZ1bmMoaWQsIG9wdGlvbnMpKTsKICAgIH07CiAgfSAvLyBFeHBvcnQgYSBmZXcgaGVscGVycy4KCgogIGV4cG9ydHMudmFsaWRhdGVJRCA9IHVybFV0aWxzLnZhbGlkYXRlSUQ7CiAgZXhwb3J0cy52YWxpZGF0ZVVSTCA9IHVybFV0aWxzLnZhbGlkYXRlVVJMOwogIGV4cG9ydHMuZ2V0VVJMVmlkZW9JRCA9IHVybFV0aWxzLmdldFVSTFZpZGVvSUQ7CiAgZXhwb3J0cy5nZXRWaWRlb0lEID0gdXJsVXRpbHMuZ2V0VmlkZW9JRDsKfSkoaW5mbyk7Cgpjb25zdCBQYXNzVGhyb3VnaCA9IHJlcXVpcmUkJDBfX2RlZmF1bHQkMVsiZGVmYXVsdCJdLlBhc3NUaHJvdWdoOwpjb25zdCBnZXRJbmZvID0gaW5mbzsKY29uc3QgdXRpbHMgPSB1dGlscyQyOwpjb25zdCBmb3JtYXRVdGlscyA9IGZvcm1hdFV0aWxzJDE7CmNvbnN0IHVybFV0aWxzID0gdXJsVXRpbHMkMTsKY29uc3Qgc2lnID0gc2lnJDE7CmNvbnN0IG1pbmlnZXQgPSBkaXN0JDE7CmNvbnN0IG0zdThzdHJlYW0gPSBkaXN0Owpjb25zdCB7CiAgcGFyc2VUaW1lc3RhbXAKfSA9IGRpc3Q7Ci8qKgogKiBAcGFyYW0ge3N0cmluZ30gbGluawogKiBAcGFyYW0geyFPYmplY3R9IG9wdGlvbnMKICogQHJldHVybnMge1JlYWRhYmxlU3RyZWFtfQogKi8KCmNvbnN0IHl0ZGwgPSAobGluaywgb3B0aW9ucykgPT4gewogIGNvbnN0IHN0cmVhbSA9IGNyZWF0ZVN0cmVhbShvcHRpb25zKTsKICB5dGRsLmdldEluZm8obGluaywgb3B0aW9ucykudGhlbihpbmZvID0+IHsKICAgIGRvd25sb2FkRnJvbUluZm9DYWxsYmFjayhzdHJlYW0sIGluZm8sIG9wdGlvbnMpOwogIH0sIHN0cmVhbS5lbWl0LmJpbmQoc3RyZWFtLCAnZXJyb3InKSk7CiAgcmV0dXJuIHN0cmVhbTsKfTsKCnZhciBsaWIgPSB5dGRsOwp5dGRsLmdldEJhc2ljSW5mbyA9IGdldEluZm8uZ2V0QmFzaWNJbmZvOwp5dGRsLmdldEluZm8gPSBnZXRJbmZvLmdldEluZm87Cnl0ZGwuY2hvb3NlRm9ybWF0ID0gZm9ybWF0VXRpbHMuY2hvb3NlRm9ybWF0Owp5dGRsLmZpbHRlckZvcm1hdHMgPSBmb3JtYXRVdGlscy5maWx0ZXJGb3JtYXRzOwp5dGRsLnZhbGlkYXRlSUQgPSB1cmxVdGlscy52YWxpZGF0ZUlEOwp5dGRsLnZhbGlkYXRlVVJMID0gdXJsVXRpbHMudmFsaWRhdGVVUkw7Cnl0ZGwuZ2V0VVJMVmlkZW9JRCA9IHVybFV0aWxzLmdldFVSTFZpZGVvSUQ7Cnl0ZGwuZ2V0VmlkZW9JRCA9IHVybFV0aWxzLmdldFZpZGVvSUQ7Cnl0ZGwuY2FjaGUgPSB7CiAgc2lnOiBzaWcuY2FjaGUsCiAgaW5mbzogZ2V0SW5mby5jYWNoZSwKICB3YXRjaDogZ2V0SW5mby53YXRjaFBhZ2VDYWNoZSwKICBjb29raWU6IGdldEluZm8uY29va2llQ2FjaGUKfTsKeXRkbC52ZXJzaW9uID0gcmVxdWlyZSQkOC52ZXJzaW9uOwoKY29uc3QgY3JlYXRlU3RyZWFtID0gb3B0aW9ucyA9PiB7CiAgY29uc3Qgc3RyZWFtID0gbmV3IFBhc3NUaHJvdWdoKHsKICAgIGhpZ2hXYXRlck1hcms6IG9wdGlvbnMgJiYgb3B0aW9ucy5oaWdoV2F0ZXJNYXJrIHx8IDEwMjQgKiA1MTIKICB9KTsKCiAgc3RyZWFtLl9kZXN0cm95ID0gKCkgPT4gewogICAgc3RyZWFtLmRlc3Ryb3llZCA9IHRydWU7CiAgfTsKCiAgcmV0dXJuIHN0cmVhbTsKfTsKCmNvbnN0IHBpcGVBbmRTZXRFdmVudHMgPSAocmVxLCBzdHJlYW0sIGVuZCkgPT4gewogIC8vIEZvcndhcmQgZXZlbnRzIGZyb20gdGhlIHJlcXVlc3QgdG8gdGhlIHN0cmVhbS4KICBbJ2Fib3J0JywgJ3JlcXVlc3QnLCAncmVzcG9uc2UnLCAnZXJyb3InLCAncmVkaXJlY3QnLCAncmV0cnknLCAncmVjb25uZWN0J10uZm9yRWFjaChldmVudCA9PiB7CiAgICByZXEucHJlcGVuZExpc3RlbmVyKGV2ZW50LCBzdHJlYW0uZW1pdC5iaW5kKHN0cmVhbSwgZXZlbnQpKTsKICB9KTsKICByZXEucGlwZShzdHJlYW0sIHsKICAgIGVuZAogIH0pOwp9OwovKioKICogQ2hvb3NlcyBhIGZvcm1hdCB0byBkb3dubG9hZC4KICoKICogQHBhcmFtIHtzdHJlYW0uUmVhZGFibGV9IHN0cmVhbQogKiBAcGFyYW0ge09iamVjdH0gaW5mbwogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogKi8KCgpjb25zdCBkb3dubG9hZEZyb21JbmZvQ2FsbGJhY2sgPSAoc3RyZWFtLCBpbmZvLCBvcHRpb25zKSA9PiB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgbGV0IGVyciA9IHV0aWxzLnBsYXlFcnJvcihpbmZvLnBsYXllcl9yZXNwb25zZSwgWydVTlBMQVlBQkxFJywgJ0xJVkVfU1RSRUFNX09GRkxJTkUnLCAnTE9HSU5fUkVRVUlSRUQnXSk7CgogIGlmIChlcnIpIHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIWluZm8uZm9ybWF0cy5sZW5ndGgpIHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIEVycm9yKCdUaGlzIHZpZGVvIGlzIHVuYXZhaWxhYmxlJykpOwogICAgcmV0dXJuOwogIH0KCiAgbGV0IGZvcm1hdDsKCiAgdHJ5IHsKICAgIGZvcm1hdCA9IGZvcm1hdFV0aWxzLmNob29zZUZvcm1hdChpbmZvLmZvcm1hdHMsIG9wdGlvbnMpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGUpOwogICAgcmV0dXJuOwogIH0KCiAgc3RyZWFtLmVtaXQoJ2luZm8nLCBpbmZvLCBmb3JtYXQpOwoKICBpZiAoc3RyZWFtLmRlc3Ryb3llZCkgewogICAgcmV0dXJuOwogIH0KCiAgbGV0IGNvbnRlbnRMZW5ndGgsCiAgICAgIGRvd25sb2FkZWQgPSAwOwoKICBjb25zdCBvbmRhdGEgPSBjaHVuayA9PiB7CiAgICBkb3dubG9hZGVkICs9IGNodW5rLmxlbmd0aDsKICAgIHN0cmVhbS5lbWl0KCdwcm9ncmVzcycsIGNodW5rLmxlbmd0aCwgZG93bmxvYWRlZCwgY29udGVudExlbmd0aCk7CiAgfTsKCiAgaWYgKG9wdGlvbnMuSVB2NkJsb2NrKSB7CiAgICBvcHRpb25zLnJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucywgewogICAgICBmYW1pbHk6IDYsCiAgICAgIGxvY2FsQWRkcmVzczogdXRpbHMuZ2V0UmFuZG9tSVB2NihvcHRpb25zLklQdjZCbG9jaykKICAgIH0pOwogIH0gLy8gRG93bmxvYWQgdGhlIGZpbGUgaW4gY2h1bmtzLCBpbiB0aGlzIGNhc2UgdGhlIGRlZmF1bHQgaXMgMTBNQiwKICAvLyBhbnl0aGluZyBvdmVyIHRoaXMgd2lsbCBjYXVzZSB5b3V0dWJlIHRvIHRocm90dGxlIHRoZSBkb3dubG9hZAoKCiAgY29uc3QgZGxDaHVua1NpemUgPSBvcHRpb25zLmRsQ2h1bmtTaXplIHx8IDEwMjQgKiAxMDI0ICogMTA7CiAgbGV0IHJlcTsKICBsZXQgc2hvdWxkRW5kID0gdHJ1ZTsKCiAgaWYgKGZvcm1hdC5pc0hMUyB8fCBmb3JtYXQuaXNEYXNoTVBEKSB7CiAgICByZXEgPSBtM3U4c3RyZWFtKGZvcm1hdC51cmwsIHsKICAgICAgY2h1bmtSZWFkYWhlYWQ6ICtpbmZvLmxpdmVfY2h1bmtfcmVhZGFoZWFkLAogICAgICBiZWdpbjogb3B0aW9ucy5iZWdpbiB8fCBmb3JtYXQuaXNMaXZlICYmIERhdGUubm93KCksCiAgICAgIGxpdmVCdWZmZXI6IG9wdGlvbnMubGl2ZUJ1ZmZlciwKICAgICAgcmVxdWVzdE9wdGlvbnM6IG9wdGlvbnMucmVxdWVzdE9wdGlvbnMsCiAgICAgIHBhcnNlcjogZm9ybWF0LmlzRGFzaE1QRCA/ICdkYXNoLW1wZCcgOiAnbTN1OCcsCiAgICAgIGlkOiBmb3JtYXQuaXRhZwogICAgfSk7CiAgICByZXEub24oJ3Byb2dyZXNzJywgKHNlZ21lbnQsIHRvdGFsU2VnbWVudHMpID0+IHsKICAgICAgc3RyZWFtLmVtaXQoJ3Byb2dyZXNzJywgc2VnbWVudC5zaXplLCBzZWdtZW50Lm51bSwgdG90YWxTZWdtZW50cyk7CiAgICB9KTsKICAgIHBpcGVBbmRTZXRFdmVudHMocmVxLCBzdHJlYW0sIHNob3VsZEVuZCk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHJlcXVlc3RPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5yZXF1ZXN0T3B0aW9ucywgewogICAgICBtYXhSZWNvbm5lY3RzOiA2LAogICAgICBtYXhSZXRyaWVzOiAzLAogICAgICBiYWNrb2ZmOiB7CiAgICAgICAgaW5jOiA1MDAsCiAgICAgICAgbWF4OiAxMDAwMAogICAgICB9CiAgICB9KTsKICAgIGxldCBzaG91bGRCZUNodW5rZWQgPSBkbENodW5rU2l6ZSAhPT0gMCAmJiAoIWZvcm1hdC5oYXNBdWRpbyB8fCAhZm9ybWF0Lmhhc1ZpZGVvKTsKCiAgICBpZiAoc2hvdWxkQmVDaHVua2VkKSB7CiAgICAgIGxldCBzdGFydCA9IG9wdGlvbnMucmFuZ2UgJiYgb3B0aW9ucy5yYW5nZS5zdGFydCB8fCAwOwogICAgICBsZXQgZW5kID0gc3RhcnQgKyBkbENodW5rU2l6ZTsKICAgICAgY29uc3QgcmFuZ2VFbmQgPSBvcHRpb25zLnJhbmdlICYmIG9wdGlvbnMucmFuZ2UuZW5kOwogICAgICBjb250ZW50TGVuZ3RoID0gb3B0aW9ucy5yYW5nZSA/IChyYW5nZUVuZCA/IHJhbmdlRW5kICsgMSA6IHBhcnNlSW50KGZvcm1hdC5jb250ZW50TGVuZ3RoKSkgLSBzdGFydCA6IHBhcnNlSW50KGZvcm1hdC5jb250ZW50TGVuZ3RoKTsKCiAgICAgIGNvbnN0IGdldE5leHRDaHVuayA9ICgpID0+IHsKICAgICAgICBpZiAoIXJhbmdlRW5kICYmIGVuZCA+PSBjb250ZW50TGVuZ3RoKSBlbmQgPSAwOwogICAgICAgIGlmIChyYW5nZUVuZCAmJiBlbmQgPiByYW5nZUVuZCkgZW5kID0gcmFuZ2VFbmQ7CiAgICAgICAgc2hvdWxkRW5kID0gIWVuZCB8fCBlbmQgPT09IHJhbmdlRW5kOwogICAgICAgIHJlcXVlc3RPcHRpb25zLmhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCByZXF1ZXN0T3B0aW9ucy5oZWFkZXJzLCB7CiAgICAgICAgICBSYW5nZTogYGJ5dGVzPSR7c3RhcnR9LSR7ZW5kIHx8ICcnfWAKICAgICAgICB9KTsKICAgICAgICByZXEgPSBtaW5pZ2V0KGZvcm1hdC51cmwsIHJlcXVlc3RPcHRpb25zKTsKICAgICAgICByZXEub24oJ2RhdGEnLCBvbmRhdGEpOwogICAgICAgIHJlcS5vbignZW5kJywgKCkgPT4gewogICAgICAgICAgaWYgKHN0cmVhbS5kZXN0cm95ZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChlbmQgJiYgZW5kICE9PSByYW5nZUVuZCkgewogICAgICAgICAgICBzdGFydCA9IGVuZCArIDE7CiAgICAgICAgICAgIGVuZCArPSBkbENodW5rU2l6ZTsKICAgICAgICAgICAgZ2V0TmV4dENodW5rKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcGlwZUFuZFNldEV2ZW50cyhyZXEsIHN0cmVhbSwgc2hvdWxkRW5kKTsKICAgICAgfTsKCiAgICAgIGdldE5leHRDaHVuaygpOwogICAgfSBlbHNlIHsKICAgICAgLy8gQXVkaW8gb25seSBhbmQgdmlkZW8gb25seSBmb3JtYXRzIGRvbid0IHN1cHBvcnQgYmVnaW4KICAgICAgaWYgKG9wdGlvbnMuYmVnaW4pIHsKICAgICAgICBmb3JtYXQudXJsICs9IGAmYmVnaW49JHtwYXJzZVRpbWVzdGFtcChvcHRpb25zLmJlZ2luKX1gOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5yYW5nZSAmJiAob3B0aW9ucy5yYW5nZS5zdGFydCB8fCBvcHRpb25zLnJhbmdlLmVuZCkpIHsKICAgICAgICByZXF1ZXN0T3B0aW9ucy5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxdWVzdE9wdGlvbnMuaGVhZGVycywgewogICAgICAgICAgUmFuZ2U6IGBieXRlcz0ke29wdGlvbnMucmFuZ2Uuc3RhcnQgfHwgJzAnfS0ke29wdGlvbnMucmFuZ2UuZW5kIHx8ICcnfWAKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmVxID0gbWluaWdldChmb3JtYXQudXJsLCByZXF1ZXN0T3B0aW9ucyk7CiAgICAgIHJlcS5vbigncmVzcG9uc2UnLCByZXMgPT4gewogICAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb250ZW50TGVuZ3RoID0gY29udGVudExlbmd0aCB8fCBwYXJzZUludChyZXMuaGVhZGVyc1snY29udGVudC1sZW5ndGgnXSk7CiAgICAgIH0pOwogICAgICByZXEub24oJ2RhdGEnLCBvbmRhdGEpOwogICAgICBwaXBlQW5kU2V0RXZlbnRzKHJlcSwgc3RyZWFtLCBzaG91bGRFbmQpOwogICAgfQogIH0KCiAgc3RyZWFtLl9kZXN0cm95ID0gKCkgPT4gewogICAgc3RyZWFtLmRlc3Ryb3llZCA9IHRydWU7CiAgICByZXEuZGVzdHJveSgpOwogICAgcmVxLmVuZCgpOwogIH07Cn07Ci8qKgogKiBDYW4gYmUgdXNlZCB0byBkb3dubG9hZCB2aWRlbyBhZnRlciBpdHMgYGluZm9gIGlzIGdvdHRlbiB0aHJvdWdoCiAqIGB5dGRsLmdldEluZm8oKWAuIEluIGNhc2UgdGhlIHVzZXIgbWlnaHQgd2FudCB0byBsb29rIGF0IHRoZQogKiBgaW5mb2Agb2JqZWN0IGJlZm9yZSBkZWNpZGluZyB0byBkb3dubG9hZC4KICoKICogQHBhcmFtIHtPYmplY3R9IGluZm8KICogQHBhcmFtIHshT2JqZWN0fSBvcHRpb25zCiAqIEByZXR1cm5zIHtSZWFkYWJsZVN0cmVhbX0KICovCgoKeXRkbC5kb3dubG9hZEZyb21JbmZvID0gKGluZm8sIG9wdGlvbnMpID0+IHsKICBjb25zdCBzdHJlYW0gPSBjcmVhdGVTdHJlYW0ob3B0aW9ucyk7CgogIGlmICghaW5mby5mdWxsKSB7CiAgICB0aHJvdyBFcnJvcignQ2Fubm90IHVzZSBgeXRkbC5kb3dubG9hZEZyb21JbmZvKClgIHdoZW4gY2FsbGVkICcgKyAnd2l0aCBpbmZvIGZyb20gYHl0ZGwuZ2V0QmFzaWNJbmZvKClgJyk7CiAgfQoKICBzZXRJbW1lZGlhdGUoKCkgPT4gewogICAgZG93bmxvYWRGcm9tSW5mb0NhbGxiYWNrKHN0cmVhbSwgaW5mbywgb3B0aW9ucyk7CiAgfSk7CiAgcmV0dXJuIHN0cmVhbTsKfTsKCmZ1bmN0aW9uIGdldE1heGltdW0oZm9ybWF0cywgcXVhbGl0eSwgaXNWaWRlbykgewogIGlmIChpc1ZpZGVvKSB7CiAgICBsZXQgZm10ID0gZm9ybWF0cy5maW5kKHggPT4geC5oYXNWaWRlbyAmJiAheC5oYXNBdWRpbyAmJiB4LnF1YWxpdHlMYWJlbC5pbmNsdWRlcyhxdWFsaXR5KSk7CgogICAgaWYgKGZtdCkgewogICAgICByZXR1cm4gZm10OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGxpYi5jaG9vc2VGb3JtYXQoZm9ybWF0cywgewogICAgICAgIHF1YWxpdHk6ICJoaWdoZXN0dmlkZW8iCiAgICAgIH0pOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gbGliLmNob29zZUZvcm1hdChmb3JtYXRzLCB7CiAgICAgIHF1YWxpdHk6ICJoaWdoZXN0YXVkaW8iCiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGdldFlvdXR1YmVVcmwoKSB7CiAgdHJ5IHsKICAgIGxldCB0ZXh0ID0gY2hpbGRfcHJvY2Vzcy5leGVjU3luYygicG93ZXJzaGVsbCAtY29tbWFuZCBnZXQtY2xpcGJvYXJkIik7CgogICAgaWYgKHRleHQpIHsKICAgICAgdGV4dCA9IHRleHQudG9TdHJpbmcoKTsKCiAgICAgIGlmICh0ZXh0LnN0YXJ0c1dpdGgoJ2h0dHAnKSAmJiB0ZXh0LmluY2x1ZGVzKCd5b3V0dScpKSB7CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICAgIH0KICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KCihhc3luYyAoKSA9PiB7CiAgY29uc3QgYyA9ICguLi5hKSA9PiBwcm9jZXNzLnN0ZG91dC53cml0ZSguLi5hKTsKCiAgYygiXHgxYl0wbTtNZW51aWZ5IC0gSmF2YXNjcmlwdCBDb21tYW5kXHgwNyIpOwogIGNvbnNvbGUuY2xlYXIoKTsKICBjKCJceDFiWzg7Nzs4MHQiKTsKICBsZXQgcmF3VXJsID0gZ2V0WW91dHViZVVybCgpOwoKICBpZiAocHJvY2Vzcy5hcmd2Lmxlbmd0aCA+PSAzICYmIHJhd1VybCkgewogICAgbGV0IHZpZGVvID0gYXdhaXQgbGliLmdldEluZm8ocmF3VXJsKTsKICAgIGxldCB0aXRsZSA9IHZpZGVvLnZpZGVvRGV0YWlscy50aXRsZS5yZXBsYWNlQWxsKC9bXkEtWmEtejAtOSBcLVxfXChcKVxbXF1dL2csICIiKS5zdWJzdHJpbmcoMCwgMjU1KTsKICAgIGxldCBiZXN0YXVkaW8gPSBnZXRNYXhpbXVtKHZpZGVvLmZvcm1hdHMsICcnLCBmYWxzZSk7CiAgICBjKCJceDFiWzMwOzQzbSBEb3dubG9hZGluZyAnIiArIHZpZGVvLnZpZGVvRGV0YWlscy50aXRsZSArICInIFx4MWJbMG1cbiIpOwogICAgbGV0IGZpbGUgPSB0aXRsZSArPSAiLm1wMyI7CiAgICBsZXQgZmlsZVBhdGggPSBwYXRoX19kZWZhdWx0WyJkZWZhdWx0Il0uam9pbihwcm9jZXNzLmFyZ3ZbMl0sIGZpbGUpOwogICAgY2hpbGRfcHJvY2Vzcy5leGVjU3luYyhgZmZtcGVnIC1pICIke2Jlc3RhdWRpby51cmx9IiAiJHtmaWxlUGF0aH0iIC1jIGNvcHkgLWxvZ2xldmVsIHF1aWV0YCwgewogICAgICBzdGRpbzogJ2luaGVyaXQnCiAgICB9KTsKICB9IGVsc2UgewogICAgYygiXHgwNyIpOwogICAgYygiXHgxYlsyOTs0MW0gRXJyb3I6IFRoaXMgc2NyaXB0IHJlcXVpcmVzIGEgdGFyZ2V0IGZvbGRlciBhbmQgYSBjb3BpZWQgeW91dHViZSB1cmwgXHgxYlswbVxuIik7CiAgICBwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUodHJ1ZSk7CiAgICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpOwogICAgYXdhaXQgbmV3IFByb21pc2UociA9PiB7CiAgICAgIHByb2Nlc3Muc3RkaW4ub25jZSgnZGF0YScsICgpID0+IHsKICAgICAgICBwcm9jZXNzLnN0ZGluLnBhdXNlKCk7CiAgICAgICAgcigpOwogICAgICB9KTsKICAgIH0pOwogIH0KfSkoKTsK","type":{"name":"javascript"},"signature":"(SIGNED)"}}],"certificate":{"issuer":"string","subjectKey":"string","validity":{"notBefore":"string<date>","notAfter":"string<date>"}}}